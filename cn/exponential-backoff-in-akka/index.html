<!DOCTYPE html><html lang="zh">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>通过Akka学习指数退避（Exponential Backoff） - Mincong Huang</title>

<meta name="description" content="让我们通过Akka框架学习什么是指数退避（Exponential Backoff），它在高负荷环境下如何担任重要的角色。它的基本参数，如何测试，应用场景，软件监控等等。">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>通过Akka学习指数退避（Exponential Backoff） | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="通过Akka学习指数退避（Exponential Backoff）" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="zh" />
<meta name="description" content="让我们通过Akka框架学习什么是指数退避（Exponential Backoff），它在高负荷环境下如何担任重要的角色。它的基本参数，如何测试，应用场景，软件监控等等。" />
<meta property="og:description" content="让我们通过Akka框架学习什么是指数退避（Exponential Backoff），它在高负荷环境下如何担任重要的角色。它的基本参数，如何测试，应用场景，软件监控等等。" />
<link rel="canonical" href="https://mincong.io/cn/exponential-backoff-in-akka/" />
<meta property="og:url" content="https://mincong.io/cn/exponential-backoff-in-akka/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-ocean-ng-L0xOtAnv94Y-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-20T05:21:16+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-ocean-ng-L0xOtAnv94Y-unsplash.jpg" />
<meta property="twitter:title" content="通过Akka学习指数退避（Exponential Backoff）" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Mincong Huang"},"description":"让我们通过Akka框架学习什么是指数退避（Exponential Backoff），它在高负荷环境下如何担任重要的角色。它的基本参数，如何测试，应用场景，软件监控等等。","@type":"BlogPosting","image":"https://mincong.io/assets/bg-ocean-ng-L0xOtAnv94Y-unsplash.jpg","url":"https://mincong.io/cn/exponential-backoff-in-akka/","dateModified":"2021-04-20T05:21:16+02:00","datePublished":"2021-04-20T05:21:16+02:00","headline":"通过Akka学习指数退避（Exponential Backoff）","mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/cn/exponential-backoff-in-akka/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="1280"/>
<meta property="og:image:height" content="1920"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/cn/exponential-backoff-in-akka/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>
<a title="Hi, welcome to my blog! I'm a software engineer at Datadog. I write blog posts in my free time. My blogs are bits and pieces of my tech journey. Most of them are related to Java. Hope you enjoy them! My opinions are my own, not Datadog's. This blog is powered by Jekyll, a simple, blog-aware, static sites solution.
" href="/">Mincong Huang</a></div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/categories">分类</a></li><li class="navigation__item"><a href="/series">系列</a></li><li class="navigation__item"><a href="/archive">归档</a></li><li class="navigation__item"><a href="/about">关于</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/assets/bg-ocean-ng-L0xOtAnv94Y-unsplash.jpg);background-color:#203028;"><div class="hero__content"><div class ="main"><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=java">java</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=akka">akka</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>2021年 04月20日</span>
            </li></ul></div><div class="article__header"><header><h1>通过Akka学习指数退避（Exponential Backoff）</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">程序总出错，光重试还不行？</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      Photo by
      <a href="https://unsplash.com/@oceanng" target="_blank">
        Ocean Ng
      </a>
      on
      <a href="https://unsplash.com/license" target="_blank">
        Unplash 
      </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><meta itemprop="headline" content="通过Akka学习指数退避（Exponential Backoff）"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2021-04-20T05:21:16+02:00">
    <meta itemprop="keywords" content="java,akka"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h2 id="前言">前言</h2>

<p>在软件开发中，我们免不了要跟各种错误异常打交道。比如说，当一个服务在调用另一个服务的时候，很可能会出现一些错误，而且这些错误不一定跟业务逻辑相关。一些常见的错误是：大批量调用API，导致限流报错；网络不稳定，导致连接断开；对方服务器暂时不可用等等。面对这些问题，我们该如何处理呢？今天，让我们通过Akka这个框架来了解一下什么指数退避（Exponential Backoff）。</p>

<p>读完这篇文章，你会明白：</p>

<ul>
  <li>什么是指数退避？</li>
  <li>如何理解它的各个参数？</li>
  <li>它的一些应用场景</li>
  <li>指数退避在别的框架中的实现</li>
  <li>怎么从这篇文章拓展出去</li>
</ul>

<p>事不宜迟，我们马上开始吧！</p>

<h2 id="什么是指数退避">什么是指数退避</h2>

<p>指数退避是退避技术（backoff）中很常见的一种，它是处理重负荷的一个很有效的方法。指数退避中最常用的估计是二进制退避技术。根据<a href="https://baike.baidu.com/item/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%8C%87%E6%95%B0%E9%80%80%E9%81%BF%E7%AE%97%E6%B3%95/3405081">百度百科</a>，二进制退避技术（Binary Exponential Backoff）指在遇到重复的冲突时，站点将重复传输，但在每一次冲突之后，随着时延的平均值将加倍。二进制指数退避算法提供了一个处理重负荷的方法。尝试传输的重复失败导致更长的退避时间，这将有助于负荷的平滑。如果没有这样的退避，以下状况可能发生：两个或多站点同时尝试传输，这将导致冲突，之后这些站点又立即尝试重传，导致一个新冲突。</p>

<p>啊，太抽象，看不懂？不要紧，那么让我来画个图帮助大家理解：</p>

<p><img src="/assets/20210420-expotential-backoff.png" alt="二进制指数退避示意图" /></p>

<p>上面这幅图，它的横轴是时间，上面的点是发生异常和重试的时刻。第一次（0）收到服务器异常在第0秒，我们决定1秒以后重试；结果重试失败，第二次（1）再次重试，这时候重试时间翻倍，定在2秒以后；结果又失败，第三次（2）重试，这个时候重试时间再次翻倍，定在4秒以后。结果又失败，第四次（4）重试，这个时候重试时间再次翻倍，定在8秒以后…如此类推。这就是基本的二进制指数退避算法。</p>

<p>这里面涉及的两个基本参数：</p>

<ul>
  <li>初始退避时长（initial backoff duration）：1秒</li>
  <li>指数：2</li>
</ul>

<h2 id="akka中的指数退避">Akka中的指数退避</h2>

<p>在Akka中，创建一个普通的actor可以通过创造它的属性（Props）来实现，然后把props交给Akka系统：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">creatorProps</span> <span class="o">=</span> <span class="nc">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
    <span class="nc">DocumentCreator</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
    <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">DocumentCreator</span><span class="o">(</span><span class="n">externalServiceClient</span><span class="o">,</span> <span class="n">managerRef</span><span class="o">,</span> <span class="n">request</span><span class="o">));</span>
</code></pre></div></div>

<p>如果要实现指数退避的话，那么可以不直接把props传递回去，而是先加入一个退避监督者（BackoffSupervisor），然后再返回：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">props</span> <span class="o">=</span> <span class="nc">DocumentCreator</span><span class="o">.</span><span class="na">props</span><span class="o">(</span><span class="n">externalServiceClient</span><span class="o">,</span> <span class="n">managerRef</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>

<span class="kt">var</span> <span class="n">creatorProps</span> <span class="o">=</span> <span class="nc">BackoffSupervisor</span><span class="o">.</span><span class="na">props</span><span class="o">(</span>
    <span class="nc">BackoffOpts</span><span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="n">props</span><span class="o">,</span> <span class="s">"document-creator"</span><span class="o">,</span> <span class="n">minBackOff</span><span class="o">,</span> <span class="n">maxBackOff</span><span class="o">,</span> <span class="mf">0.1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withSupervisorStrategy</span><span class="o">(</span>
            <span class="k">new</span> <span class="nf">OneForOneStrategy</span><span class="o">(</span>
                    <span class="nc">DeciderBuilder</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="nc">TooManyRequestsException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">restart</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">matchAny</span><span class="o">(</span><span class="n">o</span> <span class="o">-&gt;</span> <span class="n">stop</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                <span class="o">.</span><span class="na">withMaxNrOfRetries</span><span class="o">(</span><span class="n">maxRetries</span><span class="o">)));</span>
</code></pre></div></div>

<p>这段代码长得有点奇葩，希望不影响大家阅读。接下来，让我们仔细分析一下它的几个参数：</p>

<p><strong>最小退避时长（minBackoff）</strong>也是初始退避时长，它决定了actor在终止（terminiated）以后，多久以后被重启。主要用途是为了避免马上重启。那么多久的时间比较合适呢？我认为应该根据不同的服务、不同异常类型来决定。如果是因为过度调用对方API导致限流，那么应该视乎对方的冷却时间来决定什么时候重试。如果是因为网络不好，可以把最小初始重试时间调短一点。</p>

<p><strong>最大退避时长（maxBackoff）</strong>决定了退避时长增加到哪一个点以后不会继续增加。可能是为了避免产生过大的时长。</p>

<p><strong>随机值（randomFactor）</strong>是一个随机的增量。它决定了在计算好下一个退避时长的时候，要随机增加多少额外的时间。赋予0.2代表随机增加不超过20%的时间。这个做法是为了避免多个actors在同一时刻退避，增加了那个时刻对方服务器的负荷。这样的做法使得负荷更加的平滑。如果不想要这个随机增量的话，可以把它设成0.0。</p>

<p><strong>监督机制（supervisorStategy）</strong>：Akka 提供了两种监管策略，一种是OneForOneStrategy，另一种是AllForOneStrategy。两者都配置了从异常类型到监督指令的映射，并限制了在终止之前允许子级失败的频率。它们之间的区别在于前者只将获得的指令应用于失败的子级，而后者也将其应用于所有的子级。通常，你应该使用OneForOneStrategy，如果没有明确指定，它也是默认的选项。在上面的示例代码里面，我们规定了如果actor遇到过多请求的异常（TooManyRequestsException），它是会被重启的；如果actor遇到了任何别的异常，直接让它关掉。我这么做是因为我每次创建一个新的文档的时候，都让系统创建一个新的actor，所以它的生命周期本身就很短，关掉也没有影响。但我这里只是做个示范，如果你需要写类似代码的话，请仔细考虑什么最适合你。</p>

<p><strong>最大重试次数（maxNrOfRetries）</strong>是决定最多退避多少次就停止。这个是一个选填参数，默认重试无限次。有时候你需要这个参数，因为出错了就是出错了，可能再尝试也是没有结果的。比如我的工作中一个例子是，Elasticsearch的客户端在询问Elasticsearch是不是含有数据，可是对应的Elasticsearch集群已经被删除了，这个时候就没有必要无限次的问下去，因为对方已经不存在了。</p>

<h2 id="如何测试">如何测试</h2>

<p>可是怎么测试这个退避呢？我们先看看akka的逻辑，也就是这个DocumentCreator的逻辑，它是我们要测试的对象。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DocumentCreator</span> <span class="kd">extends</span> <span class="nc">AbstractActor</span> <span class="o">{</span>
  <span class="o">...</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Receive</span> <span class="nf">createReceive</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="nc">CreateDocumentRequest</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">createDoc</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">preStart</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">preStart</span><span class="o">();</span>
    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Starting actor"</span><span class="o">);</span>
    <span class="n">self</span><span class="o">().</span><span class="na">tell</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="na">noSender</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">createDoc</span><span class="o">(</span><span class="nc">CreateDocumentRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Creating document for user {}"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">user</span><span class="o">());</span>
    <span class="kt">var</span> <span class="n">response</span> <span class="o">=</span> <span class="n">externalServiceClient</span><span class="o">.</span><span class="na">createDocument</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

    <span class="c1">// only submit successful response, failure will be retried</span>
    <span class="n">managerRef</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">self</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>大家可以看出来它的逻辑很简单，它启动的时候给自己发一封信，类型是CreateDocumentRequest。当它收到这封信的时候，它呼叫外部服务去创建一个文档。创建成功的话，返回一个response。如果创建失败的话，那就会抛出一个异常。为了简化这个例子，我们没有处理异常。异常留给Akka的监督机制（supervisorStategy）去处理。</p>

<p>好了，所以怎么测试呢？这里我的想法是通过Mockito把第三方的服务mock掉，然后让它抛出特定的异常值TooManyRequestsException。这样，我们就可以测试退避的机制了。然后，我们把这个假的第三方服务注入到我们要测试的actor，也就是我们的文档创建者（DocumentCreator）。注入并启动这个actor后，这个actor会自动执行创建文件的逻辑（因为我把它写在prestart里面了）。然后我们就期待它一直不会返回任何正确的response：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="nd">@Timeout</span><span class="o">(</span><span class="mi">60</span><span class="o">)</span> <span class="c1">// avoid incorrect implementation</span>
<span class="kt">void</span> <span class="nf">exceptionBackoff_TooManyRequestsException</span><span class="o">()</span> <span class="o">{</span>
  <span class="c1">// Given</span>
  <span class="kt">var</span> <span class="n">count</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
  <span class="n">when</span><span class="o">(</span><span class="n">externalServiceClient</span><span class="o">.</span><span class="na">createDocument</span><span class="o">(</span><span class="n">any</span><span class="o">()))</span>
      <span class="o">.</span><span class="na">thenAnswer</span><span class="o">((</span><span class="nc">Answer</span><span class="o">&lt;</span><span class="nc">CreateDocumentResponse</span><span class="o">&gt;)</span> <span class="n">invocation</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">TooManyRequestsException</span><span class="o">(</span><span class="s">""</span> <span class="o">+</span> <span class="n">count</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">());</span>
      <span class="o">});</span>
  <span class="kt">var</span> <span class="n">maxBackOff</span> <span class="o">=</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>

  <span class="c1">// When</span>
  <span class="n">system</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span>
      <span class="nc">DocumentCreator</span><span class="o">.</span><span class="na">propsWithBackoff</span><span class="o">(</span>
          <span class="n">externalServiceClient</span><span class="o">,</span>
          <span class="n">testKit</span><span class="o">.</span><span class="na">getRef</span><span class="o">(),</span>
          <span class="k">new</span> <span class="nf">CreateDocumentRequest</span><span class="o">(</span><span class="s">"Tom"</span><span class="o">),</span>
          <span class="nc">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span>
          <span class="n">maxBackOff</span><span class="o">,</span>
          <span class="no">MAX_RETRIES</span><span class="o">));</span>

  <span class="c1">// Then</span>
  <span class="n">testKit</span><span class="o">.</span><span class="na">expectNoMessage</span><span class="o">(</span><span class="n">maxBackOff</span><span class="o">);</span>
  <span class="c1">// initial (1) + retries (N)</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span> <span class="o">+</span> <span class="no">MAX_RETRIES</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>结果测试通过了，真的没有返回任何response。而且我们有在mock里面设置了一个计数器，记录到底抛出了多少个异常。然后得到的结果是比最大重试次数多一个，也就是一开始失败了。然后重试N次也都失败了。全部加起来，一共失败了N+1次。其实怎么测试不是重点，重点是想让大家理解思路。如果对代码有兴趣的同学可以去我的GitHub里看，都放在上面了。链接在文末。</p>

<h2 id="应用场景">应用场景</h2>

<p>那什么情况下适合运用退避技术呢？总体上来说，我认为数据量大的服务应该使用退避技术，这个可以减轻对方服务的峰值负荷。如果要通过网络来交互，也可以考虑退避技术。还有跟业务逻辑无关的错误可以考虑退避技术。这么说可能有点抽象，让我来举几个实例吧！</p>

<ul>
  <li>第三方API请求。如果API调用次数过多，容易被对方限流（rate limited）。被限制以后再发也没用，反而可能延长冷却时间，得不偿失。这个时候适合使用退避技术。</li>
  <li>数据库操作。有时候数据库由于网络问题，连接超时。这个时候可以考虑退避。或者说数据库又异常，集群丢失了一个或多个节点，剩余节点由于要处理的任务很多，压力很大。它可能会拒绝接受新的请求来保护自己。这个时候，作为数据库的使用者，我们的服务如果有退避技术，可以缓解当时的压力，避免雪上加霜。</li>
  <li>前端退避。前端app与后端交流时，如果后端已经无法反应（5xx错误），使用退避技术可以缓解局面。</li>
</ul>

<p>上文指的“对方服务”，也不一定说是别人公司的第三方服务。它也可能是同个公司别人组的服务，可能是自己组的另一个服务。这里主要想强调我们是这个服务的客户端（client）。另外，退避也不是万能的。它只能够使得对方服务的负荷更平滑，但是不能够从根本上解决负荷很大的问题。关于负荷很大的问题，大家有兴趣的话，我们可以下次讲。</p>

<h2 id="如何监控">如何监控</h2>

<p>如果退避做得好的话，可以避免一些不必要的线上事故，也能提高用户体验。如果从可观测性（observability）的角度，我们可以如何观测退避呢？我觉得可以先不急着回答这个问题，先明白观测的目的。观测退避本身不是目的，它只是一个手段而已。目的是为了更快、更准确地发现问题。这么一想，目标就明确了。我们可以按照服务器、客户端、网络三方面来说。</p>

<p>服务器的话，主要是保证它不要过载，不要超负荷运作。那么如果是数据库的话，可以看连接的个数、查询写入的个数、内存、硬盘的读写、CPU、集群状态等等。客户端的话，我们可以看请求的总个数，错误个数和错误率，尤其是需要退避的错误的个数和错误率。对实时数据有要求的应用，我们也可以看由于退避引起的对于上下游的实时影响：延迟、百分比、客户方面的端到端（end-to-end）的影响等。网络方面，如果是基于TCP，可以看看总量，延迟，重传（retransmissions）等。刚才说到的主要是数据点/指标（metrics）。当然也可以看看日志，看错误的类型、频率、造成的后果等等。</p>

<p>监控这个事其实没有标准答案，可以视乎app的情况制定和完善。</p>

<h2 id="拓展">拓展</h2>

<p><em>除了Akka，那么有没有别的框架有退避？</em></p>

<p>我相信大部分框架都是有的。我自己经历过有两个例子，跟大家分享一下。</p>

<p>第一个是Kubernetes。当启动一个pod的时候，启动有可能会失败。这个时候Kubernetes会不断地重试。一个简单的例子就是你的Docker Image是从Docker官方的Registry下载的，然后下载次数太多又没给钱，他们就不乐意了。这个时候，作为第三方服务的Docker公司对你限流，然后无法下载Docker Image，于是无法启动pod。然后Kubernetes会迟一点再重试。当然，也有可能是不可恢复的错误，那么Kubernetes会不断重试，然后在某一时刻，pod会进入CrashLoopBackOff的状态。具体原因可以通过“kubectl describe”看到。</p>

<p>第二个是Temporal。Temporal是一个比较新的devops工具，做workflow自动化的。它的每一个job的每一个步骤，也就是他们所说的每个activity，都有退避技术。当acitivity抛出异常的时候，默认是重试的。然后如果是workflow自己，也就是job自己抛出异常的话不会重试。如果略读以下的Go文件，你可以看出我们上文提到的那些参数：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// RetryPolicy defines the retry policy.</span>
<span class="n">RetryPolicy</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c">// Backoff interval for the first retry. If coefficient is 1.0 then it is used for all retries.</span>
    <span class="c">// Required, no default value.</span>
    <span class="n">InitialInterval</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span>

    <span class="c">// Coefficient used to calculate the next retry backoff interval.</span>
    <span class="c">// The next retry interval is previous interval multiplied by this coefficient.</span>
    <span class="c">// Must be 1 or larger. Default is 2.0.</span>
    <span class="n">BackoffCoefficient</span> <span class="kt">float64</span>

    <span class="c">// Maximum backoff interval between retries. Exponential backoff leads to interval increase.</span>
    <span class="c">// This value is the cap of the interval. Default is 100x of initial interval.</span>
    <span class="n">MaximumInterval</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span>

    <span class="c">// Maximum number of attempts. When exceeded the retries stop even if not expired yet.</span>
    <span class="c">// If not set or set to 0, it means unlimited</span>
    <span class="n">MaximumAttempts</span> <span class="kt">int32</span>

    <span class="c">// Non-Retriable errors. This is optional. Temporal server will stop retry if error type matches this list.</span>
    <span class="c">// Note:</span>
    <span class="c">//  - cancellation is not a failure, so it won't be retried,</span>
    <span class="c">//  - only StartToClose or Heartbeat timeouts are retryable.</span>
    <span class="n">NonRetryableErrorTypes</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>
</code></pre></div></div>

<p>如果你对Akka本身感兴趣的话，建议看看官方英语版的原文<a href="https://doc.akka.io/docs/akka/current/fault-tolerance.html#delayed-restarts-for-classic-actors">“Classic Fault Tolerance - Delayed restarts for classic actors”</a>。里面有提到别的退避技术以及更多的退避参数。你也可以在我的Github项目<a href="https://github.com/mincong-h/java-examples/tree/blog/akka-backoff/akka">minong-h/java-examples</a>里面的akka文件夹里面找到这篇文章相对应的源代码。</p>

<h2 id="结论">结论</h2>

<p>在今天的文章里面，我们讨论了什么是指数退避、如何理解它的各个参数、怎么测试它、它的一些应用场景、如何监控、以及指数退避在别的框架中的实现。谢谢大家读完，希望这篇文章对你有用！</p>

<h2 id="参考文献">参考文献</h2>

<ul>
  <li>百度词条贡献者，《二进制指数退避算法》，百度百科，2020年。<a href="https://baike.baidu.com/item/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%8C%87%E6%95%B0%E9%80%80%E9%81%BF%E7%AE%97%E6%B3%95/3405081">https://baike.baidu.com/item/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%8C%87%E6%95%B0%E9%80%80%E9%81%BF%E7%AE%97%E6%B3%95/3405081</a></li>
  <li>CG国斌，《Akka 中文指南 - 监督和监控》，Github，2020年。<a href="https://github.com/guobinhit/akka-guide">https://github.com/guobinhit/akka-guide</a></li>
  <li>Prodesire，《指数退避（Exponential backoff）在网络请求中的应用》，阿里云，2020年。<a href="https://developer.aliyun.com/article/748634">https://developer.aliyun.com/article/748634</a></li>
  <li>Lightbend，《Classic Fault Tolerance》，Akka Documentation，2021年。<a href="https://doc.akka.io/docs/akka/current/fault-tolerance.html">https://doc.akka.io/docs/akka/current/fault-tolerance.html</a></li>
  <li>Temporal，《Activities - Retries》，Temporal，2021年。<a href="https://docs.temporal.io/docs/concept-activities/#retries">https://docs.temporal.io/docs/concept-activities/#retries</a></li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2021-04-20T05:21:16+02:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">订阅</a>
</div><div style="text-align: center">
  <img
    src="/assets/wechat-QR-code.jpg"
    alt="WeChat QR Code"
    width="400px"
    style="max-width: 100%">
</div></div><div class="article__license"><div class="license">
    <p>本文遵守 <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> 许可协议。
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>上篇</span><a href="/cn/http-proxy/">什么是HTTP代理服务器（HTTP Proxy）？</a></div><div class="next"><span>下篇</span><a href="/cn/throttler/">用Java创建一个简单的节流阀</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/cn/exponential-backoff-in-akka/';
    this.page.identifier = '/cn/exponential-backoff-in-akka';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="给我发邮件。">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="在 Twitter 上关注我。">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="在 Linkedin 上关注我。">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="在 Github 上关注我。">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">搜索</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        取消</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

