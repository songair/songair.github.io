<!DOCTYPE html><html lang="zh">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>在 Nginx 中配置二级域名 - Mincong Huang</title>

<meta name="description" content="如何在一台机器上部署多个网站？">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>在 Nginx 中配置二级域名 | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="在 Nginx 中配置二级域名" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="zh" />
<meta name="description" content="如何在一台机器上部署多个网站？" />
<meta property="og:description" content="如何在一台机器上部署多个网站？" />
<link rel="canonical" href="https://mincong.io/cn/nginx-subdomains/" />
<meta property="og:url" content="https://mincong.io/cn/nginx-subdomains/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-aaron-burden-GFpxQ2ZyNc0-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-29T09:46:04+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-aaron-burden-GFpxQ2ZyNc0-unsplash.jpg" />
<meta property="twitter:title" content="在 Nginx 中配置二级域名" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Mincong Huang"},"description":"如何在一台机器上部署多个网站？","@type":"BlogPosting","image":"https://mincong.io/assets/bg-aaron-burden-GFpxQ2ZyNc0-unsplash.jpg","url":"https://mincong.io/cn/nginx-subdomains/","dateModified":"2021-05-29T09:46:04+02:00","datePublished":"2021-05-29T09:46:04+02:00","headline":"在 Nginx 中配置二级域名","mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/cn/nginx-subdomains/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="960"/>
<meta property="og:image:height" content="1280"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/cn/nginx-subdomains/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>
<a title="Hi, welcome to my blog! I'm a software engineer at Datadog. I write blog posts in my free time. My blogs are bits and pieces of my tech journey. Most of them are related to Java. Hope you enjoy them! My opinions are my own, not Datadog's. This blog is powered by Jekyll, a simple, blog-aware, static sites solution.
" href="/">Mincong Huang</a></div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/categories">分类</a></li><li class="navigation__item"><a href="/series">系列</a></li><li class="navigation__item"><a href="/archive">归档</a></li><li class="navigation__item"><a href="/about">关于</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/assets/bg-aaron-burden-GFpxQ2ZyNc0-unsplash.jpg);background-color:#203028;"><div class="hero__content"><div class ="main"><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=nginx">nginx</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>2021年 05月29日</span>
            </li></ul></div><div class="article__header"><header><h1>在 Nginx 中配置二级域名</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">如何在一台机器上部署多个网站？</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      Photo by
      <a href="https://unsplash.com/@aaronburden" target="_blank">
        Aaron Burden
      </a>
      on
      <a href="https://unsplash.com/license" target="_blank">
        Unplash 
      </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><meta itemprop="headline" content="在 Nginx 中配置二级域名"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2021-05-29T09:46:04+02:00">
    <meta itemprop="keywords" content="nginx"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h2 id="前言">前言</h2>

<p>这两天在研究如何通过 Nginx 来配置二级域名（subdomains），觉得挺有意思的，想跟大家分享一下。我在一个机器部署多个子域名的原因很简单，就是因为：穷。。。没钱买服务器，于是想把多个服务部署在同一台机器上面，通过 Nginx 来实现。阅读本文后，你会明白：</p>

<ul>
  <li>如何在阿里云配置关于 DNS 的“域名解析”</li>
  <li>如何在 Nginx 中配置 HTTP 的重定向（redirection）</li>
  <li>如何在 Nginx 中配置部署多个子域名（subdomains）</li>
  <li>如何在后续阶段，部署新的子域名</li>
</ul>

<p>在开始之前，先明确一下目的。文章的目的是造出三个关于吉米数据（<a href="https://jimidata.fr">https://jimidata.fr</a>）的子域名，然后让它们都指向同一个服务器：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">URL</th>
      <th style="text-align: left">IP 地址</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><a href="https://www.jimidata.fr">https://www.jimidata.fr</a></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">47.243.61.237</code></td>
      <td style="text-align: left">静态网页服务</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://api.jimidata.fr">https://api.jimidata.fr</a></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">47.243.61.237</code></td>
      <td style="text-align: left">API 服务</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://blog.jimidata.fr">https://blog.jimidata.fr</a></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">47.243.61.237</code></td>
      <td style="text-align: left">博客服务</td>
    </tr>
  </tbody>
</table>

<p>吉米数据是一个没什么实质内容的网站，只是为了练手用的。下面就让我们开始吧！</p>

<h2 id="配置域名解析">配置域名解析</h2>

<p>第一步在阿里云的“云解析 DNS / 域名解析 / 解析设置”中添加新的记录。这里以<code class="language-plaintext highlighter-rouge">api.jimidata.fr</code>为例：我们选择一个 A 记录，也就是将域名指向一个 IPV4 地址；它的解析路线根据阿里云默认线路实现；记录值是我的机器的名字；缓存最长存活时间十分钟。具体配置如下：</p>

<p><img src="/assets/20210529-add-new-record.png" alt="阿里云：在解析设置中添加记录" /></p>

<p>用同样的方法配置其他的几个记录，最后生成结果如下：</p>

<p><img src="/assets/20210529-record-list.png" alt="阿里云：解析列表" /></p>

<p>可以看到，除了 HTTPS 的证书验证以外，其他的主机记录全部指向同一台机器，也就是我的服务器<code class="language-plaintext highlighter-rouge">47.243.61.237</code>。</p>

<h2 id="配置-http-重定向">配置 HTTP 重定向</h2>

<p>第二步是 HTTP 重定向（redireciton）。当用户以 HTTP 协议访问的时候，自动导向 HTTPS 保证安全。</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> {
    <span class="n">listen</span>       <span class="m">80</span>;
    <span class="n">server_name</span>  <span class="err">_</span>;
    <span class="n">return</span>       <span class="m">301</span> <span class="n">https</span>://$<span class="n">host</span>$<span class="n">request_uri</span>;
}
</code></pre></div></div>

<p>解释一下上面的配置：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">listen 80</code> 这个命令告诉 Nginx 要监听 80 号端口。所有 HTTP 都是通过 80 号端口抵达的。</li>
  <li><code class="language-plaintext highlighter-rouge">server_name _</code> 这个命令告诉 Nginx 无论什么 hostname 都会被匹配，无论是 <code class="language-plaintext highlighter-rouge">www.jimidata.fr</code>、<code class="language-plaintext highlighter-rouge">api.jimidata.fr</code>、<code class="language-plaintext highlighter-rouge">blog.jimidata.fr</code> 还是别的 host。</li>
  <li><code class="language-plaintext highlighter-rouge">return 301 https://$host$request_uri</code> 把用户的 HTTP 请求永久重定向（<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status">301 Moved Permanently</a>）到 HTTPS 那边，并且保证链接的剩余部分不变：host 以及 URI 部分都是一样的。唯一改变的就是把 HTTP 变成了 HTTPS。</li>
</ul>

<p>整个 Nginx 只需要这一个服务器（Server block）监听 80 号端口就可以了。因为它对所有的 hostname 都是匹配的。</p>

<h2 id="配置子域名">配置子域名</h2>

<p>下一步就是在 Nginx 中配置三个子域名相对应的服务器：</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ssl_certificate</span>      /<span class="n">path</span>/<span class="n">to</span>/<span class="n">fullchain</span>.<span class="n">cer</span>;
<span class="n">ssl_certificate_key</span>  /<span class="n">path</span>/<span class="n">to</span>/<span class="n">cert</span>.<span class="n">key</span>;

<span class="n">server</span> {
    <span class="n">listen</span>       <span class="m">443</span> <span class="n">ssl</span>;
    <span class="n">server_name</span>  <span class="n">www</span>.<span class="n">jimidata</span>.<span class="n">fr</span>;
    <span class="n">root</span>         /<span class="n">app</span>/<span class="n">jimi</span>/<span class="n">www</span>.<span class="n">jimidata</span>.<span class="n">fr</span>;
    <span class="n">index</span>        <span class="n">index</span>.<span class="n">html</span>;
}

<span class="n">server</span> {
    <span class="n">listen</span>       <span class="m">443</span> <span class="n">ssl</span>;
    <span class="n">server_name</span>  <span class="n">api</span>.<span class="n">jimidata</span>.<span class="n">fr</span>;
    <span class="n">root</span>         /<span class="n">app</span>/<span class="n">jimi</span>/<span class="n">api</span>.<span class="n">jimidata</span>.<span class="n">fr</span>;
    <span class="n">index</span>        <span class="n">index</span>.<span class="n">html</span>;
}

<span class="n">server</span> {
    <span class="n">listen</span>       <span class="m">443</span> <span class="n">ssl</span>;
    <span class="n">server_name</span>  <span class="n">blog</span>.<span class="n">jimidata</span>.<span class="n">fr</span>;
    <span class="n">root</span>         /<span class="n">app</span>/<span class="n">jimi</span>/<span class="n">blog</span>.<span class="n">jimidata</span>.<span class="n">fr</span>;
    <span class="n">index</span>        <span class="n">index</span>.<span class="n">html</span>;
}
</code></pre></div></div>

<p>解释一下上面的配置：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ssl_certificate /path/to/fullchain.cer</code> 是 SSL 证书存放的地址。</li>
  <li><code class="language-plaintext highlighter-rouge">ssl_certificate_key /path/to/cert.key</code> 是 SSL 密匙存放的地址。</li>
  <li><code class="language-plaintext highlighter-rouge">listen 443 ssl</code> 监听 443 号端口，也就是 HTTPS 端口。</li>
  <li><code class="language-plaintext highlighter-rouge">server_name</code> 填写相应的子域名，不需要加 <code class="language-plaintext highlighter-rouge">https://</code> 的前缀。填写这个使得 Nginx 可以正确匹配不同子域的请求。</li>
  <li><code class="language-plaintext highlighter-rouge">root /app/jimi/blog.jimidata.fr</code> 指示这个子域名所对应的文件夹根目录的位置。</li>
  <li><code class="language-plaintext highlighter-rouge">index index.html</code> 指示显示主页时所使用的文件名。</li>
</ul>

<p>下一个问题是：上面所说的配置，它应该放在哪里呢？其实它的存放位置有很多选择，你可以：</p>

<ul>
  <li>放在主配置文件 <code class="language-plaintext highlighter-rouge">/etc/nginx/nginx.conf</code> 里面的 <code class="language-plaintext highlighter-rouge">http</code> block</li>
  <li>放在配置文件夹 <code class="language-plaintext highlighter-rouge">/etc/nginx/conf.d/</code> 里面，但是我觉得这个文件夹主要是放公共的配置文件的，放这里虽然方便，但似乎不太妥当。</li>
  <li>放在文件夹 <code class="language-plaintext highlighter-rouge">/etc/nginx/sites-available/</code> 里面。每一个子域网站用一个独立的文件存储，然后再文件夹 <code class="language-plaintext highlighter-rouge">/etc/nginx/site-enabled</code> 创建快捷方式（symlink）激活这些子域网站。</li>
</ul>

<p>没准还有别的配置方法，希望大家留言分享哈。配置完成后，重启 Nginx 服务器来激活这些配置：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nginx <span class="nt">-s</span> reload
</code></pre></div></div>

<h2 id="验证结果">验证结果</h2>

<p>打开网站来验证一下结果：</p>

<p><img src="/assets/20210529-www.png" alt="Home Service" /></p>

<p><img src="/assets/20210529-api.png" alt="API Service" /></p>

<p><img src="/assets/20210529-blog.png" alt="Blog Service" /></p>

<p>再检查一下 HTTP 到 HTTPS 的重定向：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ curl -iL http://jimidata.fr
HTTP/1.1 301 Moved Permanently
Server: nginx/1.20.0
Date: Sat, 29 May 2021 14:13:46 GMT
Content-Type: text/html
Content-Length: 169
Connection: keep-alive
Location: https://jimidata.fr/

HTTP/1.1 200 OK
Server: nginx/1.20.0
Date: Sat, 29 May 2021 14:13:48 GMT
Content-Type: text/html
Content-Length: 111
Last-Modified: Sat, 29 May 2021 07:30:14 GMT
Connection: keep-alive
ETag: "60b1ed86-6f"
Accept-Ranges: bytes

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Jimi&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Home Service&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>你可以看见 curl 一共发送了两个请求：第一个请求被永久地重导向（301 Moved Permanently）到 HTTPS 版的网页；然后第二个请求成功（200 OK）并显示网页。</p>

<h2 id="增加新的子域名">增加新的子域名</h2>

<p>当业务增长的时候，你可能需要在后续阶段部署新的子域名。如果你使用阿里云的话，后续部署需要以下几个步骤：</p>

<ol>
  <li>部署你的应用</li>
  <li>修改 Nginx 配置</li>
  <li>添加新的子域名到阿里云的云解析 DNS</li>
  <li>更新 SSL 证书</li>
</ol>

<p>这里用另一个网站“阳光特教”举例。</p>

<p>第一步部署新的应用，比如：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="se">\</span>
    <span class="nt">--name</span> sunny-static <span class="se">\</span>
    <span class="nt">--publish</span> 18000:80 <span class="se">\</span>
    <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">--detach</span> <span class="se">\</span>
    <span class="nt">--volume</span> <span class="s2">"</span><span class="k">${</span><span class="nv">SUNNY_STATIC_PATH</span><span class="k">}</span><span class="s2">:/usr/share/nginx/html:ro"</span> <span class="se">\</span>
    <span class="s2">"</span><span class="nv">$image</span><span class="s2">"</span>
</code></pre></div></div>

<p>第二步，修改 Nginx 配置。把新的应用注册到反向代理（reverse proxy）：</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> {
    <span class="n">listen</span>               <span class="m">443</span> <span class="n">ssl</span>;
    <span class="n">server_name</span>          <span class="n">static</span>.<span class="n">sunnytj</span>.<span class="n">info</span>;

    <span class="n">location</span> / {
        <span class="n">proxy_pass</span>       <span class="n">http</span>://<span class="n">localhost</span>:<span class="m">18000</span>;
        <span class="c"># ...
</span>    }
    <span class="c"># ...
</span>}
</code></pre></div></div>

<p>第三步像上文一样在阿里云平台上增加新的子域名。填写记录类型、主机记录、解析线路、记录值、以及缓存有效期（TTL）。</p>

<p><img src="/assets/20210529-create-subdomain-aliyun-DNS.png" alt="增加新的子域名到阿里云的云解析DNS" /></p>

<p>第四步更新 SSL 证书。如果使用 Certbot 管理 SSL 证书的话，推荐使用它的命令行来操作。Certbot 会自动检测你已经部署在 Nginx 的域名，并请求你确认哪个域名需要激活 HTTPS：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>certbot <span class="nt">--nginx</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Saving debug log to /var/log/letsencrypt/letsencrypt.log

Which names would you like to activate HTTPS for?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1: sunnytj.info
2: admin.sunnytj.info
3: api.sunnytj.info
4: static.sunnytj.info
5: www.sunnytj.info
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Select the appropriate numbers separated by commas and/or spaces, or leave input
blank to select all options shown (Enter 'c' to cancel): 4
</code></pre></div></div>

<p>这里我选择激活第 4 个域名 <code class="language-plaintext highlighter-rouge">static.sunnytj.info</code>。确认以后 Certbot 向 Let’s Encrypt 申请新的证书。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Requesting a certificate for static.sunnytj.info
...
</code></pre></div></div>

<p>结束以后，新的域名就成功地被添加以及可以安全地通过 HTTPS 访问了。下面测试一下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl https://static.sunnytj.info/index.txt
Welcome to Sunny!
</code></pre></div></div>

<p>成功了，oh yeah！</p>

<h2 id="扩展">扩展</h2>

<p>如何从这篇文章中扩展出去？</p>

<ul>
  <li>如果想知道关于给 Nginx 配置 HTTPS 服务器的更多详情，访问官网页面：<a href="https://docs.nginx.com/nginx/admin-guide/security-controls/terminating-ssl-http/">NGINX SSL Termination</a></li>
  <li>看完了这篇文章还是不懂怎么配置二级域名？可以翻墙看看 Coding with Glove 的 YouTube 视频 <a href="https://youtu.be/b6YKx72XXQM">Using Nginx to Host Multiple Websites on One Server</a></li>
</ul>

<h2 id="结论">结论</h2>

<p>在本文中，我们看到了如何通过 Nginx 来配置二级域名：如何在阿里云配置关于 DNS 的域名解析；如何在 Nginx 中配置 HTTP 到 HTTPS 的重定向；如何在 Nginx 中配置多个子域名；如何在后续阶段添加新的子域名。最后，我们还分享了一些资源，让大家可以从这篇文章拓展出去。希望这篇文章能够解决你关于 Nginx 的配置问题，并且给你带来一些额外的思考。如果你有兴趣了解更多的咨询，欢迎关注我的 GitHub <a href="https://github.com/mincong-h">mincong-h</a> 或者微信订阅号【码农小黄】。谢谢大家！</p>

<h2 id="参考文献">参考文献</h2>

<ul>
  <li>Phoenix NAP, “How to Redirect HTTP to HTTPS in Nginx”, <em>phoenixnap.com</em>, 2020. <a href="https://phoenixnap.com/kb/redirect-http-to-https-nginx">https://phoenixnap.com/kb/redirect-http-to-https-nginx</a></li>
  <li>Andrew B, “Difference in sites-available vs sites-enabled vs conf.d directories (Nginx)?”, <em>Server Fault</em>, 2013. <a href="https://serverfault.com/questions/527630/">https://serverfault.com/questions/527630/</a></li>
  <li>sativaware, “Include HTTP headers in Curl response”, 2019. <a href="https://coderwall.com/p/f3avyq/include-http-headers-in-curl-response">https://coderwall.com/p/f3avyq/include-http-headers-in-curl-response</a></li>
  <li>Santosh Venkatraman, “Configure nginx to host multiple subdomains”, <em>dev.to</em>, 2019. <a href="https://dev.to/on_stash/configure-nginx-to-host-multiple-subdomains-2g0b">https://dev.to/on_stash/configure-nginx-to-host-multiple-subdomains-2g0b</a></li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><span>更新于
      <time itemprop="dateModified" datetime="2021-07-04T09:00:00+02:00">2021年 07月04日</time>
    </span><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">订阅</a>
</div><div style="text-align: center">
  <img
    src="/assets/wechat-QR-code.jpg"
    alt="WeChat QR Code"
    width="400px"
    style="max-width: 100%">
</div></div><div class="article__license"><div class="license">
    <p>本文遵守 <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> 许可协议。
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>上篇</span><a href="/cn/github-actions-acr/">GitHub Actions持续集成阿里云容器镜像服务（ACR）</a></div><div class="next"><span>下篇</span><a href="/cn/lang-m/">M 语言是什么鬼？</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/cn/nginx-subdomains/';
    this.page.identifier = '/cn/nginx-subdomains';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="给我发邮件。">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="在 Twitter 上关注我。">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="在 Linkedin 上关注我。">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="在 Github 上关注我。">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">搜索</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        取消</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

