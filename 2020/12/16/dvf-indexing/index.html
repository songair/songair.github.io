<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><!--
	_title: DVF: Indexing New Documents;
        _titles: ;
        __return: DVF: Indexing New Documents;
 -->
<!-- title: "DVF: Indexing New Documents" -->
<title>DVF: Indexing New Documents - Mincong Huang</title>

<meta name="description" content="Part 1: Indexing new documents into Elasticsearch using French government's open data &quot;Demande de valeurs foncières (DVF)&quot;.">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>DVF: Indexing New Documents | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="DVF: Indexing New Documents" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="en" />
<meta name="description" content="Part 1: Indexing new documents into Elasticsearch using French government’s open data “Demande de valeurs foncières (DVF)”." />
<meta property="og:description" content="Part 1: Indexing new documents into Elasticsearch using French government’s open data “Demande de valeurs foncières (DVF)”." />
<link rel="canonical" href="https://mincong.io/2020/12/16/dvf-indexing/" />
<meta property="og:url" content="https://mincong.io/2020/12/16/dvf-indexing/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-rodrigo-kugnharski-pdWc5wm1STw-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-16T15:27:56+01:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-rodrigo-kugnharski-pdWc5wm1STw-unsplash.jpg" />
<meta property="twitter:title" content="DVF: Indexing New Documents" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"image":"https://mincong.io/assets/bg-rodrigo-kugnharski-pdWc5wm1STw-unsplash.jpg","headline":"DVF: Indexing New Documents","description":"Part 1: Indexing new documents into Elasticsearch using French government’s open data “Demande de valeurs foncières (DVF)”.","datePublished":"2020-12-16T15:27:56+01:00","dateModified":"2020-12-16T15:27:56+01:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/2020/12/16/dvf-indexing/"},"url":"https://mincong.io/2020/12/16/dvf-indexing/","author":{"@type":"Person","name":"Mincong Huang"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="726"/>
<meta property="og:image:height" content="1280"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/2020/12/16/dvf-indexing/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>

          

          
          
          

          
          
          

          
          

          
          

          <a href="/">Home</a>
        </div><button class="button button--secondary button--circle search-button js-search-toggle">
            <i class="fas fa-search"></i>
          </button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/en/categories/">Categories</a></li><li class="navigation__item"><a href="/en/series/">Series</a></li><li class="navigation__item"><a href="/en/archive/">Archive</a></li><li class="navigation__item"><a href="/en/about/">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li><li>
            <a href="/cn/">
             <img src="/assets/flag-CN.png"
                  alt=""
                  class="naviation__lang_img">
            </a>
          </li>
        </ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/assets/bg-rodrigo-kugnharski-pdWc5wm1STw-unsplash.jpg);background-color:#203028;"><div class="hero__content"><div class ="main">

  
  <div class="article__info clearfix">
      <ul class="left-col menu">
        <li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=elasticsearch">elasticsearch</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=java">java</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=docker">docker</a>
            </li>

        <li class="separator">|</li>
          
            <li>
              <a class="button button--circle button--primary focus lang"
                 href="/2020/12/16/dvf-indexing/"><span>EN</span></a>

              






              

              
            </li>
          
        
      </ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Dec 16, 2020</span>
            </li></ul></div><!--
	_title: DVF: Indexing New Documents;
        _titles: ;
        __return: DVF: Indexing New Documents;
 -->
<div class="article__header"><header><h1>DVF: Indexing New Documents</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">Part 1: Indexing new documents into Elasticsearch using French government's open data "Demande de valeurs foncières (DVF)".</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      
      Photo by
      <a href="https://unsplash.com/@kugnharski" target="_blank">Rodrigo Kugnharski</a>
      
      on
      <a href="https://unsplash.com/license" target="_blank">Unplash </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><!--
	_title: DVF: Indexing New Documents;
        _titles: ;
        __return: DVF: Indexing New Documents;
 -->
<meta itemprop="headline" content="DVF: Indexing New Documents"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2020-12-16T15:27:56+01:00">
    <meta itemprop="keywords" content="elasticsearch,java,docker"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h2 id="introduction">Introduction</h2>

<p>In the last months, I wrote many articles explaining how to use solve one
specific problem in software. But I start to get tired of it and would like
to try something new: something that is based on a project. Today, I will start
a new series about Elasticsearch documenting my new personal project: DVF. Open
data <a href="https://cadastre.data.gouv.fr/dvf">“Demande de valeurs foncières (DVF)”</a>
is an open dataset provided by the French government which collects all the
real-estate transactions since January 2014, in mainland France and the
overseas departments and territories, except in Mayotte and Alsace-Moselle.</p>

<p>This blog series will focus on the features of Elasticsearch by using the DVF
dataset. We are going to explore how to index documents, optimize storage, backup,
and search documents using Elasticsearch. The main technologies used in this
series are: Elasticsearch, Docker, Java, and Postman.</p>

<p>This article will only cover the first part: indexing. We are going to see how
to download the dataset, prepare the environment, set up index mappings, and
create new documents in Elasticsearch.
After reading this article, you will understand:</p>

<ul>
  <li>How to download the dataset?</li>
  <li>How to read the dataset? (deserialization)</li>
  <li>How to set up Elasticsearch using Docker?</li>
  <li>How to set up Java High Level REST Client?</li>
  <li>How to create a new index and handle mappings?</li>
  <li>How to create new documents?</li>
</ul>

<p>Now, let’s get started!</p>

<h2 id="download-dataset">Download Dataset</h2>

<p>You can download the dataset from <a href="https://cadastre.data.gouv.fr/dvf">https://cadastre.data.gouv.fr/dvf</a>, where the
dataset is separated per year: 2014, 2015, 2016… There are two format: TXT and
CSV format. The one chosen here is the CSV one. You can find them here:
<a href="https://cadastre.data.gouv.fr/data/etalab-dvf/latest/csv/">https://cadastre.data.gouv.fr/data/etalab-dvf/latest/csv/</a>. Once downloaded,
you will get a compressed file called “full.csv.gz”. Depending on the chosen year, it will
contain the dataset of that year. For example, the “full.csv.gz” of 2020
contains all the transactions of 2020. You may want to rename it to avoid
conflictions if you want to download multiple years. Then, you need to
uncompress the file to obtain the CSV file. I use the <code class="language-plaintext highlighter-rouge">gunzip</code> command to handle
it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gunzip full.csv.gz
</code></pre></div></div>

<p>… and a CSV file called <code class="language-plaintext highlighter-rouge">full.csv</code> without the <code class="language-plaintext highlighter-rouge">.gz</code> will be available in the
same directory. Here is how the CSV of year 2020 looks like by showing the top 3
lines (<code class="language-plaintext highlighter-rouge">head -n 3 full.csv</code>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>id_mutation,date_mutation,numero_disposition,nature_mutation,valeur_fonciere,adresse_numero,adresse_suffixe,adresse_nom_voie,adresse_code_voie,code_postal,code_commune,nom_commune,code_departement,ancien_code_commune,ancien_nom_commune,id_parcelle,ancien_id_parcelle,numero_volume,lot1_numero,lot1_surface_carrez,lot2_numero,lot2_surface_carrez,lot3_numero,lot3_surface_carrez,lot4_numero,lot4_surface_carrez,lot5_numero,lot5_surface_carrez,nombre_lots,code_type_local,type_local,surface_reelle_bati,nombre_pieces_principales,code_nature_culture,nature_culture,code_nature_culture_speciale,nature_culture_speciale,surface_terrain,longitude,latitude
2020-1,2020-01-07,000001,Vente,8000,,,FORTUNAT,B063,01250,01072,Ceyzériat,01,,,01072000AK0216,,,,,,,,,,,,,0,,,,,T,terres,,,1061,5.323522,46.171899
2020-2,2020-01-07,000001,Vente,75000,,,RUE DE LA CHARTREUSE,0064,01960,01289,Péronnas,01,,,01289000AI0210,,,,,,,,,,,,,0,,,,,AB,terrains a bâtir,,,610,5.226197,46.184538
</code></pre></div></div>

<p>As you can see, there are a lot of columns here. The mappings will be fun… But
we are going to cover that later. Before going further, let’s measure the size
of the
dataset: this CSV file is 136MB and contains 827,106 transactions from January
2020 to June 2020.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ du -h full.2020.csv
136M	full.2020.csv

$ wc -l full.2020.csv
  827106 full.2020.csv
</code></pre></div></div>

<h2 id="read-dataset">Read Dataset</h2>

<p>To read the CSV file, I chose the framework Jackson because Jackson is one of
the most popular frameworks about JSON serialization in the Java ecosystem.
Here, we are using the module <a href="https://github.com/FasterXML/jackson-dataformats-text/tree/master/csv">Jackson Data-Format CSV</a> (<code class="language-plaintext highlighter-rouge">jackson-dataformat-csv</code>)
to deserialize from the CSV file. Since this article is more about Elasticsearch, I
try to be short about CSV handling. Briefly speaking, we need the
following things to read CSV rows:</p>

<ol>
  <li>Create a Jackson <code class="language-plaintext highlighter-rouge">CsvSchema</code> to be used during deserialization</li>
  <li>Create a Jackson <code class="language-plaintext highlighter-rouge">CsvMapper</code> to deserialize the CSV. <code class="language-plaintext highlighter-rouge">CsvMapper</code> inherits the
famous Jackson <code class="language-plaintext highlighter-rouge">ObjectMapper</code>.</li>
  <li>Create a value class <code class="language-plaintext highlighter-rouge">TransactionRow</code> to represent a row in the CSV file. This
class contains the <code class="language-plaintext highlighter-rouge">@JsonProperty</code> annotations used for the JSON/Java mapping and
<code class="language-plaintext highlighter-rouge">@JsonPropertyOrder</code> annotation used for specifying the order of the column
in the CSV file. If we don’t specify <code class="language-plaintext highlighter-rouge">@JsonPropertyOrder</code>, the alphabetic
order of the columns will be used, which will make the deserialization
wrong. For this value class, I use framework <a href="https://immutables.github.io/">Immutables</a>
to generate the class.</li>
</ol>

<p>Here is the key logic for creating a new CSV mapper, a new CSV schema, and a new
object reader to read the values from the csv file:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">csvMapper</span> <span class="o">=</span> <span class="nc">Jackson</span><span class="o">.</span><span class="na">newCsvMapper</span><span class="o">();</span>
<span class="kt">var</span> <span class="n">csvSchema</span> <span class="o">=</span> <span class="n">csvMapper</span><span class="o">.</span><span class="na">schemaFor</span><span class="o">(</span><span class="nc">TransactionRow</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">withHeader</span><span class="o">();</span>
<span class="kt">var</span> <span class="n">objectReader</span> <span class="o">=</span> <span class="n">csvMapper</span><span class="o">.</span><span class="na">readerFor</span><span class="o">(</span><span class="nc">TransactionRow</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">csvSchema</span><span class="o">);</span>
<span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">ImmutableTransactionRow</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">objectReader</span><span class="o">.</span><span class="na">readValues</span><span class="o">(</span><span class="n">csv</span><span class="o">);</span>
</code></pre></div></div>

<p>And the class of <code class="language-plaintext highlighter-rouge">TransactionRow</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Immutable</span>
<span class="nd">@JsonSerialize</span><span class="o">(</span><span class="n">as</span> <span class="o">=</span> <span class="nc">ImmutableTransactionRow</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@JsonDeserialize</span><span class="o">(</span><span class="n">as</span> <span class="o">=</span> <span class="nc">ImmutableTransactionRow</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@JsonPropertyOrder</span><span class="o">({</span>
  <span class="s">"id_mutation"</span><span class="o">,</span>
  <span class="s">"date_mutation"</span><span class="o">,</span>
  <span class="s">"numero_disposition"</span><span class="o">,</span>
  <span class="o">...</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TransactionRow</span> <span class="o">{</span>

  <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"id_mutation"</span><span class="o">)</span>
  <span class="nc">String</span> <span class="nf">mutationId</span><span class="o">();</span>

  <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"date_mutation"</span><span class="o">)</span>
  <span class="nc">LocalDate</span> <span class="nf">mutationDate</span><span class="o">();</span>

  <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"numero_disposition"</span><span class="o">)</span>
  <span class="nc">String</span> <span class="nf">dispositionNumber</span><span class="o">();</span>

  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The implementation of the transaction row is handled by Immutables. More precisely,
it is generated by the annotation processor of Immutables during code
compilation. The generated version is called <code class="language-plaintext highlighter-rouge">ImmutableTransactionRow</code>. As the
name suggested.</p>

<p><em>Why using Iterator instead of List?</em></p>

<p>As you may have observed, the object reader does not return all the values from the
CSV as a list. Why? This is because the CSV is too big, returning a list of
transactions eagerly can trigger a <code class="language-plaintext highlighter-rouge">java.lang.OutOfMemoryError</code>. This was the
case when I wrote the first version of the implementation. Here, using an iterator
means returning the transactions lazily, only deserialize the target row when
<code class="language-plaintext highlighter-rouge">next()</code> is called.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">ImmutableTransactionRow</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">objectReader</span><span class="o">.</span><span class="na">readValues</span><span class="o">(</span><span class="n">csv</span><span class="o">);</span>
</code></pre></div></div>

<p>We can also convert this iterator into a Java stream using the helper class
<code class="language-plaintext highlighter-rouge">StreamSupport</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">ImmutableTransactionRow</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">objectReader</span><span class="o">.</span><span class="na">readValues</span><span class="o">(</span><span class="n">csv</span><span class="o">);</span>
<span class="nc">Stream</span><span class="o">&lt;</span><span class="nc">ImmutableTransactionRow</span><span class="o">&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="nc">StreamSupport</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span>
    <span class="nc">Spliterators</span><span class="o">.</span><span class="na">spliteratorUnknownSize</span><span class="o">(</span><span class="n">iterator</span><span class="o">,</span> <span class="no">ORDERED</span><span class="o">),</span>
    <span class="kc">false</span>
<span class="o">);</span>
</code></pre></div></div>

<p>At this point, we can consider that the dataset is prepared and we can start
preparing the Elasticsearch server and Elasticsearch client.</p>

<h2 id="set-up-elasticsearch">Set Up Elasticsearch</h2>

<p>The easiest way to set up Elasticsearch is via Docker. Elasticsearch provides an
official Docker image <a href="https://hub.docker.com/_/elasticsearch/">elasticsearch</a>
and provides a detailed installation guide here: <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html">Install Elasticsearch with
Docker</a>.
You can start multiple nodes with Docker Compose to create a cluster or you can
start a single node for development or testing. In our case, we are going to use
the single-node mode, which requires less CPU and less memory. This is because
I’m running Elasticsearch in my Macbook Pro 2015 with 2.7 GHz Dual-Core Intel
Core i5 and 8 GB 1867 MHz DDR3, which is not super performant. Before starting
the Docker image, we also need to prepare a Docker volume so that the documents
indexed will persist even if we shut down the Docker container. Here is the
command that I use to start the Docker:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">esdata</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/dvf-volume-es"</span>

docker run <span class="se">\</span>
  <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">-p</span> 9200:9200 <span class="se">\</span>
  <span class="nt">-p</span> 9300:9300 <span class="se">\</span>
  <span class="nt">-e</span> <span class="s2">"discovery.type=single-node"</span> <span class="se">\</span>
  <span class="nt">-e</span> <span class="s2">"cluster.name=es-docker-cluster"</span> <span class="se">\</span>
  <span class="nt">-v</span> <span class="s2">"</span><span class="nv">$esdata</span><span class="s2">"</span>:/usr/share/elasticsearch/data <span class="se">\</span>
  docker.elastic.co/elasticsearch/elasticsearch:7.10.1
</code></pre></div></div>

<p>From the command above, you can see that the Docker volume for Elasticsearch is
located in my local hard disk at path <code class="language-plaintext highlighter-rouge">~/dvf-volume-es</code> and it’s mounted to
<code class="language-plaintext highlighter-rouge">/usr/share/elasticsearch/data</code> which is the common location to store the
Elasticsearch data inside a Docker container. The Docker container will be
removed once the container is stopped because we specified the option <code class="language-plaintext highlighter-rouge">--rm</code>.
We bind the port <code class="language-plaintext highlighter-rouge">9200</code> and port <code class="language-plaintext highlighter-rouge">9300</code> of the container to TCP port <code class="language-plaintext highlighter-rouge">9200</code> and
<code class="language-plaintext highlighter-rouge">9300</code> on localhost. We also specified the environment variable
<code class="language-plaintext highlighter-rouge">discovery.type=single-node</code> to ensure that Elasticsearch is started as a
single-node cluster and will bypass the bootstrap checks. We specified the
cluster name as <code class="language-plaintext highlighter-rouge">es-docker-cluster</code>. We mounted the volume to persist data as
explained above. And finally, we used the image <code class="language-plaintext highlighter-rouge">elasticsearch</code> of version
7.10.1 from the registry of Elasticsearch (<a href="https://docker.elastic.co">https://docker.elastic.co</a>).
This version is the latest at
the time I write this article. This command starts the Docker container in the
foreground so you can stop the container any time you want by pressing keys CTRL + C.</p>

<h2 id="set-up-java-client">Set Up Java Client</h2>

<p><em>Transport Client or Java High Level REST Client?</em></p>

<p>In the section above, we finished the set up on the server side (Elasticsearch).
Now, let’s continue on the client side. In this article, I am using the Java
client because Java is the best programming language in the world 😝
If you were familiar with Elasticsearch, you probably know that there are two
Java clients in Elasticsearch: the <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api/7.x/transport-client.html">Transport
Client</a>
and the <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high.html">Java High Level REST
Client</a>.
The reason I chose REST Client is that the Transport Client is
deprecated in favor of the REST client and will be removed in Elasticsearch
8.0. The new client is better because the Transport Client uses the transport
protocol to communicate with Elasticsearch, which causes compatibility problems
if the client is not on the same version as the Elasticsearch instances it talks
to.</p>

<p>To set up the Java High Level REST Client, you need to download the following
dependency if you are using Maven:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.elasticsearch.client<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>elasticsearch-rest-high-level-client<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>7.10.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>And then set up the Java client:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">builder</span> <span class="o">=</span> <span class="nc">RestClient</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="k">new</span> <span class="nc">HttpHost</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">9200</span><span class="o">,</span> <span class="s">"http"</span><span class="o">));</span>
<span class="k">try</span> <span class="o">(</span><span class="kt">var</span> <span class="n">restClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RestHighLevelClient</span><span class="o">(</span><span class="n">builder</span><span class="o">))</span> <span class="o">{</span>
  <span class="c1">// TODO: implementation goes here</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="elasticsearch-mappings">Elasticsearch Mappings</h2>

<p><em>What are index mappings in Elasticsearch?</em></p>

<p>According to official documentation <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/mapping.html">“Mapping
(7.x)”</a>,
mapping is the process of defining how a document, and the fields it contains,
are stored and indexed. For instance, use mappings to define which string fields
should be treated as full-text fields; which fields contain numbers, dates, or
geolocations; the format of the date values; custom rules to control the mappings
for dynamically added fields.</p>

<p>There are two types of mapping modes: dynamic mappings or explicit mappings.
When using dynamic mappings, fields and mapping types do not need to be defined
before being used, new field names will be added automatically. The other mode
is explicit mappings, where we can create the field mappings when creating a new
index. Explicit mappings are the mode that we use in this article because the
type of each field is well known. Making Elasticsearch guess the types can
make them incorrect.</p>

<p><em>Which data types to use for DVF dataset?</em></p>

<p>Elasticsearch provides many <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/mapping-types.html">field data
types</a>
and here are some of them used by DVF.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Field Name</th>
      <th style="text-align: center">Data Type</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">id_mutation</td>
      <td style="text-align: center">keyword</td>
      <td style="text-align: left">The identifier of the mutation. We can use <code class="language-plaintext highlighter-rouge">keyword</code> in Elasticsearch because it can be used for structured content such as IDs, email addresses, hostnames, status code, zip codes, or tags.</td>
    </tr>
    <tr>
      <td style="text-align: center">date_mutation</td>
      <td style="text-align: center">date</td>
      <td style="text-align: left">The date of the mutation is stored in the format “yyyy-MM-dd” in the CSV file. This matches what Elasticsearch wanted as well, where the input can be a string containing the formatted date. We can use a <code class="language-plaintext highlighter-rouge">date</code> field for queries, such as <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/query-dsl-range-query.html">range query</a>, or for aggregations, such as <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/search-aggregations-bucket-datehistogram-aggregation.html">date histogram aggregation</a>.</td>
    </tr>
    <tr>
      <td style="text-align: center">lot1_surface_carrez</td>
      <td style="text-align: center">double</td>
      <td style="text-align: left">The surface in m² for lot 1. Use <code class="language-plaintext highlighter-rouge">double</code> because this is not always an integer.</td>
    </tr>
    <tr>
      <td style="text-align: center">nombre_lots</td>
      <td style="text-align: center">integer</td>
      <td style="text-align: left">The number of lots.</td>
    </tr>
    <tr>
      <td style="text-align: center">location</td>
      <td style="text-align: center">geo_point</td>
      <td style="text-align: left">The latitude and longitude of a given geo-point. It refers to two fields in the CSV file, but after a tranformation in Java models, they are converted into a nested Java class called <code class="language-plaintext highlighter-rouge">Location</code> which contains 2 fields: <code class="language-plaintext highlighter-rouge">lon</code> and <code class="language-plaintext highlighter-rouge">lat</code>, as required by Elasticsearch. This nested object matches the JSON property <code class="language-plaintext highlighter-rouge">location</code>. Using this type, we will be able to find transactions within a certain distance of a central point, aggregate documents geographically or by distance from a central point, sort documents by distance, and much more.</td>
    </tr>
  </tbody>
</table>

<p>Once we understand which types to use for DVF, the next step is to create the
mappings. There are several ways to do this: we can use dynamic mappings or
explicit mappings. Since we know all the types, we are going to create the
mappings when we create the index. Here, we are going to create an index called
“transactions” which will contain all the transactions available in DVF.</p>

<p>Before writing Java code, let’s take a look at how the PUT mappings request
looks like in HTTP request and try to get some inspiration for the Java part:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT /transactions
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">mappings</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">properties</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">id_mutation</span><span class="dl">"</span><span class="p">:</span>         <span class="p">{</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">keyword</span><span class="dl">"</span> <span class="p">},</span>
      <span class="dl">"</span><span class="s2">date_mutation</span><span class="dl">"</span><span class="p">:</span>       <span class="p">{</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">date</span><span class="dl">"</span> <span class="p">},</span>
      <span class="dl">"</span><span class="s2">lot1_surface_carrez</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">double</span><span class="dl">"</span> <span class="p">},</span>
      <span class="dl">"</span><span class="s2">nombre_lots</span><span class="dl">"</span><span class="p">:</span>         <span class="p">{</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">integer</span><span class="dl">"</span> <span class="p">},</span>
      <span class="dl">"</span><span class="s2">location</span><span class="dl">"</span><span class="p">:</span>            <span class="p">{</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">geo_point</span><span class="dl">"</span> <span class="p">},</span>
      <span class="p">...</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, let’s check the Java code:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">esMappings</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">mappings</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">mappings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"mutation_id"</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"type"</span><span class="o">,</span> <span class="s">"keyword"</span><span class="o">));</span>
  <span class="o">...</span>
  <span class="k">return</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"properties"</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">mappings</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CreateIndexRequest</span><span class="o">(</span><span class="nc">Transaction</span><span class="o">.</span><span class="na">INDEX_NAME</span><span class="o">).</span><span class="na">mapping</span><span class="o">(</span><span class="nc">Transaction</span><span class="o">.</span><span class="na">esMappings</span><span class="o">());</span>
<span class="nc">CreateIndexResponse</span> <span class="n">response</span><span class="o">;</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">indices</span><span class="o">().</span><span class="na">create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Failed to create index "</span> <span class="o">+</span> <span class="nc">Transaction</span><span class="o">.</span><span class="na">INDEX_NAME</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">response</span><span class="o">.</span><span class="na">isAcknowledged</span><span class="o">())</span> <span class="o">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
      <span class="s">"Failed to create index "</span> <span class="o">+</span> <span class="nc">Transaction</span><span class="o">.</span><span class="na">INDEX_NAME</span> <span class="o">+</span> <span class="s">": response was not acknowledged"</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Creation of index {} is acknowledged"</span><span class="o">,</span> <span class="nc">Transaction</span><span class="o">.</span><span class="na">INDEX_NAME</span><span class="o">);</span>
</code></pre></div></div>

<p>In the code snippet above, we provide all the mappings as <code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code>
returned by <code class="language-plaintext highlighter-rouge">Transaction#esMappings()</code>, which matches the JSON structure
mentioned above in the HTTP PUT request. The mapping is provided as part of the
index creation request for index <code class="language-plaintext highlighter-rouge">transactions</code>. From the Java High Level REST
client <code class="language-plaintext highlighter-rouge">client</code>, we call its sub-client index-client to handle the request. To
simplify the demo, I throw an exception when the index failed to be created or
when the response is not acknowledged. In production, I believe we need
something more serious: in case of failure, we probably need to retry the
creation until the destination exists and provide information (metrics, logs) to
improve the observability.</p>

<h2 id="create-new-documents">Create New Documents</h2>

<p>Now, it’s time to index new documents in Elasticsearch. This can be done using the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/docs-index_.html">Index
API</a>,
where “transactions” is the name of the target index used during these document
creations:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT  /transactions/_doc/&lt;_id&gt;
POST /transactions/_doc/
</code></pre></div></div>

<p>If we translate the HTTP request into Java code, it can be done in follows:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">json</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">transaction</span><span class="o">);</span>
<span class="kt">var</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexRequest</span><span class="o">(</span><span class="s">"transactions"</span><span class="o">).</span><span class="na">source</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="nc">XContentType</span><span class="o">.</span><span class="na">JSON</span><span class="o">);</span>
<span class="kt">var</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
</code></pre></div></div>

<p>Let’s take a deeper look at the code snippet above. At the first step, we
serialize the transaction object into a JSON string. This is the source for the
Elasticsearch document. Then, we create an index request for index
“transactions” with this source JSON. Finally, we submit an index request via
Java High Level REST Client <code class="language-plaintext highlighter-rouge">client</code> to Elasticsearch synchronously and wait
until the acknowledgment from Elasticsearch. In the code snippet above, we
skipped the exception-handling part to simplify the reasoning because it’s not
the goal of this article. But in production, you will need to be very careful
about this part because it can lead to data loss.</p>

<p>Now going back to the indexing part, once the indexing is started, you can use
the <code class="language-plaintext highlighter-rouge">_cat</code> index API to retrieve the list of indices and see a new index
appeared. It’s “transactions” that we just created:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl localhost:9200/_cat/indices
yellow open transactions n4kNyGceQZOhQ0n-Yd8Qgg 1 1 10000 0 3mb 3mb
</code></pre></div></div>

<p>The code above works but it’s far from ideal. It’s too slow. The DVF dataset
contains 827,105 records (6-months) and it will take a long time to complete the
indexing process. I did a small calculation: by indexing 10,000 documents, we
need 2m34, where the indexing speed is 64.94 documents/s (see screenshot below).
Therefore, we will need 12,736 seconds or 3.5 hours to complete the indexing
process.</p>

<p><img src="/assets/20201217-normal-index-request.png" alt="Index Speed using normal Index request" /></p>

<p>🐢 This is not fast enough. In the following article, I will share how to improve
this indexing process.
At this point, we can consider that the basic indexing process works, and
therefore, we are approaching the end of this article.</p>

<h2 id="going-further">Going Further</h2>

<p>How to go further from here?</p>

<ul>
  <li>To learn more about DVF, visit the website: <a href="https://cadastre.data.gouv.fr/dvf">https://cadastre.data.gouv.fr/dvf</a></li>
  <li>To learn more about Elasticsearch installation with Docker, visit the official
documentation:
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/docker.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.x/docker.html</a></li>
  <li>To learn more about Java High Level REST Client, visit the website:
<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high.html</a></li>
  <li>To learn more about Java framework Immutables, visit the website:
<a href="https://immutables.github.io/">https://immutables.github.io/</a></li>
</ul>

<p>You can also find the source code of this project on GitHub under project
<a href="https://github.com/mincong-h/learning-elasticsearch/tree/master/demo-dvf">mincong-h/learning-elasticsearch</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we saw how to download the open data “Demande de valeurs
foncières (DVF)” 🇫🇷 ; how to read the dataset using Jackson Data-Format CSV;
how to set up Elasticsearch single-node cluster using Docker image; how to set
up Java High Level REST Client; how to choose the right data types of the index
mappings, such as keyword, date, integer, and geo-point. We finished the
operations by creating new documents in Elasticsearch using the simple Index
API. However, we also observed that the performance is not optimal and there is
room for improvements — which will be discussed in the next article.
Interested to know more? You can subscribe to <a href="/feed.xml">the feed of my blog</a>, follow me
on <a href="https://twitter.com/mincong_h">Twitter</a> or
<a href="https://github.com/mincong-h/">GitHub</a>. Hope you enjoy this article, see you the next time!</p>

<h2 id="references">References</h2>

<ul>
  <li>Etalab, “Base « Demande de valeurs foncières »”, 2020.
<a href="https://cadastre.data.gouv.fr/dvf">https://cadastre.data.gouv.fr/dvf</a></li>
  <li>Tatu Saloranta et al., “Jackson Data-Formats Text”, 2020.
<a href="https://github.com/FasterXML/jackson-dataformats-text">https://github.com/FasterXML/jackson-dataformats-text</a></li>
  <li>Elasticsearch, “Elasticsearch Reference 7.x”, 2020.
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/index.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.x/index.html</a></li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2020-12-16T15:27:56+01:00"><!-- start custom article footer snippet -->


  

  

  <div class="article__ads">
    
      <div id="ea-article"
           data-ea-publisher="mincongio"
           data-ea-keywords="elasticsearch|java|docker"
           data-ea-type="image">
    
    </div>
  </div>

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">Subscribe</a>
</div></div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/2020/11/28/data-deletion/">8 Lessons Learned From Data Deletion</a></div><div class="next"><span>NEXT</span><a href="/2020/12/17/dvf-indexing-optimization/">DVF: Indexing Optimization</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/2020/12/16/dvf-indexing/';
    this.page.identifier = '/2020/12/16/dvf-indexing';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script><script src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script>
<script>
ethicalads.wait.then((placements) => {
  if (!placements.length) {
    console.debug('Loading backup content');
    div = document.querySelector('[data-ea-publisher]')
    div.innerHTML = '<p>Check out our first-party ad content.</p>'
  } else {
    console.debug('EthicalAds are loaded');
  }
});
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

