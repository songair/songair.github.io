<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>DVF: Indexing Optimization - Mincong Huang</title>

<meta name="description" content="Part 2: Optimize the indexing process using bulk index requests and multi-threading.">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>DVF: Indexing Optimization | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="DVF: Indexing Optimization" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="en" />
<meta name="description" content="Part 2: Optimize the indexing process using bulk index requests and multi-threading." />
<meta property="og:description" content="Part 2: Optimize the indexing process using bulk index requests and multi-threading." />
<link rel="canonical" href="https://mincong.io/2020/12/17/dvf-indexing-optimization/" />
<meta property="og:url" content="https://mincong.io/2020/12/17/dvf-indexing-optimization/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-jonathan-velasquez-eUSpDPSFdKU-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-17T15:08:30+01:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-jonathan-velasquez-eUSpDPSFdKU-unsplash.jpg" />
<meta property="twitter:title" content="DVF: Indexing Optimization" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Mincong Huang"},"description":"Part 2: Optimize the indexing process using bulk index requests and multi-threading.","@type":"BlogPosting","image":"https://mincong.io/assets/bg-jonathan-velasquez-eUSpDPSFdKU-unsplash.jpg","url":"https://mincong.io/2020/12/17/dvf-indexing-optimization/","dateModified":"2020-12-17T15:08:30+01:00","datePublished":"2020-12-17T15:08:30+01:00","headline":"DVF: Indexing Optimization","mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/2020/12/17/dvf-indexing-optimization/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="853"/>
<meta property="og:image:height" content="1280"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/2020/12/17/dvf-indexing-optimization/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>
<a title="Hi, welcome to my blog! I'm a software engineer at Datadog. I write blog posts in my free time. My blogs are bits and pieces of my tech journey. Most of them are related to Java. Hope you enjoy them! My opinions are my own, not Datadog's. This blog is powered by Jekyll, a simple, blog-aware, static sites solution.
" href="/">Mincong Huang</a></div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/categories">Categories</a></li><li class="navigation__item"><a href="/series">Series</a></li><li class="navigation__item"><a href="/archive">Archive</a></li><li class="navigation__item"><a href="/about">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/assets/bg-jonathan-velasquez-eUSpDPSFdKU-unsplash.jpg);background-color:#203028;"><div class="hero__content"><div class ="main"><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=elasticsearch">elasticsearch</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=java">java</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=concurrency">concurrency</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Dec 17, 2020</span>
            </li></ul></div><div class="article__header"><header><h1>DVF: Indexing Optimization</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">Part 2: Optimize the indexing process using bulk index requests and multi-threading.</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      Photo by
      <a href="https://unsplash.com/@jonathanvez" target="_blank">
        Jonathan Velasquez
      </a>
      on
      <a href="https://unsplash.com/license" target="_blank">
        Unplash 
      </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><meta itemprop="headline" content="DVF: Indexing Optimization"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2020-12-17T15:08:30+01:00">
    <meta itemprop="keywords" content="elasticsearch,java,concurrency"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h2 id="introduction">Introduction</h2>

<p>In the previous article ‚ÄúDVF: Indexing New Documents‚Äù, we talked about how to
index new documents in Elasticsearch using the open data DVF. However, the
performance is not optimized because we can only index 64.9 documents/s.
In this article, I am going to share with you two tricks to improve the
indexing speed: using bulk index request and using multi-threading.</p>

<p>After reading this article, you will understand:</p>

<ul>
  <li>How to prepare the CSV reader (Jackson) for bulk processing?</li>
  <li>How to create bulk-index-request in Elasticsearch?</li>
  <li>How to perform index requests concurrently using a thread pool and how to
control its parallelism</li>
</ul>

<h2 id="bulk-iterator">Bulk Iterator</h2>

<p>To add multiple documents into a single bulk request, it‚Äôs better
to provide a stream of lists of documents as <code class="language-plaintext highlighter-rouge">Stream&lt;List&lt;ImmutableTransaction&gt;&gt;</code> as
an input parameter for the method which prepares the bulk request. However, it‚Äôs
not the value returned by the CSV reader.
Currently, the CSV reader returns a stream of transactions as
<code class="language-plaintext highlighter-rouge">Stream&lt;ImmutableTransaction&gt;</code>. In this section, I am going to explain how to
modify it. To better illustrate the changes, you can see the difference as
follows:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code> public class TransactionCsvReader {

-  public Stream&lt;ImmutableTransaction&gt; readCsv(Path path) {
<span class="gi">+  public Stream&lt;List&lt;ImmutableTransaction&gt;&gt; readCsv(Path path) {
</span>     try {
       Iterator&lt;ImmutableTransactionRow&gt; iterator = objectReader.readValues(path.toFile());
<span class="gi">+      var bulkIterator = new BulkIterator&lt;&gt;(iterator, bulkSize);
</span><span class="gd">-      return StreamSupport.stream(Spliterators.spliteratorUnknownSize(iterator, ORDERED), false)
</span><span class="gi">+      return StreamSupport.stream(Spliterators.spliteratorUnknownSize(bulkIterator, ORDERED), false)
</span>           .map(rows -&gt;
               rows.stream()
                   .map(TransactionRow::toTransactionObj)
                   .collect(Collectors.toList())
           );
     } catch (IOException e) {
       throw new IllegalStateException("Failed to read file " + path, e);
     }
   }
   ...
 }
</code></pre></div></div>

<p>The idea is pretty simple: create a new <code class="language-plaintext highlighter-rouge">BulkIterator</code> to encapsulate the existing
iterator returned by Jackson and provide a parameter <code class="language-plaintext highlighter-rouge">bulkSize</code> to control the
level of bulking. Besides that, using iterator ensures that the deserialization
is done lazily, i.e. deserialize the row when the object reader actually reaches
that row. It avoids out-of-memory errors in the JVM and keeps the memory usage
efficient.</p>

<p>Now, let‚Äôs take a look at this bulk iterator.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="kd">class</span> <span class="nc">BulkIterator</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">iterator</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">bulkSize</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">BulkIterator</span><span class="o">(</span><span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">iterator</span><span class="o">,</span> <span class="kt">int</span> <span class="n">bulkSize</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">iterator</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">bulkSize</span> <span class="o">=</span> <span class="n">bulkSize</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">hasNext</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kt">var</span> <span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;(</span><span class="n">bulkSize</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">hasNext</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">results</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">bulkSize</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">results</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">results</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In the constructor, we accept an external iterator (the one created by Jackson
object reader) and the bulk size for creating bulk. The <code class="language-plaintext highlighter-rouge">hasNext()</code> calls that
underlying iterator so that this iterator and the underlying iterator are
aligned about the current position. As for <code class="language-plaintext highlighter-rouge">next()</code>, the iterator moves forward
N steps to create a bulk as a <code class="language-plaintext highlighter-rouge">List&lt;T&gt;</code>. It stops when the bulk is full or when
the underlying iterator is exhausted. Following the specification of iterator
(see Javadoc), it throws an exception when there is no more element.</p>

<h2 id="bulk-index-request">Bulk Index Request</h2>

<p>Once we have the structure <code class="language-plaintext highlighter-rouge">Stream&lt;List&lt;ImmutableTransaction&gt;&gt;</code>, the next step
is the create a <code class="language-plaintext highlighter-rouge">BulkRequest</code> for each item in the stream, i.e. each list of
transactions (<code class="language-plaintext highlighter-rouge">List&lt;ImmutableTransaction&gt;</code>). Java High Level REST Client
provides a class <code class="language-plaintext highlighter-rouge">BulkRequest</code> to call the <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-document-bulk.html">Bulk
API</a>
of Elasticsearch. In the code snippet below, you can how to do that step by
step. The first step is to create a bulk request. Then, for each transaction in
the list, we serialize it as JSON and create an invividual index request. Then,
we add each index request into the bulk request. Finally, we submit the request
to the Bulk API and retrieve the bulk response.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">bulkRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BulkRequest</span><span class="o">();</span>

<span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">transaction</span> <span class="o">:</span> <span class="n">transactions</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">json</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">transaction</span><span class="o">);</span>
    <span class="n">bulkRequest</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">IndexRequest</span><span class="o">(</span><span class="n">indexName</span><span class="o">).</span><span class="na">source</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="nc">XContentType</span><span class="o">.</span><span class="na">JSON</span><span class="o">));</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JsonProcessingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// This should never happen</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Failed to serialize transaction "</span> <span class="o">+</span> <span class="n">transaction</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="kt">var</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">bulk</span><span class="o">(</span><span class="n">bulkRequest</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
</code></pre></div></div>

<p>But you may ask: how much do we improve by using Bulk API instead of the normal
Index API? To compare the difference, I did a small benchmark using two
computers: my Macbook Pro 13 and my Toshiba KIRA, respectively for the
Elasticsearch client and the Elasticsearch server. Both of them are a bit
outdated these days, but they are still providing valuable results as we
will see right after. I need two machines because I don‚Äôt want the settings of
the Java client to impact the performance of Elasticsearch. If you are curious
about the specification of these machines, you can find them as follows:</p>

<ul>
  <li>Macbook Pro (Retina, 13-inch, Early 2015)
    <ul>
      <li>Processor: 2.7 GHz Dual-Core Intel Core i5</li>
      <li>Memory: 8GB 1867MHz DDR3</li>
    </ul>
  </li>
  <li>Toshiba KIRA
    <ul>
      <li>Processor: Intel(R) Core(TM) i7-4510U CPU @ 2.00GHz</li>
      <li>Memory: 8GB 1600MHz DDR3</li>
    </ul>
  </li>
</ul>

<p>On the Toshiba KIRA side, I started a Docker container of Elasticsearch 7.10.1
as what we did in the last article. Now, everything is ready, we can start the
comparison of different bulk sizes for real.</p>

<p>In the screenshot below, you can see the CPU usage, memory usage, and the
network usage of the host running the Elasticsearch server (Toshiba KIRA)
without bulk request API. The performance is not optimal: the CPU usage is low
and the network traffic is low as well. From the client-side logs, we can see
that we only indexed 10,000 documents in 2 minutes and 50 seconds, which is
58.82 documents/s. In this speed, we need about 827,106 / 58.82 / 3600 = 3.91
hours to index the full dataset. üòÖ</p>

<p><img src="/assets/20201218.dvf-B1-T1-start.png" alt="Stats of B1-T1" /></p>

<p><img src="/assets/20201218.dvf-B1-T1-logs.png" alt="Logs of B1-T1" /></p>

<p>Now, let‚Äôs see if the performance can be improved by increasing the bulk size to
10, 100, 1000:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">Bulk Size</th>
      <th style="text-align: right">Indexing Duration</th>
      <th style="text-align: right">Indexing Speed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: right">(estimated) 3h54m00</td>
      <td style="text-align: right">58.8 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: right">10</td>
      <td style="text-align: right">26m49</td>
      <td style="text-align: right">514.1 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: right">100</td>
      <td style="text-align: right">6m04</td>
      <td style="text-align: right">2,272.3 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: right">1,000</td>
      <td style="text-align: right">3m16</td>
      <td style="text-align: right">4,219.9 docs/s</td>
    </tr>
  </tbody>
</table>

<p>As you can see, the performance is improved significantly when we increase the
bulk size. However, we can also observe that the improvement is not
proportional: when we bulk 10 times more, the speed does not necessarily improve
10 times. There are several reasons: the first reason is that when the client
is preparing the request, the server is idle ‚Äî it already finished the previous
tasks. The second reason is that the client is running synchronously in a single
thread, so it couldn‚Äôt prepare enough tasks in parallel and it is idle when
waiting for the bulk response from Elasticsearch.</p>

<p>From the screenshot below, you can see the CPU usage, memory usage, and the
network usage of the host running the Elasticsearch server (Toshiba KIRA) when
the bulk size is set to 1,000. You can see that the 4 CPU cores are not fully
used.</p>

<p><img src="/assets/20201218.dvf-B1000-T1-start.png" alt="Stats of B1000-T1" /></p>

<p>In the next section, we are going to discuss how to improve the situation again
using multi-threading.</p>

<h2 id="multi-threading">Multi-Threading</h2>

<p>To implement a multi-threading solution, we need to match two criteria:</p>

<ol>
  <li>We need to find a Java class to support the concurrent execution, such as
<code class="language-plaintext highlighter-rouge">Thread</code>, <code class="language-plaintext highlighter-rouge">Runnable</code>, <code class="language-plaintext highlighter-rouge">Future</code> or <code class="language-plaintext highlighter-rouge">CompletableFuture</code>.</li>
  <li>We need to fina a way to control the parallelism, such as using a thread
pool.</li>
</ol>

<p>For the first point, I chose <code class="language-plaintext highlighter-rouge">CompletableFuture</code> because it extends the
interface <code class="language-plaintext highlighter-rouge">Future</code> and it supports multi-stage executions since it extends
<code class="language-plaintext highlighter-rouge">CompletionStage</code> as well. It‚Äôs very similar to promise in the JS world. Using
it facilitates the interaction with a thread pool because most of the methods
contain an asynchronous version using suffix <code class="language-plaintext highlighter-rouge">*Async</code>, such as <code class="language-plaintext highlighter-rouge">thenApplyAsync</code>,
<code class="language-plaintext highlighter-rouge">thenRunAsync</code>, etc. By calling these APIs, the execution of the stage will be
done inside the target executor rather than the current thread.</p>

<p>For the second point, the thread pool, I chose the fixed thread pool because we need a strong
control about the parallelism of the number of threads. We are going to compare the
indexing performance when using 1 thread, 4 threads, 8 threads, and 16 threads
on the client-side. Yes, on the client-side. Please don‚Äôt confuse about the
server-side: here we‚Äôre investigating improvements on the Java High Level REST
client, not the server. Now, I am going to use the API <code class="language-plaintext highlighter-rouge">supplyAsync</code> to wrap
the blocking indexing logic <code class="language-plaintext highlighter-rouge">index(...)</code> into a completable future:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="nf">indexAsync</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">ImmutableTransaction</span><span class="o">&gt;</span> <span class="n">transactions</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">index</span><span class="o">(</span><span class="n">transactions</span><span class="o">),</span> <span class="n">executor</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And on the caller side, the transaction stream is converted into a stream of
futures. Using <code class="language-plaintext highlighter-rouge">CompletableFuture#allOf(...)</code>, we will wait until the completion
of all the futures before considering the current future as complete:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="nf">write</span><span class="o">(</span>
  <span class="nc">Stream</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">ImmutableTransaction</span><span class="o">&gt;&gt;</span> <span class="n">transactions</span><span class="o">)</span> <span class="o">{</span>
  <span class="kt">var</span> <span class="n">cfs</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">indexAsync</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
  <span class="k">return</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="n">cfs</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="nc">CompletableFuture</span><span class="o">[]::</span><span class="k">new</span><span class="o">))</span>
      <span class="o">.</span><span class="na">thenApply</span><span class="o">(...);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The code snippets above sound a bit abstract. All you need to remember is that
we are changing the number of threads to see how it impacts the indexing speed.
We are going to test it against two factors:</p>

<ul>
  <li>Bulk size: 10, 100, 1000</li>
  <li>Parallelism: 1, 4, 8, 16</li>
</ul>

<p>As a reminder, I‚Äôm testing it using two computers: Macbook Pro 13 for the client
and Toshiba KIRA for the server. After testing a few hours, the results are as
follows:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Item</th>
      <th style="text-align: right">Bulk Size</th>
      <th style="text-align: right">Threads</th>
      <th style="text-align: right">Indexing Duration</th>
      <th style="text-align: right">Indexing Speed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">B1-T1</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">(estimated) 3h54m00</td>
      <td style="text-align: right">58.8 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: left">B10-T1</td>
      <td style="text-align: right">10</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">26m49</td>
      <td style="text-align: right">514.1 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: left">B10-T4</td>
      <td style="text-align: right">10</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">8m19</td>
      <td style="text-align: right">1,657.5 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: left">B10-T8</td>
      <td style="text-align: right">10</td>
      <td style="text-align: right">8</td>
      <td style="text-align: right">5m04</td>
      <td style="text-align: right">2,720.7 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: left">B10-T16</td>
      <td style="text-align: right">10</td>
      <td style="text-align: right">16</td>
      <td style="text-align: right">3m58</td>
      <td style="text-align: right">3,475.2 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: left">B100-T1</td>
      <td style="text-align: right">100</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">6m04</td>
      <td style="text-align: right">2,272.3 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: left">B100-T4</td>
      <td style="text-align: right">100</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">2m05</td>
      <td style="text-align: right">6,616.8 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: left">B100-T8</td>
      <td style="text-align: right">100</td>
      <td style="text-align: right">8</td>
      <td style="text-align: right">1m25</td>
      <td style="text-align: right">9,730.6 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: left">B100-T16</td>
      <td style="text-align: right">100</td>
      <td style="text-align: right">16</td>
      <td style="text-align: right">1m21</td>
      <td style="text-align: right">10,211,2 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: left">B1000-T1</td>
      <td style="text-align: right">1,000</td>
      <td style="text-align: right">1</td>
      <td style="text-align: right">3m16</td>
      <td style="text-align: right">4,219.9 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: left">B1000-T4</td>
      <td style="text-align: right">1,000</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">1m31</td>
      <td style="text-align: right">9,089.1 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: left">B1000-T8</td>
      <td style="text-align: right">1,000</td>
      <td style="text-align: right">8</td>
      <td style="text-align: right">1m14</td>
      <td style="text-align: right">11,177.1 docs/s</td>
    </tr>
    <tr>
      <td style="text-align: left">B1000-T16</td>
      <td style="text-align: right">1,000</td>
      <td style="text-align: right">16</td>
      <td style="text-align: right">1m10</td>
      <td style="text-align: right">11,815.8 docs/s</td>
    </tr>
  </tbody>
</table>

<p>If we pivot the table and focus on the indexing duration, we can see them as the
table below. As you can see, when the bulk size increases, the duration
decreases. Same for the number of threads. To make the indexing efficient (less
than 1 min 30), we need to use at least 8 threads and a bulk size equal to or
higher than 100 items per bulk, where 8 threads are twice the amount of logical
processor (4) in my Macbook Pro 13. I believe this is because the tasks are
blocking, they spend lot of time waiting for the response from Elasticsearch and they
are not CPU-intensive.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">Bulk Size</th>
      <th style="text-align: right">1 Thread</th>
      <th style="text-align: right">4 Threads</th>
      <th style="text-align: right">8 Threads</th>
      <th style="text-align: right">16 Threads</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right"><strong>10</strong></td>
      <td style="text-align: right">26m49</td>
      <td style="text-align: right">8m19</td>
      <td style="text-align: right">5m04</td>
      <td style="text-align: right">3m58</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>100</strong></td>
      <td style="text-align: right">6m04</td>
      <td style="text-align: right">2m05</td>
      <td style="text-align: right">1m25</td>
      <td style="text-align: right">1m21</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>1000</strong></td>
      <td style="text-align: right">3m16</td>
      <td style="text-align: right">1m31</td>
      <td style="text-align: right">1m14</td>
      <td style="text-align: right">1m10</td>
    </tr>
  </tbody>
</table>

<p>If we take the fastest case in the table, which is using bulk size 1000 and 16
threads (<code class="language-plaintext highlighter-rouge">B1000-T16</code>), you can see the resource usage as follows. You can see
that the 4 CPU cores are used to 100% and the host received more than 12MB/s. We
can say that in this case, the CPU is fully used compared to previous cases.</p>

<p><img src="/assets/20201218.dvf-B1000-T16-start.png" alt="Stats of B1000-T16" /></p>

<p>Although the indexing speed is amazing in this example, it does not mean that
the settings should be this aggressive if you run an Elasticsearch cluster
yourself. There are factors to be considered, such as search
activity, relocations, and snapshot activity. Searching takes time, especially
the complex queries. Shard relocations take time as well. Relocating a shard
being actively writing can lead to huge
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/index-modules-translog.html">translog</a>.
Snapshot-related actions (creation, restore, ‚Ä¶)  can also increase CPU
usage. There can be other cases, the best solution is to add a monitoring
solution to better observe the cluster.</p>

<h2 id="going-further">Going Further</h2>

<p>How to go further from here?</p>

<ul>
  <li>To better understand the Bulk API in Elasticsearch, visit <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/docs-bulk.html">REST APIs - Bulk API</a></li>
  <li>To better understand the Bulk API in Java High Level REST Client, visit <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-document-bulk.html">Java
High Level REST Client - Bulk API</a></li>
  <li>In this article, we focus on the improvements to the Elasticsearch client. But do
you know that the cluster side settings are even more important? In
Elasticsearch 7, indexing is done using the <code class="language-plaintext highlighter-rouge">write</code> thread pool. To better
understand the different thread pools and their related settings, visit
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/modules-threadpool.html">Thread pools</a>.</li>
  <li>Another way to improve indexing performance is to use multiple shards for
one index. Each Elasticsearch shard is a Lucene index. You can find the shard
definition in the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/glossary.html">Glossary of terms</a>
and visit the page <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x//size-your-shards.html">How to size your shards?</a>
to understand how to size the index correctly.</li>
</ul>

<p>If you are interested in the source code of this article, you can find it on
GitHub in my project
<a href="https://github.com/mincong-h/learning-elasticsearch">mincong-h/learning-elasticsearch</a>
under the folder
<a href="https://github.com/mincong-h/learning-elasticsearch/tree/master/demo-dvf">demo-dvf</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we saw how to optimize the indexing speed in Elasticsearch by
going through three steps: prepare the iterator for bulk processing; use bulk
request rather than individual index requests; use completable future and
executor to make the execution in parallel. Then we compared the performance
by adjusting the bulk size and the number of threads. We saw that having a bulk
size of 100+ and using multiple threads increase significantly the performance.
We were able to increase the indexing speed from 58.8 docs/s to 11,815.8 docs/s
which is 200 times of improvement and reduced the indexing duration by 99.6%.
Interested to know more? You can subscribe to <a href="/feed.xml">the feed of my blog</a>, follow me
on <a href="https://twitter.com/mincong_h">Twitter</a> or
<a href="https://github.com/mincong-h/">GitHub</a>. Hope you enjoy this article, see you the next time!</p>

<h2 id="references">References</h2>

<ul>
  <li>Elasticsearch, ‚ÄúJava High Level REST Client - Bulk API‚Äù, 2020.
<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high</a></li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2020-12-17T15:08:30+01:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">Subscribe</a>
</div></div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/2020/12/16/dvf-indexing/">DVF: Indexing New Documents</a></div><div class="next"><span>NEXT</span><a href="/2020/12/25/dvf-storage-optimization/">DVF: Storage Optimization</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/2020/12/17/dvf-indexing-optimization/';
    this.page.identifier = '/2020/12/17/dvf-indexing-optimization';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>¬© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ‚¨Ö, 38  ‚¨Ü, 39  ‚û°, 40  ‚¨á
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

