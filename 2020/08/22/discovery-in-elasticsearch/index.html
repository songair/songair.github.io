<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Discovery in Elasticsearch - Mincong Huang</title>

<meta name="description" content="How does discovery work in Elasticsearch? This article explains different mechanisms of discovery, the key settings, fault detection, related logs, and more.">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Discovery in Elasticsearch | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Discovery in Elasticsearch" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="en" />
<meta name="description" content="How does discovery work in Elasticsearch? This article explains different mechanisms of discovery, the key settings, fault detection, related logs, and more." />
<meta property="og:description" content="How does discovery work in Elasticsearch? This article explains different mechanisms of discovery, the key settings, fault detection, related logs, and more." />
<link rel="canonical" href="https://mincong.io/2020/08/22/discovery-in-elasticsearch/" />
<meta property="og:url" content="https://mincong.io/2020/08/22/discovery-in-elasticsearch/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-tim-graf-ErO0E8wZaTA-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-22T18:38:54+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-tim-graf-ErO0E8wZaTA-unsplash.jpg" />
<meta property="twitter:title" content="Discovery in Elasticsearch" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/2020/08/22/discovery-in-elasticsearch/"},"author":{"@type":"Person","name":"Mincong Huang"},"image":"https://mincong.io/assets/bg-tim-graf-ErO0E8wZaTA-unsplash.jpg","description":"How does discovery work in Elasticsearch? This article explains different mechanisms of discovery, the key settings, fault detection, related logs, and more.","@type":"BlogPosting","url":"https://mincong.io/2020/08/22/discovery-in-elasticsearch/","headline":"Discovery in Elasticsearch","dateModified":"2020-08-22T18:38:54+02:00","datePublished":"2020-08-22T18:38:54+02:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="853"/>
<meta property="og:image:height" content="1280"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/2020/08/22/discovery-in-elasticsearch/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>

          

          
          
          

          
          
          

          
          

          
          

          <a href="/">Mincong Huang</a>
        </div><button class="button button--secondary button--circle search-button js-search-toggle">
            <i class="fas fa-search"></i>
          </button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/en/categories/">Categories</a></li><li class="navigation__item"><a href="/en/series/">Series</a></li><li class="navigation__item"><a href="/en/archive/">Archive</a></li><li class="navigation__item"><a href="/en/about/">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li><li>
            <a href="/cn/">
             <img src="/assets/flag-CN.png"
                  alt=""
                  class="naviation__lang_img">
            </a>
          </li>
        </ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/assets/bg-tim-graf-ErO0E8wZaTA-unsplash.jpg);background-color:#203028;"><div class="hero__content"><div class ="main"><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=elasticsearch">elasticsearch</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Aug 22, 2020</span>
            </li></ul></div><div class="article__header"><header><h1>Discovery in Elasticsearch</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">How does discovery work in Elasticsearch? This article explains different mechanisms of discovery, the key settings, fault detection, related logs, and more.</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      
      Photo by
      <a href="https://unsplash.com/@timgraf99" target="_blank">Tim Graf</a>
      
      on
      <a href="https://unsplash.com/license" target="_blank">Unplash </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><meta itemprop="headline" content="Discovery in Elasticsearch"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2020-08-22T18:38:54+02:00">
    <meta itemprop="keywords" content="elasticsearch"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h2 id="introduction">Introduction</h2>

<p>Discovery is an important topic when running an Elasticsearch cluster on
production. Discovering nodes within the cluster or running a master election,
these are the two main tasks of the discovery module. The goal of this article
is to share the basic concepts about the discovery in Elasticsearch 6 so that you
can better configure your cluster or better handle operations about it.</p>

<p>After reading this article, you will understand:</p>

<ul>
  <li>The different mechanisms of discovery</li>
  <li>Key settings about discovery</li>
  <li>Fault detection</li>
  <li>Logs about discovery</li>
  <li>Discovery in Elasticsearch 7</li>
  <li>How to go further on this topic?</li>
</ul>

<p>Note that this article is mainly focused on Elasticsearch 6. If you need to know
about the discovery in Elasticsearch 7, please jump to the “Discovery in
Elasticsearch 7” section or read the official documentation of Elasticsearch
directly. Now, let’s get started!</p>

<h2 id="multicast-discovery"><del>Multicast Discovery</del></h2>

<p>Multicast discovery does not exist anymore. It was only available as a plugin
from Elasticsearch 2.0 onwards, and that plugin was removed in Elasticsearch
5.0, according to Clinton Gormley on <a href="https://github.com/elastic/elasticsearch/issues/18686#issuecomment-223078307">this comment</a>.</p>

<h2 id="unicast-discovery">Unicast Discovery</h2>

<p>Unicast discovery configures a static list of hosts for use as seed nodes. These hosts can be specified as hostnames or IP addresses; hosts specified as hostnames are resolved to IP addresses during each round of pinging.
Here is an example of a unicast configuration inside the Elasticsearch configuration file
(<code class="language-plaintext highlighter-rouge">elasticsearch.yml</code>):</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">discovery.zen.ping.unicast.hosts</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">10.0.0.3:9300"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">10.0.0.4:9300"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">10.0.0.5:9300"</span><span class="pi">]</span>
</code></pre></div></div>

<blockquote>
  <p>But what is the location of <code class="language-plaintext highlighter-rouge">elasticsearch.yml</code>? If you’re using the Elasticsearch
Docker image, the default absolute path of the configuration file is
/usr/share/elasticsearch/config/elasticsearch.yml
(<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html#docker-config-bind-mount">reference</a>).
You can also check directory <code class="language-plaintext highlighter-rouge">$ES_HOME/config/</code> or <code class="language-plaintext highlighter-rouge">$ES_PATH_CONF</code> as
mentioned in “Configuring Elasticsearch”
(<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/settings.html">6.8</a>).</p>
</blockquote>

<p>Not all of the Elasticsearch nodes in the cluster need to be present in the
unicast list to discover all the nodes, but enough addresses should be
configured for each node to know about an available gossip node.</p>

<h2 id="file-based-discovery">File-based Discovery</h2>

<p>In addition to hosts provided by the setting <code class="language-plaintext highlighter-rouge">discovery.zen.ping.unicast.hosts</code>,
you can provide a list of hosts via an external file. Elasticsearch can detect
changes on this file and reload it so that the list of seed hosts can be
changed dynamically without needing to restart a node. To enable the filed-based
discovery, configure the <code class="language-plaintext highlighter-rouge">file</code> hosts provider as:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">discovery.zen.hosts_provider</span><span class="pi">:</span> <span class="s">file</span>
</code></pre></div></div>

<p>Then, you need to create a new file under the configuration directory of
Elasticsearch as <code class="language-plaintext highlighter-rouge">$ES_PATH_CONF/unicast_hosts.txt</code> as the format below.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.0.0.6:9300
10.0.0.7:9300
</code></pre></div></div>

<p>Combined with the values defined by <code class="language-plaintext highlighter-rouge">discovery.zen.ping.unicast.hosts</code> in the
previous section, the
final list of seed hosts will be <code class="language-plaintext highlighter-rouge">10.0.0.{2,3,4,5,6,7}:9300</code> because both the
values defined by the unicast and defined by the file <code class="language-plaintext highlighter-rouge">unicast_hosts.txt</code> are
used. For more detail, you can see the “File-based” section of <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/modules-discovery-zen.html">Zen Discovery
(6.8)</a>.</p>

<h2 id="discovery-settings">Discovery Settings</h2>

<p>In Elasticsearch 6, there are two important settings for discovery, they should be configured before going to production:</p>

<ul>
  <li>discovery.zen.ping.unicast.hosts</li>
  <li>discovery.zen.minimum_master_nodes</li>
</ul>

<p>Let’s go into more detail about these settings.</p>

<h3 id="discoveryzenpingunicasthosts">discovery.zen.ping.unicast.hosts</h3>

<p>This setting defines a static list of hosts for use as seed nodes for Zen
discovery. These hosts can be specified as hostnames or IP addresses; hosts
specified as hostnames are resolved to IP addresses during each round of
pinging. Each value should be in the form of <code class="language-plaintext highlighter-rouge">host:port</code> or <code class="language-plaintext highlighter-rouge">host</code>. In other
words, the port of the host is optional. If empty, the <code class="language-plaintext highlighter-rouge">port</code> defaults to the
setting <code class="language-plaintext highlighter-rouge">transport.profiles.default.port</code> falling back to <code class="language-plaintext highlighter-rouge">transport.port</code> if
not set. A hostname that resolves to multiple IP addresses will try all resolved
addresses. You can also provide IPv6 addresses. Additionally, the
<code class="language-plaintext highlighter-rouge">discovery.zen.ping.unicast.resolve_timeout</code> configures the amount of time to wait for DNS lookups on each round of pinging. This is specified as a time unit and defaults to 5s.</p>

<h3 id="discoveryzenminimum_master_nodes">discovery.zen.minimum_master_nodes</h3>

<p>This setting defines the minimum of master-eligible nodes to form a cluster. It
is essential to form a cluster correctly and prevent data loss. Without this
setting, the cluster may suffer from split-brain issues. A split-brain scenario is when a subset of your cluster (one or more nodes) loses communication to the master node and forms a new cluster. It means that two different Elasticsearch clusters are running independently of each other. To prevent this from happening, set the minimum of master nodes as half of the master-eligible nodes plus one, i.e the minimum value to be majority:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(master_eligible_nodes / 2) + 1
</code></pre></div></div>

<p>For example, if you have 3 master-eligible nodes, set the minimum of master nodes as 2 because “(3 / 2) + 1 = 2”.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">discovery.zen.minimum_master_nodes</span><span class="pi">:</span> <span class="m">2</span>
</code></pre></div></div>

<h2 id="fault-detection">Fault Detection</h2>

<p>Fault detection ensures that master node and other nodes are connected and
healthy so that a master election or a node removal does not need to be held. On
one side, the elected master periodically checks the connectivity and health of each
of the nodes in the cluster; on the other side, each node in the cluster checks
the health of the elected master. These checks are known as “follower checks” and
“leader checks”. Elasticsearch allows these checks to occasionally fail or timeout. It considers
a node to be faulty only after several consecutive checks have failed. Here
are the settings to configure to fault detection (<code class="language-plaintext highlighter-rouge">fd</code>):</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Setting</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">discovery.zen.fd.ping_interval</code></td>
      <td style="text-align: left">How often a node gets pinged. Defaults to <code class="language-plaintext highlighter-rouge">1s</code>.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">discovery.zen.fd.ping_timeout</code></td>
      <td style="text-align: left">How long to wait for a ping response, defaults to <code class="language-plaintext highlighter-rouge">30s</code>.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">discovery.zen.fd.ping_retries</code></td>
      <td style="text-align: left">How many ping failures/timeouts cause a node to be considered failed. Defaults to <code class="language-plaintext highlighter-rouge">3</code>.</td>
    </tr>
  </tbody>
</table>

<p>For more detail, check the Elasticsearch official document “Cluster fault detection”
(<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/cluster-fault-detection.html">7.9</a>).</p>

<h2 id="logs">Logs</h2>

<p>Here are some logs related to Zen Discovery that may help you to identify the
problem of your cluster.</p>

<h3 id="not-enough-master-nodes-discovery-during-pinging">Not enough master nodes discovery during pinging</h3>

<blockquote>
  <p>WARN: not enough master nodes discovered during pinging (found […], but need [2]),
pinging again</p>
</blockquote>

<p>There aren’t enough master nodes discovered during pinging. Only N
master-eligible nodes were found but the minimum required nodes are 2. The nodes
found are described in the list above <code class="language-plaintext highlighter-rouge">[...]</code>. It happens probably because one
or more master eligible-nodes were disconnected from the network or shutdown.
Therefore, the <code class="language-plaintext highlighter-rouge">discovery.zen.minimum_master_nodes</code> setting is not satisfied. A master
election cannot happen because there are not enough master to elect from.
This is a critical error and prevents the cluster to be fully operational. According
to documentation <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/modules-discovery-zen.html#no-master-block">“Zen Discovery &gt; no master block
(6.8)”</a>,
when it happens, by default, the write operations will be rejected. Read
operations will succeed, based on the last know cluster configuration. If the
setting of <code class="language-plaintext highlighter-rouge">discovery.zen.no_master_block</code> is not the default option (<code class="language-plaintext highlighter-rouge">write</code>)
but option <code class="language-plaintext highlighter-rouge">all</code>, then both read and write operations will be rejected.</p>

<p><a href="https://github.com/elastic/elasticsearch/blob/v6.8.12/server/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java#L954-L955">Source
code in Elasticsearch
6.8</a>.</p>

<h3 id="master-left">Master left</h3>

<blockquote>
  <p>WARN: master left (reason = failed to ping, tried [3] times, each with maximum [30s]
timeout), current nodes: …</p>
</blockquote>

<p>This is part of the fault detection as “leader checks”.
A node failed to ping master node after 3 times, each with a maximum 30s timeout,
so it considers master node is left and decides the join another master.
Before doing so, the list of current nodes is logged to record the current
situation. The list of nodes is retrieved from the cluster state.
This can happen when heavy network issues happen or the master node is
disconnected/stopped.</p>

<p><a href="https://github.com/elastic/elasticsearch/blob/v6.8.12/server/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java#L993">Source code in Elasticsearch 6.8</a>.</p>

<h3 id="other-logs">Other Logs</h3>

<p>I only documented some of the logs here, if you need more, you can find them from
<a href="https://github.com/elastic/elasticsearch/blob/v6.8.12/server/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java">ZenDiscovery.java</a>
or the Zen module
(<a href="https://github.com/elastic/elasticsearch/tree/v6.8.12/server/src/main/java/org/elasticsearch/discovery/zen">org.elasticsearch.discovery.zen</a>)
in general. If you have a service collecting logs for you, you find search logs
related to logger <code class="language-plaintext highlighter-rouge">ZenDiscovery</code> to find them out.</p>

<h2 id="discovery-in-elasticsearch-7">Discovery in Elasticsearch 7</h2>

<p>The implementation of discovery is rewritten in Elasticsearch 7 as Zen2. Philipp
Krenn has an excellent video about this topic. You can see his talk <em>“Reaching
Zen in ElasticSearch’s Coordination”</em> (2019) on YouTube:</p>

<iframe width="100%" height="315" src="https://www.youtube-nocookie.com/embed/Ns1Erg4I92U" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>This talk shows the main improvements of the new implementation: Master
elections are much faster, the infamous <code class="language-plaintext highlighter-rouge">minimum_master_nodes</code> setting has been
removed, growing and shrinking clusters becomes safer and easier, and leaves
less room to misconfigure the system. If you need more information about how
discovery works on Elasticsearch 7, you can also reach the official
documentation
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-hosts-providers.html">Discovery</a>
of Elasticsearch.</p>

<h2 id="plugins">Plugins</h2>

<p>Other plugins exist for discovery:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Plugin</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Azure Classic Discovery Plugin (<a href="https://www.elastic.co/guide/en/elasticsearch/plugins/6.8/discovery-azure-classic.html">6.8</a>)</td>
      <td style="text-align: left">(Deprecated in 5.0.0) This plugin uses the Azure Classic API for unicast discovery. The development of its replacement Azure ARM Discovery Plugin was discontinued (<a href="https://github.com/elastic/elasticsearch/issues/19146">Issue #19146</a>).</td>
    </tr>
    <tr>
      <td style="text-align: left">Google Compute Engine Discovery Plugin (<a href="https://www.elastic.co/guide/en/elasticsearch/plugins/6.8/discovery-gce.html">6.8</a>)</td>
      <td style="text-align: left">This plugin uses the GCE API for unicast discovery.</td>
    </tr>
    <tr>
      <td style="text-align: left">EC2 Discovery Plugin (<a href="https://www.elastic.co/guide/en/elasticsearch/plugins/6.8/discovery.html">6.8</a>)</td>
      <td style="text-align: left">This plugin uses the AWS API for unicast discovery.</td>
    </tr>
  </tbody>
</table>

<h2 id="going-further">Going Further</h2>

<p>How to go further from here?</p>

<ul>
  <li>To better understand Zen Discovery, read the official documentation of Zen
Discovery on Elasticsearch 6.8.
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/modules-discovery-zen.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.8/modules-discovery-zen.html</a></li>
  <li>To better understand the implementation of Zen Discovery, read the source code
of <a href="https://github.com/elastic/elasticsearch/blob/v6.8.12/server/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java">ZenDiscovery.java (6.8)</a>
on GitHub and other classes in the same package.</li>
  <li>To better understand discovery and cluster formation, see the official
documentation of “Discovery and cluster formation” on Elasticsearch 7.9.
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-discovery.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-discovery.html</a></li>
  <li>To see the full list of log errors related to this Elasticsearch discovery,
see Opster’s article: Elasticsearch Discovery.
<a href="https://opster.com/elasticsearch-glossary/elasticsearch-discovery/">https://opster.com/elasticsearch-glossary/elasticsearch-discovery/</a></li>
  <li>To learn more about Elasticsearch, I highly recommend the book “Elasticesarch
in Action” written by Radu Gheorghe, Matthew Lee Hinman, and Roy Russo.
<a href="https://www.manning.com/books/elasticsearch-in-action">https://www.manning.com/books/elasticsearch-in-action</a></li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we saw different types of discovery: unicast discovery,
file-based discovery, plugin-based discovery; we saw the two most important
settings for unicast discovery for the list of seed hosts and the minimum number
of master-eligible nodes; we took a look about fault detection in Elasticsearch
using pings; we saw some logs related to zen discovery; we also the changes
about the discovery in Elasticsearch 7. Finally, I shared some resources which
allow you to go further on this topic.
Interested to know more? You can subscribe to <a href="/feed.xml">the feed of my blog</a>, follow me
on <a href="https://twitter.com/mincong_h">Twitter</a> or
<a href="https://github.com/mincong-h/">GitHub</a>. Hope you enjoy this article, see you the next time!</p>

<h2 id="references">References</h2>

<ul>
  <li>Radu Gheorghe, Matthew Lee Hinman, Roy Russo, “Elasticsearch in Action”,
<em>Manning</em>, 2016. [book]</li>
  <li>Opster, “Elasticsearch Discovery”, <em>Opster</em>, 2020.<br />
<a href="https://opster.com/elasticsearch-glossary/elasticsearch-discovery/">https://opster.com/elasticsearch-glossary/elasticsearch-discovery/</a></li>
  <li>Philipp Krenn, “Reaching Zen in Elasticsearch’s Coordination”, <em>Berlin
Buzzwords</em>, 2019.<br />
<a href="https://www.youtube.com/watch?v=Ns1Erg4I92U">https://www.youtube.com/watch?v=Ns1Erg4I92U</a></li>
  <li>Elasticsearch, “Install Elasticsearch with Docker”, <em>Elasticsearch</em>,
2020.<br />
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html</a></li>
  <li>Elasticsearch, “Configuring Elasticsearch”, <em>Elasticsearch</em>,
2020.<br />
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html</a></li>
  <li>Elasticsearch, “Zen Discovery”, <em>Elasticsearch</em>,
2020.<br />
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/modules-discovery-zen.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.8/modules-discovery-zen.html</a></li>
  <li>Elasticsearch, “Cluster fault detection”, <em>Elasticsearch</em>, 2020.<br />
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/cluster-fault-detection.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.9/cluster-fault-detection.html</a></li>
  <li>Clinton Gormley, Answer of Issue “Elasticsearch 5.0 (5.0.0-alpha2) Disable
multicast - unknown setting error”, <em>GitHub</em>, 2016.<br />
<a href="https://github.com/elastic/elasticsearch/issues/18686">https://github.com/elastic/elasticsearch/issues/18686</a></li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2020-08-22T18:38:54+02:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">Subscribe</a>
</div></div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/2020/07/26/es-client-completablefuture/">Wrap Elasticsearch Response Into CompletableFuture</a></div><div class="next"><span>NEXT</span><a href="/2020/08/30/gc-in-elasticsearch/">GC in Elasticsearch</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/2020/08/22/discovery-in-elasticsearch/';
    this.page.identifier = '/2020/08/22/discovery-in-elasticsearch';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

