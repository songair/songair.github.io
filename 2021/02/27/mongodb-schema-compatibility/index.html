<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><!--
	_title: Making Backward-Compatible Schema Changes in MongoDB;
        _titles: ;
        __return: Making Backward-Compatible Schema Changes in MongoDB;
 -->
<!-- title: "Making Backward-Compatible Schema Changes in MongoDB" -->
<title>Making Backward-Compatible Schema Changes in MongoDB - Mincong Huang</title>

<meta name="description" content="How to add or remove a field from a Mongo collection without breaking the production?">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Making Backward-Compatible Schema Changes in MongoDB | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Making Backward-Compatible Schema Changes in MongoDB" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="en" />
<meta name="description" content="How to add or remove a field from a Mongo collection without breaking the production?" />
<meta property="og:description" content="How to add or remove a field from a Mongo collection without breaking the production?" />
<link rel="canonical" href="https://mincong.io/2021/02/27/mongodb-schema-compatibility/" />
<meta property="og:url" content="https://mincong.io/2021/02/27/mongodb-schema-compatibility/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-bence-sandor-sztrecska-wIs-mjKMiw4-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-27T17:07:27+01:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-bence-sandor-sztrecska-wIs-mjKMiw4-unsplash.jpg" />
<meta property="twitter:title" content="Making Backward-Compatible Schema Changes in MongoDB" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"image":"https://mincong.io/assets/bg-bence-sandor-sztrecska-wIs-mjKMiw4-unsplash.jpg","headline":"Making Backward-Compatible Schema Changes in MongoDB","description":"How to add or remove a field from a Mongo collection without breaking the production?","datePublished":"2021-02-27T17:07:27+01:00","dateModified":"2021-02-27T17:07:27+01:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/2021/02/27/mongodb-schema-compatibility/"},"url":"https://mincong.io/2021/02/27/mongodb-schema-compatibility/","author":{"@type":"Person","name":"Mincong Huang"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="1600"/>
<meta property="og:image:height" content="2400"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/2021/02/27/mongodb-schema-compatibility/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>

          

          
          
          

          
          
          

          
          

          
          

          <a href="/">Home</a>
        </div><button class="button button--secondary button--circle search-button js-search-toggle">
            <i class="fas fa-search"></i>
          </button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/en/categories/">Categories</a></li><li class="navigation__item"><a href="/en/series/">Series</a></li><li class="navigation__item"><a href="/en/archive/">Archive</a></li><li class="navigation__item"><a href="/en/about/">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li><li>
            <a href="/cn/">
             <img src="/assets/flag-CN.png"
                  alt=""
                  class="naviation__lang_img">
            </a>
          </li>
        </ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .3), rgba(0, 0, 0, .2)),url(/assets/bg-bence-sandor-sztrecska-wIs-mjKMiw4-unsplash.jpg);background-color:#203028;"><div class="hero__content"><div class ="main">

  
  <div class="article__info clearfix">
      <ul class="left-col menu">
        <li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=java">java</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=mongodb">mongodb</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=serialization">serialization</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=jackson">jackson</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=reliability">reliability</a>
            </li>

        <li class="separator">|</li>
          
            <li>
              <a class="button button--circle button--primary focus lang"
                 href="/2021/02/27/mongodb-schema-compatibility/"><span>EN</span></a>

              






              

              
                <a class="button button--circle button--secondary lang"
                   href="/cn/mongodb-schema-compatibility/"><span>CN</span></a>
              
            </li>
          
        
      </ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Feb 27, 2021</span>
            </li></ul></div><!--
	_title: Making Backward-Compatible Schema Changes in MongoDB;
        _titles: ;
        __return: Making Backward-Compatible Schema Changes in MongoDB;
 -->
<div class="article__header"><header><h1>Making Backward-Compatible Schema Changes in MongoDB</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">How to add or remove a field from a Mongo collection without breaking the production?</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      
      Photo by
      <a href="https://unsplash.com/@arpheus" target="_blank">Bence Sandor Sztrecska</a>
      
      on
      <a href="https://unsplash.com/license" target="_blank">Unplash </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><!--
	_title: Making Backward-Compatible Schema Changes in MongoDB;
        _titles: ;
        __return: Making Backward-Compatible Schema Changes in MongoDB;
 -->
<meta itemprop="headline" content="Making Backward-Compatible Schema Changes in MongoDB"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2021-02-27T17:07:27+01:00">
    <meta itemprop="keywords" content="java,mongodb,serialization,jackson,reliability"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h2 id="introduction">Introduction</h2>

<p>Changing the schema of a Mongo collection is a common request for developers. We
need this when the business evolves: we need to add new fields or remove
existing fields from a target Mongo collection to better support different
use-cases. Nevertheless, this is a risky operation, it may trigger an incident or
outage when this is not handled correctly. In this article, we are going to what
can go wrong, how to change the schema safely, and how to investigate
if things go wrong. This article assumes that you are familiar with the basic
concepts of MongoDB and uses <a href="https://github.com/FasterXML/jackson-databind">Jackson</a> as the serialization framework for your
Java application.</p>

<p>After reading this article, you will understand:</p>

<ul>
  <li>Potential risks when adding a new field</li>
  <li>Filling missing data with a default value</li>
  <li>Writing unit tests</li>
  <li>Migrating existing documents</li>
  <li>Preparing the worst case: how to revert changes</li>
  <li>Incident: how to mitigate using Mongo queries?</li>
  <li>How to go further from here?</li>
</ul>

<p>This article is written with MongoDB 4.2, Jackson 2.12, and Java 11. But the
concepts are not tight to these versions and should be valid for older versions.
Now, let’s get started!</p>

<h2 id="potential-risks">Potential Risks</h2>

<p><em>What can go wrong when adding a new field?</em></p>

<p>If a new field is added in the Java class without changing the existing
documents in MongoDB, the deserialization can be completely broken. This is
because the new field required by the Java class does not exist for those
documents. Deserializing them can trigger an <code class="language-plaintext highlighter-rouge">UnrecognizedPropertyException</code> by
Jackson Object Mapper.</p>

<p>Here is an example called <code class="language-plaintext highlighter-rouge">OrderV1</code>. The 1st version of the order contains
3 fields: the object ID in MongoDB, the customer ID, and the amount of this
order. Recently, the product owner wants the possibility to cancel an order, so
we need a new field “isCanceled” to support this use-case as <code class="language-plaintext highlighter-rouge">OrderV2</code>. Also,
the product owner wants us to add an operator to keep track of the person who
handles the order. The changes look pretty simple:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">-public class OrderV1 {
</span><span class="gi">+public class OrderV2 {
</span>
   @JsonProperty("_id")
   private final String id;

   @JsonProperty("customerId")
   private final String customerId;

   @JsonProperty("amount")
   private final double amount;

+  @JsonProperty("isCanceled")
<span class="gi">+  private final boolean isCanceled;
</span>
+  @JsonProperty("operator")
<span class="gi">+  private final String operator;
</span>
   ...
 }
</code></pre></div></div>

<p>But you will see that there are some major risks here.</p>

<h3 id="nullpointerexception">NullPointerException</h3>

<p>Without changing existing documents in MongoDB, the deserialization of the new fields may
be set to <code class="language-plaintext highlighter-rouge">null</code>. This is the case for the new field <code class="language-plaintext highlighter-rouge">operator</code>. This is because
the field <code class="language-plaintext highlighter-rouge">operator</code> does not exist for those Mongo documents. In Java, having a
field with a <code class="language-plaintext highlighter-rouge">null</code>
value can trigger <code class="language-plaintext highlighter-rouge">NullPointerException</code> and break your application. You need to
either handle the <code class="language-plaintext highlighter-rouge">null</code> case in your Java code; or perform data migration in
Mongo, i.e. adding the missing fields for your existing documents. We will talk
about these tricks in detail in the following sections.</p>

<h3 id="impossible-to-rollback">Impossible To Rollback</h3>

<p>Another risk is about reverting the changes. Without additional configuration in
the Jackson object mapper or your value class, you may not be able to roll back
your changes once they are deployed to production. Once the Java changes are reverted,
the deserialization of the new documents from MongoDB to Java will fail with the
following exception:</p>

<blockquote>
  <p>“java.io.UncheckedIOException:
com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException: Unrecognized field
“isCanceled” (class io.mincong.mongodb.model_changes.OrderV1), not marked as ignorable (3
known properties: “amount”, “customerId”, “_id”]) at [Source: (String)”{“_id”: “2”,
“customerId”: “Customer2”, “amount”: 200.0, “isCanceled”: true, “operator”:
“emea@example.com”, “productIds”: [“A”, “B”, “C”]}”; line: 1, column: 77] (through reference
chain: io.mincong.mongodb.model_changes.OrderV1[“isCanceled”])”</p>
</blockquote>

<p>This is because new documents have the field “isCanceled” but the old value
class <code class="language-plaintext highlighter-rouge">OrderV1</code> does not know how to deserialize it! This is so dangerous, we
rolled back, but the production is on fire, exceptions are everywhere. But how to avoid this from
happening? We will discuss it in detail in the “Preparing For Rollback” section.</p>

<p>Now we have a better understanding of how adding new fields may impact our
production, it’s time to see how to improve the situation using different
techniques.</p>

<h2 id="filling-missing-data">Filling Missing Data</h2>

<p>To prevent <code class="language-plaintext highlighter-rouge">NullPointerException</code>, we can fill the missing data in Java by
providing a default value. There are 4 ways to do that:</p>

<ul>
  <li>Use Java language feature</li>
  <li>Fill null in the constructor</li>
  <li>Fill null in the getter</li>
  <li>Use Jackson module</li>
</ul>

<h3 id="using-java-language-feature">Using Java Language Feature</h3>

<p>When declaring a class attribute as primitive, Jackson chooses a default value
for you. For <code class="language-plaintext highlighter-rouge">boolean</code>, it defaults to <code class="language-plaintext highlighter-rouge">false</code>; for <code class="language-plaintext highlighter-rouge">integer</code>, it defaults to 0;
for <code class="language-plaintext highlighter-rouge">double</code>, it defaults to 0.0; …
Therefore, you can rely on this technique to avoid having a <code class="language-plaintext highlighter-rouge">null</code> field in your
Java application. For example, to express whether an order is canceled, we
can use the field <code class="language-plaintext highlighter-rouge">isCanceled</code> which is a primitive type <code class="language-plaintext highlighter-rouge">boolean</code>. When the field
does not exist in Mongo document, it defaults to <code class="language-plaintext highlighter-rouge">false</code>, which means the order
is valid, not canceled.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderV2</span> <span class="o">{</span>

  <span class="cm">/**
   * This is a new boolean field.
   *
   * &lt;p&gt;For existing documents which do not contain this field, the
   * deserialization defaults to `false`.
   */</span>
  <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"isCanceled"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isCanceled</span><span class="o">;</span>

  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>However, be careful when choosing the adjective used for the new information. You
should ensure that <code class="language-plaintext highlighter-rouge">false</code> has the correct meaning for documents missing that
field. For example, if you are adding a field to represent the visibility of
an object, you have two choices: <code class="language-plaintext highlighter-rouge">isHidden</code> or <code class="language-plaintext highlighter-rouge">isVisible</code>, which one should
you use? You should probably choose the adjective
<code class="language-plaintext highlighter-rouge">isHidden</code> rather than <code class="language-plaintext highlighter-rouge">isVisible</code> because, for existing Mongo
documents, they don’t have the field for visibility. In this case:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">isHidden</code> defaults to false (visible) when the field does not exist</li>
  <li><code class="language-plaintext highlighter-rouge">isVisible</code> defaults to false (hidden) when the field does not exist. This is
NOT what we need: we want to default to visible, not hidden.</li>
</ul>

<p>So <code class="language-plaintext highlighter-rouge">isHidden</code> is a better choice here.</p>

<h3 id="filling-null-in-constructor">Filling Null In Constructor</h3>

<p>Another way is to handle to <code class="language-plaintext highlighter-rouge">null</code> in the constructor of the value class.
Therefore, when the deserialization happens, Jackson uses the constructor as the
JSON creator to create the Java instance, and the null case will be handled
properly.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderV2</span> <span class="o">{</span>

  <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"operator"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">operator</span><span class="o">;</span>

  <span class="o">...</span>

  <span class="nd">@JsonCreator</span>
  <span class="kd">public</span> <span class="nf">OrderV2</span><span class="o">(</span>
      <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"_id"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">id</span><span class="o">,</span>
      <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"customerId"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">customerId</span><span class="o">,</span>
      <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"amount"</span><span class="o">)</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">,</span>
      <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"isCanceled"</span><span class="o">)</span> <span class="kt">boolean</span> <span class="n">isCancelled</span><span class="o">,</span>
      <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"operator"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">operator</span><span class="o">,</span>
      <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"productIds"</span><span class="o">)</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">productIds</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">operator</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">operator</span> <span class="o">=</span> <span class="s">"support@example.com"</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">operator</span> <span class="o">=</span> <span class="n">operator</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Let’s take a real example. Given a document in Mongo collection without the new
field <code class="language-plaintext highlighter-rouge">operator</code>:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"customerId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Customer1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"amount"</span><span class="p">:</span><span class="w"> </span><span class="mf">100.0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Then during the deserialization, this is considered as <code class="language-plaintext highlighter-rouge">null</code> by Jackson, but
then fall back to “support@example.com” in the constructor:</p>

<p><img src="/assets/20210227-handle-null-in-constructor.png" alt="Handle null in constructor" /></p>

<p>Therefore, the <code class="language-plaintext highlighter-rouge">null</code> case is handled successfully.</p>

<h3 id="filling-null-in-getter">Filling Null In Getter</h3>

<p>In a similar approach, you can also handle null in the getter method.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderV2</span> <span class="o">{</span>

  <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"operator"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">operator</span><span class="o">;</span>

  <span class="o">...</span>

  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getOperator</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">operator</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">"support@example.com"</span> <span class="o">:</span> <span class="n">operator</span><span class="o">;</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="jackson-jdk8module">Jackson Jdk8Module</h3>

<p>Another solution is to use <code class="language-plaintext highlighter-rouge">Optional</code>, combined with Jackson module <code class="language-plaintext highlighter-rouge">Jdk8Module</code> to
serialize and deserialize it correctly. You can visit GitHub project
<a href="https://github.com/FasterXML/jackson-modules-java8">https://github.com/FasterXML/jackson-modules-java8</a> or read the article <a href="https://www.baeldung.com/jackson-optional">“Using
Optional with Jackson”</a> in Baeldung
to learn more about it.</p>

<h2 id="writing-unit-tests">Writing Unit Tests</h2>

<p>To better simulate the changes, you can write some unit tests to test different
behavior. I am not recommending you to write tests to cover all the cases, that
will be very time-consuming. I am just trying to share different testing
techniques to demonstrate that it is possible to assert in some way.</p>

<h3 id="testing-reciprocity">Testing Reciprocity</h3>

<p>One possible test is to ensure that you can serialize a document into MongoDB,
deserialize it back in Java, and the restored Java instance is equal to the
original one.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Java             MongoDB
---              ---
orignal   -----&gt; Mongo document
restored &lt;-----
</code></pre></div></div>

<p>Something like:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Given</span>
<span class="kt">var</span> <span class="n">result</span> <span class="o">=</span> <span class="n">orderCollection</span><span class="o">.</span><span class="na">insertOne</span><span class="o">(</span><span class="n">order1</span><span class="o">);</span>

<span class="c1">// When</span>
<span class="kt">var</span> <span class="n">results</span> <span class="o">=</span> <span class="n">orderCollection</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Filters</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">"customerId"</span><span class="o">,</span> <span class="s">"BigCorp"</span><span class="o">));</span>

<span class="c1">// Then</span>
<span class="n">assertThat</span><span class="o">(</span><span class="n">results</span><span class="o">).</span><span class="na">containsExactly</span><span class="o">(</span><span class="n">order1</span><span class="o">);</span>
</code></pre></div></div>

<h3 id="testing-backward-compatibility">Testing Backward-Compatibility</h3>

<p>Another possible test is to test that deserializing an old Mongo document into
Java using the new schema (new Java class) will work as expected.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Java             MongoDB
---              ---
BSON      -----&gt; Mongo document
restored &lt;-----
</code></pre></div></div>

<p>Because your Java class is changed (added new fields), you cannot use it to create the same
structure as it was before. To simulate the existing Mongo documents, you can
create a Mongo document using <code class="language-plaintext highlighter-rouge">org.bson.Document</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Document</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"{ \"_id\": \"1\", \"customerId\": \"Customer1\", \"amount\": 100.0 }"</span><span class="o">);</span>
</code></pre></div></div>

<p>In the example, we created a BSON document without the new field <code class="language-plaintext highlighter-rouge">isCanceled</code>
in the test. It simulates the existing Mongo documents created before the schema
change. It allows us to assert the
deserialization and ensure that the restored document contains the values that
we expect.</p>

<h3 id="testing-rollback">Testing Rollback</h3>

<p>This sounds a bit overkill to me. Testing in staging is probably enough. But
if you want to do this, it’s possible as well.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Java                  MongoDB
---                   ---
original (V2)  -----&gt; Mongo document
restored (V1) &lt;-----
</code></pre></div></div>

<p>You can copy the existing Java class into a new class, such as
<code class="language-plaintext highlighter-rouge">LegacyOrder.java</code> or <code class="language-plaintext highlighter-rouge">OrderV1.java</code>. Then, write an instance V2 into
MongoDB and read it back as V1 (legacy) format to assert if the result is what
you expect.</p>

<h2 id="migrating-existing-documents">Migrating Existing Documents</h2>

<p>Besides providing a default value during the deserialization, another possibility
to avoid the <code class="language-plaintext highlighter-rouge">NullPointerException</code> is to migrate the existing documents in
MongoDB. Before doing so, consider:</p>

<ul>
  <li>Whether you need to perform a backup before running your query. Ideally, the
backup is scheduled regularly. Or consider export the concerned
documents using
<a href="https://docs.mongodb.com/database-tools/mongoexport/">mongoexport</a>.</li>
  <li>Testing your query in localhost and staging environment before running it in
production.</li>
  <li>Ask for approval from at least one of your teammates before changing the
documents.</li>
  <li>Create a conversation in the chat tool, e.g. Slack or Microsoft Teams, to keep
track of the operations.</li>
  <li>Update one document before updating multiple ones.</li>
</ul>

<p>Now, back to the Mongo query for migration. This can be as simple as:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">orders</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span>
  <span class="p">{</span> <span class="na">isCanceled</span><span class="p">:</span> <span class="p">{</span> <span class="na">$exists</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}</span> <span class="p">},</span>  <span class="c1">// 1</span>
  <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">isCanceled</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}</span> <span class="p">},</span>  <span class="c1">// 2</span>
  <span class="p">{</span> <span class="na">multi</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>  <span class="c1">// 3</span>
<span class="p">)</span>
</code></pre></div></div>

<p>In the query above:</p>

<ol>
  <li>We find the documents in collection <code class="language-plaintext highlighter-rouge">orders</code> that do not contain the field
<code class="language-plaintext highlighter-rouge">isCanceled</code>.</li>
  <li>Then for those documents, we set the missing field <code class="language-plaintext highlighter-rouge">isCanceled</code> as “false”.</li>
  <li>By default, an update statement only updates one single document. We set it to
update multiple ones — all those matching the selection (without field
<code class="language-plaintext highlighter-rouge">isCanceled</code>). Note that it’s better to perform the update query twice: the
first time with option <code class="language-plaintext highlighter-rouge">{ multi: false }</code> to test if the update statement
works. Then perform it a second-time with option <code class="language-plaintext highlighter-rouge">{ multi: true }</code> to update
all the documents that matched the selection. In this way, we reduce the risk of
breaking the entire collection.</li>
</ol>

<p>Then the update result shows how many documents were concerned: the number of
documents matched the query, number of documents updated or inserted, and number
of documents modified.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">WriteResult</span><span class="p">({</span> <span class="dl">"</span><span class="s2">nMatched</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="dl">"</span><span class="s2">nUpserted</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="dl">"</span><span class="s2">nModified</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
</code></pre></div></div>

<h2 id="preparing-for-rollback">Preparing For Rollback</h2>

<p><em>How to handle an unknown field in Jackson?</em></p>

<p>In the previous section “Potential Risks”, we mentioned that rolling back to
the previous version in Java application may not be possible.
The deserialization of the new documents in MongoDB may fail with the
following exception:</p>

<blockquote>
  <p>“java.io.UncheckedIOException:
com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException: Unrecognized field
“isCanceled” (class io.mincong.mongodb.model_changes.OrderV1), not marked as ignorable (3
known properties: “amount”, “customerId”, “_id”]) at [Source: (String)”{“_id”: “2”,
“customerId”: “Customer2”, “amount”: 200.0, “isCanceled”: true, “operator”:
“emea@example.com”, “productIds”: [“A”, “B”, “C”]}”; line: 1, column: 77] (through reference
chain: io.mincong.mongodb.model_changes.OrderV1[“isCanceled”])”</p>
</blockquote>

<p>This is because new documents have the field “isCanceled” but the old value
class <code class="language-plaintext highlighter-rouge">OrderV1</code> does not know how to deserialize it! In this section, we are
going to see how to handle unknown fields correctly in Jackson.</p>

<h3 id="handle-unknown-field-globally">Handle Unknown Field Globally</h3>

<p>Make the Jackson object mapper more lenient face to unknown properties during
the JSON deserialization by disabling the feature <code class="language-plaintext highlighter-rouge">FAIL_ON_UNKNOWN_PROPERTIES</code>.
We can do that using one of the following lines:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">objectMapper</span><span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="nc">DeserializationFeature</span><span class="o">.</span><span class="na">FAIL_ON_UNKNOWN_PROPERTIES</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">objectMapper</span><span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="nc">DeserializationFeature</span><span class="o">.</span><span class="na">FAIL_ON_UNKNOWN_PROPERTIES</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</code></pre></div></div>

<p>This will apply to all the JSON objects deserialized by this object mapper.</p>

<h3 id="handle-unknown-field-locally">Handle Unknown Field Locally</h3>

<p>Make the Jackson object mapper more lenient for a given value class during the
JSON deserialization by adding annotation <code class="language-plaintext highlighter-rouge">@JsonIgnoreProperties</code> in your value
class:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@JsonIgnoreProperties</span><span class="o">(</span><span class="n">ignoreUnknown</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderV1</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</code></pre></div></div>

<p>This will apply to all the JSON objects deserialized into this value class
<code class="language-plaintext highlighter-rouge">OrderV1</code>. Compared to setting the feature globally, setting it locally at the class
level gives you finer control about the behavior over different classes, but
it’s also easier to forget adding this annotation because you will have to do
that for <em>all</em> the classes and bring inconsistency over the deserialization
behavior.</p>

<p>Once you configured one of the features mentioned above (globally or locally),
then it should be safe to rollback! Hopefully, you won’t need to rollback, but
it’s always a good idea to know that your code is prepared for that.</p>

<h2 id="useful-mongo-queries">Useful Mongo Queries</h2>

<p>In the previous sections, we were focused on how to avoid breaking the schema in
the first place. But what if the production is already broken? Maybe someone
else didn’t realize his changes can trigger an incident. Therefore, it’s always
a good thing to learn some basic Mongo queries to prepare the worst case. That
is, fixing the production when it is broken. Here are some Mongo queries that I
prepared for you.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">orders</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span>
<span class="mi">2</span>
</code></pre></div></div>

<p>Count the number of documents in the collection <code class="language-plaintext highlighter-rouge">orders</code>. Useful to understand
how many documents are concerned and the potential impact if things go wrong.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">orders</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="na">isCanceled</span><span class="p">:</span> <span class="p">{</span> <span class="na">$exists</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}</span> <span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nx">pretty</span><span class="p">()</span>
<span class="p">{</span> <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">customerId</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">Customer1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">amount</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">100</span> <span class="p">}</span>
</code></pre></div></div>

<p>Find out 10 documents without the field <code class="language-plaintext highlighter-rouge">isCanceled</code> and print them in pretty
format. Useful to inspect the JSON before or after the actual update.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">orders</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span>
  <span class="p">{</span> <span class="na">isCanceled</span><span class="p">:</span> <span class="p">{</span> <span class="na">$exists</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">$unset</span><span class="p">:</span> <span class="p">{</span> <span class="na">isCanceled</span><span class="p">:</span> <span class="dl">""</span> <span class="p">}</span> <span class="p">}</span>
  <span class="p">{</span> <span class="na">multi</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Remove field <code class="language-plaintext highlighter-rouge">isCanceled</code> from all the documents having this field. Useful for
reverting the changes. Especially when your Java code had been rolled back to
the previous version but the Jackson fails to deserialize the recently-added Mongo
documented, which contains the new field <code class="language-plaintext highlighter-rouge">isCanceled</code>.</p>

<h2 id="other-scenarios">Other Scenarios</h2>

<p>In the sections above, we mainly discussed what happened when adding a new field
in MongoDB. But what about other scenarios?</p>

<ul>
  <li>Another common scenario is to remove a field. Removing a field may have an issue
because the Java class may not be prepared for accepting unknown properties.
This is exactly what we discussed during the section “Preparing For Rollback”.</li>
  <li>Another possible scenario is to change the type of an existing field. I would
avoid doing this. There must be a better solution, such as creating a new
field using another name.</li>
  <li>Renaming or removing an element in a Java enum. Renaming is possible but please
ensure that the JSON property naming is not going to be changed implicitly.
For example, by renaming an enum item from <code class="language-plaintext highlighter-rouge">FOO</code> to <code class="language-plaintext highlighter-rouge">BAR</code>, the serialization will
be changed from “FOO” to “BAR”, which will completely break your application.
Removing an element is dangerous as well. Ensure that
this element does not exist in any of your databases (staging, production)
before doing so.</li>
</ul>

<p>There are eventually other scenarios that I didn’t mention. Please leave a
comment so that everyone reading this article can learn about that.</p>

<h2 id="going-further">Going Further</h2>

<p>How to go further from here?</p>

<ul>
  <li>This article assumes that you use <a href="https://github.com/FasterXML/jackson-databind">Jackson
Databind</a> to serialize and
deserialize your Mongo documents in Java. If you are not using it and want to
give it a try, take a look at this Stack Overflow question <a href="https://stackoverflow.com/a/47949886/4381330">Is there any way
for creating Mongo codecs
automatically?</a>, my implementation
is highly inspired by Kevin Day’s answer.</li>
  <li>To learn more about different update operators in MongoDB, such as <code class="language-plaintext highlighter-rouge">$set</code>,
<code class="language-plaintext highlighter-rouge">$unset</code>, visit MongoDB Manual <a href="https://docs.mongodb.com/manual/reference/operator/update/">“Update
Operators”</a>.</li>
  <li>To learn more about database tool <code class="language-plaintext highlighter-rouge">mongodump</code>, visit MongoDB documentation
<a href="https://docs.mongodb.com/database-tools/mongodump/#mongodb-binary-bin.mongodump">mongodump</a>.</li>
</ul>

<p>You can also find the source code of this article on GitHub under project
<a href="https://github.com/mincong-h/java-examples/tree/blog/mongo-schema-compatibility/mongo">mincong-h/java-examples</a>,
in particular the <a href="https://github.com/mincong-h/java-examples/tree/blog/mongo-schema-compatibility/mongo/src/main/java/io/mincong/mongodb/model_changes">source
code</a>
and the <a href="https://github.com/mincong-h/java-examples/tree/blog/mongo-schema-compatibility/mongo/src/test/java/io/mincong/mongodb/model_changes">test code</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we saw the potential risks for MongoDB when adding a new field
in the Java application (<code class="language-plaintext highlighter-rouge">NullPointerException</code> and issue for rollback), the
different techniques for filling the <code class="language-plaintext highlighter-rouge">null</code> value, how to write unit tests, how
to migrate the existing documents, how to prepare for rollback by handling
unknown field correctly via object mapper or via Java class annotation, and some
useful MongoDB queries to help you investigate the incident when something goes
wrong. Finally, we discussed briefly other scenarios and saw some resources
about how to go further from here.
Interested to know more? You can subscribe to <a href="/feed.xml">the feed of my blog</a>, follow me
on <a href="https://twitter.com/mincong_h">Twitter</a> or
<a href="https://github.com/mincong-h/">GitHub</a>. Hope you enjoy this article, see you the next time!</p>

<h2 id="references">References</h2>

<ul>
  <li>MongoDB, “MongoDB Documentation”, 2021.
<a href="https://docs.mongodb.com/">https://docs.mongodb.com/</a></li>
  <li>Tatu Saloranta et al., “Jackson Databind”, 2021.
<a href="https://github.com/FasterXML/jackson-databind">https://github.com/FasterXML/jackson-databind</a></li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2021-02-27T17:07:27+01:00"><!-- start custom article footer snippet -->


  

  

  <div class="article__ads">
    
      <div id="ea-article"
           data-ea-publisher="mincongio"
           data-ea-keywords="java|mongodb|serialization|jackson|reliability"
           data-ea-type="image">
    
    </div>
  </div>

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">Subscribe</a>
</div></div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/2021/01/31/juni5-parameterized-tests/">Writing Parameterized Tests in JUnit 5</a></div><div class="next"><span>NEXT</span><a href="/2021/04/09/junit-5-dynamic-tests/">JUnit 5: Dynamic Tests with TestFactory</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/2021/02/27/mongodb-schema-compatibility/';
    this.page.identifier = '/2021/02/27/mongodb-schema-compatibility';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script><script src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script>
<script>
ethicalads.wait.then((placements) => {
  if (!placements.length) {
    console.debug('Loading backup content');
    div = document.querySelector('[data-ea-publisher]')
    div.innerHTML = '<p>Check out our first-party ad content.</p>'
  } else {
    console.debug('EthicalAds are loaded');
  }
});
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

