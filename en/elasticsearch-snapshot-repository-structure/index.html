<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Internal Structure Of Snapshot Repository - Mincong Huang</title>

<meta name="description" content="This article takes you to the Elasticsearch snapshot repository to explore its internal structure and understand the contents and uses of different files.">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Internal Structure Of Snapshot Repository | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Internal Structure Of Snapshot Repository" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="en" />
<meta name="description" content="This article takes you to the Elasticsearch snapshot repository to explore its internal structure and understand the contents and uses of different files." />
<meta property="og:description" content="This article takes you to the Elasticsearch snapshot repository to explore its internal structure and understand the contents and uses of different files." />
<link rel="canonical" href="https://mincong.io/en/elasticsearch-snapshot-repository-structure/" />
<meta property="og:url" content="https://mincong.io/en/elasticsearch-snapshot-repository-structure/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-dmitrij-paskevic-YjVa-F9P9kk-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-09-04T10:11:10+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-dmitrij-paskevic-YjVa-F9P9kk-unsplash.jpg" />
<meta property="twitter:title" content="Internal Structure Of Snapshot Repository" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"description":"This article takes you to the Elasticsearch snapshot repository to explore its internal structure and understand the contents and uses of different files.","@type":"BlogPosting","image":"https://mincong.io/assets/bg-dmitrij-paskevic-YjVa-F9P9kk-unsplash.jpg","headline":"Internal Structure Of Snapshot Repository","dateModified":"2021-09-04T10:11:10+02:00","datePublished":"2021-09-04T10:11:10+02:00","url":"https://mincong.io/en/elasticsearch-snapshot-repository-structure/","mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/en/elasticsearch-snapshot-repository-structure/"},"author":{"@type":"Person","name":"Mincong Huang"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="1279"/>
<meta property="og:image:height" content="1920"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/en/elasticsearch-snapshot-repository-structure/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>

          

          
          
          

          
          
          

          
          

          
          

          <a href="/">Mincong Huang</a>
        </div><button class="button button--secondary button--circle search-button js-search-toggle">
            <i class="fas fa-search"></i>
          </button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/en/categories/">Categories</a></li><li class="navigation__item"><a href="/en/series/">Series</a></li><li class="navigation__item"><a href="/en/archive/">Archive</a></li><li class="navigation__item"><a href="/en/about/">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li><li>
            <a href="/cn/">
             <img src="/assets/flag-CN.png"
                  alt=""
                  class="naviation__lang_img">
            </a>
          </li>
        </ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/assets/bg-dmitrij-paskevic-YjVa-F9P9kk-unsplash.jpg);background-color:#203028;"><div class="hero__content"><div class ="main">

  
  <div class="article__info clearfix">
      <ul class="left-col menu">
        <li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=elasticsearch">elasticsearch</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=java">java</a>
            </li>

        <li class="separator">|</li>
          
            <li>
              <a class="button button--circle button--primary focus lang"
                 href="/en/elasticsearch-snapshot-repository-structure/"><span>EN</span></a>

              






              

              
                <a class="button button--circle button--secondary lang"
                   href="/cn/elasticsearch-snapshot-repository-structure/"><span>CN</span></a>
              
            </li>
          
        
      </ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Sep 04, 2021</span>
            </li></ul></div><div class="article__header"><header><h1>Internal Structure Of Snapshot Repository</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">Do you know these files?</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      
      Photo by
      <a href="https://unsplash.com/@zeak" target="_blank">Dmitrij Paskevic</a>
      
      on
      <a href="https://unsplash.com/license" target="_blank">Unplash </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><meta itemprop="headline" content="Internal Structure Of Snapshot Repository"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2021-09-04T10:11:10+02:00">
    <meta itemprop="keywords" content="elasticsearch,java"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><p class="info">This article is translated with Google Translate and reviewed by Mincong.</p>

<h2 id="introduction">Introduction</h2>

<p>If you use an Elasticsearch cluster in production, I believe you must have heard of Elasticsearch’s <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/snapshot-restore-apis.html">snapshot and restore feature</a>, because it is an important means to ensure that cluster data is not lost. There are a lot of materials on the Internet about how to use Elasticsearch snapshots, but there are very few articles about its implementation. Today, I want to discuss with you the internal structure of the Elasticsearch snapshot repository. Knowing it can give us a better understanding of how Elasticsearch’s snapshots work, and can also provide more ideas for troubleshooting when there is a problem in production.</p>

<p>After reading this article, you will understand:</p>

<ul>
  <li>What is a snapshot repository?</li>
  <li>Different files inside a snapshot repository</li>
  <li>Learning more about <code class="language-plaintext highlighter-rouge">index-N</code> files</li>
  <li>Learning more about the <code class="language-plaintext highlighter-rouge">index.latest</code> file</li>
  <li>Learning more about snapshot information files</li>
</ul>

<p>Without further ado, let’s get started right away!</p>

<h2 id="what-is-a-snapshot-repository">What is a snapshot repository?</h2>

<p>A snapshot repository is a location where Elasticsearch stores snapshots. One snapshot repository can store multiple snapshots. Snapshots are how Elasticsearch backups your data. You can create a snapshot for one single index or multiple indices. Inside a snapshot repository, snapshots are incremental: new snapshots will only snapshot those parts that were not snapshotted in the previous snapshot to avoid wasting time and storage space. There are many types of snapshot repositories: they can be local repository or remote repositories for  cloud providers, such as AWS S3, Google Cloud Storage, Azure Blob Storage, Aliyun OSS, etc.</p>

<h2 id="different-files-inside-a-snapshot-repository">Different files inside a snapshot repository</h2>

<p>Below, let’s take a look the different files stored inside a snapshot repository. Here is an excerpt from the <a href="https://github.com/elastic/elasticsearch/blob/7.12/server/src/main/java/org/elasticsearch/repositories/blobstore/package-info.java">Javadoc of Elasticsearch 7.12 about Snapshot Repository</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> STORE_ROOT
 |- index-N           - JSON serialized {@link org.elasticsearch.repositories.RepositoryData} containing a list of all snapshot ids
 |                      and the indices belonging to each snapshot, N is the generation of the file
 |- index.latest      - contains the numeric value of the latest generation of the index file (i.e. N from above)
 |- incompatible-snapshots - list of all snapshot ids that are no longer compatible with the current version of the cluster
 |- snap-20131010.dat - SMILE serialized {@link org.elasticsearch.snapshots.SnapshotInfo} for snapshot "20131010"
 |- meta-20131010.dat - SMILE serialized {@link org.elasticsearch.cluster.metadata.Metadata } for snapshot "20131010"
 |                      (includes only global metadata)
 |- snap-20131011.dat - SMILE serialized {@link org.elasticsearch.snapshots.SnapshotInfo} for snapshot "20131011"
 |- meta-20131011.dat - SMILE serialized {@link org.elasticsearch.cluster.metadata.Metadata } for snapshot "20131011"
 .....
 |- indices/ - data for all indices
    |- Ac1342-B_x/ - data for index "foo" which was assigned the unique id Ac1342-B_x (not to be confused with the actual index uuid)
    |  |             in the repository
    |  |- meta-20131010.dat - JSON Serialized {@link org.elasticsearch.cluster.metadata.IndexMetadata} for index "foo"
    |  |- 0/ - data for shard "0" of index "foo"
    |  |  |- __1                      \  (files with numeric names were created by older ES versions)
    |  |  |- __2                      |
    |  |  |- __VPO5oDMVT5y4Akv8T_AO_A |- files from different segments see snap-* for their mappings to real segment files
    |  |  |- __1gbJy18wS_2kv1qI7FgKuQ |
    |  |  |- __R8JvZAHlSMyMXyZc2SS8Zg /
    |  |  .....
    |  |  |- snap-20131010.dat - SMILE serialized {@link org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardSnapshot} for
    |  |  |                      snapshot "20131010"
    |  |  |- snap-20131011.dat - SMILE serialized {@link org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardSnapshot} for
    |  |  |                      snapshot "20131011"
    |  |  |- index-123         - SMILE serialized {@link org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardSnapshots} for
    |  |  |                      the shard (files with numeric suffixes were created by older versions, newer ES versions use a uuid
    |  |  |                      suffix instead)
    |  |
    |  |- 1/ - data for shard "1" of index "foo"
    |  |  |- __1
    |  |  |- index-Zc2SS8ZgR8JvZAHlSMyMXy - SMILE serialized {@code BlobStoreIndexShardSnapshots} for the shard
    |  |  .....
    |  |
    |  |-2/
    |  ......
    |
    |- 1xB0D8_B3y/ - data for index "bar" which was assigned the unique id of 1xB0D8_B3y in the repository
    ......
</code></pre></div></div>

<p>Organize them again in a table:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">File path</th>
      <th style="text-align: left">explanation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">index-N</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">RepositoryData</code> serialized in JSON format, including all snapshot IDs and their corresponding indexes. N represents the generation of this file.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">index.latest</code></td>
      <td style="text-align: left">The file is a pointer that represents the last generation index file in digital form, which is the number N mentioned above. Here N is a hexadecimal number, for example, the index of the 100th generation (decimal), and finally represented by 64 in hexadecimal, because 64 = 16*6 + 4.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">incompatible-snapshots</code></td>
      <td style="text-align: left">A list of all snapshot IDs that are no longer compatible with the current cluster version</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">snap-20131010.dat</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">SnapshotInfo</code> serialized in SMILE format, used to represent the information corresponding to the snapshot 20131010</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">meta-20131010.dat</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Metadata</code> serialized in SMILE format, used to represent the metadata corresponding to the snapshot 20131010  (includes only global metadata)</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">indices/</code></td>
      <td style="text-align: left">Data for all indices</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">indices/Ac1342-B_x/</code></td>
      <td style="text-align: left">Index the data corresponding to foo. The UUID of the index in the repository is Ac1342-B_x. But do not confuse with the UUID of the index.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">indices/Ac1342-B_x/meta-20131010.dat</code></td>
      <td style="text-align: left">Index foo <code class="language-plaintext highlighter-rouge">IndexMetadata</code> serialized in JSON format</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">indices/Ac1342-B_x/0/</code></td>
      <td style="text-align: left">Index foo data corresponding to shard 0</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">indices/Ac1342-B_x/0/__1</code></td>
      <td style="text-align: left">Files ending in numbers were created by an older version of Elasticsearch</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">indices/Ac1342-B_x/0/__2</code></td>
      <td style="text-align: left">Same as above</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Indices / Ac1342-B_x / 0 / __ VPO5oDMVT5y4Akv8T_AO_A</code></td>
      <td style="text-align: left">segment files, with specific mappings real segment, see <code class="language-plaintext highlighter-rouge">snap-*</code> file</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">indices/Ac1342-B_x/0/__1gbJy18wS_2kv1qI7FgKuQ</code></td>
      <td style="text-align: left">Same as above</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">indices/Ac1342-B_x/0/__R8JvZAHlSMyMXyZc2SS8Zg</code></td>
      <td style="text-align: left">Same as above</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">indices/Ac1342-B_x/0/snap-20131010.dat</code></td>
      <td style="text-align: left">Snapshot 20131010 <code class="language-plaintext highlighter-rouge">BlobStoreIndexShardSnapshot</code> serialized in SMILE format</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">indices/Ac1342-B_x/0/snap-20131011.dat</code></td>
      <td style="text-align: left">Snapshot 20131011 <code class="language-plaintext highlighter-rouge">BlobStoreIndexShardSnapshot</code> serialized in SMILE format</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">indices/Ac1342-B_x/0/index-123</code></td>
      <td style="text-align: left">Shard 0 <code class="language-plaintext highlighter-rouge">BlobStoreIndexShardSnapshots</code> serialized in SMILE format. Files with numeric suffixes were created by older versions, newer ES versions use a uuid suffix instead</td>
    </tr>
  </tbody>
</table>

<h2 id="data-preparation">Data Preparation</h2>

<p>Next, let’s take a look at some of the more important files.</p>

<p>But before getting started, we need to prepare the data locally: by starting Elasticsearch, and creating some data and snapshots.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">es_repo</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/es-backup/blog-snapshot-repo-structure/"</span>

<span class="c"># Start Elasticsearch</span>
docker run <span class="se">\</span>
  <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">-p</span> 9200:9200 <span class="se">\</span>
  <span class="nt">-p</span> 9300:9300 <span class="se">\</span>
  <span class="nt">-e</span> <span class="s2">"discovery.type=single-node"</span> <span class="se">\</span>
  <span class="nt">-e</span> <span class="s2">"cluster.name=es-docker-cluster"</span> <span class="se">\</span>
  <span class="nt">-e</span> <span class="s2">"path.repo=/opt/elasticsearch/backup"</span> <span class="se">\</span>
  <span class="nt">-v</span> <span class="s2">"</span><span class="k">${</span><span class="nv">es_repo</span><span class="k">}</span><span class="s2">:/opt/elasticsearch/backup"</span> <span class="se">\</span>
  docker.elastic.co/elasticsearch/elasticsearch:7.12.0

<span class="c"># Create document</span>
curl <span class="nt">-X</span> PUT localhost:9200/my_index/_doc/1 <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{"msg": "Hello Elasticsearch"}'</span>

<span class="c"># Create snapshot repository</span>
curl <span class="nt">-X</span> PUT localhost:9200/_snapshot/my_repo <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
  "type": "fs",
  "settings": {
    "location": "my_repo"
  }
}'</span>

<span class="c"># Create snapshot</span>
curl <span class="nt">-X</span> PUT localhost:9200/_snapshot/my_repo/my_snapshot_1 <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
  "indices": "my_index",
  "include_global_state": false,
  "metadata": {
    "taken_by": "Mincong",
    "taken_because": "https://mincong.io is the best blog for learning Elasticsearch"
  }
}'</span>
</code></pre></div></div>

<p>Then enter the local folder <code class="language-plaintext highlighter-rouge">blog-snapshot-repo-structure</code>, make sure the repository <code class="language-plaintext highlighter-rouge">my_repo</code> and the files in it are ready:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  blog-snapshot-repo-structure find my_repo
my_repo
my_repo/index-0
my_repo/indices
my_repo/indices/Uxom82JcSfORXgbtZ4jLSg
my_repo/indices/Uxom82JcSfORXgbtZ4jLSg/0
my_repo/indices/Uxom82JcSfORXgbtZ4jLSg/0/index-MwjmFzyOT_2NI6DdXLcsNw
my_repo/indices/Uxom82JcSfORXgbtZ4jLSg/0/__IlzZcMdOSkC-j6xx0Qj04A
my_repo/indices/Uxom82JcSfORXgbtZ4jLSg/0/snap-2hiUzvH3RPCp9iOeiTa6TQ.dat
my_repo/indices/Uxom82JcSfORXgbtZ4jLSg/0/__jQbQk7YYTwW8G5gL_RtR8w
my_repo/indices/Uxom82JcSfORXgbtZ4jLSg/meta-N1BHtXsBYxjWXi8lXhTR.dat
my_repo/index.latest
my_repo/meta-2hiUzvH3RPCp9iOeiTa6TQ.dat
my_repo/snap-2hiUzvH3RPCp9iOeiTa6TQ.dat
</code></pre></div></div>

<p>Now, we can further explore the contents of the repository!</p>

<h2 id="file-index-n">File index-N</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>index-0 | jq
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">min_version</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">7.12.0</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">uuid</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">C87ijmZURAK3ij8MsAaDAw</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">cluster_id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">aSNpPgDAShyYAiKhsun6IA</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">snapshots</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my_snapshot_1</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">uuid</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2hiUzvH3RPCp9iOeiTa6TQ</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">state</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">index_metadata_lookup</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">Uxom82JcSfORXgbtZ4jLSg</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Uz7B9HV2SJ6peiLiUMJhyg-_na_-1-2-1</span><span class="dl">"</span>
      <span class="p">},</span>
      <span class="dl">"</span><span class="s2">version</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">7.12.0</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="dl">"</span><span class="s2">indices</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">my_index</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Uxom82JcSfORXgbtZ4jLSg</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">snapshots</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">2hiUzvH3RPCp9iOeiTa6TQ</span><span class="dl">"</span>
      <span class="p">],</span>
      <span class="dl">"</span><span class="s2">shard_generations</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">MwjmFzyOT_2NI6DdXLcsNw</span><span class="dl">"</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="dl">"</span><span class="s2">index_metadata_identifiers</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">Uz7B9HV2SJ6peiLiUMJhyg-_na_-1-2-1</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">N1BHtXsBYxjWXi8lXhTR</span><span class="dl">"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl "localhost:9200/_cat/indices/my_index?v"
health status index    uuid                   pri rep docs.count docs.deleted store.size pri.store.size
yellow open   my_index Uz7B9HV2SJ6peiLiUMJhyg   1   1          1            0      3.9kb          3.9kb
</code></pre></div></div>

<p>The above file <code class="language-plaintext highlighter-rouge">index-0</code> represents generation 0 of the snapshot repository. It is a <code class="language-plaintext highlighter-rouge">RepositoryData</code> serialized in JSON format, which contains all the snapshot IDs and their corresponding indexes. The UUID of the index <code class="language-plaintext highlighter-rouge">my_index</code> in the repository is <code class="language-plaintext highlighter-rouge">Uxom82JcSfORXgbtZ4jLSg</code>, and its corresponding UUID in the cluster is <code class="language-plaintext highlighter-rouge">Uz7B9HV2SJ6peiLiUMJhyg</code>. This index is referenced by a snapshot, which is the snapshot <code class="language-plaintext highlighter-rouge">my_snapshot_1</code> (<code class="language-plaintext highlighter-rouge">2hiUzvH3RPCp9iOeiTa6TQ</code>).</p>

<h2 id="file-indexlatest">File index.latest</h2>

<p>The <code class="language-plaintext highlighter-rouge">index.latest</code> file is a pointer that represents the last-generation index file in numerical form, which is the number N mentioned above. Here N is a hexadecimal number, for example, the index of the 100th generation (decimal) is represented as 64 in hexadecimal, because 64 = 16*6 + 4. In the repository <code class="language-plaintext highlighter-rouge">my_repo</code> prepared above, since only one snapshot was taken, it is the 0th generation:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜ hexdump index.latest
0000000 00 00 00 00 00 00 00 00
0000008
</code></pre></div></div>

<p>Now, let’s generate more documents and create more snapshots, so that we can better view the changes in <code class="language-plaintext highlighter-rouge">index.latest</code>:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>2..20<span class="o">}</span>
<span class="k">do
  </span><span class="nb">echo</span> <span class="s2">"Creating document </span><span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="s2">"</span>
  curl <span class="nt">-s</span> <span class="nt">-X</span> PUT <span class="s2">"localhost:9200/my_index/_doc/</span><span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">-H</span><span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
    <span class="nt">-d</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">msg</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">Hello Elasticsearch </span><span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="se">\"</span><span class="s2">}"</span>

  <span class="nb">echo</span> <span class="s2">"Creating snapshot </span><span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="s2">"</span>
  curl <span class="nt">-s</span> <span class="nt">-X</span> PUT <span class="s2">"localhost:9200/_snapshot/my_repo/my_snapshot_</span><span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">-H</span><span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
    <span class="nt">-d</span><span class="s1">'{
    "indices": "my_index",
    "include_global_state": false,
    "metadata": {
      "taken_by": "Mincong",
      "taken_because": "https://mincong.io is the best blog for learning Elasticsearch"
    }
  }'</span>
<span class="k">done</span>
</code></pre></div></div>

<p>At this time, <code class="language-plaintext highlighter-rouge">index.latest</code> has become the 19th generation (starting from the 0 generation, so it is actually the 20th generation). 19 = 16*1 + 3</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜ hexdump index.latest
0000000 00 00 00 00 00 00 00 00 13
0000008
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜ echo'ibase=16; 13' | bc
19
</code></pre></div></div>

<p>But how does Elasticsearch load the <code class="language-plaintext highlighter-rouge">RepositoryData</code> through <code class="language-plaintext highlighter-rouge">index-N</code> and <code class="language-plaintext highlighter-rouge">index.latest</code> files?</p>

<p>Loading <code class="language-plaintext highlighter-rouge">RepositoryData</code> and the mapping of index name to its repository <code class="language-plaintext highlighter-rouge">IndexId</code>, which is done by calling <code class="language-plaintext highlighter-rouge">BlobStoreRepository.getRepositoryData()</code>. The specific implementation is as follows (<a href="https://github.com/elastic/elasticsearch/blob/7.12/server/src/main/java/org/elasticsearch/repositories/blobstore/package-info.java">extracted from Javadoc</a>):</p>

<ol>
  <li>Step 1: Storing repository data
    <ol>
      <li>The blobstore repository stores the <code class="language-plaintext highlighter-rouge">RepositoryData</code> in blobs named with incrementing suffix <code class="language-plaintext highlighter-rouge">N</code> at <code class="language-plaintext highlighter-rouge">/index-N</code> directly under the repository’s root.</li>
      <li>For each <code class="language-plaintext highlighter-rouge">BlobStoreRepository</code> an entry of type <code class="language-plaintext highlighter-rouge">RepositoryMetadata</code> exists in the cluster state. It tracks the current valid generation <code class="language-plaintext highlighter-rouge">N</code> as well as the latest generation that a write was attempted for.</li>
      <li>The blobstore also stores the most recent <code class="language-plaintext highlighter-rouge">N</code> as a 64bit long in the blob <code class="language-plaintext highlighter-rouge">/index.latest</code> directly under the repository’s root.</li>
    </ol>
  </li>
  <li>Step 2: Determine the value of N
    <ol>
      <li>First, find the most recent <code class="language-plaintext highlighter-rouge">RepositoryData</code> by getting a list of all index-N blobs through listing all blobs with prefix “index-“ under the repository root and then selecting the one with the highest value for N.</li>
      <li>If this operation fails because the repository’s <code class="language-plaintext highlighter-rouge">BlobContainer</code> does not support list operations (in the case of read-only repositories), read the highest value of N from the <code class="language-plaintext highlighter-rouge">index.latest</code> blob.</li>
    </ol>
  </li>
  <li>Step 3: Deserialization
    <ol>
      <li>Use the just determined value of <code class="language-plaintext highlighter-rouge">N</code> and get the <code class="language-plaintext highlighter-rouge">/index-N</code> blob and deserialize the <code class="language-plaintext highlighter-rouge">RepositoryData</code> from it.</li>
      <li>If no value of <code class="language-plaintext highlighter-rouge">N</code> could be found since neither an <code class="language-plaintext highlighter-rouge">index.latest</code> nor any <code class="language-plaintext highlighter-rouge">index-N</code> blobs exist in the repository, it is assumed to be empty and <code class="language-plaintext highlighter-rouge">RepositoryData#EMPTY</code> is returned.</li>
    </ol>
  </li>
</ol>

<h2 id="repo-level-snapshot-info">Repo-Level Snapshot Info</h2>

<p><code class="language-plaintext highlighter-rouge">SnapshotInfo</code> serialized in SMILE format is used to represent the information related to the snapshot. The following is the snapshot info for <code class="language-plaintext highlighter-rouge">my_snapshot_20</code> (<code class="language-plaintext highlighter-rouge">snap-WbjaeQk1T4u2JrGfsWlHsw.dat</code>). By the way, it is worth mentioning that there is no way to directly inspect files in SMILE format (for example, using <code class="language-plaintext highlighter-rouge">cat</code>). You need a special demodulation tool, such as <a href="https://github.com/cowtowncoder/Jackformer">cowtowncoder/Jackformer</a>. After converting to JSON, we obtain the results as:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// decoded version of repository-level snapshot info</span>
<span class="c1">// $STORE_ROOT/snap-WbjaeQk1T4u2JrGfsWlHsw.dat</span>
<span class="p">{</span>
  <span class="dl">"</span><span class="s2">snapshot</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">my_snapshot_20</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">uuid</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">WbjaeQk1T4u2JrGfsWlHsw</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">version_id</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">7120099</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">indices</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">my_index</span><span class="dl">"</span> <span class="p">],</span>
    <span class="dl">"</span><span class="s2">data_streams</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span> <span class="p">],</span>
    <span class="dl">"</span><span class="s2">state</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">SUCCESS</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">include_global_state</span><span class="dl">"</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">metadata</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">taken_by</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">Mincong</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">taken_because</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">https://mincong.io is the best blog for learning Elasticsearch</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">start_time</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1630835219489</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">end_time</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1630835222295</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">total_shards</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">successful_shards</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">failures</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span> <span class="p">],</span>
    <span class="dl">"</span><span class="s2">feature_states</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="shard-level-snapshot-info">Shard-Level Snapshot Info</h2>

<p>We can do the same thing for shard-level snapshot information, such as this one <code class="language-plaintext highlighter-rouge">snap-WbjaeQk1T4u2JrGfsWlHsw.dat</code>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// decoded version of shard-level snapshot info</span>
<span class="c1">// $STORE_ROOT/indices/Uxom82JcSfORXgbtZ4jLSg/0/snap-WbjaeQk1T4u2JrGfsWlHsw.dat</span>
<span class="p">{</span>
  <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">my_snapshot_20</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">index_version</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">start_time</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1630835221092</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">time</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">number_of_files</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">total_size</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">files</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">__5NSZ0_cESkq6xuZO0KsflA</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">physical_name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_b.cfe</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">length</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">479</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">checksum</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">10v9n85</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">part_size</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">9223372036854775807</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">written_by</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">8.8.0</span><span class="dl">"</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">__409YH-VqThKfHoKO64Jw3A</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">physical_name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_c.cfs</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">length</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">3921</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">checksum</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">aro23l</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">part_size</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">9223372036854775807</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">written_by</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">8.8.0</span><span class="dl">"</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">__-y2SRorARLmutzx_8R0pdA</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">physical_name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_7.cfs</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">length</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">2954</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">checksum</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">40ricv</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">part_size</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">9223372036854775807</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">written_by</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">8.8.0</span><span class="dl">"</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">v__eBFWiPBIRqetvzlHocSdmg</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">physical_name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_c.si</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">length</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">405</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">checksum</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">1raps0i</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">part_size</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">9223372036854775807</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">written_by</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">8.8.0</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">meta_hash</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">P9dsFxNMdWNlbmU4NlNlZ21lbnRJbmZvAAAAAIZgkzI3PmaEHCzgC37ywlIAAAAACAAAAAgAAAAAAQAAAAgAAAAIAAAAAAAAAA4BDAJvcwVMaW51eAxqYXZhLnZlcnNpb24GMTUuMC4xB29zLmFyY2gFYW1kNjQUamF2YS5ydW50aW1lLnZlcnNpb24IMTUuMC4xKzkGc291cmNlBW1lcmdlCm9zLnZlcnNpb24QNS4xMC4yNS1saW51eGtpdAtqYXZhLnZlbmRvcgxBZG9wdE9wZW5KREsPamF2YS52bS52ZXJzaW9uCDE1LjAuMSs5Dmx1Y2VuZS52ZXJzaW9uBTguOC4wE21lcmdlTWF4TnVtU2VnbWVudHMCLTELbWVyZ2VGYWN0b3ICMTAJdGltZXN0YW1wDTE2MzA4MzUyMTg2MDQDBl9jLmNmcwVfYy5zaQZfYy5jZmUBH0x1Y2VuZTg3U3RvcmVkRmllbGRzRm9ybWF0Lm1vZGUKQkVTVF9TUEVFRADAKJPoAAAAAAAAAADkIQAS</span><span class="dl">"</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">v__H3vg9g8aRsCMh3Ni-GypSA</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">physical_name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_b.si</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">length</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">367</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">checksum</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">1ms49nm</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">part_size</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">9223372036854775807</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">written_by</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">8.8.0</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">meta_hash</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">P9dsFxNMdWNlbmU4NlNlZ21lbnRJbmZvAAAAAIZgkzI3PmaEHCzgC37ywlEAAAAACAAAAAgAAAAAAQAAAAgAAAAIAAAAAAAAAAMBCgJvcwVMaW51eAtqYXZhLnZlbmRvcgxBZG9wdE9wZW5KREsMamF2YS52ZXJzaW9uBjE1LjAuMQ9qYXZhLnZtLnZlcnNpb24IMTUuMC4xKzkObHVjZW5lLnZlcnNpb24FOC44LjAHb3MuYXJjaAVhbWQ2NBRqYXZhLnJ1bnRpbWUudmVyc2lvbggxNS4wLjErOQZzb3VyY2UFZmx1c2gKb3MudmVyc2lvbhA1LjEwLjI1LWxpbnV4a2l0CXRpbWVzdGFtcA0xNjMwODM1MjE5MTkzAwZfYi5jZmUGX2IuY2ZzBV9iLnNpAR9MdWNlbmU4N1N0b3JlZEZpZWxkc0Zvcm1hdC5tb2RlCkJFU1RfU1BFRUQAwCiT6AAAAAAAAAAA09nN4g==</span><span class="dl">"</span>
  <span class="p">},</span>
  <span class="p">...</span> <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="going-further">Going Further</h2>

<p>How to expand from this article?</p>

<ul>
  <li>If you want to know more about the internal file format or loading mechanism of snapshot repository, you can check the <a href="https://github.com/elastic/elasticsearch/blob/7.12/server/src/main/java/org/elasticsearch/repositories/blobstore/package-info.java">official Javadoc of Elasticsearch (7.12) of the snapshot repository</a></li>
  <li>If you want to learn more about how Snapshot Repository works, you can check out <a href="https://steve-mushero.medium.com/how-elasticsearch-snapshots-work-3824fdfc4493">How Elasticsearch Snapshots Work</a> by Steve Mushero on Medium</li>
  <li>If you want to know more about SMILE format, you can check Wikipedia <a href="https://en.wikipedia.org/wiki/Smile_%28data_interchange_format%29">Smile (data interchange format)</a> or check Ayush Gupta’s article on Medium <a href="https://medium.com/code-with-ayush/understanding-smile-a-data-format-based-on-json-29972a37d376">Understanding Smile — A data format based on JSON</a></li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we walked into Elasticsearch’s snapshot repository and saw its internal structure. We also learn more about <code class="language-plaintext highlighter-rouge">index-N</code>, <code class="language-plaintext highlighter-rouge">index.latest</code>, and some other files related to snapshots. I hope that by knowing these files, it will give you a have a better understanding of Elasticsearch’s “snapshot and restore” feature, and also give you more ideas for troubleshooting when there is an issue on production. Finally, we briefly saw some resources to expand out. You can subscribe to the <a href="/feed.xml">feed of my blog</a>, follow me on <a href="https://twitter.com/mincong_h">Twitter</a> or <a href="https://github.com/mincong-h/">GitHub</a>. Hope you enjoy this article, see you the next time!</p>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2021-09-04T10:11:10+02:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">Subscribe</a>
</div></div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/en/elasticsearch-settings/">Elasticsearch Settings</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/en/elasticsearch-snapshot-repository-structure/';
    this.page.identifier = '/en/elasticsearch-snapshot-repository-structure';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

