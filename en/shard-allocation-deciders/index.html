<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>The Decision System For Shard Allocation in Elasticsearch - Mincong Huang</title>

<meta name="description" content="Curious about how does a decision system work? This article explains the deciders for shard allocation in Elasticsearch by going through their responsibility...">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>The Decision System For Shard Allocation in Elasticsearch | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="The Decision System For Shard Allocation in Elasticsearch" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="en" />
<meta name="description" content="Curious about how does a decision system work? This article explains the deciders for shard allocation in Elasticsearch by going through their responsibility, structure, decision making, lifecycle, testing, and more." />
<meta property="og:description" content="Curious about how does a decision system work? This article explains the deciders for shard allocation in Elasticsearch by going through their responsibility, structure, decision making, lifecycle, testing, and more." />
<link rel="canonical" href="https://mincong.io/en/shard-allocation-deciders/" />
<meta property="og:url" content="https://mincong.io/en/shard-allocation-deciders/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-patrick-federi-LJEjI7LXABU-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-27T14:36:13+01:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-patrick-federi-LJEjI7LXABU-unsplash.jpg" />
<meta property="twitter:title" content="The Decision System For Shard Allocation in Elasticsearch" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"image":"https://mincong.io/assets/bg-patrick-federi-LJEjI7LXABU-unsplash.jpg","headline":"The Decision System For Shard Allocation in Elasticsearch","description":"Curious about how does a decision system work? This article explains the deciders for shard allocation in Elasticsearch by going through their responsibility, structure, decision making, lifecycle, testing, and more.","datePublished":"2021-12-27T14:36:13+01:00","dateModified":"2021-12-27T14:36:13+01:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/en/shard-allocation-deciders/"},"url":"https://mincong.io/en/shard-allocation-deciders/","author":{"@type":"Person","name":"Mincong Huang"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="1440"/>
<meta property="og:image:height" content="1920"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/en/shard-allocation-deciders/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>

          

          
          
          

          
          
          

          
          

          
          

          <a href="/">Home</a>
        </div><button class="button button--secondary button--circle search-button js-search-toggle">
            <i class="fas fa-search"></i>
          </button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/en/categories/">Categories</a></li><li class="navigation__item"><a href="/en/series/">Series</a></li><li class="navigation__item"><a href="/en/archive/">Archive</a></li><li class="navigation__item"><a href="/en/about/">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li><li>
            <a href="/cn/">
             <img src="/assets/flag-CN.png"
                  alt=""
                  class="naviation__lang_img">
            </a>
          </li>
        </ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/assets/bg-patrick-federi-LJEjI7LXABU-unsplash.jpg);background-color:#203028;"><div class="hero__content"><div class ="main">

  
  <div class="article__info clearfix">
      <ul class="left-col menu">
        <li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=java">java</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=elasticsearch">elasticsearch</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=system-design">system-design</a>
            </li>

        <li class="separator">|</li>
          
            <li>
              <a class="button button--circle button--primary focus lang"
                 href="/en/shard-allocation-deciders/"><span>EN</span></a>

              






              

              
            </li>
          
        
      </ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Dec 27, 2021</span>
            </li></ul></div><div class="article__header"><header><h1>The Decision System For Shard Allocation in Elasticsearch</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">How does it work and what can we learn from it?</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      
      Photo by
      <a href="https://unsplash.com/@federi" target="_blank">Patrick Federi</a>
      
      on
      <a href="https://unsplash.com/license" target="_blank">Unplash </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article><meta itemprop="headline" content="The Decision System For Shard Allocation in Elasticsearch"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2021-12-27T14:36:13+01:00">
    <meta itemprop="keywords" content="java,elasticsearch,system-design"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h2 id="introduction">Introduction</h2>

<p>Shard allocation plays an important role in the data distribution of an
Elasticsearch cluster. Having all the shards allocated ensures the good health
of your cluster and avoids potential data loss. That’s why it’s important to
avoid unassigned shards and avoid yellow cluster. But as a software engineer or
as a database administrator (DBA), do you know how the decision is made
internally? How does Elasticsearch know which node should be used? In this
article, we are going to study this part by exploring the decider system.</p>

<p>After reading this article, you will understand:</p>

<ul>
  <li>The responsibility of allocation service and allocation deciders.</li>
  <li>The structure of these 19 deciders.</li>
  <li>How do they make decisions?</li>
  <li>The deciders’ position in the lifecycle of an ES node.</li>
  <li>How to test them?</li>
  <li>How to go further from this article?</li>
</ul>

<p>And hopefully, this article will help you better understand the internal mechanism
or inspire you to make your decision system based on a similar
architecture. Note that this article is written with Elasticsearch 7.16.2
(latest), which may be different from what you are using. Now, let’s get started!</p>

<h2 id="responsibility">Responsibility</h2>

<p>Allocation deciders are part of the allocation service in Elasticsearch. This
service manages the shard allocation of a cluster. For this reason, the
<code class="language-plaintext highlighter-rouge">AllocationService</code> contains an instance of <code class="language-plaintext highlighter-rouge">AllocationDeciders</code> to choose nodes for shard
allocation. This class also manages new nodes joining the cluster
and the rerouting of shards. If none of the nodes accepts the allocation, the shard
will remain unassigned. Having unassigned shard leads to under-replicated
shards. It will probably result to a yellow cluster and increase the risk of data loss.</p>

<p><em>Which actions require decisions?</em></p>

<p>We can find this information from the abstract class <code class="language-plaintext highlighter-rouge">AllocationDecider</code>.
An allocation decider can decide for many actions: allocation,
rebalancing, keeping the shard in the current node (<code class="language-plaintext highlighter-rouge">canRemain</code>), and auto-expanding the
shards of a given index. Each method returns a decision so that the allocation service knows
how to react. Each action respects the naming convention <code class="language-plaintext highlighter-rouge">can{Action}</code> or
<code class="language-plaintext highlighter-rouge">should{Action}</code>. Here is a more detailed version:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  elasticsearch git:(v7.16.2 u=) ✗ grep "public Decision" server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDecider.java | sort
    public Decision canAllocate(IndexMetadata indexMetadata, RoutingNode node, RoutingAllocation allocation) {
    public Decision canAllocate(ShardRouting shardRouting, RoutingAllocation allocation) {
    public Decision canAllocate(ShardRouting shardRouting, RoutingNode node, RoutingAllocation allocation) {
    public Decision canAllocateReplicaWhenThereIsRetentionLease(ShardRouting shardRouting, RoutingNode node, RoutingAllocation allocation) {
    public Decision canForceAllocateDuringReplace(ShardRouting shardRouting, RoutingNode node, RoutingAllocation allocation) {
    public Decision canForceAllocatePrimary(ShardRouting shardRouting, RoutingNode node, RoutingAllocation allocation) {
    public Decision canRebalance(RoutingAllocation allocation) {
    public Decision canRebalance(ShardRouting shardRouting, RoutingAllocation allocation) {
    public Decision canRemain(ShardRouting shardRouting, RoutingNode node, RoutingAllocation allocation) {
    public Decision shouldAutoExpandToNode(IndexMetadata indexMetadata, DiscoveryNode node, RoutingAllocation allocation) {
</code></pre></div></div>

<h2 id="deciders-structure">Deciders Structure</h2>

<p>In Elasticsearch 7.16, there are 19 deciders for the shard allocation. You can
find them as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  elasticsearch git:(v7.16.2 u=) rg -l --sort-files "extends AllocationDecider" server/src/main | sed 's/.*\///g'
AllocationDeciders.java
AwarenessAllocationDecider.java
ClusterRebalanceAllocationDecider.java
ConcurrentRebalanceAllocationDecider.java
DiskThresholdDecider.java
EnableAllocationDecider.java
FilterAllocationDecider.java
MaxRetryAllocationDecider.java
NodeReplacementAllocationDecider.java
NodeShutdownAllocationDecider.java
NodeVersionAllocationDecider.java
RebalanceOnlyWhenActiveAllocationDecider.java
ReplicaAfterPrimaryActiveAllocationDecider.java
ResizeAllocationDecider.java
RestoreInProgressAllocationDecider.java
SameShardAllocationDecider.java
ShardsLimitAllocationDecider.java
SnapshotInProgressAllocationDecider.java
ThrottlingAllocationDecider.java
</code></pre></div></div>

<p>Among these deciders, there is a root decider, the <code class="language-plaintext highlighter-rouge">AllocationDeciders</code>, which
contains the references of all other deciders. When making a decision, it will
ask those deciders to decide for the shard allocation, and then assemble them to
make a global decision. We will discuss more details in the following
section. As for other deciders, you can see their purposes from
their filenames, such as for awareness key-value pairs (e.g. availability zone),
cluster rebalancing, concurrent rebalancing, disk threshold, and much more.</p>

<h2 id="making-decisions">Making Decisions</h2>

<p>There are two types of decision in the decider system: single decision and
multi-decision. A single decision represents a decision made on one
dimension, e.g. awareness or disk threshold. While a multi-decision represents a decision
container that contains a list of child decisions. Let’s take a closer look at
both of them.</p>

<h3 id="single-decision">Single Decision</h3>

<p><code class="language-plaintext highlighter-rouge">DiskThresholdDecider</code> is a good example of making a single decision. Let’s check its method
for shard allocation: <code class="language-plaintext highlighter-rouge">canAllocate(...)</code>. First of all, it retrieves the settings from the
class member
<code class="language-plaintext highlighter-rouge">diskThresholdSettings</code> for the low and high thresholds, then it retrieves the disk
usage from the given information (node, routing allocation, usages), and finally
compare both of them to make the decision.
Depending on the situation, we will either get a YES or a NO decision. Here is the code
snippet:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Decision</span> <span class="nf">canAllocate</span><span class="o">(</span><span class="nc">ShardRouting</span> <span class="n">shardRouting</span><span class="o">,</span> <span class="nc">RoutingNode</span> <span class="n">node</span><span class="o">,</span> <span class="nc">RoutingAllocation</span> <span class="n">allocation</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="c1">// retrieve settings</span>
    <span class="kd">final</span> <span class="kt">double</span> <span class="n">usedDiskThresholdLow</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">-</span> <span class="n">diskThresholdSettings</span><span class="o">.</span><span class="na">getFreeDiskThresholdLow</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">double</span> <span class="n">usedDiskThresholdHigh</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">-</span> <span class="n">diskThresholdSettings</span><span class="o">.</span><span class="na">getFreeDiskThresholdHigh</span><span class="o">();</span>

    <span class="c1">// checks for exact byte comparisons</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">freeBytes</span> <span class="o">&lt;</span> <span class="n">diskThresholdSettings</span><span class="o">.</span><span class="na">getFreeBytesThresholdLow</span><span class="o">().</span><span class="na">getBytes</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="c1">// checks for percentage comparisons</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">freeDiskPercentage</span> <span class="o">&lt;</span> <span class="n">diskThresholdSettings</span><span class="o">.</span><span class="na">getFreeDiskThresholdLow</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Note that YES and NO are not the only types for the decision. It also exists a
THROTTLE type, which allows users to control the shard allocation based on the
concurrency. We can consider it as a “temporary NO”, as
the allocation is not allowed right now, but may be YES in the future.</p>

<h3 id="multi-decision">Multi-Decision</h3>

<p>Now let’s take a look at the <code class="language-plaintext highlighter-rouge">AllocationDeciders</code> to see how it makes a
multi-decision. When starting the decision, it accepts information about the shard
routing, node routing, and the current allocation. Then, it either ignores the
shard or delegates the decision-making to its child deciders and assembles them at the end.
All child
deciders make a decision synchronously, probably because they don’t require
additional information (such as HTTP requests) from an external service. Once the
decision is made by a child decider, the result is processed with the fail-fast
strategy. That is, whenever one child decision is negative (NO), we consider the
whole decision as NO without asking the remaining deciders. It’s a short
circuit. We do that unless we are in the debug mode, in which case, we
gather all the decisions, including the NO decisions, before returning the final
result. If my explanation is a bit confusing for you, here is the source code of
<code class="language-plaintext highlighter-rouge">AllocationDeciders</code>, hopefully, it makes things clearer.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Decision</span> <span class="nf">canAllocate</span><span class="o">(</span><span class="nc">ShardRouting</span> <span class="n">shardRouting</span><span class="o">,</span> <span class="nc">RoutingNode</span> <span class="n">node</span><span class="o">,</span> <span class="nc">RoutingAllocation</span> <span class="n">allocation</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">allocation</span><span class="o">.</span><span class="na">shouldIgnoreShardForNode</span><span class="o">(</span><span class="n">shardRouting</span><span class="o">.</span><span class="na">shardId</span><span class="o">(),</span> <span class="n">node</span><span class="o">.</span><span class="na">nodeId</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Decision</span><span class="o">.</span><span class="na">NO</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">Decision</span><span class="o">.</span><span class="na">Multi</span> <span class="n">ret</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Decision</span><span class="o">.</span><span class="na">Multi</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">AllocationDecider</span> <span class="n">allocationDecider</span> <span class="o">:</span> <span class="n">allocations</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Decision</span> <span class="n">decision</span> <span class="o">=</span> <span class="n">allocationDecider</span><span class="o">.</span><span class="na">canAllocate</span><span class="o">(</span><span class="n">shardRouting</span><span class="o">,</span> <span class="n">node</span><span class="o">,</span> <span class="n">allocation</span><span class="o">);</span>
            <span class="c1">// short track if a NO is returned.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">decision</span><span class="o">.</span><span class="na">type</span><span class="o">()</span> <span class="o">==</span> <span class="nc">Decision</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">NO</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
                    <span class="o">...</span>
                <span class="o">}</span>
                <span class="c1">// short circuit only if debugging is not enabled</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">allocation</span><span class="o">.</span><span class="na">debugDecision</span><span class="o">()</span> <span class="o">==</span> <span class="kc">false</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="nc">Decision</span><span class="o">.</span><span class="na">NO</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">ret</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">decision</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">addDecision</span><span class="o">(</span><span class="n">ret</span><span class="o">,</span> <span class="n">decision</span><span class="o">,</span> <span class="n">allocation</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>Now if we go further into the structure of the value class <code class="language-plaintext highlighter-rouge">Decision.Multi</code>,
we can see that a multi-decision is a decision container, it contains
multiple child decisions inside it:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Multi</span> <span class="kd">extends</span> <span class="nc">Decision</span> <span class="kd">implements</span> <span class="nc">ToXContentFragment</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Decision</span><span class="o">&gt;</span> <span class="n">decisions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="o">...</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>Unlike single decisions, it does not have a label and explanation. More precisely,
getting a label from a multi-decision returns <code class="language-plaintext highlighter-rouge">null</code>, and getting an explanation
throws an unsupported operation exception. In my opinion,
the <code class="language-plaintext highlighter-rouge">Decision</code> base class is too vague and we shouldn’t return null or raise an
exception. But that’s a design choice and probably does not matter as this
decider system is internal to Elasticsearch.</p>

<h2 id="lifecycle">Lifecycle</h2>

<p><em>When are deciders created? I.e. where are deciders positioned in the lifecycle of
an Elasticsearch cluster?</em></p>

<p>When starting a new node, the class <code class="language-plaintext highlighter-rouge">Bootstrap</code> is called. Before starting the
node, it creates a new <code class="language-plaintext highlighter-rouge">Node</code> instance, which creates and adds a list of modules.
One of these modules is
called <code class="language-plaintext highlighter-rouge">ClusterModule</code> and it contains the deciders. So the whole logic happens
at the early stage of the lifecycle, more precisely, the creation happens before the
startup of a node.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="s">boostrap</span>
  <span class="s">- construct node</span>
    <span class="s">- create modules</span>
      <span class="s">- create master module</span>
        <span class="s">- create deciders</span>
        <span class="s">- create root decider (AllocationDeciders)</span>
        <span class="s">- create allocation service</span>
        <span class="s">- ...</span>
    <span class="s">- add modules</span>
  <span class="s">- start node</span>
</code></pre></div></div>

<p>Now another question is: <em>when updating a setting of a cluster, do we need to restart
the node to take the new value into account?</em></p>

<p>I don’t think so. I handled such
cases many times in production and it never requires a restart. These settings are dynamic.
When looking into Elasticsearch’s source code, such as awareness allocation decider and
disk threshold decider, we can find out that the settings are passed
from the constructor of the deciders. Here are the code snippets:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">AwarenessAllocationDecider</span><span class="o">(</span><span class="nc">Settings</span> <span class="n">settings</span><span class="o">,</span> <span class="nc">ClusterSettings</span> <span class="n">clusterSettings</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">DiskThresholdDecider</span><span class="o">(</span><span class="nc">Settings</span> <span class="n">settings</span><span class="o">,</span> <span class="nc">ClusterSettings</span> <span class="n">clusterSettings</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">diskThresholdSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiskThresholdSettings</span><span class="o">(</span><span class="n">settings</span><span class="o">,</span> <span class="n">clusterSettings</span><span class="o">);</span>
    <span class="k">assert</span> <span class="nc">Version</span><span class="o">.</span><span class="na">CURRENT</span><span class="o">.</span><span class="na">major</span> <span class="o">&lt;</span> <span class="mi">9</span> <span class="o">:</span> <span class="s">"remove enable_for_single_data_node in 9"</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">enableForSingleDataNode</span> <span class="o">=</span> <span class="no">ENABLE_FOR_SINGLE_DATA_NODE</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">settings</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And the decider is subscribed to the settings update. In other words, when a setting is updated,
the decider is notified and its setting is updated as well. Here is the code for subscribing to the settings update
for disk thresholds (low watermark, high watermark, flood-stage) in class <code class="language-plaintext highlighter-rouge">DiskThresholdSettings</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">DiskThresholdSettings</span><span class="o">(</span><span class="nc">Settings</span> <span class="n">settings</span><span class="o">,</span> <span class="nc">ClusterSettings</span> <span class="n">clusterSettings</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="n">clusterSettings</span><span class="o">.</span><span class="na">addSettingsUpdateConsumer</span><span class="o">(</span><span class="no">CLUSTER_ROUTING_ALLOCATION_LOW_DISK_WATERMARK_SETTING</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">setLowWatermark</span><span class="o">);</span>
    <span class="n">clusterSettings</span><span class="o">.</span><span class="na">addSettingsUpdateConsumer</span><span class="o">(</span><span class="no">CLUSTER_ROUTING_ALLOCATION_HIGH_DISK_WATERMARK_SETTING</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">setHighWatermark</span><span class="o">);</span>
    <span class="n">clusterSettings</span><span class="o">.</span><span class="na">addSettingsUpdateConsumer</span><span class="o">(</span><span class="no">CLUSTER_ROUTING_ALLOCATION_DISK_FLOOD_STAGE_WATERMARK_SETTING</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">setFloodStage</span><span class="o">);</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>where you can see that when those cluster settings are updated, the class <code class="language-plaintext highlighter-rouge">DiskThresholdSettings</code>
sets the new value into its instance.</p>

<h2 id="testing">Testing</h2>

<p>There are three types of testing related to the deciders: 1) the tests for the
single deciders which make one decision at a time; 2) the tests for the root
decider which gathers information from multiple single decisions and makes a
multi-decision; 3) other services that depend on deciders since deciders are
part of the cluster module. And … we are going to discuss three of them right now.</p>

<p><strong>Testing a single-decision decider.</strong> To understand this, let’s take the disk threshold
decider as an example (<code class="language-plaintext highlighter-rouge">DiskThresholdDeciderTests</code>). As we saw in the previous sections “Responsibility” and
“Making Decisions”, the allocation is made using the index metadata, shard routing,
routing allocation, etc. All these data are fetched eagerly and passed as input parameters.
Therefore, it makes the test quite simple: we just need to provide this information to
a decider without mocking anything as there are no external calls. More precisely, in a test case, we:</p>

<ul>
  <li>prepare settings that are relevant to this decider</li>
  <li>create a decider instance using these settings</li>
  <li>prepare a cluster state (including index metadata, shard routing, etc) which are
necessary for making the decision</li>
  <li>create an allocation service that encapsulates the decider under test</li>
  <li>require re-routing the shards by calling the service, which asks the deciders to make the
decision behind the screen</li>
  <li>finally assert the result</li>
</ul>

<p><strong>Testing a multi-decision decider.</strong> To understand this, let’s take
<code class="language-plaintext highlighter-rouge">AllocationDecidersTests</code> as an example. In this test suite, it tests the debug mode and
the early termination. Because these expectations are not tight to any specific child
deciders, the setup simply uses some mocked deciders instantiated as anonymous classes.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="nc">AllocationDeciders</span> <span class="n">allocationDeciders</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AllocationDeciders</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">AllocationDecider</span><span class="o">()</span> <span class="o">{</span> <span class="o">...</span> <span class="o">},</span> <span class="k">new</span> <span class="nc">AllocationDecider</span><span class="o">()</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}));</span>
</code></pre></div></div>

<p><strong>Testing a service that depends on the deciders.</strong> In this case, the testing is more complex
to set up because we need to prepare the deciders. Depending on the needs of that service,
it may plug some decider during the setup phase. The easiest setup is to prepare
a no-operation decider system,
which requires an empty all-deciders decider.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClusterAllocationExplainActionTests</span> <span class="kd">extends</span> <span class="nc">ESTestCase</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">AllocationDeciders</span> <span class="no">NOOP_DECIDERS</span>
        <span class="o">=</span> <span class="k">new</span> <span class="nc">AllocationDeciders</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">());</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="going-further">Going Further</h2>

<p>How to go further from here?</p>

<ul>
  <li>To better understand what do all those deciders do, you can read another article
that I wrote last year: <a href="/2020/09/27/shard-allocation/">18 Allocation Deciders in Elasticsearch 7.9</a></li>
  <li>To better understand the disk watermarks in Elasticsearch, you can read another article
that I wrote early this year: <a href="/04/10/disk-watermarks-in-elasticsearch/">Disk Watermarks In Elasticsearch</a></li>
  <li>To better understand how to resolve unassigned shards in Elasticsearch, I suggest you
to read Datadog’s blog <a href="https://www.datadoghq.com/blog/elasticsearch-unassigned-shards/">“How to resolve unassigned shards in Elasticsearch”</a>, written by Emily Chang.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we saw the decider system for shard allocation. More precisely,
we saw that the allocation service is responsible for allocating shards and balancing shards;
we saw that there are 19 deciders in Elasticsearch 7.16 and there are two types of decisions:
single decision and multi-decision. When making a decision, a decider relies on information from the ES settings and from
cluster state (index metadata, node, routing allocation info).
The deciders are created early in the lifecycle during node bootstrap. We also saw
how the testing works for testing a single-decision decider, a multi-decision decider, and
other services that depend on deciders. Finally, I suggested some resources for you so that you can
go further from this article. Interested to know more? You can subscribe to <a href="/feed.xml">the feed of my blog</a>, follow me
on <a href="https://twitter.com/mincong_h">Twitter</a> or
<a href="https://github.com/mincong-h/">GitHub</a>. Hope you enjoy this article, see you the next time!</p>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://github.com/elastic/elasticsearch/">“Elasticsearch 7.16 source code (elastic/elasticsearch)</a>, <em>GitHub</em>, 2021.</li>
  <li><a href="https://opster.com/guides/elasticsearch/glossary/elasticsearch-shards/">“Elasticsearch Shards”</a>,
Opster, 2021.</li>
  <li>Emily Chang, <a href="https://www.datadoghq.com/blog/elasticsearch-unassigned-shards/">“How to resolve unassigned shards in
Elasticsearch”</a>,
<em>Datadog</em>, 2019.</li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2021-12-27T14:36:13+01:00"><!-- start custom article footer snippet -->


  

  

  <div class="article__ads">
    
      <div id="ea-article"
           data-ea-publisher="mincongio"
           data-ea-keywords="java|elasticsearch|system-design|search"
           data-ea-type="image">
    
    </div>
  </div>

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">Subscribe</a>
</div></div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/en/use-component-in-vue-js/">Using Component in Vue.js</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/en/shard-allocation-deciders/';
    this.page.identifier = '/en/shard-allocation-deciders';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script><script src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script>
<script>
ethicalads.wait.then((placements) => {
  if (!placements.length) {
    console.debug('Loading backup content');
    div = document.querySelector('[data-ea-publisher]')
    div.innerHTML = '<p>Check out our first-party ad content.</p>'
  } else {
    console.debug('EthicalAds are loaded');
  }
});
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

