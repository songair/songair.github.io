<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><!--
	_title: Error Retries in Temporal Workflow;
        _titles: ;
        __return: Error Retries in Temporal Workflow;
 -->
<!-- title: "Error Retries in Temporal Workflow" -->
<title>Error Retries in Temporal Workflow - Mincong Huang</title>

<meta name="description" content="This article discusses the error retries in workflow engine Temporal, including retryable and non-retryable application errors, error types in retry policy, ...">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Error Retries in Temporal Workflow | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Error Retries in Temporal Workflow" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="en" />
<meta name="description" content="This article discusses the error retries in workflow engine Temporal, including retryable and non-retryable application errors, error types in retry policy, retry policy usage in different levels, maximum attempts, and more." />
<meta property="og:description" content="This article discusses the error retries in workflow engine Temporal, including retryable and non-retryable application errors, error types in retry policy, retry policy usage in different levels, maximum attempts, and more." />
<link rel="canonical" href="https://mincong.io/en/error-retries-in-temporal/" />
<meta property="og:url" content="https://mincong.io/en/error-retries-in-temporal/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-pablo-garcia-saldana-lPQIndZz8Mo-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-09T22:08:20+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-pablo-garcia-saldana-lPQIndZz8Mo-unsplash.jpg" />
<meta property="twitter:title" content="Error Retries in Temporal Workflow" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"image":"https://mincong.io/assets/bg-pablo-garcia-saldana-lPQIndZz8Mo-unsplash.jpg","headline":"Error Retries in Temporal Workflow","description":"This article discusses the error retries in workflow engine Temporal, including retryable and non-retryable application errors, error types in retry policy, retry policy usage in different levels, maximum attempts, and more.","datePublished":"2021-10-09T22:08:20+02:00","dateModified":"2021-10-09T22:08:20+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/en/error-retries-in-temporal/"},"url":"https://mincong.io/en/error-retries-in-temporal/","author":{"@type":"Person","name":"Mincong Huang"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="1280"/>
<meta property="og:image:height" content="1920"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/en/error-retries-in-temporal/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>

          

          
          
          

          
          
          

          
          

          
          

          <a href="/">Home</a>
        </div><button class="button button--secondary button--circle search-button js-search-toggle">
            <i class="fas fa-search"></i>
          </button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/en/categories/">Categories</a></li><li class="navigation__item"><a href="/en/series/">Series</a></li><li class="navigation__item"><a href="/en/archive/">Archive</a></li><li class="navigation__item"><a href="/en/about/">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li><li>
            <a href="/cn/">
             <img src="/assets/flag-CN.png"
                  alt=""
                  class="naviation__lang_img">
            </a>
          </li>
        </ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/assets/bg-pablo-garcia-saldana-lPQIndZz8Mo-unsplash.jpg);background-color:#203028;"><div class="hero__content"><div class ="main">

  
  <div class="article__info clearfix">
      <ul class="left-col menu">
        <li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=temporal">temporal</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=go">go</a>
            </li>

        <li class="separator">|</li>
          
            <li>
              <a class="button button--circle button--primary focus lang"
                 href="/en/error-retries-in-temporal/"><span>EN</span></a>

              






              

              
            </li>
          
        
      </ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Oct 09, 2021</span>
            </li></ul></div><!--
	_title: Error Retries in Temporal Workflow;
        _titles: ;
        __return: Error Retries in Temporal Workflow;
 -->
<div class="article__header"><header><h1>Error Retries in Temporal Workflow</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">Retry or not retry?</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      
      Photo by
      <a href="https://unsplash.com/@garciasaldana_" target="_blank">Pablo García Saldaña</a>
      
      on
      <a href="https://unsplash.com/license" target="_blank">Unplash </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><!--
	_title: Error Retries in Temporal Workflow;
        _titles: ;
        __return: Error Retries in Temporal Workflow;
 -->
<meta itemprop="headline" content="Error Retries in Temporal Workflow"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2021-10-09T22:08:20+02:00">
    <meta itemprop="keywords" content="temporal,go"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h2 id="introduction">Introduction</h2>

<p>When working with Temporal to build workflows, you will have to face to error
handling at some point because workflow and activity can fail for different
reasons. Temporal Go SDK defines its <a href="https://docs.temporal.io/docs/go/error-handling/">error
handling</a> logic and <a href="https://docs.temporal.io/docs/go/retries/">activity
and workflow retries</a> in the official
documentation. But whenever I visit those pages, I always feel that
it’s missing something that I need as a developer. So I decide to write this
article, to share my understanding of error retries in Temporal in Go SDK, as a
complementary to the official documents. And hopefully, it will clarify
different situations and give you a clearer picture of how errors are retried.
This article is written with Temporal Go SDK v1.10.0 (15 Sept 2021).</p>

<p>After reading this article, you will understand:</p>

<ul>
  <li>The difference between retryable and non-retryable error at acvitity level</li>
  <li>Non-retryable error types in retry policy</li>
  <li>How to use retry policy?</li>
  <li>The maximum attempts when retrying</li>
  <li>How to write unit tests?</li>
</ul>

<p>If you don’t have time to read the entire article, here is a table for
summarizing the difference.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Scope</th>
      <th style="text-align: left">Error Type</th>
      <th style="text-align: left">Methods</th>
      <th style="text-align: left">Retryable (Default)</th>
      <th style="text-align: left">Retryable (Override)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">Activity</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ApplicationError</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">temporal.NewNonRetryableApplicationError()</code></td>
      <td style="text-align: left">No</td>
      <td style="text-align: left">-</td>
    </tr>
    <tr>
      <td style="text-align: center">Activity</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ApplicationError</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">temporal.NewApplicationError()</code></td>
      <td style="text-align: left">Yes</td>
      <td style="text-align: left">-</td>
    </tr>
    <tr>
      <td style="text-align: center">Activity</td>
      <td style="text-align: left">Other errors</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">fmt.Errorf()</code>, <code class="language-plaintext highlighter-rouge">errors.New()</code></td>
      <td style="text-align: left">Yes</td>
      <td style="text-align: left">Retry policy (activity options)</td>
    </tr>
    <tr>
      <td style="text-align: center">Top-level workflow</td>
      <td style="text-align: left">All</td>
      <td style="text-align: left">-</td>
      <td style="text-align: left">No</td>
      <td style="text-align: left">Retry policy (start workflow options)</td>
    </tr>
    <tr>
      <td style="text-align: center">Child workflow</td>
      <td style="text-align: left">All</td>
      <td style="text-align: left">-</td>
      <td style="text-align: left">No</td>
      <td style="text-align: left">Retry policy (child workflow options)</td>
    </tr>
  </tbody>
</table>

<h2 id="retryable-and-non-retryable-application-error">Retryable and Non-Retryable Application Error</h2>

<p>By default, Temporal retries activities, but not workflows. According to
official documentation <a href="https://docs.temporal.io/docs/go/error-handling/">Error Handling in
Go</a>, if the activity returns
an error as <code class="language-plaintext highlighter-rouge">errors.New()</code> or <code class="language-plaintext highlighter-rouge">fmt.Errorf()</code>, that error will be converted to
<code class="language-plaintext highlighter-rouge">*temporal.ApplicationError</code>, which is retryable. If you don’t want the error to
be retried, you can return a non-retryable application error from the activity.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">MyActivity</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="c">// retryable</span>
	<span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"oops"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">MyActivity</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="c">// retryable</span>
	<span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">temporal</span><span class="o">.</span><span class="n">NewApplicationError</span><span class="p">(</span><span class="s">"oops"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">MyActivity</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="c">// non-retryable</span>
	<span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">temporal</span><span class="o">.</span><span class="n">NewNonRetryableApplicationError</span><span class="p">(</span><span class="s">"oops"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is easy to understand: Temporal wants to provide a fault-tolerant system so
that it can retry automatically when thing goes wrong. So at activity-level,
error are retried by default, unless user asks Temporal to not retry explicitly via wrapper
method <code class="language-plaintext highlighter-rouge">temporal.NewNonRetryableApplicationError(...)</code>.</p>

<p>If we dive into the source code, you can see that
<code class="language-plaintext highlighter-rouge">ApplicationError</code> determines the retry-ability of an error using its internal
boolean attribute <code class="language-plaintext highlighter-rouge">nonRetryable</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// go.temporal.io/sdk@v1.10.0/internal/error.go</span>
<span class="k">type</span> <span class="p">(</span>
	<span class="c">// ApplicationError returned from activity implementations with message and optional details.</span>
	<span class="n">ApplicationError</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="n">temporalError</span>
		<span class="n">msg</span>          <span class="kt">string</span>
		<span class="n">errType</span>      <span class="kt">string</span>
		<span class="n">nonRetryable</span> <span class="kt">bool</span>  <span class="c">// HERE</span>
		<span class="n">cause</span>        <span class="kt">error</span>
		<span class="n">details</span>      <span class="n">converter</span><span class="o">.</span><span class="n">EncodedValues</span>
	<span class="p">}</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>One possible usecase for <code class="language-plaintext highlighter-rouge">temporal.NewNonRetryableApplicationError(...)</code> is when
interacting with a third-party service. When that service returns a
deterministic error indicating that required action cannot be performed, you may
not want to retry. For example, when a resource deletion request is rejected by
the third party service because it is still in used, you probably
don’t want to retry. Therefore, calling
<code class="language-plaintext highlighter-rouge">temporal.NewNonRetryableApplicationError(...)</code> is a good choice.</p>

<h2 id="non-retryable-error-types-in-retry-policy">Non-Retryable Error Types in Retry Policy</h2>

<p>Another way to define non-retryable error types for activity is to provide a
custom <code class="language-plaintext highlighter-rouge">RetryPolicy</code> as part of the <code class="language-plaintext highlighter-rouge">ActivityOptions</code> or <code class="language-plaintext highlighter-rouge">ChildWorkflowOptions</code>.
For example, to avoid retrying errors of type <code class="language-plaintext highlighter-rouge">MyError</code>, we can make it as
non-retryable as follows:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">MyWorkflowWithRetryPolicy</span><span class="p">(</span><span class="n">ctx</span> <span class="n">workflow</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">WithActivityOptions</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ActivityOptions</span><span class="p">{</span>
		<span class="n">StartToCloseTimeout</span><span class="o">:</span> <span class="m">10</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
		<span class="n">RetryPolicy</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">temporal</span><span class="o">.</span><span class="n">RetryPolicy</span><span class="p">{</span>
			<span class="n">InitialInterval</span><span class="o">:</span>    <span class="m">1</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
			<span class="n">BackoffCoefficient</span><span class="o">:</span> <span class="m">2</span><span class="p">,</span>
			<span class="n">MaximumInterval</span><span class="o">:</span>    <span class="m">1</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Minute</span><span class="p">,</span>
			<span class="n">MaximumAttempts</span><span class="o">:</span>    <span class="m">5</span><span class="p">,</span>
			<span class="n">NonRetryableErrorTypes</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"MyError"</span><span class="p">},</span>  <span class="c">// HERE</span>
		<span class="p">},</span>
	<span class="p">})</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>But, why Temporal has <code class="language-plaintext highlighter-rouge">NonRetryableErrorTypes</code> in Retry Policy? In my opionion,
there are several reasons:</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">temporal.NewNonRetryableApplicationError(...)</code> is not enough.</strong>
It does not fit all the usecases.
Sometime users already know the error types that they don’t want to retry, but
they don’t want to determine the error types themselves for each activity and
fire a non-retryable applicaton error, since it makes the activity verbose.</li>
  <li><strong>Bringing the control at workflow level.</strong> An activity can be used for multiple
workflows, e.g. primitive activities for GitHub, Slack, Build, Kubernetes, etc.
Depending on the case of each workflow, some may want to retry while others
don’t.</li>
  <li><strong>Retry policy is not only used by activity.</strong> It can be used as part of
the activity options, child workflow options, or event the top-level workflow
options. Since the policy controls the retry activitation, having
<code class="language-plaintext highlighter-rouge">NonRetryableErrorTypes</code> allows to refine the activiations on different
types of error.</li>
</ul>

<h2 id="using-retry-policy">Using Retry Policy</h2>

<p>Now, let’s see how to use retry policy in different cases.</p>

<h3 id="activity-options">Activity Options</h3>

<p>Enable custom retry policy as activity options:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">MyWorkflowWithRetryPolicy</span><span class="p">(</span><span class="n">ctx</span> <span class="n">workflow</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">WithActivityOptions</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ActivityOptions</span><span class="p">{</span>
		<span class="n">StartToCloseTimeout</span><span class="o">:</span> <span class="m">10</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
		<span class="n">RetryPolicy</span><span class="o">:</span>         <span class="o">&amp;</span><span class="n">retryPolicy</span><span class="p">,</span>
	<span class="p">})</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In this case, failed activities will be retried, more precisely:</p>

<ul>
  <li>Errors having type defined in <code class="language-plaintext highlighter-rouge">NonRetryableErrorTypes</code> won’t be retried</li>
  <li>Errors wrapped into non-retryable application error won’t be retried</li>
  <li>Other application errors will be retried</li>
</ul>

<h3 id="child-workflow-options">Child Workflow Options</h3>

<p>Enable custom retry policy as child workflow options:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">MyWorkflowWithChildWorkflowRetryPolicy</span><span class="p">(</span><span class="n">ctx</span> <span class="n">workflow</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">WithChildOptions</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ChildWorkflowOptions</span><span class="p">{</span>
		<span class="n">WorkflowRunTimeout</span><span class="o">:</span> <span class="m">10</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
		<span class="n">RetryPolicy</span><span class="o">:</span>        <span class="o">&amp;</span><span class="n">retryPolicy</span><span class="p">,</span>
	<span class="p">})</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In this case, failed child workflow will be retried (which is not the case by
default). The child workflow will be retried on all types of errors, except the ones
defined in <code class="language-plaintext highlighter-rouge">NonRetryableErrorTypes</code> in the retry policy.</p>

<h3 id="top-level-workflow-options">Top-Level Workflow Options</h3>

<p>Enable custom retry policy as top-level workflow options:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">startOptions</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">StartWorkflowOptions</span><span class="p">{</span>
	<span class="n">ID</span><span class="o">:</span>                  <span class="n">id</span><span class="p">,</span>
	<span class="n">TaskQueue</span><span class="o">:</span>           <span class="n">ts</span><span class="o">.</span><span class="n">taskQueueName</span><span class="p">,</span>
	<span class="n">WorkflowRunTimeout</span><span class="o">:</span>  <span class="m">20</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
	<span class="n">WorkflowTaskTimeout</span><span class="o">:</span> <span class="m">3</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
	<span class="n">RetryPolicy</span><span class="o">:</span>         <span class="o">&amp;</span><span class="n">retryPolicy</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">err</span> <span class="o">:=</span> <span class="n">ts</span><span class="o">.</span><span class="n">executeWorkflowWithOption</span><span class="p">(</span><span class="n">startOptions</span><span class="p">,</span> <span class="n">workflowFn</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
</code></pre></div></div>

<p>In this case, top-level workflow will be retried by the server on all types of
errors, except the ones defined in <code class="language-plaintext highlighter-rouge">NonRetryableErrorTypes</code> in the retry policy.</p>

<h2 id="maximum-attempts">Maximum Attempts</h2>

<p><em>For how many times is the server going to retry?</em></p>

<p>When the custom retry policy is defined, the answer is obvious: the server is
going to retry <code class="language-plaintext highlighter-rouge">MaximumAttempts</code> times, defined in the policy. If the policy is
defined, but <code class="language-plaintext highlighter-rouge">MaximumAttempts</code> is not set or set to 0, it means unlimited, and
we rely on activity <code class="language-plaintext highlighter-rouge">ScheduleToCloseTimeout</code> to stop.</p>

<p>When the custom retry policy is not defined, for activities, it means using the
default retry policy. The default RetryPolicy provided by the server specifies
(<a href="https://github.com/temporalio/sdk-go/blob/9d143aa8634807e523b3ac199a0447b9cf147e72/internal/activity.go#L127-L131">v1.10.0</a>):</p>

<ul>
  <li>InitialInterval of 1 second</li>
  <li>BackoffCoefficient of 2.0</li>
  <li>MaximumInterval of 100 x InitialInterval</li>
  <li>MaximumAttempts of 0 (unlimited)</li>
</ul>

<p>For top-level workflow or child workflow, it means that there are no
retry because by default, Temporal retries activies, but not workflows
(<a href="https://docs.temporal.io/docs/go/retries/">doc</a>).</p>

<h2 id="writing-unit-tests">Writing Unit Tests</h2>

<p>Now we understand how the error retries mechanism works, it’s time to write some
tests. Yes, writing tests because we need it: we need it to assert the retry
behavior, to assert the number of retry attempts, to assert the completion and
the result of the workflow, etc.</p>

<p>Here is an example for demonstrating that an applicaton error “oops” is
retryable and the activity is being executed twice: the first time failed and
the second time succeed.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">ts</span> <span class="o">*</span><span class="n">WorkflowTestSuite</span><span class="p">)</span> <span class="n">TestActivityError_ExplicitRetryableError</span><span class="p">()</span> <span class="p">{</span>
	<span class="c">// Given</span>
	<span class="n">executionCount</span> <span class="o">:=</span> <span class="m">0</span>
	<span class="n">ts</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">OnActivity</span><span class="p">(</span><span class="n">MyActivity</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">Anything</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">Anything</span><span class="p">)</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">executionCount</span><span class="o">++</span>
		<span class="k">if</span> <span class="n">executionCount</span> <span class="o">==</span> <span class="m">1</span> <span class="p">{</span>
			<span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">temporal</span><span class="o">.</span><span class="n">NewApplicationError</span><span class="p">(</span><span class="s">"oops"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="s">"Hello, UnitTest!"</span><span class="p">,</span> <span class="no">nil</span>
		<span class="p">}</span>
	<span class="p">})</span>

	<span class="c">// When</span>
	<span class="n">ts</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ExecuteWorkflow</span><span class="p">(</span><span class="n">MyWorkflow</span><span class="p">,</span> <span class="s">"UnitTest"</span><span class="p">)</span>

	<span class="c">// Then</span>
	<span class="n">ts</span><span class="o">.</span><span class="n">True</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">IsWorkflowCompleted</span><span class="p">())</span>

	<span class="k">var</span> <span class="n">result</span> <span class="kt">string</span>
	<span class="n">ts</span><span class="o">.</span><span class="n">NoError</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">GetWorkflowResult</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">))</span>
	<span class="n">ts</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="s">"Hello, UnitTest!"</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
	<span class="n">ts</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">executionCount</span><span class="p">,</span> <span class="s">"1st execution failed and 2nd execution succeed"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>See <a href="https://github.com/mincong-h/learning-go/pull/15">https://github.com/mincong-h/learning-go/pull/15</a> for more samples.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we saw the retryable and non-retryable application errors in
Temporal; we saw the non-retryable error tpes defined by <code class="language-plaintext highlighter-rouge">RetryPolicy</code>; we saw
how to use retry policy as activity options, child workflow options, and
start workflow options for top-level workflows; and we also discuss the maximum
attempts for retries in different cases.</p>

<p>I hope that this article gives you more insights about how error retries is done
in Temporal workflow. The source code of this article is also available on
<a href="https://github.com/mincong-h/learning-go/pull/15">GitHub</a>.
You can subscribe to the <a href="/feed.xml">feed of my blog</a>, follow me on <a href="https://twitter.com/mincong_h">Twitter</a> or <a href="https://github.com/mincong-h/">GitHub</a>. Hope you enjoy this article, see you the next time!</p>

<h2 id="references">References</h2>

<ul>
  <li>Temporal, “Activity and Workflow Retries”, <em>Temporal Documentation</em>, 2021.
<a href="https://docs.temporal.io/docs/go/retries/">https://docs.temporal.io/docs/go/retries/</a></li>
  <li>Temporal, “Error Handling in Go”, <em>Temporal Documentation</em>, 2021.
<a href="https://docs.temporal.io/docs/go/error-handling/">https://docs.temporal.io/docs/go/error-handling/</a></li>
  <li>Temporal, “Testing and Debugging”, <em>Temporal Documentation</em>, 2021.
<a href="https://docs.temporal.io/docs/go/testing/">https://docs.temporal.io/docs/go/testing/</a></li>
  <li>Temporal, “Temporal Go SDK”, <em>GitHub</em>, 2021.
<a href="https://github.com/temporalio/sdk-go">https://github.com/temporalio/sdk-go</a></li>
  <li>Temporal, “Temporal Go SDK Samples”, <em>GitHub</em>, 2021.
<a href="https://github.com/temporalio/samples-go">https://github.com/temporalio/samples-go</a></li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2021-10-09T22:08:20+02:00"><!-- start custom article footer snippet -->


  

  

  <div class="article__ads">
    
      <div id="ea-article"
           data-ea-publisher="mincongio"
           data-ea-keywords="temporal|go|automation|devops|infra"
           data-ea-type="image">
    
    </div>
  </div>

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">Subscribe</a>
</div></div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/en/elasticsearch-snapshot-repository-structure/">Internal Structure Of Snapshot Repository</a></div><div class="next"><span>NEXT</span><a href="/en/elasticsearch-snapshot-apis/">Elasticsearch Snapshot APIs</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/en/error-retries-in-temporal/';
    this.page.identifier = '/en/error-retries-in-temporal';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script><script src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script>
<script>
ethicalads.wait.then((placements) => {
  if (!placements.length) {
    console.debug('Loading backup content');
    div = document.querySelector('[data-ea-publisher]')
    div.innerHTML = '<p>Check out our first-party ad content.</p>'
  } else {
    console.debug('EthicalAds are loaded');
  }
});
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

