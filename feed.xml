<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.2.0">Jekyll</generator><link href="https://mincong.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://mincong.io/" rel="alternate" type="text/html" hreflang="en" /><updated>2021-07-11T09:30:49+02:00</updated><id>https://mincong.io/feed.xml</id><title type="html">Mincong Huang</title><subtitle>Hi, welcome to my blog! I'm a software engineer at Datadog. I write blog posts in my free time. My blogs are bits and pieces of my tech journey. Most of them are related to Java. Hope you enjoy them! My opinions are my own, not Datadog's. This blog is powered by Jekyll, a simple, blog-aware, static sites solution.
</subtitle><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><entry xml:lang="en"><title type="html">An Important Change</title><link href="https://mincong.io/2021/04/20/an-important-change/" rel="alternate" type="text/html" title="An Important Change" /><published>2021-04-20T04:40:32+02:00</published><updated>2021-04-20T04:40:32+02:00</updated><id>https://mincong.io/2021/04/20/an-important-change</id><content type="html" xml:base="https://mincong.io/2021/04/20/an-important-change/">&lt;p&gt;Hi my readers,&lt;/p&gt;

&lt;p&gt;Currently I am traveling to Tianjing (天津) and writing this article in my hotel. In
China, we cannot access to the internet the same way as others do in other
countries. So the searching experience is completely different. Because of this,
I discovered how painful it is for Chinese developers to search some
documentations for their daily work. Also, most of the people don’t speak fluent
English. Therefore, I think I should make some effort to make their lives easier.
So I want to write articles in Chinese to better help them.
Makig this decision is really hard. Because writing in Chinese means the rest of
the world won’t understand these articles anymore. But I want to try something
new.&lt;/p&gt;

&lt;p&gt;I am also writing this article to thank all those who follow my blog and give my precious
feedback. I hope my articles bring you some inspirations to your work. Thank
you!&lt;/p&gt;

&lt;p&gt;Here is my plan:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;mark&gt;Starting from this article, most of the new articles will be written in
Chinese.&lt;/mark&gt;&lt;/li&gt;
  &lt;li&gt;Existing articles won’t be deleted.&lt;/li&gt;
  &lt;li&gt;I will still use the same feed.&lt;/li&gt;
  &lt;li&gt;I will try to add a Google translater to automatically translate the content of the
article. I cannot do that right now because I don’t have access to Google…&lt;/li&gt;
  &lt;li&gt;The blog will be progressively internationalized to be more Chinese friendly.
It means that the nagivations, post metadata and footer will support both EN
and CN depending on the settings of the OS or the broswer.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Thanks for reading! Best,&lt;/p&gt;

&lt;p&gt;Mincong&lt;/p&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="review" /><category term="project" /><summary type="html">English to Chinese?</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-javier-allegue-barros-C7B-ExXpOIE-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-javier-allegue-barros-C7B-ExXpOIE-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">DVF: Real Estate Analysis For Île-de-France in 2020</title><link href="https://mincong.io/2021/04/16/dvf-real-estate-analysis-idf-2020/" rel="alternate" type="text/html" title="DVF: Real Estate Analysis For Île-de-France in 2020" /><published>2021-04-16T02:03:43+02:00</published><updated>2021-04-16T02:03:43+02:00</updated><id>https://mincong.io/2021/04/16/dvf-real-estate-analysis-idf-2020</id><content type="html" xml:base="https://mincong.io/2021/04/16/dvf-real-estate-analysis-idf-2020/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;Open data &lt;a href=&quot;https://www.data.gouv.fr/fr/datasets/demandes-de-valeurs-foncieres-geolocalisees/&quot;&gt;“Demande de valeurs foncières géolocalisées
(DVF)”&lt;/a&gt;
is an open dataset provided by the French government which collects all the
real-estate transactions since January 2014, in mainland France and the overseas
departments and territories, except in Mayotte and Alsace-Moselle. Today, we are
going to explore this dataset using Elasticsearch and Kibana. In particular, we
are going to study the real estate market of Île-de-France in 2020.&lt;/p&gt;

&lt;p&gt;After reading this article, you will understand:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The prerequisite before the analytics&lt;/li&gt;
  &lt;li&gt;The overview of the market Île-de-France&lt;/li&gt;
  &lt;li&gt;The comparison of apartments and houses&lt;/li&gt;
  &lt;li&gt;Some more specific analytics on apartments&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Globally, the idea is to see the big picture and identify some valuable factors to
study. Then step-by-step, we will go into a more specific direction to go
further in our exploration. Now, let’s get started!&lt;/p&gt;

&lt;h2 id=&quot;prerequisite&quot;&gt;Prerequisite&lt;/h2&gt;

&lt;p&gt;Before the analytics, we need to prepare the dataset. Here, I am using
&lt;a href=&quot;https://www.elastic.co/elasticsearch/&quot;&gt;Elasticsearch&lt;/a&gt; and
&lt;a href=&quot;https://www.elastic.co/kibana/&quot;&gt;Kibana&lt;/a&gt;. For those who don’t know Elasticsearch, Elasticsearch
is a distributed, RESTful search and analytics engine. As for Kibana, Kibana is
a free and open user interface that lets you visualize your Elasticsearch data
and navigate the Elastic Stack. The steps of the preparation are mainly the following
ones:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Download the dataset from &lt;a href=&quot;https://www.data.gouv.fr&quot;&gt;https://www.data.gouv.fr&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Design the data model and index them into Elaticsearch&lt;/li&gt;
  &lt;li&gt;Optimize the storage for search&lt;/li&gt;
  &lt;li&gt;Set up Kibana and create dashboards to analyze the data&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;To set up Elasticsearch, you can use Docker: just running a Docker container in
localhost and
you are ready to go. The same thing applies to Kibana.
However, you need to give the name of the Elasticsearch cluster to Kibana so that they
can be linked together. Here, I am using the names “elasticsearch-dvf” and
“kibana-dvf” to achieve that. Once the setup is done and the indexing process is finished, you can
see all the data in Elasticsearch. There are several gigabytes (GB) of data:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;➜  curl &quot;localhost:9200/_cat/indices/transactions.*&quot;
yellow open transactions.2019 ExlbB3EuQSqk__4MEW6eHQ 1 1 3142952 0 802.3mb 802.3mb
yellow open transactions.2018 1B3pKi4URDar2w0vAvPysA 1 1 3319426 0 853.3mb 853.3mb
yellow open transactions.2017 HJLTdbbtSqW686jQFzgg7g 1 1 3381190 0 862.4mb 862.4mb
yellow open transactions.2016 ZNPlUNeTStS8KsOgvaMTww 1 1 2939004 0 753.5mb 753.5mb
yellow open transactions.2015 h2CEOxWzTYymAt9KBMasJg 1 1 2750305 0 704.1mb 704.1mb
yellow open transactions.2014 17ZVk9oMQ6KmvTpMgGdMBg 1 1 2516802 0 650.7mb 650.7mb
yellow open transactions.2020 Khw7RAl1RcCDeLlz8Blt7g 1 1 2459560 0 623.5mb 623.5mb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On the Kibana side, we need to define an index pattern &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;transactions.*&lt;/code&gt; that
matches all the indices mentioned above.
Since this is not aimed to be a technical blog, I am going to skip the
technical details here. If you were interested in the entire preparation, you
can see my previous articles on the series page &lt;a href=&quot;/series/dvf&quot;&gt;“DVF”&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Starting from the next section, we are going to analyze the data of
Île-de-France, the Greater Paris area. It consists of 8 departments:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Paris (75)&lt;/li&gt;
  &lt;li&gt;Hauts-de-Seine (92)&lt;/li&gt;
  &lt;li&gt;Seine-Saint-Denis (93)&lt;/li&gt;
  &lt;li&gt;Val-de-Marne (94)&lt;/li&gt;
  &lt;li&gt;Seine-et-Marne (77)&lt;/li&gt;
  &lt;li&gt;Yvelines (78)&lt;/li&gt;
  &lt;li&gt;Essonne (91)&lt;/li&gt;
  &lt;li&gt;Val-d’Oise (95)&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;overview&quot;&gt;Overview&lt;/h2&gt;

&lt;h3 id=&quot;transactions-2020&quot;&gt;Transactions 2020&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210416-idf-mutation-count.png&quot; alt=&quot;2020 Ile-de-France mutation count&quot; /&gt;&lt;/p&gt;

&lt;p&gt;First of all, let’s take a look at the global landscape of the real estate
market of Île-de-France in 2020. There were 146,084 transactions
happened in this area with 387,425 mutations (*). From the widget above, we can
see the number of mutations over the year. The real estate market was active
despite the pandemic. However, the number of transactions was greatly reduced
between the end of March and mid-May, probably because of the first lockdown measure
taken by the French government. After that period, the market quickly regained its dynamics.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;(*) One mutation represents a transfer of ownership of a given premise. A premise
can be an apartment, a house, a cellar, etc. Each transaction contains one or
multiple mutations. For example, you can buy one apartment and one cellar in
the same transaction.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;transactions-2014-to-2020&quot;&gt;Transactions 2014 To 2020&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210416-idf-mutation-count-2014-to-2020.png&quot; alt=&quot;2014-2020 Ile-de-France mutation count&quot; /&gt;&lt;/p&gt;

&lt;p&gt;If we compare to the previous years, we can see that the market was impacted by
the COVID-19 in 2020. The total number of mutations decreased 19.5% (481,002 in 2019
vs 387,425 in 2020) in Île-de-France. Some contributing factors may be the COVID-19 measures
taken by the government (lockdown, curfew), the economic impact (partial
unemployment, complete unemployment), the psychological factor (uncertainty
about the future).&lt;/p&gt;

&lt;p&gt;Before going further, let’s spend some time understanding
which part of the dataset is the most valuable for the analysis. To do that, we
can aggregate the data per field and continue our study on the most significant ones.
Here I chose the field “nature of mutation” and the field “premise type”.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210416-idf-nature_mutation-and-local_type.png&quot; alt=&quot;2020 Ile-de-France distribution of nature of mutation and distribution of premise type&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Nature of mutation.&lt;/strong&gt; From the widget on the left side, you can see that there are several reasons
why people make a transaction: expropriation, vente terrain à bâtir
(building plot for sales), adjudication (judgement), échange (exchange), vente
(sales), and vente en l’état future d’achèvement” (sales before completion).
Most of the time it’s either “Vente” or “Vente en l’état future d’achèvement”.
That’s why I am going to focus my analysis on these two types in the following
sections.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Premise type.&lt;/strong&gt; From the widget on the right side, you can see the different types of premises
that people sell: local industriel, commercial ou assimilé (industrial,
commercial or related premise), maison (house), dépendance (dependent),
appartement (apartment), or empty. For those mutations having an empty type,
they can be meadows, lands, gardins, thickets, etc that we love but we
don’t have time to cover in this article. As for the “dependent” ones, they depend
on the main types: apartment, house, … where these mutations happen in the
same transaction. For example, a dependent can be a cellar. When someone buys an
apartment, he/she buys the cellar at the same time. So I am going to
filter them out as well.&lt;/p&gt;

&lt;p&gt;In short, we are going to look into the sales of apartments and houses in the
next sections.&lt;/p&gt;

&lt;h2 id=&quot;apartment-and-house&quot;&gt;Apartment And House&lt;/h2&gt;

&lt;h3 id=&quot;map&quot;&gt;Map&lt;/h3&gt;

&lt;p&gt;If we put all the sales of apartments and houses (first-hand and second-hand
combined) into a map, we can obtain the following result:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210416-idf-map-sales-apartments-and-houses-2020.png&quot; alt=&quot;Map: sales of apartments and houses in Ile-de-France in 2020&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This map is aggregated by the municipality (commune). The color represents the
average price per meter square (€/m2) of the municipality. You can see that the
most expensive ones are all located in Paris (75) in the middle of the map with
an average price higher than 9,449 €/m2. Other municipalities around Paris are 
also expensive, especially on the west side. These departements around Paris are
called “La Petite Couronne” (The . It consists of three departments: les
Hauts-de-Seine (92), la Seine-Saint-Denis (93), and le Val-de-Marne (94).&lt;/p&gt;

&lt;h3 id=&quot;first-hand-vs-second-hand&quot;&gt;First-Hand vs Second-Hand&lt;/h3&gt;

&lt;p&gt;If we split the market into first-hand and second-hand, you can see that they
are actually quite different. In the widgets below, we compare the first-hand
market and second-hard market for their volume in 2020. The first one is for the entire
Île-de-France and the second one is aggregated by the department.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210416-idf-bar-sales-apartments-and-houses-2020-volumes.png&quot; alt=&quot;Bar chart: volume of apartments and houses in Ile-de-France in 2020&quot; /&gt;&lt;/p&gt;

&lt;p&gt;For the entire Île-de-France, the first-hand apartments and houses represent about 1.1% of
the total mutations and the second-hand ones represent 98.9%. On the right
side, you can see the actual volume of each department. The first series (red)
is for second-hand transactions and the second series (green) is for
first-hand transactions.
As you can see,
second-hand transactions represent 99.9% of the transactions in Paris (75).
In other departments, second-hand transactions represent
about 98.5% of the market. I believe that this ratio is probably related to
COVID-19 because historically speaking, the ratio of second-hand transactions is
about 93% (2014 to 2019).&lt;/p&gt;

&lt;h3 id=&quot;second-hand&quot;&gt;Second-Hand&lt;/h3&gt;

&lt;p&gt;Now, what if we focus on the second-hand market?&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210416-idf-bar-sales-apartments-and-houses-2020-second-hand-volumes.png&quot; alt=&quot;Bar chart: volume of second-hand apartments and houses in Ile-de-France in 2020&quot; /&gt;&lt;/p&gt;

&lt;p&gt;If we focus on the second-hand market, we can see that there is almost no house
to sell in Paris (75). The entire market is filled with apartments (30,956
mutations). If you want to buy a house,
you probably need to go to the petite gouronne (92, 93, 94) or the grande
gouronne (77, 78, 91, 95). They have more offers. As for the price, Paris (75) is
still the champion with an average of 11,673 €/m2 for houses and 14,959 €/m2 for
the apartments. Les Hauts-de-Seine (92), le Val-de-Marne (94), and la
Seine-Saint-Denis (93) follow Paris (75) and take the top 4.&lt;/p&gt;

&lt;p&gt;We are reaching the end of this section. In this section, we compared the
apartments and houses in Île-de-France. We
compared the type of sales, the volume, and the price in different departments.
In the next section, we are going to explore the market of second-hand
apartments.&lt;/p&gt;

&lt;h2 id=&quot;second-hand-apartments&quot;&gt;Second-Hand Apartments&lt;/h2&gt;

&lt;h3 id=&quot;price&quot;&gt;Price&lt;/h3&gt;

&lt;p align=&quot;center&quot;&gt;
  &lt;img src=&quot;/assets/20210416-idf-line-sales-apartments-price-evolution-per-department.png&quot; alt=&quot;Line chart: median price of second-hand apartments and houses in Ile-de-France from 2016 to 2020&quot; width=&quot;700&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;First of all, let’s take a look at the price. As you can see in the graph above,
the median price of Paris is significantly higher than other departments and
the trend continues in 2020 despite the global pandemic. The podium didn’t
change in 2020: les Hauts-de-Seine (92) is still in the 2nd position and followed by
le Val-de-Marne (94) at the 3rd position. However, the price of les
Hauts-de-Seine (92) dropped significantly alongside with la Seine-et-Marne (77).
If you want to have a more detailed version of the trends displayed above, here
a table of comparison for you. In this table, there is the median price of the
second-hand apartment for each department in 2015 (5 years ago), 2019 (1 year
ago), and 2020. It allows you to better follow the department that matches your
interest.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Table: Median Price of the second-hand apartments in Île-de-France&lt;/strong&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Department&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;2015 (€/m2)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;5y Diff&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;2019 (€/m2)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;1y Diff&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;2020 (€/m2)&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;75 - Paris&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;8,098&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+35.0%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,218&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+7.0%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,933&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;92 - Hauts-de-Seine&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;5,463&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+25.6%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;6,536&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+5.0%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;6,860&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;93 - Seine-Saint-Denis&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,266&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+25.2%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,848&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+6.3%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;4,089&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;94 - Val-de-Marne&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;4,122&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+21.5%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;4,733&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+5.8%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;5,009&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;77 - Seine-et-Marne&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;2,989&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+10.3%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,176&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+3.8%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,296&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;78 - Yvelines&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,685&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+7.6%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,899&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+1.5%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,956&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;91 - Essonne&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;2,729&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+8.7%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;2,946&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+0.5%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;2,960&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;95 - Val-d’Oise&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;2,877&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+10.7%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,071&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;+3.7%&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,184&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;pieces&quot;&gt;Pieces&lt;/h3&gt;

&lt;p&gt;Another important factor to take into account is the number of pieces. A single
person, a young couple, a family with 2 children, … they probably don’t have
the same needs. That’s why I want to study the number of pieces so that you can
find out what matches you most. Here is the distribution of the transactions grouped by the number
of pieces. The first one is for the entire Île-de-France and the second one is aggregated by department:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210416-idf-composite-apartments-pieces-per-department-2020.png&quot; alt=&quot;Number of pieces for second-hand apartments and houses in Ile-de-France from 2016 to 2020&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;:warning: On the widget on the right side, the percentage is not shown in order.
The displayed order is 2, 5, 1, 3, and other. This is because
the term having the highest percentage has to be placed first in Kibana.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;You can see that T1 and T2 represent about half of the offers in the market of
the second-hand apartments. T3 and T4 represent almost the other half. There are only a few
apartments having more than 4 pieces, maybe because people prefer houses over
apartments when they need more rooms.&lt;/p&gt;

&lt;h3 id=&quot;budget&quot;&gt;Budget&lt;/h3&gt;

&lt;p&gt;We talked about the price per meter square (€/m2) and the number of pieces
inside an apartment. But we didn’t talk about the total price — how many budgets
do you have? Are you ready to spend that amount of money or make a mortgage?
To let you better understand the situation, I prepared another widget. It tells
you what you can buy with a given range of budget (200K€, 400K€, 600K€, 800K€):&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210416-idf-bar-apartments-total-price-range.png&quot; alt=&quot;Number of pieces for second-hand apartments and houses in Ile-de-France from 2016 to 2020&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The color is not great but I don’t have time to make it better. I hope that it
won’t bother you too much.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;From the widget above, we can find interesting information:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;If you have 200K€, you have a wide range of choices across all the
departments. You can buy an apartment at a reasonable price. It may not be
the best apartment that you want, but buying it will allow you to
start having your own property and stop wasting money on the apartment rent.
Based on the salary in Île-de-France and the constraint about the loan (up to 33%
net income), I think 200K€ is an important amount. Note that the choices are
much less for les Hauts-de-Seine (92) compared to other departments.&lt;/li&gt;
  &lt;li&gt;If you have 400K€, e.g. you are buying an apartment with your partner,
you can see that the range of choices is even larger. You should be able to
find something that fits your needs in each department.&lt;/li&gt;
  &lt;li&gt;For 400K€+, you can see that Paris (75) still has a lot of apartments that are
located in these ranges. They are super expensive. The buyers are probably not
normal residents but rather some real-estate investors (person or company)
or rich people. According to the Notary of France (Notaires de France), the
number of investors coming from foreign countries is not negligible. However,
the number reduced in 2020 and reached
its lowest level. For example, in the 6th district of Paris, the number
reduced from 17% in 2015 to 9.4% in Q3 2020 (&lt;a href=&quot;https://www.notaires.fr/fr/immobilier-fiscalit%C3%A9/prix-et-tendances-de-limmobilier/analyse-du-march%C3%A9-immobilier&quot;&gt;article link&lt;/a&gt;).&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;To learn more about Kibana, visit Elastic’s official website
&lt;a href=&quot;https://www.elastic.co/kibana/&quot;&gt;https://www.elastic.co/kibana/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;To learn more about Elasticsearch, visit Elastic’s official website
&lt;a href=&quot;https://www.elastic.co/elasticsearch/&quot;&gt;https://www.elastic.co/elasticsearch/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;To learn more about how to use Elasticsearch for DVF, you can visit my
previous articles of this series &lt;a href=&quot;/series/dvf&quot;&gt;“DVF”&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;To see the source code about this DVF project, you can visit my GitHub
repository &lt;a href=&quot;https://github.com/mincong-h/learning-elasticsearch&quot;&gt;mincong-h/learning-elasticsearch&lt;/a&gt;,
the source code is under the directory “demo-dvf”.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we analyzed the real estate market of Île-de-France in 2020. We
started from the global landscape and ended with a more focused analysis on the
market of second-hand apartments. We
saw the market was active in 2020 despite the pandemic. The period of March to May 2020
was difficult because of the lockdown. We saw that the number of
sales-under-completion reduced significantly in 2020 compared to last years (1%
vs 7%). As for apartments, les Hauts-de-Seine (92) was impacted by the pandemic
as the median price dropped at the end of 2020. On the other hand, the
situation is more optimistic for Paris (75): the median price of second-hand
apartments in Paris (75) increased 35.0% in 5 years and the growth continued
(7.0%) in 2020. We also saw that the 400K€ is maybe enough for the greater Paris area,
but not for Paris (75).
Interested to know more? Please subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. This will really motivate me to
write more. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;todo&quot;&gt;TODO&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;What to do the next time?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;I did this analysis for fun during my holidays and I spent 3 days on it. The
main issues were that the data preparation was very long and this is the first
time I used Kibana. Because of my limited number of day-offs, I don’t have more
time spent on it. If I can do that again in the future, here are some ideas of improvements:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Going further in the one department, e.g. Paris (75) because real estate is
highly related to geography, it does not have much added value if we only stay in
a high-level overview.&lt;/li&gt;
  &lt;li&gt;Perform a prediction-related widget to forecast the trend of a given metric.&lt;/li&gt;
  &lt;li&gt;Create a widget using a time-based comparison (e.g. comparing the same period
last year)&lt;/li&gt;
  &lt;li&gt;Annotate some widgets to better fit the analysis.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;… and you, do you have suggestions for improvements or what do you want to know more
about? Please let me know by leaving a comment 🙏&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Grégoire David, “France GeoJSON”, &lt;em&gt;github.com&lt;/em&gt;, 2018.
 &lt;a href=&quot;https://github.com/gregoiredavid/france-geojson&quot;&gt;https://github.com/gregoiredavid/france-geojson&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Notaires de France, “Marché immobilier : tendance et évolution des prix de
l’immobilier”, &lt;em&gt;notaires.fr&lt;/em&gt;, 2021. &lt;a href=&quot;https://www.notaires.fr/fr/immobilier-fiscalit%C3%A9/prix-et-tendances-de-limmobilier/analyse-du-march%C3%A9-immobilier&quot;&gt;https://www.notaires.fr/fr/immobilier-fiscalit%C3%A9/prix-et-tendances-de-limmobilier/analyse-du-march%C3%A9-immobilier&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;PwC, “Emerging Trends in Real Estate - United States and Canada 2019”, &lt;em&gt;PwC&lt;/em&gt;, 2019.
&lt;a href=&quot;https://www.pwc.com/jg/en/publications/etre_us_2019_report.pdf&quot;&gt;https://www.pwc.com/jg/en/publications/etre_us_2019_report.pdf&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Jingwen Zheng, “Second-hand apartments transactions in Île-de-France (01/2014 - 06/2020)”,
&lt;em&gt;jingwen-z.github.io&lt;/em&gt;, 2021.
&lt;a href=&quot;https://jingwen-z.github.io/second-hand-apartments-transactions-in-idf-1420/&quot;&gt;https://jingwen-z.github.io/second-hand-apartments-transactions-in-idf-1420/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="elasticsearch" /><category term="elasticsearch" /><category term="kibana" /><category term="open-data" /><summary type="html">This article studies the real estate market of Île-de-France in 2020 by exploring and visualizing the dataset DVF using Kibana. We will discuss the global landscape, the impact of COVID-19, the situation in different departments, and more.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-alexander-kagan-t9Td0zfDTwI-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-alexander-kagan-t9Td0zfDTwI-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">DVF: Aggregations</title><link href="https://mincong.io/2021/04/12/dvf-aggregations/" rel="alternate" type="text/html" title="DVF: Aggregations" /><published>2021-04-12T01:34:30+02:00</published><updated>2021-04-12T01:34:30+02:00</updated><id>https://mincong.io/2021/04/12/dvf-aggregations</id><content type="html" xml:base="https://mincong.io/2021/04/12/dvf-aggregations/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;Open data “Demande de valeurs foncières (DVF)” is an open dataset provided by
the French government which collects all the real-estate transactions since
January 2014, in mainland France and the overseas departments and territories.
In the previous DVF articles, we talked about the write path: how to index new
documents, how to optimize storage, and how to perform snapshots and restores.
Starting from this article, we are going to focus on the read path: how to
perform different search actions on this dataset.&lt;/p&gt;

&lt;p&gt;This article will focus on aggregations. Aggregations are important for your
application because it provides an overview to your users without showing any
documents in detail. It also provides information about the selection range, such
as the min/max value of a given field. This topic is also part of the &lt;a href=&quot;https://www.elastic.co/training/elastic-certified-engineer-exam&quot;&gt;Elastic
Certified Engineer
Exam&lt;/a&gt;. After
reading this article, you will understand:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;How to write and execute metric aggregation?&lt;/li&gt;
  &lt;li&gt;How to write and execute bucket aggregation?&lt;/li&gt;
  &lt;li&gt;How to write and execute aggregations that contain sub-aggregations?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;To better demonstrate the importance of aggregations in real-world scenarios, I am going to use
different examples from the DVF dataset.
This article is written in Elasticsearch 7.12 and Java 11, but most of the
concepts should be appliable to any Elasticsearch 7.x cluster. Most of the
examples are written in two formats: HTTP requests with JSON content and Java. The goal is
to let you better understand how it works even if you are not familiar with
Java.&lt;/p&gt;

&lt;h2 id=&quot;prerequisite&quot;&gt;Prerequisite&lt;/h2&gt;

&lt;p&gt;Before writing any aggregation, we need to index the dataset into Elasticsearch.
This has been done in the previous articles so I am not going to go into detail
about it in this article. If you were interested in how to do it, you can
find the previous articles under the category “Elasticsearch” of my blog, they
are prefixed by “DVF”. Once the index is ready, you can find it in the
Elasticsearch cluster via the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_cat&lt;/code&gt; indices API as “transactions”:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ curl localhost:9200/_cat/indices
yellow open transactions xMLeTfvwTYW1mdz5P85JsA 1 1 827105 0 207.3mb 207.3mb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;metric-aggregation&quot;&gt;Metric Aggregation&lt;/h2&gt;

&lt;p&gt;According to Elasticsearch documentation &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/search-aggregations-metrics.html&quot;&gt;Metrics Aggregation
(7.x)&lt;/a&gt;,
the aggregations in this family compute metrics based on values extracted in one
way or another from the documents that are being aggregated. The values are
typically extracted from the fields of the document (using the field data), but
can also be generated using scripts.&lt;/p&gt;

&lt;p&gt;Here I am going to take a simple one: the metric &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/search-aggregations-metrics-valuecount-aggregation.html&quot;&gt;value
count&lt;/a&gt;. As the name indicated,
metric &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;value_count&lt;/code&gt; shows how many documents are extracted from the aggregated
documents. To do that via REST API, we can use the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_search&lt;/code&gt; endpoint as
follows:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /transactions/_search
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;match_all&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 1&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 2&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;aggs&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;mutation_id/value_count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 3&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;value_count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 4&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;field&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;mutation_id&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 5&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we take a quick look into the HTTP request, you will see that:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;We use a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;match_all&lt;/code&gt; query, which matches all the documents of the index
“transactions” without filtering.&lt;/li&gt;
  &lt;li&gt;The number of search hits to return is set to 0. The default value is 10.
Since we don’t care about those documents, setting it to 0 simplifies the
HTTP response.&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;We use one single-value metric aggregation and name it as
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mutation_id/value_count&lt;/code&gt;. I name it using the naming convention:&lt;/p&gt;

    &lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;${field_name}/${metric_type}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;

    &lt;p&gt;so that I can understand the target field name to be aggregated and the type
of metric. But this is just a personal preference. You are free to choose the name you
want.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;The type of metric is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;value_count&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;The metric applies to field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mutation_id&lt;/code&gt;. I use this field because it is the
key of the mutation (transaction), so it is always non-null.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Sending the request above will return:&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;took&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;timed_out&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;_shards&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;total&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;successful&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;skipped&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;failed&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;hits&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;total&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;relation&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;gte&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;max_score&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;hits&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;aggregations&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;mutation_id/count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;827105&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It means that there were 827105 transactions in 2020 according to
the dataset. It matches the number of lines in the CSV file.
There is a difference of 1 line because the CSV file includes the header.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;➜  dvf git:(master u=) wc -l downloads/full.2020.csv
  827106 downloads/full.2020.csv
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, let’s see how to do the same thing in Java:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sourceBuilder&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;SearchSourceBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 1&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;aggregation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;AggregationBuilders&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;mutation_id/value_count&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;field&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;mutation_id&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 2&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;QueryBuilders&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;matchAllQuery&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 3&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;SearchRequest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 4&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;indices&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;transactions&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sourceBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;restClient&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;search&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RequestOptions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;DEFAULT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 5&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;valueCount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ValueCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getAggregations&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;mutation_id/value_count&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 6&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is almost the same thing as the HTTP request. Here we:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Create an HTTP request with a search source. The hit size is set to 0 to avoid
returning hits.&lt;/li&gt;
  &lt;li&gt;The aggregation used is the value count (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;value_count&lt;/code&gt;), named as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mutation_id/value_count&lt;/code&gt;,
targeting field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mutation_id&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;On the query side, it matches all documents without filtering.&lt;/li&gt;
  &lt;li&gt;Combining the index name and the search source, we create a search request.&lt;/li&gt;
  &lt;li&gt;We use the Java REST High Level Client to send the search request and get the
search response.&lt;/li&gt;
  &lt;li&gt;We can retrieve the aggregation from the response using the name of the
aggregation, i.e. using “mutation_id/value_count”.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;In this section, we discussed how metric aggregation works: we need to provide
the index names to be searched, the query to filter the document, and the
metrics aggregations to be performed. Now, let’s go to the next part: bucket
aggregations.&lt;/p&gt;

&lt;h2 id=&quot;bucket-aggregation&quot;&gt;Bucket Aggregation&lt;/h2&gt;

&lt;p&gt;Bucket aggregations that group documents into buckets, also called bins, based
on field values, ranges, or other criteria. In this section, we are going to use
postal code as an example: let’s see which postal code in France contains the
highest number of transactions?&lt;/p&gt;

&lt;p&gt;To answer this question, we need to prepare an HTTP request for bucket
aggregation:&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;match_all&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 1&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 2&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;aggs&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;postal_code/terms&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;terms&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 3&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;field&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;postal_code&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 4&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we take a quick look into the HTTP request, you will see the same concept as
above for the metric aggregation. This time, the bucket aggregation &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;term&lt;/code&gt; does
the following things:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;It queries all the documents in the target index.&lt;/li&gt;
  &lt;li&gt;It sets the size to 0 to avoid returning documents (hits) because we don’t need them.&lt;/li&gt;
  &lt;li&gt;This is the key of the request. It specifies the type of aggregation to
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;terms&lt;/code&gt; on field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;postal_code&lt;/code&gt;. Therefore, we can obtain a result grouped by
postal code.&lt;/li&gt;
  &lt;li&gt;It only takes the top 3 results. More precisely, there are two notions: size
and order. Here we specified the size, which means the aggregation will return 3
results. As for the order, terms aggregation returns results in descending
order by default. So the terms having the most occurrences will be returned (defaults to 10).
Therefore, combined together (size and order), this setting returns the top 3 results.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Sending the request above will return:&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;took&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;97&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;timed_out&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;_shards&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;total&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;successful&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;skipped&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;failed&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;hits&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;total&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;relation&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;gte&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;max_score&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;hits&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;aggregations&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;postal_code/terms&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;doc_count_error_upper_bound&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;sum_other_doc_count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;812333&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;doc_count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9392&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;51100&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;doc_count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2859&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;75016&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;doc_count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2521&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So the top 1 result is… missing value. Oh my god 😅 But this is the forever
pain for data scientists or whoever doing data analytics, isn’t it? If
we filter out that result, then the top 1 goes to Reims (51100) and the top 2
goes to Paris 16e district (75016).&lt;/p&gt;

&lt;p&gt;And here is the implementation in Java. I am not going to explain this code
block because it’s pretty straightforward:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sourceBuilder&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;SearchSourceBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;aggregation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;AggregationBuilders&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;terms&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;postal_code/terms&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;field&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;postal_code&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;QueryBuilders&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;matchAllQuery&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;SearchRequest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;indices&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;transactions&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sourceBuilder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;restClient&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;search&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RequestOptions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;DEFAULT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;terms&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ParsedStringTerms&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getAggregations&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;postal_code/terms&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;countPerPostalCode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;terms&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getBuckets&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;stream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ParsedBucket&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;nc&quot;&gt;Collectors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;toMap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;nl&quot;&gt;ParsedBucket:&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getKeyAsString&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;nl&quot;&gt;ParsedBucket:&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getDocCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this section, we saw how to create a bucket aggregation using terms
aggregations and field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;postal_code&lt;/code&gt;. But all we saw are very primitive examples and they
didn’t provide much added value for data analytics. In the following sections, I
want to share something more interesting with you, such as: &lt;mark&gt;what is the average
price of a second-hand apartment in Paris?&lt;/mark&gt; Before answering this question, we will
need to compute the price per square meter (€/m2). I will show you how to do
that in the next section. And then, we will do the analysis for Paris.&lt;/p&gt;

&lt;h2 id=&quot;scripted-metric-aggregation&quot;&gt;Scripted Metric Aggregation&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;How to compute the price per square meter (€/m2)?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Our current goal is to compute the price per square meter for each apartment sold.
We can do that by doing simple math:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;price_m2 = total_price / built-up area
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are mainly 3 choices to compute this field:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Do it at index-time: when we create the new document in Elasticsearch, we can
compute a field in our value class in Java. This is useful when we know
exactly what we need in advance.&lt;/li&gt;
  &lt;li&gt;Do it at runtime: update the index mapping to include a new scripted field.
This will apply to all the documents. This is useful when we don’t know what
additional fields we need when indexing documents. It provides flexibility to modify documents
at runtime. Especially useful for end-users.&lt;/li&gt;
  &lt;li&gt;Do it at query-time: create the field when running the query. This is probably
the most expensive one but it fits the on-demand requirement. Sometimes we
don’t want to keep one additional field forever because it’s only useful for
some queries.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;For now, I am going to use choice 3 because it fits the current article
which is about search. To prepare the scripted metric aggregation, we need to
provide a runtime mapping &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;price_m2&lt;/code&gt;, which is computed by two existing fields:
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;property_value&lt;/code&gt; and the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;real_built_un_area&lt;/code&gt;. It looks like this:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /transactions/_search
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;runtime_mappings&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;price_m2&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;double&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;emit(doc['property_value'].value / doc['real_built_up_area'].value)&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The script is written in “Painless Script”. Be careful about the logic that you
are going to add to this script because it is easy to change from painless to
painful 🙂. If you want to know more about Painless, visit Elasticsearch
documentation: &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/painless/master/painless-lang-spec.html&quot;&gt;Painless Language
Specification&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Now, going back to our scripted metric, we will need to handle some corner cases
because the property value or real built-up area may be missing or equal to 0. I
filtered them out in the “query” section of the aggregation. Also, we need to
filter the nature of the transaction (mutation) to select only the sales. Other
types like expropriation, exchange, judgement are not what we want. To simplify a
bit, I also excluded the category “sales under construction”. The final HTTP
request looks like this:&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 1&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;mutation_nature&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Vente&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;local_type&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Appartement&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;property_value&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;gt&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;real_built_up_area&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;gt&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;runtime_mappings&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 2&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;price_m2&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;double&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;emit(doc['property_value'].value / doc['real_built_up_area'].value)&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 3&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;aggs&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;   &lt;span class=&quot;c1&quot;&gt;// 4&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;price_m2/stats&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;stats&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;field&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;price_m2&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we take a quick look into the HTTP request, you will see the same concept
again, as above for the metric aggregation and bucket aggregation. This time,
the metric aggregation term does the following things:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;It does not query all the documents anymore. It contains multiple filters,
encapsulated in a boolean query.&lt;/li&gt;
  &lt;li&gt;It defines a runtime mapping for field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;price_m2&lt;/code&gt;, computed from property
value and real built-up area.&lt;/li&gt;
  &lt;li&gt;It sets the size to 0 to avoid returning documents (hits) because we don’t need them.&lt;/li&gt;
  &lt;li&gt;This is the key of the request. It specifies the type of aggregation. We use
multi-valued metric aggregation &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stats&lt;/code&gt;, which returns the min, max, average,
sum, and count of the field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;price_m2&lt;/code&gt; in the selected documents.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Sending the request above will return:&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;took&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;timed_out&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;_shards&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;total&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;successful&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;skipped&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;failed&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;hits&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;total&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;relation&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;gte&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;max_score&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;hits&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;aggregations&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;price_m2/stats&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;147763&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;min&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.003750000149011612&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;8166666.666666667&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;avg&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;26941.800127837614&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;3981001212.2896695&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;transactions-in-paris&quot;&gt;Transactions In Paris&lt;/h2&gt;

&lt;p&gt;Now we have all the elements that we need, it’s time to do something fun! We
know how to execute a multi-valued metric aggregation, e.g. stats. We know how
to execute a bucket aggregation, e.g. per postal code. We know how to compute a
scripted metric for the price per meter square (m2). Now, let’s
use them to do a quick case study for Paris. This section aims to answer two questions:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;What is the price for second-hand apartments in Paris per district
(arrondissement)?&lt;/li&gt;
  &lt;li&gt;What is the price for second-hand apartments in Paris per type of apartment (T1,
T2, T3, …)?&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;To answer the first question, we need to use sub-aggregations with 2 levels. The first
level is a terms aggregation per postal code and the second level is a list of
multi-valued metric aggregations: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;percentiles&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stats&lt;/code&gt;. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;percentiles&lt;/code&gt; for
price per square meter and
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stats&lt;/code&gt; for the total property value.&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;must&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;wildcard&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;postal_code&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;75*&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;mutation_nature&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Vente&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;local_type&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Appartement&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;property_value&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;gt&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;real_built_up_area&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;gt&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;runtime_mappings&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;price_m2&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;double&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;emit(doc['property_value'].value / doc['real_built_up_area'].value)&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;aggs&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;postal-code-aggregation&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;terms&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;field&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;postal_code&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;20&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;aggs&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;price_m2/percentiles&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;percentiles&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;field&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;price_m2&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;property_value/percentiles&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;stats&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;field&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;property_value&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Sending the request above will return:&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;aggregations&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;postal-code-aggregation&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;doc_count_error_upper_bound&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;sum_other_doc_count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;buckets&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;75018&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;doc_count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1740&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;property_value/stats&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1740&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;min&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.15000000596046448&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9278000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;avg&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;685657.4655678796&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1193043990.0881104&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;price_m2/percentiles&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;values&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
              &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;38.31908831908832&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
              &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;5.0&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;4263.305322128852&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
              &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;25.0&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;8581.576948155804&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
              &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;50.0&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;10221.628370766353&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
              &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;75.0&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;12191.63493555511&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
              &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;95.0&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;62619.36339522546&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
              &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;99.0&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;205629.62962962964&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;75017&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;doc_count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1411&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;property_value/stats&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;price_m2/percentiles&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we transform the response a bit, we can obtain the following tables.&lt;/p&gt;

&lt;h3 id=&quot;total-price-per-district&quot;&gt;Total Price Per District&lt;/h3&gt;

&lt;p&gt;Here is the total price per district in Paris in percentiles: p5, p25, p50, p75,
p95. You can see that the 8th district (&lt;mark&gt;75008&lt;/mark&gt;) is the most
expensive for most of the percentiles. 50% of the apartments are more expensive
than 1.3M€ 🤯.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;Postal Code&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p5 (€)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p25 (€)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p50 (€)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p75 (€)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p95 (€)&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75001&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;41,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;404,794&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;691,666&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,740,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;7,005,000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75002&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;45,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;278,350&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;496,075&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;970,392&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;18,500,000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75003&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;610&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;319,583&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;541,163&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,095,193&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,550,000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75004&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;16,100&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;350,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;595,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,030,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;2,171,100&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75005&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;86,722&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;303,805&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;500,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;852,500&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,746,600&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75006&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;103,500&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;389,867&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;729,260&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,504,999&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,408,400&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75007&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;146,600&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;452,985&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;845,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,854,400&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;6,000,000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;mark&gt;75008&lt;/mark&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;19,310&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;433,250&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;&lt;mark&gt;1,299,950&lt;/mark&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,323,542&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;33,100,000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75009&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;80,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;301,325&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;551,894&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,148,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;6,300,000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75010&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;106,499&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;295,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;486,668&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;837,383&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,716,667&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75011&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;122,505&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;272,264&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;436,082&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;719,349&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,320,000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75012&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;124,172&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;290,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;432,585&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;680,481&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,150,000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75013&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;148,800&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;280,867&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;424,521&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;609,400&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,378,005&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75014&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;149,250&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;310,500&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;494,981&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;770,160&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,104,743&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75015&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;154,400&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;316,764&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;471,024&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;699,333&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,280,571&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75016&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;118,915&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;395,990&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;781,012&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,400,268&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,500,000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75017&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;97,013&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;312,448&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;562,425&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,199,034&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;13,230,000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75018&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;87,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;237,636&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;371,317&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;586,359&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;2,800,000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75019&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;117,750&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;262,500&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;353,613&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;540,250&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,018,594&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75020&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;134,060&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;248,990&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;407,585&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;636,100&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;8,500,000&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;price-per-m2-per-district&quot;&gt;Price Per M2 Per District&lt;/h3&gt;

&lt;p&gt;But using the total price of the apartment is not objective for judging whether
the appartment is expensive because they don’t have the same real built-in area
(m2). So we should normalize it. We can normalize it by calculating the price per meter square (€/m2). It
gives another table:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;Postal Code&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p5 (€/m2)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p25 (€/m2)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p50 (€/m2)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p75 (€/m2)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p95 (€/m2)&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75001&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;729&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,591&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;14,208&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;26,602&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;231,818&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75002&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,492&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,853&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,505&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;15,586&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;391,045&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75003&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;14&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,144&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;13,308&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;17,131&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;167,899&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75004&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;343&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,405&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;13,077&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;15,448&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;32,767&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75005&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;2,616&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,004&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,679&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;15,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;30,905&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;mark&gt;75006&lt;/mark&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,348&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,679&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;&lt;mark&gt;15,492&lt;/mark&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;19,666&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;49,035&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;mark&gt;75007&lt;/mark&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;7,114&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,857&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;&lt;mark&gt;15,236&lt;/mark&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;20,179&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;130,105&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75008&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;260&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,715&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;13,301&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;39,951&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;919,444&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75009&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;2,925&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,208&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,207&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;14,734&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;342,463&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75010&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;5,331&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,570&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,174&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;13,747&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;128,161&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75011&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;6,140&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,787&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,167&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;13,078&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;198,674&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75012&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;5,222&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,015&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,264&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,669&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;84,290&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75013&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;5,010&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;8,345&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,769&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,386&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;56,522&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75014&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;6,389&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,378&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,805&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,948&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;318,546&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75015&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;6,994&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,546&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,762&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,066&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;17,901&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75016&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;4,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,910&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,504&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;13,810&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;28,489&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75017&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;4,152&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,967&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,700&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;14,165&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;181,150&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75018&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;4,263&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;8,582&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,222&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,192&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;62,619&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75019&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;5,204&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;7,294&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,060&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,579&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;30,095&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;75020&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;5,390&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;8,347&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,664&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,538&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;234,160&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;You can see that not only the 8th district (75008), but all the districts from
1th to 8th are very expensive. In particular, the median (percentile 50) of 6th
district (&lt;mark&gt;75006&lt;/mark&gt;) and 7th district (&lt;mark&gt;75007&lt;/mark&gt;) are higher
than 15k€/m2.&lt;/p&gt;

&lt;h3 id=&quot;prices-per-lot-type&quot;&gt;Prices Per Lot Type&lt;/h3&gt;

&lt;p&gt;In the previous tables, we use bucket aggregation on postal code. But we can
also analyze from another angle: the lot type (T1, T2, T3, T4, …). T1 means
there is only 1 piece in the apartment, T2 means there are 2 pieces, etc.
This type of analysis is useful because different people have different needs in
their lives. Young people probably want
to save some money and buy a small apartment, but a family probably wants a better
one (T3+) because they need more room for the babies, etc. Using the runtime
mappings (painless script) we saw before, we can compute the lot type as part
of the search aggregation request
and obtain the following tables.&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;runtime_mappings&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;price_m2&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;double&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;emit(doc['property_value'].value / doc['real_built_up_area'].value)&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;lot_type&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;keyword&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;if (0 &amp;lt; doc['lots_count'].value &amp;amp;&amp;amp; doc['lots_count'].value &amp;lt; 6) { emit('T' + doc['lots_count'].value) } else { emit('Others') }&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The prices per lot type in Paris in percentiles:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;Lot Type&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p5 (€)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p25 (€)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p50 (€)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p75 (€)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p95 (€)&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;T1&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;31,264&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;210,041&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;358,500&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;600,600&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,565,087&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;T2&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;179,993&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;338,870&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;&lt;mark&gt;517,788&lt;/mark&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;792,894&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,702,597&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;T3&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;162,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;372,188&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;618,806&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,232,125&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;2,740,950&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;T4&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;147,470&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;&lt;mark&gt;414,250&lt;/mark&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;699,413&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,222,750&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,173,845&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;T5&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;331,108&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;530,791&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;809,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;1,275,048&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,220,000&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;Others&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;262,500&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;2,880,000&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;5,712,857&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,572,222&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;33,100,000&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;From the table above, we can see that it will be very hard to find an apartment if
your budget is below &lt;mark&gt;400,000€&lt;/mark&gt;. It means that either you have a wonderful job or
you will have to the house with your partner. Or maybe with some luck you won the
loto 😉. Anyway it’s very expensive.&lt;/p&gt;

&lt;p&gt;We can also normalize the price as we did before. Here is the price per meter square (€/m2) in Paris per lot type in percentiles:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;Lot Type&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p5 (€/m2)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p25 (€/m2)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p50 (€/m2)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p75 (€/m2)&lt;/th&gt;
      &lt;th style=&quot;text-align: right&quot;&gt;p95 (€/m2)&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;T1&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;840&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;8,936&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,857&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;13,118&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;31,321&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;T2&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;6,235&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,246&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,742&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,545&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;19,277&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;T3&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;5,763&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,679&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,488&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;13,572&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;23,407&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;T4&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;3,047&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;9,251&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;11,021&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;13,586&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;22,644&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;T5&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;8,169&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;10,498&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;12,649&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;15,878&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;37,168&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;Others&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;6,250&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;63,372&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;147,957&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;300,013&lt;/td&gt;
      &lt;td style=&quot;text-align: right&quot;&gt;916,866&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;From this table, we can see that regardless the number of pieces you want (the
lot type), the price per meter square (m2) does not change much. The lot type is
not an important factor for the price. The district is probably more important
as we saw in the previous sections.&lt;/p&gt;

&lt;p&gt;Alright, we go far enough into the Paris real-estate market. It’s
crazy and it’s not for us right now. Let’s come back to the aggregations
of Elasticsearch and we are reaching the end of this article.&lt;/p&gt;

&lt;h2 id=&quot;recapitulation&quot;&gt;Recapitulation&lt;/h2&gt;

&lt;p&gt;We saw several metric and bucket aggregations in this article, but we didn’t
see all of them. There are so many metrics in Elasticsearch that we cannot
remember everything. For me, the takeover is the syntax of the aggregation API.
Once you remember this, it’s easy to search on the internet and complete the rest:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /{index_name_expression}/_search
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;{query_type}&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;runtime_mappings&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;{mapping_name}&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;aggs&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;{aggregation_name}&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;{aggregation_type}&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;field&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;{field_name}&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The API path contains the name of the index to be searched. It can also be multiple
indices separated by comma (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;,&lt;/code&gt;) or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_all&lt;/code&gt; indices. As for the API request body,
it consists of multiple parts: the query part where you can specify the criteria
of the selection; the size part where you can specify the number of search hits
returned (actual documents found in Elasticsearch); the runtime mappings part
to define one or multiple computed fields at query time; and finally the
aggregations part where you can define your metric or bucket aggregation. You
can also provide sub-aggregations under a given aggregation.&lt;/p&gt;

&lt;p&gt;As for the response:&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;took&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;timed_out&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;_shards&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;hits&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;aggregations&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;price_m2/stats&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;147763&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;min&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.003750000149011612&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;8166666.666666667&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;avg&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;26941.800127837614&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;3981001212.2896695&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It contains some metadata about the search settings and performance, such as the
execution time, the timeout, the number of shards reached. Then, it contains the
number of hits and the actual documents. And finally the aggregations, each
aggregation is a key-value pair in the JSON response, where the key is the name
of the aggregation we specified and the value is the actual result of the
aggregation. As for the structure of the aggregation result:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;For metric aggregation, the actual result is the metric. There is one metric
if this is a single-valued metric; there are multiple metrics if this is a
multi-valued metric.&lt;/li&gt;
  &lt;li&gt;For bucket aggregation, the actual results are shown under entry &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;buckets&lt;/code&gt;.
Each bucket contains the key, the number of documents found, and the actual
metric(s) requested.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We can also see it from another angle by comparing the syntax of Elasticsearch
Aggregations API to SQL. They are
not exactly equivalent, but I believe this comparison is helpful for
understanding:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Item&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;SQL&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Elasticsearch&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Comment&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Source&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FROM {source_table}&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Index name&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;You can select multiple indices in Elasticsearch but you cannot do that in SQL without JOIN.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Metric&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SELECT my_func(my_field)&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Name of the aggregation&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Aggregation&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GROUP BY my_field&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&quot;field&quot;: {my_field}&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Query&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;WHERE {clause}&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&quot;query&quot;: {clause}&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Size&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;-&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&quot;size&quot;: {size}&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;There are no equivalent. In SQL, you cannot GROUP BY and select all the fields of some documents at the same time.&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;To learn more about aggregations for Elasticsearch 7, visit official
documentation &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/search-aggregations.html&quot;&gt;“Aggregations
(7.x)”&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;To learn more about boolean query for Elasticsearch 7, visit official
documentation &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/query-dsl-bool-query.html&quot;&gt;“Boolean query (7.x)”&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;To learn more about dataset “Demandes de valeurs foncières géolocalisées”,
visit the website of the French government
&lt;a href=&quot;https://www.data.gouv.fr/fr/datasets/demandes-de-valeurs-foncieres-geolocalisees/&quot;&gt;etalab&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;To learn how to earn 1M€ and buy an apartment in Paris? Well, I want to know
as well. Please let me know if you have an answer by leaving a comment below. 😬&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If you are interested to see the source code, you can also find it on my GitHub
under project
&lt;a href=&quot;https://github.com/mincong-h/learning-elasticsearch/tree/blog-dvf-aggregations/demo-dvf&quot;&gt;mincong-h/learning-elasticsearch&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we saw how to use metric aggregation using an example of
value-count aggregation, how to use bucket aggregation for postal code via
terms aggregation, and how to use
scripted aggregation by computing the metric of price per square meter (m2). We
also saw how to perform an aggregation that contains sub-aggregations (stats and
percentiles) using Paris real-estate market as a demo. Finally, we saw how to
remember the syntax efficiently and how to go further from here.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Elasticsearch, “Value count aggregation”, &lt;em&gt;elastic.co&lt;/em&gt;, 2021.
&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/search-aggregations-metrics-valuecount-aggregation.html&quot;&gt;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/search-aggregations-metrics-valuecount-aggregation.html&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Elasticsearch, “Elastic Certified Engineer Exam”, &lt;em&gt;elastic.co&lt;/em&gt;, 2021.
&lt;a href=&quot;https://www.elastic.co/training/elastic-certified-engineer-exam&quot;&gt;https://www.elastic.co/training/elastic-certified-engineer-exam&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Jingwen Zheng, “Second-hand apartments transactions in Paris (01/2014 -
06/2020)”, &lt;em&gt;jingwen.github.io&lt;/em&gt;, 2021. &lt;a href=&quot;https://jingwen-z.github.io/second-hand-apartments-transactions-in-paris-1420/&quot;&gt;https://jingwen-z.github.io/second-hand-apartments-transactions-in-paris-1420/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="elasticsearch" /><category term="elasticsearch" /><category term="java" /><summary type="html">How to write and execute metric and bucket aggregations in Elasticsearch for dataset: Demandes de valeurs foncières (DVF) for data analytics. Also, how to execute aggregations that contain sub-aggregations.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-henrique-ferreira-ZyYsY0ez2D4-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-henrique-ferreira-ZyYsY0ez2D4-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Elasticsearch: Generate Configuration With Python Jinja 2</title><link href="https://mincong.io/2021/04/11/elasticsearch-generate-configuration-with-python-jinja2/" rel="alternate" type="text/html" title="Elasticsearch: Generate Configuration With Python Jinja 2" /><published>2021-04-11T02:31:10+02:00</published><updated>2021-04-11T02:31:10+02:00</updated><id>https://mincong.io/2021/04/11/elasticsearch-generate-configuration-with-python-jinja2</id><content type="html" xml:base="https://mincong.io/2021/04/11/elasticsearch-generate-configuration-with-python-jinja2/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;When hosting multiple Elasticsearch clusters in production, you will
probably face a problem about cluster provisioning: how can we generate the
configuration for Elasticsearch in a consistent way? There are many factors to
be taken into account: the cloud providers, the instance types, the network
settings, the products or the customers for which the cluster is running, the
version of Elasticsearch, the architecture of Elasticsearch (hot/warm/cold),
etc. Therefore, it’s important to have a tool that helps you and avoid spending
time doing this manually. It is not only about spending time, it is also
about reducing human errors and being consistent for different settings.&lt;/p&gt;

&lt;p&gt;Choosing a templating engine is a good solution. It allows you to have an
automated solution at a reasonable cost. You can start small and add more
complex logic in the future. In this article, we are going to explore one
popular templating engine in Python: Jinja 2. We will see how easy it is to use
and explore some more advanced use-cases. After reading this article, you will
understand:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;What is Jinja?&lt;/li&gt;
  &lt;li&gt;How to use it to generate configuration, such as for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;elasticsearch.yml&lt;/code&gt;?&lt;/li&gt;
  &lt;li&gt;How to use Python class for more complex logic?&lt;/li&gt;
  &lt;li&gt;Going further into Jinja: understanding its core features&lt;/li&gt;
  &lt;li&gt;Testing&lt;/li&gt;
  &lt;li&gt;How to go further from here?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now, let’s get started!&lt;/p&gt;

&lt;h2 id=&quot;what-is-jinja&quot;&gt;What is Jinja?&lt;/h2&gt;

&lt;p&gt;Jinja is a modern and designer-friendly templating language for Python.
Jinja is designed to be flexible, fast, and secure. To use Jinja, you can declare
the following requirement in your &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;requirements.txt&lt;/code&gt; file:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Jinja2 == 2.11.3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or declare the following requirement in your &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Pipfile&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nn&quot;&gt;[packages]&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;Jinja2&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;==2.11.3&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I recommend using a fixed version to avoid potential issues with the
requirements. But you can remove it if you don’t feel that it is necessary.&lt;/p&gt;

&lt;h2 id=&quot;generating-configuration&quot;&gt;Generating Configuration&lt;/h2&gt;

&lt;p&gt;In our case, if we want to generate the configuration for Elasticsearch, such as for
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;elasticsearch.yml&lt;/code&gt;, it can be as easy as:&lt;/p&gt;

&lt;div class=&quot;language-yml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# template: elasticsearch.yml.j2&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;cluster.name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;{{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;cluster_name&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;}}&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;node.name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;{{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;node_name&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;}}&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;network.host&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0.0.0.0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;… where we inject two variables &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cluster_name&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;node_name&lt;/code&gt; to the template
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;elasticsearch.yml.j2&lt;/code&gt;. But having a template is not enough, we also need the
Python code which injects the variables into the template to render the actual
result. In my demo, I am using the following structure, where the templates are
stored in a separated directory called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;templates&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;➜  jinja2 git:(jinja2 u=) tree .
.
├── es_config_generator.py
└── templates
    └── elasticsearch.yml.j2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On the generator side, the code is simple as well. It accepts the two
variables: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cluster_name&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;node_name&lt;/code&gt; as input. Then, it locates the
template directory from relative path &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;./templates&lt;/code&gt; and creates a Jinja
environment for it. Finally, it locates the template and renders it by
passing all the variables as input parameters:&lt;/p&gt;

&lt;div class=&quot;language-py highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;os&lt;/span&gt;

&lt;span class=&quot;kn&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;jinja2&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FileSystemLoader&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Environment&lt;/span&gt;


&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;render_config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cluster_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;template_dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dirname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;__file__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;templates&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;env&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Environment&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;loader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FileSystemLoader&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;template_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;template&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get_template&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;elasticsearch.yml.j2&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cluster_name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cluster_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node_name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks to this method, we can generate an Elasticsearch configuration file like
this:&lt;/p&gt;

&lt;div class=&quot;language-yml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;cluster.name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;es-demo&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;node.name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;es-demo-data-1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;network.host&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0.0.0.0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And starting an Elasticsearch node with this custom configuration will work (you
can see the entry &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;name&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cluster_name&lt;/code&gt; in the HTTP response:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--rm&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; discovery.type&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;single-node &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 9200:9200 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;HOME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/custom.elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml&quot;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  docker.elastic.co/elasticsearch/elasticsearch:7.12.0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET localhost:9200
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;es-demo-data-1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;cluster_name&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;es-demo&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;cluster_uuid&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;2qiANXx0SIO4HTG9FD_QPg&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;version&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;number&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;7.12.0&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;build_flavor&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;default&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;build_type&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;docker&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;build_hash&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;78722783c38caa25a70982b5b042074cde5d3b3a&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;build_date&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;2021-03-18T06:17:15.410153305Z&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;build_snapshot&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;lucene_version&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;8.8.0&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;minimum_wire_compatibility_version&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;6.8.0&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;minimum_index_compatibility_version&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;6.0.0-beta1&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;tagline&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;You Know, for Search&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the sample above, we saw how to handle the logic in a simple way. That is, to
pass all the variables one after another into the template to render the result.
It works well for small projects. But when the project grows and you need to
accept more and more complex logic, you will need a better solution. In this
case, it comes to two choices:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Using more complex logic in the template: for-loops, if-statements, filters,
etc.&lt;/li&gt;
  &lt;li&gt;Using more complex logic in Python scripts and keep the templating part simple.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;I prefer the second choice because I do not like having complex logic in a
template file. It makes things hard to read and hard to test. The structure of
the file can become unclear when the logic grows. On the other side, using
more complex logic in Python scripts is easy to test because we can extract a
function, where the outputs are the template variables. It
splits the processing and the rendering into two parts. In the following
sections, I am going to explain how to use Python class to represent more
complex logic. Then, I will also represent more features about Jinja 2, just in
case you think choice 1 is better or you already have templates like
this and have to deal with them.&lt;/p&gt;

&lt;h2 id=&quot;using-python-class&quot;&gt;Using Python Class&lt;/h2&gt;

&lt;p&gt;One effective way to manage the complexity is to group several variables
together as a class. Or a class nested into another. Therefore, you need to pass
one object (one instance of that class) rather than passing multiple variables
for the template rendering. For example, we can modify the variable from
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cluster_name&lt;/code&gt; to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cluster.name&lt;/code&gt; so that we only need to pass the object
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cluster&lt;/code&gt;. And the same for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;node&lt;/code&gt;. The new template can look like this:&lt;/p&gt;

&lt;div class=&quot;language-yml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;cluster.name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;{{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;cluster.name&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;}}&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;node.name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;{{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;node.name&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;}}&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;network.host&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0.0.0.0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the associated data classes in Python:&lt;/p&gt;

&lt;div class=&quot;language-py highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kn&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;dataclasses&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dataclass&lt;/span&gt;


&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dataclass&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ClusterConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;


&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dataclass&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;NodeConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then, the generator is changed a bit. You can see that we create the named
tuples &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cluster&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;node&lt;/code&gt; before passing them to the template rendering.&lt;/p&gt;

&lt;div class=&quot;language-py highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;render_config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cluster_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;template_dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dirname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;__file__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;templates&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;env&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Environment&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;loader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FileSystemLoader&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;template_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;template&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get_template&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;elasticsearch.yml.v2.j2&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# create data classes before rendering
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;cluster&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ClusterConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cluster_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NodeConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sa&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cluster_name&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;-data-&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node_id&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cluster&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cluster&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here my example is almost useless. But imagine a situation where you need to add
if-statements, compute multiple fields, add validation, etc. It will make more
sense in those situations.&lt;/p&gt;

&lt;p&gt;You may also ask: why do we use data class? Because it implements
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;__hash__()&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;__eq__()&lt;/code&gt;, and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;__repr__()&lt;/code&gt;. Also, you don’t need to create the
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;__init__()&lt;/code&gt; function anymore. So I believe it is much better than a regular
class. You can see more information in &lt;a href=&quot;https://www.python.org/dev/peps/pep-0557/&quot;&gt;PEP 557 – Data Classes&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;basic-features-of-jinja-2&quot;&gt;Basic Features of Jinja 2&lt;/h2&gt;

&lt;p&gt;Here are some basic features of Jinja 2 that are useful for many templates. But
of course, Jinja is much more powerful than that. I will explain that later on.&lt;/p&gt;

&lt;p&gt;If statement:&lt;/p&gt;

&lt;div class=&quot;language-yml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;pi&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;if node_name %&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;node.name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;{{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;node_name&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;}}&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;endif %&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For loop:&lt;/p&gt;

&lt;div class=&quot;language-yml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;discovery.seed_hosts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;for seed_host in seed_hosts %&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;{{&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;seed_host&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;}}&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;endfor %&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Comment:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;{# Comment goes here #}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Comparison:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;Operator&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Description&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;==&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Compares two objects for equality.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;!=&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Compares two objects for inequality.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;gt;&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;true if the left hand side is greater than the right hand side.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;gt;=&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;true if the left hand side is greater or equal to the right hand side.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;true if the left hand side is lower than the right hand side.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;=&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;true if the left hand side is lower or equal to the right hand side.&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Logic:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;Operator&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Description&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;and&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Return true if the left and the right operand are true.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;or&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Return true if the left or the right operand are true.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;not&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;negate a statement.&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;If you want to know more about Jinja 2, I suggest you visit to following
documents:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;a href=&quot;https://jinja.palletsprojects.com/en/2.11.x/templates/&quot;&gt;Jinja - Template Designer Documentation
(v2.11)&lt;/a&gt;. Not only you can
find all the expressions listed above, but much more than that, such as
variables, white space control, template inheritance, HTML escaping, filters.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://jinja.palletsprojects.com/en/2.11.x/api/&quot;&gt;Jinja - API (v2.11)&lt;/a&gt;.
Here you will find different APIs in Python. You will need them to integrate
Jinja into your Python scripts.&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;testing&quot;&gt;Testing&lt;/h2&gt;

&lt;p&gt;I believe testing is an important part of the generation. It is an effective way
to ensure the correctness of the results. There are two ways to test:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Testing the data classes&lt;/li&gt;
  &lt;li&gt;Testing the final rendered result&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The first way, testing the data class, is useful when the data models are
present in the Python scripts and when you have complex processing logic there:
validation, computed fields, etc. But testing it does not verify the actual
rendering in the templates.&lt;/p&gt;

&lt;p&gt;The second way, testing the final rendered result, is an end-to-end approach. It
is useful for any scenario. It asserts the correctness of the final result, such
as string or file. Going this way at the beginning is good, but may become
harder to maintain when the template rendering becomes more complex.
Here is a simple demo of the assertions:&lt;/p&gt;

&lt;div class=&quot;language-py highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;test_render_app&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;():&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;yml&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;render_config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cluster_name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;es-demo&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node_id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;yml&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;cluster.name: es-demo
node.name: es-demo-data-1
network.host: 0.0.0.0&quot;&quot;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I believe there are no perfect solutions for testing. Ultimately, testing is
to provide safety to your product and avoid unexpected results later on. As far
as you feel safe for the generated configuration, maybe that’s the most
important.&lt;/p&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;To know more about how to configure Elasticsearch, visit official
documentation &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/settings.html&quot;&gt;“Configuring
Elasticsearch”&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;To see the initial template of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;elasticsearch.yml&lt;/code&gt;, visit the source code on
GitHub (here the link is for Elastcsearch v7.12.0):
&lt;a href=&quot;https://github.com/elastic/elasticsearch/blob/v7.12.0/distribution/src/config/elasticsearch.yml&quot;&gt;https://github.com/elastic/elasticsearch/blob/v7.12.0/distribution/src/config/elasticsearch.yml&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;To learn more about templating engine Jinja, visit the official website
&lt;a href=&quot;https://jinja.palletsprojects.com/&quot;&gt;https://jinja.palletsprojects.com/&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;You can also see the source code of this article on GitHub under repository
&lt;a href=&quot;https://github.com/mincong-h/learning-python/tree/blog/elasticsearch-jinja2/src/jinja2&quot;&gt;mincong-h/learning-python&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we saw what is templating engine Jinja 2, how to use it to
generate the configuration for Elasticsearch clusters, such as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;elasticsearch.yml&lt;/code&gt;,
how to use Python data classes to represent more complex logic, the basic
features of Jinja 2, how to test the generation, and finally how to go further
from here.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Eric V. Smith, “PEP 557 – Data Classes”, &lt;em&gt;python.org&lt;/em&gt;, 2017.
&lt;a href=&quot;https://www.python.org/dev/peps/pep-0557/&quot;&gt;https://www.python.org/dev/peps/pep-0557/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Miguel Brito, “Everything You Need to Know About Python’s Namedtuples”,
&lt;em&gt;dev.to&lt;/em&gt;, 2020. &lt;a href=&quot;https://dev.to/miguendes/everything-you-need-to-know-about-python-s-namedtuples-1l12&quot;&gt;https://dev.to/miguendes/everything-you-need-to-know-about-python-s-namedtuples-1l12&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;卡拉先生, “Elasticsearch配置yaml中文教程”, &lt;em&gt;kalasearch.cn&lt;/em&gt;, 2020.
&lt;a href=&quot;https://kalasearch.cn/community/tutorials/how-to-configure-yaml-file-for-elastic-search/&quot;&gt;https://kalasearch.cn/community/tutorials/how-to-configure-yaml-file-for-elastic-search/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="elasticsearch" /><category term="python" /><category term="elasticsearch" /><category term="python" /><category term="jinja" /><summary type="html">This article explains how to generate the configuration for Elasticsearch using Python templating engine Jinja 2 by going through a basic use-case. It also explains features about Jinja2, testing, and more.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-heiman-ip-iFk8n8ntVDU-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-heiman-ip-iFk8n8ntVDU-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Disk Watermarks In Elasticsearch</title><link href="https://mincong.io/2021/04/10/disk-watermarks-in-elasticsearch/" rel="alternate" type="text/html" title="Disk Watermarks In Elasticsearch" /><published>2021-04-10T01:00:00+02:00</published><updated>2021-04-10T01:00:00+02:00</updated><id>https://mincong.io/2021/04/10/disk-watermarks-in-elasticsearch</id><content type="html" xml:base="https://mincong.io/2021/04/10/disk-watermarks-in-elasticsearch/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;If you operate one or multiple Easticsearch clusters, you probably already heard about disk watermarks.
There are three disk watermarks in Elasticsearch: low, high, flood-stage. They are cluster-level settings and
are important for shard allocations. Its primary goal is to ensure all the nodes have enough disk space and
avoid disk full problems. In this article, we are going to explore their definition, the
symptom when the watermark is reached, and different solutions (i.e. how to avoid it in the first place or how to
mitigate when it happens).&lt;/p&gt;

&lt;p&gt;After reading this article, you will understand:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;How to get and update the watermarks in Elasticsearch?&lt;/li&gt;
  &lt;li&gt;Low disk watermark&lt;/li&gt;
  &lt;li&gt;High disk watermark&lt;/li&gt;
  &lt;li&gt;Flood-stage disk watermark&lt;/li&gt;
  &lt;li&gt;How to avoid disk full problem?&lt;/li&gt;
  &lt;li&gt;How to go further from here?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This article is written for Elasticsearch 6.x and 7.x. Now, let’s get started!&lt;/p&gt;

&lt;h2 id=&quot;overview&quot;&gt;Overview&lt;/h2&gt;

&lt;p&gt;Elasticsearch considers the available disk space on a node before deciding whether
to allocate new shards to that node or to actively relocate shards away from that node.&lt;/p&gt;

&lt;p&gt;Below are the settings that can be configured in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;elasticsearch.yml&lt;/code&gt; config file or updated
dynamically on a live cluster with the cluster-update-settings API:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Setting&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Description&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cluster.routing.allocation.disk.watermark.low&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;The low watermark for disk usage, defaults to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;85%&lt;/code&gt;. Elasticsearch will not allocate shards to nodes that have more than 85% disk used.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cluster.routing.allocation.disk.watermark.high&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;The high watermark for disk usage, defaults to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;90%&lt;/code&gt;. Elasticsearch will attempt to relocate shards away from a node whose disk usage is above 90%.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cluster.routing.allocation.disk.watermark.flood_stage&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;The flood-stage watermark for disk usage, defaults to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95%&lt;/code&gt;. Elasticsearch enforces a read-only index block (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;index.blocks.read_only_allow_delete&lt;/code&gt;) on every index that has one or more shards allocated on the node, and that has at least one disk exceeding the flood stage.&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;To retrieve the current value of different disk watermarks, you can send a GET request to the Cluster Settings API:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_cluster/settings?include_defaults
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You may want to add query parameter &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;flat_settings&lt;/code&gt; so that you can filter the disk watermarks easily:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_cluster/settings?include_defaults&amp;amp;flat_settings
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To update one or more settings of disk watermarks, specify them in the Cluster Update Settings API:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT /_cluster/settings

{
  &quot;transient&quot;: { 
    &quot;cluster.routing.allocation.disk.watermark.low&quot;: &quot;85%&quot;,
    &quot;cluster.routing.allocation.disk.watermark.high&quot;: &quot;90%&quot;,
    &quot;cluster.routing.allocation.disk.watermark.flood_stage&quot;: &quot;95%&quot;,
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now we understand the basics of these settings and how to get and update them. Let’s go further
into each of them to better understand their meaning.&lt;/p&gt;

&lt;h2 id=&quot;low-disk-watermark&quot;&gt;Low Disk Watermark&lt;/h2&gt;

&lt;p&gt;When a data node is getting more and more filled, its disk
usage will first across the low disk watermark. The default value is 85%, meaning that Elasticsearch will not allocate shards to nodes that have more than 85% disk used. It can also be set to an absolute byte value (like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;500mb&lt;/code&gt;) to prevent Elasticsearch from allocating shards if less than the specified amount of space is available. This setting does not affect the primary shards of newly-created indices but will prevent their replicas from being allocated.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210410-Elasticsearch-Disk-Warkermarks-Diagram.low-watermark.png&quot; alt=&quot;Diagram for low disk watermark&quot; /&gt;&lt;/p&gt;

&lt;p&gt;More precisely, you may see the following shard allocation decisions made by the Disk Threshold Decider:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Decision&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Message&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;NO&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Shard cannot be allocated because: “the node is above the low watermark cluster setting [cluster.routing.allocation.disk.watermark.low=%s], having less than the minimum required [%s] free space, actual free: [%s]”&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;NO&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Shard cannot be allocated because: “the node is above the low watermark cluster setting [cluster.routing.allocation.disk.watermark.low=%s], using more disk space than the maximum allowed [%s%%], actual free: [%s%%]”&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;YES&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Shard can be allocated because: “the node is above the low watermark, but less than the high watermark, and this primary shard has never been allocated before”&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Since Elasticsearch cluster will stop allocating shards to this data node, it means that your cluster may become yellow.&lt;/p&gt;

&lt;p&gt;There are multiple solutions to solve this:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Add more data nodes to the cluster.&lt;/li&gt;
  &lt;li&gt;Cleanup space by snapshotting old indices, restore them to another cluster if needed, and finally delete them from the current cluster.&lt;/li&gt;
  &lt;li&gt;Add more disk on the node.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;If you have an auto-scaling mechanism, it means that that auto-scaler is not working properly.&lt;/p&gt;

&lt;h2 id=&quot;high-disk-watermark&quot;&gt;High Disk Watermark&lt;/h2&gt;

&lt;p&gt;When a data node is getting more and more filled and after reaching the low watermark, its disk
usage will across the high disk watermark. The default value is 90%, meaning that Elasticsearch will attempt to relocate shards away from a node whose disk usage is above 90%. It can also be set to an absolute byte value (similarly to the low watermark) to relocate shards away from a node if it has less than the specified amount of free space. This setting affects the allocation of all shards, whether previously allocated or not.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210410-Elasticsearch-Disk-Warkermarks-Diagram.high-watermark.png&quot; alt=&quot;Diagram for high disk watermark&quot; /&gt;&lt;/p&gt;

&lt;p&gt;More precisely, you may see the following shard allocation decisions made by the Disk Threshold Decider:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Decision&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Message&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;NO&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Shard cannot be allocated because: “the node is above the high watermark cluster setting [cluster.routing.allocation.disk.watermark.high=%s], having less than the minimum required [%s] free space, actual free: [%s]”&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;NO&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Shard cannot be allocated because: “the node is above the high watermark cluster setting [cluster.routing.allocation.disk.watermark.high=%s], using more disk space than the maximum allowed [%s%%], actual free: [%s%%]”&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;NO&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Shard cannot be allocated because: “allocating the shard to this node will bring the node above the high watermark cluster setting [cluster.routing.allocation.disk.watermark.high=%s] and cause it to have less than the minimum required [%s] of free space (free: [%s], estimated shard size: [%s])”&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;NO&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Shard cannot be allocated because: “allocating the shard to this node will bring the node above the high watermark cluster setting [cluster.routing.allocation.disk.watermark.high=%s] and cause it to use more disk space than the maximum allowed [%s%%] (free space after shard added: [%s%%])”&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;NO&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Shard cannot be allocated because: “the shard cannot remain on this node because it is above the high watermark cluster setting [cluster.routing.allocation.disk.watermark.high=%s] and there is less than the required [%s] free space on node, actual free: [%s]”&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;NO&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Shard cannot be allocated because: “the shard cannot remain on this node because it is above the high watermark cluster setting [cluster.routing.allocation.disk.watermark.high=%s] and there is less than the required [%s%%] free disk on node, actual free: [%s%%]”&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;When a data node reached the high watermark, it is usually not alone. The entire cluster can be full. You
have to deal with this seriously. In addition to the disk being full, Elasticsearch cluster may create a lot
of relocations to relocate shards from one node to another — but it’s useless because all the nodes are getting
full.&lt;/p&gt;

&lt;p&gt;The solutions for solving this issue are the same as the solutions for the low disk watermark.&lt;/p&gt;

&lt;h2 id=&quot;flood-stage-disk-watermark&quot;&gt;Flood-Stage Disk Watermark&lt;/h2&gt;

&lt;p&gt;The next level is the flood stage. The default value is 95%. Elasticsearch enforces a read-only index block (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;index.blocks.read_only_allow_delete&lt;/code&gt;) on every index that has one or more shards allocated on the node, and that has at least one disk exceeding the flood stage. This setting is the last resort to prevent nodes from running out of disk space. Depending on your Elasticsearch version, the release mechanism is different:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Before Elasticsearch 7, the index block must be released &lt;mark&gt;manually&lt;/mark&gt; when the disk utilization falls below the high watermark.&lt;/li&gt;
  &lt;li&gt;Since Elasticsearch 7, the index block is &lt;mark&gt;automatically&lt;/mark&gt; released when the disk utilization falls below the high watermark.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210410-Elasticsearch-Disk-Warkermarks-Diagram.flood-stage-watermark.png&quot; alt=&quot;Diagram for flood-stage disk watermark&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In Elasticsearch 6, since the index block must be released manually, you can reset the index, e.g. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;twitter&lt;/code&gt;, using the following API:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT /twitter/_settings

{
  &quot;index.blocks.read_only_allow_delete&quot;: null
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;how-to-avoid-disk-full-problem&quot;&gt;How to avoid disk full problem?&lt;/h2&gt;

&lt;p&gt;Nobody wants to put their production at risk or work on this critical issue at 3:00 AM. This problem
can be mitigated in several ways:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Implement a disk-based auto-scaling mechanism so that new data nodes can be added automatically.&lt;/li&gt;
  &lt;li&gt;Create a warning alert for high disk usage, e.g. 50% full. Therefore, developers or operations teams can handle this during business hours.&lt;/li&gt;
  &lt;li&gt;Create a critical alert for high disk usage, e.g. 70% full. Therefore, the on-call team can handle this anytime when the situation becomes critical. However, the recovery may take a long time but monitoring this can be tiring as well. You may want to add another disk full alert, e.g. 85% full, to ensure that the situation is not worsened during recovery time.&lt;/li&gt;
  &lt;li&gt;Use Elasticsearch Index Lifecycle Management (ILM) to regularly clean up old indices. Or implement a custom index lifecycle management mechanism to adapt your business requirements.&lt;/li&gt;
  &lt;li&gt;Use Elasticsearch Snapshot and Restore module so that you can move data easily across clusters.&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;To better understand low disk watermark, visit Opster’s page &lt;a href=&quot;https://opster.com/elasticsearch-glossary/elasticsearch-low-disk-watermark/&quot;&gt;“Elasticsearch Low Disk Watermark”&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;To better understand high disk watermark, visit Opster’s page &lt;a href=&quot;https://opster.com/elasticsearch-glossary/elasticsearch-high-disk-watermark/&quot;&gt;“Elasticsearch High Disk Watermark”&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;To see how the decisions are made based on different thresholds, see the source code of &lt;a href=&quot;https://github.com/elastic/elasticsearch/blob/v7.12.0/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDecider.java&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DiskThresholdDecider&lt;/code&gt; (v7.12.0)&lt;/a&gt; on GitHub.&lt;/li&gt;
  &lt;li&gt;For more information about disk-based shard allocation on Elasticsearch 6, visit official documentation:
&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/6.8/disk-allocator.html&quot;&gt;https://www.elastic.co/guide/en/elasticsearch/reference/6.8/disk-allocator.html&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;For more information about disk-based shard allocation on Elasticsearch 7, visit official documentation:
&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.12/modules-cluster.html&quot;&gt;https://www.elastic.co/guide/en/elasticsearch/reference/7.12/modules-cluster.html&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;To see more shard allocation decisions, visit another article on my blog: &lt;a href=&quot;/2020/09/27/shard-allocation/&quot;&gt;“18 Allocation Deciders in Elasticsearch”&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we saw how different disk watermarks in Elasticsearch: low (85%), high (90%), and
flood-stage (95%). All of them are dynamic settings and can be updated without restarting the server.
Elasticsearch will not allocate shards to nodes that have more than 85% disk used.
Elasticsearch will attempt to relocate shards away from a node whose disk usage is above 90%.
A read-only index block will be enforced when the flood stage exceeds.
We also see different solutions to avoid disk full problems.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Elastic, “Cluster Get Settings API (7.x)”, &lt;em&gt;elastic.co&lt;/em&gt;, 2021.
&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-get-settings.html&quot;&gt;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-get-settings.html&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Elastic, “Cluster-level shard allocation and routing settings”, &lt;em&gt;elastic.co&lt;/em&gt;, 2021.
&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.12/modules-cluster.html&quot;&gt;https://www.elastic.co/guide/en/elasticsearch/reference/7.12/modules-cluster.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="elasticsearch" /><category term="elasticsearch" /><summary type="html">Understanding different disk watermarks: low, high, and flood-stage in Elasticsearch. The symptom when the cluster reaches these values and how to mitigate or avoid the issues. Also, how to better operate your clusters using these watermarks.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-kelly-sikkema-_whs7FPfkwQ-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-kelly-sikkema-_whs7FPfkwQ-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">JUnit 5: Dynamic Tests with TestFactory</title><link href="https://mincong.io/2021/04/09/junit-5-dynamic-tests/" rel="alternate" type="text/html" title="JUnit 5: Dynamic Tests with TestFactory" /><published>2021-04-09T02:54:59+02:00</published><updated>2021-04-09T02:54:59+02:00</updated><id>https://mincong.io/2021/04/09/junit-5-dynamic-tests</id><content type="html" xml:base="https://mincong.io/2021/04/09/junit-5-dynamic-tests/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;In this article, I am going to share with you how to write dynamic tests
in JUnit 5 using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@TestFactory&lt;/code&gt;. Dynamic testing is a new programming model
introduced in JUnit 5. It is useful to create tests that cannot be defined at
compile time (e.g. loaded via an external resource) or to create tests
that cannot be expressed easily via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@ParameterizedTest&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;After reading this article, you will understand:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The basic syntax of dynamic test&lt;/li&gt;
  &lt;li&gt;Different return types for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@TestFactory&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;The lifecycle of dynamic test&lt;/li&gt;
  &lt;li&gt;Checking the result in IDE&lt;/li&gt;
  &lt;li&gt;How to go further from here&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now, let’s get started!&lt;/p&gt;

&lt;h2 id=&quot;basic-syntax&quot;&gt;Basic Syntax&lt;/h2&gt;

&lt;p&gt;According to the &lt;a href=&quot;https://junit.org/junit5/docs/current/user-guide/&quot;&gt;JUnit 5 User Guide&lt;/a&gt;,
the standard &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@Test&lt;/code&gt; annotation in JUnit Jupiter described in Annotations is very
similar to the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@Test&lt;/code&gt; annotation in JUnit 4. Both describe methods that implement
test cases. These test cases are static in the sense that they are fully
specified at compile-time, and their behavior cannot be changed by anything
happening at runtime. Assumptions provide a basic form of dynamic behavior but
are intentionally rather limited in their expressiveness.&lt;/p&gt;

&lt;p&gt;In addition to these standard tests, a completely new kind of test programming
model has been introduced in JUnit Jupiter. This new kind of test is a dynamic
test which is generated at runtime by a factory method that is annotated with
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@TestFactory&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The basic syntax of a dynamic test is:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nd&quot;&gt;@TestFactory&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 1&lt;/span&gt;
&lt;span class=&quot;nc&quot;&gt;Stream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;DynamicTest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;dynamicTestStream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 2&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;IntStream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;mapToObj&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;n&quot;&gt;dynamicTest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; is a multiple of 3&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;assertEquals&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 3&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the example above, we specified several things:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;The annotation &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@TestFactory&lt;/code&gt; so that JUnit 5 can recognize this method as a
test factory containing multiple dynamic tests.&lt;/li&gt;
  &lt;li&gt;The return type of the method is a stream of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DynamicTest&lt;/code&gt;. Note that you
don’t have to use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Stream&lt;/code&gt; and there are other choices. We will talk about
that in the next section.&lt;/li&gt;
  &lt;li&gt;Use static method &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;org.junit.jupiter.api.DynamicTest.dynamicTest&lt;/code&gt; to create a
dynamic test. Each &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dynamicTest&lt;/code&gt; consists of two parts: a string for the
display name and an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Executable&lt;/code&gt; for the assertions.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Once we have them, we can run the test. There is no additional dependency
required. In the following sections, we are going
to explore a bit more into detail different pieces.&lt;/p&gt;

&lt;h2 id=&quot;return-types-for-test-factory&quot;&gt;Return Types For Test Factory&lt;/h2&gt;

&lt;p&gt;In the section above, we saw that we can return a list of dynamic tests as
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Stream&amp;lt;DynamicTest&amp;gt;&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nc&quot;&gt;Stream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;DynamicTest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;dynamicTests&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But it does not have to be in this way. We can also specify other types for
returning the tests. As far as this type is iterable, JUnit 5 is happy about it.
For example, you can use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Collection&lt;/code&gt;, Iterable&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;, &lt;/code&gt;Iterator&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;, &lt;/code&gt;Stream&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;, or array
of &lt;/code&gt;DynamicTest&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;. Besides that, you can also consider using &lt;/code&gt;DynamicContainer`
which can contain multiple tests inside it. See &lt;a href=&quot;https://junit.org/junit5/docs/current/user-guide/&quot;&gt;JUnit 5 - User
Guide&lt;/a&gt; for more
information about that.&lt;/p&gt;

&lt;h2 id=&quot;lifecycle-of-dynamic-tests&quot;&gt;Lifecycle Of Dynamic Tests&lt;/h2&gt;

&lt;p&gt;The execution lifecycle of a dynamic test is different from the standard &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@Test&lt;/code&gt;
case. The lifecycle callbacks, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@BeforeEach&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@AfterEach&lt;/code&gt;, are &lt;em&gt;not&lt;/em&gt;
executed for each dynamic test, but the whole &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@TestFactory&lt;/code&gt;. Therefore, we
need to be very careful about using class-level variables because they won’t be
reset properly.&lt;/p&gt;

&lt;p&gt;Stardard &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@Test&lt;/code&gt;:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Execute &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@BeforeEach&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Execute &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@Test&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Execute &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@AfterEach&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Dynamic tests via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@TestFactory&lt;/code&gt;:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Execute &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@BeforeEach&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Execute &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@TestFactory&lt;/code&gt;
    &lt;ul&gt;
      &lt;li&gt;Execute dynamic test 1&lt;/li&gt;
      &lt;li&gt;Execute dynamic test 2&lt;/li&gt;
      &lt;li&gt;Execute dynamic test 3&lt;/li&gt;
      &lt;li&gt;…&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Execute &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@AfterEach&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;ide&quot;&gt;IDE&lt;/h2&gt;

&lt;p&gt;When running dynamic tests in IntelliJ IDEA (2020.3.1), you can find the results
as follows:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210409-dynamic-test.png&quot; alt=&quot;Dynamic tests in IntelliJ IDEA&quot; /&gt;&lt;/p&gt;

&lt;p&gt;where each dynamic test has its result and its display name.&lt;/p&gt;

&lt;h2 id=&quot;should-we-use-dynamic-tests&quot;&gt;Should We Use Dynamic Tests?&lt;/h2&gt;

&lt;p&gt;Actually, I prefer using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@ParameterizedTest&lt;/code&gt; over &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@TestFactory&lt;/code&gt; because it
has the full lifecycle support (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@BeforeEach&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@AfterEach&lt;/code&gt;) while the test
factory doesn’t. Both of them support display names so it’s not a problem.
Usually,
the test cases can be defined at compile-time.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;So why should we dynamic tests?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;I believe there are two reasons: when the tests cannot be expressed at compile-time or when the parameterized tests are not good enough.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Runtime test sources. When the tests cannot be expressed at compiled time,
you may want to load them at runtime. Dynamic tests support this via the
following methods:&lt;/p&gt;

    &lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nc&quot;&gt;DynamicTest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;dynamicTest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;URI&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Executable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nc&quot;&gt;DynamicContainer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;dynamicContainer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;URI&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Stream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;

    &lt;p&gt;Therefore, you can pass the sources via a URI. It can be something in the
classpath, in the filesystem, etc.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Because parameterized tests are not good enough. This is my test. I wanted to
use some exceptions as input sources, and assert the exception handling
mechanism by asserting these exceptions one after another. However, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@ParameterizedTest&lt;/code&gt;
seems only support basic Java types: primitives or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;String&lt;/code&gt;, so passing an
exception as input is not possible. So I ended up using dynamic tests for
this purpose.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;There are probably other motivations as well. Please let me know what you think
by leaving a comment :)&lt;/p&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;To learn more about JUnit 5 in general, read &lt;a href=&quot;https://junit.org/junit5/docs/current/user-guide/&quot;&gt;JUnit 5 - User
Guide&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;To learn more about JUnit 5 Parmaterized Tests, I have another blog post that
may interest you &lt;a href=&quot;/2021/01/31/juni5-parameterized-tests/&quot;&gt;Writing Parameterized Tests in JUnit 5&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;You can also see the source code of this article on GitHub under
&lt;a href=&quot;https://github.com/mincong-h/java-examples/blob/blog/junit5-dynamic-tests/junit5/src/test/java/io/mincong/junit5/dynamic_test/NumberTest.java&quot;&gt;mincong-h/java-examples&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we saw how to write dynamic tests via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@TestFactory&lt;/code&gt;, the
different return types for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@TestFactory&lt;/code&gt;, such as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Collection&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Iterable&lt;/code&gt;,
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Iterator&lt;/code&gt;, array, or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Stream&lt;/code&gt; of dynamic tests. We also see the lifecycle of
dynamic tests, which do not benefit from the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@BeforeEach&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@AfterEach&lt;/code&gt;
callbacks for each individual dynamic test, how do the results look like in IDE,
and how to go further from here.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;JUnit Team, “JUnit 5 - User Guide”, &lt;em&gt;junit.org&lt;/em&gt;, 2021.
&lt;a href=&quot;https://junit.org/junit5/docs/current/user-guide/&quot;&gt;https://junit.org/junit5/docs/current/user-guide/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Baeldung, “Guide to Dynamic Tests in Junit 5”, &lt;em&gt;baeldung.com&lt;/em&gt;, 2021.
&lt;a href=&quot;https://www.baeldung.com/junit5-dynamic-tests&quot;&gt;https://www.baeldung.com/junit5-dynamic-tests&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Satish Varma, “Junit 5 dynamic tests @TestFactory with examples”,
&lt;em&gt;JavaByDeveloper&lt;/em&gt;, 2020. &lt;a href=&quot;https://javabydeveloper.com/junit-5-dynamic-tests-testfactory-with-examples/&quot;&gt;https://javabydeveloper.com/junit-5-dynamic-tests-testfactory-with-examples/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="java-testing" /><category term="java" /><category term="junit" /><category term="junit5" /><category term="testing" /><summary type="html">How to write dynamic tests using @TestFactory in JUnit 5? This article explains the syntax, different return types, the test lifecycle, and potential use-cases.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-mike-kenneally-tNALoIZhqVM-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-mike-kenneally-tNALoIZhqVM-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Making Backward-Compatible Schema Changes in MongoDB</title><link href="https://mincong.io/2021/02/27/mongodb-schema-compatibility/" rel="alternate" type="text/html" title="Making Backward-Compatible Schema Changes in MongoDB" /><published>2021-02-27T17:07:27+01:00</published><updated>2021-02-27T17:07:27+01:00</updated><id>https://mincong.io/2021/02/27/mongodb-schema-compatibility</id><content type="html" xml:base="https://mincong.io/2021/02/27/mongodb-schema-compatibility/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;Changing the schema of a Mongo collection is a common request for developers. We
need this when the business evolves: we need to add new fields or remove
existing fields from a target Mongo collection to better support different
use-cases. Nevertheless, this is a risky operation, it may trigger an incident or
outage when this is not handled correctly. In this article, we are going to what
can go wrong, how to change the schema safely, and how to investigate
if things go wrong. This article assumes that you are familiar with the basic
concepts of MongoDB and uses &lt;a href=&quot;https://github.com/FasterXML/jackson-databind&quot;&gt;Jackson&lt;/a&gt; as the serialization framework for your
Java application.&lt;/p&gt;

&lt;p&gt;After reading this article, you will understand:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Potential risks when adding a new field&lt;/li&gt;
  &lt;li&gt;Filling missing data with a default value&lt;/li&gt;
  &lt;li&gt;Writing unit tests&lt;/li&gt;
  &lt;li&gt;Migrating existing documents&lt;/li&gt;
  &lt;li&gt;Preparing the worst case: how to revert changes&lt;/li&gt;
  &lt;li&gt;Incident: how to mitigate using Mongo queries?&lt;/li&gt;
  &lt;li&gt;How to go further from here?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This article is written with MongoDB 4.2, Jackson 2.12, and Java 11. But the
concepts are not tight to these versions and should be valid for older versions.
Now, let’s get started!&lt;/p&gt;

&lt;h2 id=&quot;potential-risks&quot;&gt;Potential Risks&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;What can go wrong when adding a new field?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;If a new field is added in the Java class without changing the existing
documents in MongoDB, the deserialization can be completely broken. This is
because the new field required by the Java class does not exist for those
documents. Deserializing them can trigger an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;UnrecognizedPropertyException&lt;/code&gt; by
Jackson Object Mapper.&lt;/p&gt;

&lt;p&gt;Here is an example called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;OrderV1&lt;/code&gt;. The 1st version of the order contains
3 fields: the object ID in MongoDB, the customer ID, and the amount of this
order. Recently, the product owner wants the possibility to cancel an order, so
we need a new field “isCanceled” to support this use-case as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;OrderV2&lt;/code&gt;. Also,
the product owner wants us to add an operator to keep track of the person who
handles the order. The changes look pretty simple:&lt;/p&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gd&quot;&gt;-public class OrderV1 {
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+public class OrderV2 {
&lt;/span&gt;
   @JsonProperty(&quot;_id&quot;)
   private final String id;

   @JsonProperty(&quot;customerId&quot;)
   private final String customerId;

   @JsonProperty(&quot;amount&quot;)
   private final double amount;

+  @JsonProperty(&quot;isCanceled&quot;)
&lt;span class=&quot;gi&quot;&gt;+  private final boolean isCanceled;
&lt;/span&gt;
+  @JsonProperty(&quot;operator&quot;)
&lt;span class=&quot;gi&quot;&gt;+  private final String operator;
&lt;/span&gt;
   ...
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But you will see that there are some major risks here.&lt;/p&gt;

&lt;h3 id=&quot;nullpointerexception&quot;&gt;NullPointerException&lt;/h3&gt;

&lt;p&gt;Without changing existing documents in MongoDB, the deserialization of the new fields may
be set to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;null&lt;/code&gt;. This is the case for the new field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;operator&lt;/code&gt;. This is because
the field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;operator&lt;/code&gt; does not exist for those Mongo documents. In Java, having a
field with a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;null&lt;/code&gt;
value can trigger &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NullPointerException&lt;/code&gt; and break your application. You need to
either handle the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;null&lt;/code&gt; case in your Java code; or perform data migration in
Mongo, i.e. adding the missing fields for your existing documents. We will talk
about these tricks in detail in the following sections.&lt;/p&gt;

&lt;h3 id=&quot;impossible-to-rollback&quot;&gt;Impossible To Rollback&lt;/h3&gt;

&lt;p&gt;Another risk is about reverting the changes. Without additional configuration in
the Jackson object mapper or your value class, you may not be able to roll back
your changes once they are deployed to production. Once the Java changes are reverted,
the deserialization of the new documents from MongoDB to Java will fail with the
following exception:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;“java.io.UncheckedIOException:
com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException: Unrecognized field
“isCanceled” (class io.mincong.mongodb.model_changes.OrderV1), not marked as ignorable (3
known properties: “amount”, “customerId”, “_id”]) at [Source: (String)”{“_id”: “2”,
“customerId”: “Customer2”, “amount”: 200.0, “isCanceled”: true, “operator”:
“emea@example.com”, “productIds”: [“A”, “B”, “C”]}”; line: 1, column: 77] (through reference
chain: io.mincong.mongodb.model_changes.OrderV1[“isCanceled”])”&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is because new documents have the field “isCanceled” but the old value
class &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;OrderV1&lt;/code&gt; does not know how to deserialize it! This is so dangerous, we
rolled back, but the production is on fire, exceptions are everywhere. But how to avoid this from
happening? We will discuss it in detail in the “Preparing For Rollback” section.&lt;/p&gt;

&lt;p&gt;Now we have a better understanding of how adding new fields may impact our
production, it’s time to see how to improve the situation using different
techniques.&lt;/p&gt;

&lt;h2 id=&quot;filling-missing-data&quot;&gt;Filling Missing Data&lt;/h2&gt;

&lt;p&gt;To prevent &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NullPointerException&lt;/code&gt;, we can fill the missing data in Java by
providing a default value. There are 4 ways to do that:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Use Java language feature&lt;/li&gt;
  &lt;li&gt;Fill null in the constructor&lt;/li&gt;
  &lt;li&gt;Fill null in the getter&lt;/li&gt;
  &lt;li&gt;Use Jackson module&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;using-java-language-feature&quot;&gt;Using Java Language Feature&lt;/h3&gt;

&lt;p&gt;When declaring a class attribute as primitive, Jackson chooses a default value
for you. For &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;boolean&lt;/code&gt;, it defaults to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;false&lt;/code&gt;; for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;integer&lt;/code&gt;, it defaults to 0;
for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;double&lt;/code&gt;, it defaults to 0.0; …
Therefore, you can rely on this technique to avoid having a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;null&lt;/code&gt; field in your
Java application. For example, to express whether an order is canceled, we
can use the field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isCanceled&lt;/code&gt; which is a primitive type &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;boolean&lt;/code&gt;. When the field
does not exist in Mongo document, it defaults to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;false&lt;/code&gt;, which means the order
is valid, not canceled.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;OrderV2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;cm&quot;&gt;/**
   * This is a new boolean field.
   *
   * &amp;lt;p&amp;gt;For existing documents which do not contain this field, the
   * deserialization defaults to `false`.
   */&lt;/span&gt;
  &lt;span class=&quot;nd&quot;&gt;@JsonProperty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;isCanceled&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isCanceled&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, be careful when choosing the adjective used for the new information. You
should ensure that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;false&lt;/code&gt; has the correct meaning for documents missing that
field. For example, if you are adding a field to represent the visibility of
an object, you have two choices: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isHidden&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isVisible&lt;/code&gt;, which one should
you use? You should probably choose the adjective
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isHidden&lt;/code&gt; rather than &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isVisible&lt;/code&gt; because, for existing Mongo
documents, they don’t have the field for visibility. In this case:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isHidden&lt;/code&gt; defaults to false (visible) when the field does not exist&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isVisible&lt;/code&gt; defaults to false (hidden) when the field does not exist. This is
NOT what we need: we want to default to visible, not hidden.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;So &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isHidden&lt;/code&gt; is a better choice here.&lt;/p&gt;

&lt;h3 id=&quot;filling-null-in-constructor&quot;&gt;Filling Null In Constructor&lt;/h3&gt;

&lt;p&gt;Another way is to handle to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;null&lt;/code&gt; in the constructor of the value class.
Therefore, when the deserialization happens, Jackson uses the constructor as the
JSON creator to create the Java instance, and the null case will be handled
properly.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;OrderV2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;nd&quot;&gt;@JsonProperty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;operator&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;operator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;

  &lt;span class=&quot;nd&quot;&gt;@JsonCreator&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;OrderV2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;nd&quot;&gt;@JsonProperty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;nd&quot;&gt;@JsonProperty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;customerId&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;customerId&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;nd&quot;&gt;@JsonProperty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;amount&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;nd&quot;&gt;@JsonProperty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;isCanceled&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isCancelled&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;nd&quot;&gt;@JsonProperty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;operator&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;operator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;nd&quot;&gt;@JsonProperty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;productIds&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;productIds&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;operator&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;operator&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;support@example.com&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;operator&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;operator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let’s take a real example. Given a document in Mongo collection without the new
field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;operator&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;customerId&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Customer1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;amount&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;100.0&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then during the deserialization, this is considered as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;null&lt;/code&gt; by Jackson, but
then fall back to “support@example.com” in the constructor:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210227-handle-null-in-constructor.png&quot; alt=&quot;Handle null in constructor&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Therefore, the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;null&lt;/code&gt; case is handled successfully.&lt;/p&gt;

&lt;h3 id=&quot;filling-null-in-getter&quot;&gt;Filling Null In Getter&lt;/h3&gt;

&lt;p&gt;In a similar approach, you can also handle null in the getter method.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;OrderV2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;nd&quot;&gt;@JsonProperty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;operator&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;operator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;

  &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getOperator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;operator&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;support@example.com&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;operator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;jackson-jdk8module&quot;&gt;Jackson Jdk8Module&lt;/h3&gt;

&lt;p&gt;Another solution is to use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Optional&lt;/code&gt;, combined with Jackson module &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Jdk8Module&lt;/code&gt; to
serialize and deserialize it correctly. You can visit GitHub project
&lt;a href=&quot;https://github.com/FasterXML/jackson-modules-java8&quot;&gt;https://github.com/FasterXML/jackson-modules-java8&lt;/a&gt; or read the article &lt;a href=&quot;https://www.baeldung.com/jackson-optional&quot;&gt;“Using
Optional with Jackson”&lt;/a&gt; in Baeldung
to learn more about it.&lt;/p&gt;

&lt;h2 id=&quot;writing-unit-tests&quot;&gt;Writing Unit Tests&lt;/h2&gt;

&lt;p&gt;To better simulate the changes, you can write some unit tests to test different
behavior. I am not recommending you to write tests to cover all the cases, that
will be very time-consuming. I am just trying to share different testing
techniques to demonstrate that it is possible to assert in some way.&lt;/p&gt;

&lt;h3 id=&quot;testing-reciprocity&quot;&gt;Testing Reciprocity&lt;/h3&gt;

&lt;p&gt;One possible test is to ensure that you can serialize a document into MongoDB,
deserialize it back in Java, and the restored Java instance is equal to the
original one.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Java             MongoDB
---              ---
orignal   -----&amp;gt; Mongo document
restored &amp;lt;-----
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Something like:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// Given&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderCollection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;insertOne&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;order1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// When&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;results&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orderCollection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;find&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Filters&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;eq&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;customerId&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;BigCorp&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Then&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;assertThat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;results&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;containsExactly&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;order1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;testing-backward-compatibility&quot;&gt;Testing Backward-Compatibility&lt;/h3&gt;

&lt;p&gt;Another possible test is to test that deserializing an old Mongo document into
Java using the new schema (new Java class) will work as expected.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Java             MongoDB
---              ---
BSON      -----&amp;gt; Mongo document
restored &amp;lt;-----
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because your Java class is changed (added new fields), you cannot use it to create the same
structure as it was before. To simulate the existing Mongo documents, you can
create a Mongo document using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;org.bson.Document&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nc&quot;&gt;Document&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{ \&quot;_id\&quot;: \&quot;1\&quot;, \&quot;customerId\&quot;: \&quot;Customer1\&quot;, \&quot;amount\&quot;: 100.0 }&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the example, we created a BSON document without the new field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isCanceled&lt;/code&gt;
in the test. It simulates the existing Mongo documents created before the schema
change. It allows us to assert the
deserialization and ensure that the restored document contains the values that
we expect.&lt;/p&gt;

&lt;h3 id=&quot;testing-rollback&quot;&gt;Testing Rollback&lt;/h3&gt;

&lt;p&gt;This sounds a bit overkill to me. Testing in staging is probably enough. But
if you want to do this, it’s possible as well.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Java                  MongoDB
---                   ---
original (V2)  -----&amp;gt; Mongo document
restored (V1) &amp;lt;-----
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can copy the existing Java class into a new class, such as
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LegacyOrder.java&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;OrderV1.java&lt;/code&gt;. Then, write an instance V2 into
MongoDB and read it back as V1 (legacy) format to assert if the result is what
you expect.&lt;/p&gt;

&lt;h2 id=&quot;migrating-existing-documents&quot;&gt;Migrating Existing Documents&lt;/h2&gt;

&lt;p&gt;Besides providing a default value during the deserialization, another possibility
to avoid the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NullPointerException&lt;/code&gt; is to migrate the existing documents in
MongoDB. Before doing so, consider:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Whether you need to perform a backup before running your query. Ideally, the
backup is scheduled regularly. Or consider export the concerned
documents using
&lt;a href=&quot;https://docs.mongodb.com/database-tools/mongoexport/&quot;&gt;mongoexport&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;Testing your query in localhost and staging environment before running it in
production.&lt;/li&gt;
  &lt;li&gt;Ask for approval from at least one of your teammates before changing the
documents.&lt;/li&gt;
  &lt;li&gt;Create a conversation in the chat tool, e.g. Slack or Microsoft Teams, to keep
track of the operations.&lt;/li&gt;
  &lt;li&gt;Update one document before updating multiple ones.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now, back to the Mongo query for migration. This can be as simple as:&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nx&quot;&gt;db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;orders&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;isCanceled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;$exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 1&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;$set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;isCanceled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 2&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;multi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// 3&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the query above:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;We find the documents in collection &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;orders&lt;/code&gt; that do not contain the field
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isCanceled&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;Then for those documents, we set the missing field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isCanceled&lt;/code&gt; as “false”.&lt;/li&gt;
  &lt;li&gt;By default, an update statement only updates one single document. We set it to
update multiple ones — all those matching the selection (without field
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isCanceled&lt;/code&gt;). Note that it’s better to perform the update query twice: the
first time with option &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;{ multi: false }&lt;/code&gt; to test if the update statement
works. Then perform it a second-time with option &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;{ multi: true }&lt;/code&gt; to update
all the documents that matched the selection. In this way, we reduce the risk of
breaking the entire collection.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Then the update result shows how many documents were concerned: the number of
documents matched the query, number of documents updated or inserted, and number
of documents modified.&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nx&quot;&gt;WriteResult&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;nMatched&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;nUpserted&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;nModified&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;preparing-for-rollback&quot;&gt;Preparing For Rollback&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;How to handle an unknown field in Jackson?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;In the previous section “Potential Risks”, we mentioned that rolling back to
the previous version in Java application may not be possible.
The deserialization of the new documents in MongoDB may fail with the
following exception:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;“java.io.UncheckedIOException:
com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException: Unrecognized field
“isCanceled” (class io.mincong.mongodb.model_changes.OrderV1), not marked as ignorable (3
known properties: “amount”, “customerId”, “_id”]) at [Source: (String)”{“_id”: “2”,
“customerId”: “Customer2”, “amount”: 200.0, “isCanceled”: true, “operator”:
“emea@example.com”, “productIds”: [“A”, “B”, “C”]}”; line: 1, column: 77] (through reference
chain: io.mincong.mongodb.model_changes.OrderV1[“isCanceled”])”&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is because new documents have the field “isCanceled” but the old value
class &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;OrderV1&lt;/code&gt; does not know how to deserialize it! In this section, we are
going to see how to handle unknown fields correctly in Jackson.&lt;/p&gt;

&lt;h3 id=&quot;handle-unknown-field-globally&quot;&gt;Handle Unknown Field Globally&lt;/h3&gt;

&lt;p&gt;Make the Jackson object mapper more lenient face to unknown properties during
the JSON deserialization by disabling the feature &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FAIL_ON_UNKNOWN_PROPERTIES&lt;/code&gt;.
We can do that using one of the following lines:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;objectMapper&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;disable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;DeserializationFeature&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;FAIL_ON_UNKNOWN_PROPERTIES&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;objectMapper&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;configure&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;DeserializationFeature&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;FAIL_ON_UNKNOWN_PROPERTIES&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This will apply to all the JSON objects deserialized by this object mapper.&lt;/p&gt;

&lt;h3 id=&quot;handle-unknown-field-locally&quot;&gt;Handle Unknown Field Locally&lt;/h3&gt;

&lt;p&gt;Make the Jackson object mapper more lenient for a given value class during the
JSON deserialization by adding annotation &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@JsonIgnoreProperties&lt;/code&gt; in your value
class:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nd&quot;&gt;@JsonIgnoreProperties&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ignoreUnknown&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;OrderV1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This will apply to all the JSON objects deserialized into this value class
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;OrderV1&lt;/code&gt;. Compared to setting the feature globally, setting it locally at the class
level gives you finer control about the behavior over different classes, but
it’s also easier to forget adding this annotation because you will have to do
that for &lt;em&gt;all&lt;/em&gt; the classes and bring inconsistency over the deserialization
behavior.&lt;/p&gt;

&lt;p&gt;Once you configured one of the features mentioned above (globally or locally),
then it should be safe to rollback! Hopefully, you won’t need to rollback, but
it’s always a good idea to know that your code is prepared for that.&lt;/p&gt;

&lt;h2 id=&quot;useful-mongo-queries&quot;&gt;Useful Mongo Queries&lt;/h2&gt;

&lt;p&gt;In the previous sections, we were focused on how to avoid breaking the schema in
the first place. But what if the production is already broken? Maybe someone
else didn’t realize his changes can trigger an incident. Therefore, it’s always
a good thing to learn some basic Mongo queries to prepare the worst case. That
is, fixing the production when it is broken. Here are some Mongo queries that I
prepared for you.&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;orders&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Count the number of documents in the collection &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;orders&lt;/code&gt;. Useful to understand
how many documents are concerned and the potential impact if things go wrong.&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;orders&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;find&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;isCanceled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;$exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;limit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;pretty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;_id&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;customerId&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Customer1&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Find out 10 documents without the field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isCanceled&lt;/code&gt; and print them in pretty
format. Useful to inspect the JSON before or after the actual update.&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;orders&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;isCanceled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;$exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;$unset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;isCanceled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;multi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Remove field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isCanceled&lt;/code&gt; from all the documents having this field. Useful for
reverting the changes. Especially when your Java code had been rolled back to
the previous version but the Jackson fails to deserialize the recently-added Mongo
documented, which contains the new field &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isCanceled&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&quot;other-scenarios&quot;&gt;Other Scenarios&lt;/h2&gt;

&lt;p&gt;In the sections above, we mainly discussed what happened when adding a new field
in MongoDB. But what about other scenarios?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Another common scenario is to remove a field. Removing a field may have an issue
because the Java class may not be prepared for accepting unknown properties.
This is exactly what we discussed during the section “Preparing For Rollback”.&lt;/li&gt;
  &lt;li&gt;Another possible scenario is to change the type of an existing field. I would
avoid doing this. There must be a better solution, such as creating a new
field using another name.&lt;/li&gt;
  &lt;li&gt;Renaming or removing an element in a Java enum. Renaming is possible but please
ensure that the JSON property naming is not going to be changed implicitly.
For example, by renaming an enum item from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FOO&lt;/code&gt; to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BAR&lt;/code&gt;, the serialization will
be changed from “FOO” to “BAR”, which will completely break your application.
Removing an element is dangerous as well. Ensure that
this element does not exist in any of your databases (staging, production)
before doing so.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There are eventually other scenarios that I didn’t mention. Please leave a
comment so that everyone reading this article can learn about that.&lt;/p&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;This article assumes that you use &lt;a href=&quot;https://github.com/FasterXML/jackson-databind&quot;&gt;Jackson
Databind&lt;/a&gt; to serialize and
deserialize your Mongo documents in Java. If you are not using it and want to
give it a try, take a look at this Stack Overflow question &lt;a href=&quot;https://stackoverflow.com/a/47949886/4381330&quot;&gt;Is there any way
for creating Mongo codecs
automatically?&lt;/a&gt;, my implementation
is highly inspired by Kevin Day’s answer.&lt;/li&gt;
  &lt;li&gt;To learn more about different update operators in MongoDB, such as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$set&lt;/code&gt;,
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$unset&lt;/code&gt;, visit MongoDB Manual &lt;a href=&quot;https://docs.mongodb.com/manual/reference/operator/update/&quot;&gt;“Update
Operators”&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;To learn more about database tool &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mongodump&lt;/code&gt;, visit MongoDB documentation
&lt;a href=&quot;https://docs.mongodb.com/database-tools/mongodump/#mongodb-binary-bin.mongodump&quot;&gt;mongodump&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;You can also find the source code of this article on GitHub under project
&lt;a href=&quot;https://github.com/mincong-h/java-examples/tree/blog/mongo-schema-compatibility/mongo&quot;&gt;mincong-h/java-examples&lt;/a&gt;,
in particular the &lt;a href=&quot;https://github.com/mincong-h/java-examples/tree/blog/mongo-schema-compatibility/mongo/src/main/java/io/mincong/mongodb/model_changes&quot;&gt;source
code&lt;/a&gt;
and the &lt;a href=&quot;https://github.com/mincong-h/java-examples/tree/blog/mongo-schema-compatibility/mongo/src/test/java/io/mincong/mongodb/model_changes&quot;&gt;test code&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we saw the potential risks for MongoDB when adding a new field
in the Java application (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NullPointerException&lt;/code&gt; and issue for rollback), the
different techniques for filling the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;null&lt;/code&gt; value, how to write unit tests, how
to migrate the existing documents, how to prepare for rollback by handling
unknown field correctly via object mapper or via Java class annotation, and some
useful MongoDB queries to help you investigate the incident when something goes
wrong. Finally, we discussed briefly other scenarios and saw some resources
about how to go further from here.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;MongoDB, “MongoDB Documentation”, 2021.
&lt;a href=&quot;https://docs.mongodb.com/&quot;&gt;https://docs.mongodb.com/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Tatu Saloranta et al., “Jackson Databind”, 2021.
&lt;a href=&quot;https://github.com/FasterXML/jackson-databind&quot;&gt;https://github.com/FasterXML/jackson-databind&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="java-serialization" /><category term="reliability" /><category term="java" /><category term="mongodb" /><category term="serialization" /><category term="jackson" /><category term="reliability" /><summary type="html">How to add or remove a field from a Mongo collection without breaking the production?</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-bence-sandor-sztrecska-wIs-mjKMiw4-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-bence-sandor-sztrecska-wIs-mjKMiw4-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Writing Parameterized Tests in JUnit 5</title><link href="https://mincong.io/2021/01/31/juni5-parameterized-tests/" rel="alternate" type="text/html" title="Writing Parameterized Tests in JUnit 5" /><published>2021-01-31T16:12:25+01:00</published><updated>2021-01-31T16:12:25+01:00</updated><id>https://mincong.io/2021/01/31/juni5-parameterized-tests</id><content type="html" xml:base="https://mincong.io/2021/01/31/juni5-parameterized-tests/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;Writing tests is an important part of software development, it’s a good way to
ensure that your code works as expected. However, it is difficult to write tests
that cover all the scenarios. It’s also difficult to make them easy to understand
when the implementation is complex. In this article, we are going to see how
parameterized tests of JUnit 5 can help.&lt;/p&gt;

&lt;p&gt;After reading this article, you will understand:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The motivation of using parameterized tests&lt;/li&gt;
  &lt;li&gt;How to use parameterized tests&lt;/li&gt;
  &lt;li&gt;Different sources of arguments&lt;/li&gt;
  &lt;li&gt;The argument conversion&lt;/li&gt;
  &lt;li&gt;Interactions with IDE&lt;/li&gt;
  &lt;li&gt;When to use or not to use parameterized tests?&lt;/li&gt;
  &lt;li&gt;How to go further from here?&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;Why should we consider using parameterized tests in our code?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Improve test coverage.&lt;/strong&gt; Using parameterized testing can improve the code
coverage. Thanks to parameterized test, you can easily add more parameters, or
add more values for the same parameter to an existing test. This is done
without heavily changing the logic of the test code. By doing so, your
assertions cover more lines or more branches.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Reuse test code.&lt;/strong&gt; Using parameterized testing reuses the same test case for
multiple inputs. Therefore, it simplifies the code set up, improves the
maintainability of these tests, and therefore save your time to develop other
features or to write tests for other scenarios.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Clarify inputs and outputs.&lt;/strong&gt; Sometimes the test code is not as readable as you
may think about. Without putting additional effort into those tests, it can become
a nightmare to understand the purpose of this test, such as what are
the real input or output parameters of these tests. By using parameterized
testing, we extract those values as external parameters. Therefore, it’s easier
to understand. It’s easier because 1) we can see those parameters as method input
parameters; 2) we can find the reasoning of the inputs by comparing their common
points and differences.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Delegate the complexity to JUnit.&lt;/strong&gt; But why not just adding a for-loop inside
the test? Why using the parameterized testing feature in JUnit 5? Well, this is
because by doing so, we delegate the complexity to JUnit. More precisely, JUnit
ensures that each execution contains their set up and tear downs; the failure of
one execution won’t impact the other, they are isolated; we can have a nice
display name in IDE or build to explain the current execution; it can handle
different sources and type conversions, etc.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Validate multiple implementations.&lt;/strong&gt; Parameterized testing is also useful for
validating multiple implementations. These implementations may need to respect
the same specification. Therefore, we can express the expectations of this
specification as tests and require all implementations to pass these tests. This
is a good way to prevent regressions.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Testing the orthogonality.&lt;/strong&gt; Sometimes, one method accepts multiple input
parameters, they should be orthogonal. That is, the output of one scenario will
only depend on one input parameter, not others. So when changing the value of
any other parameters, the test result shouldn’t be changed. We can ensure that
the orthogonality is respected through parameterized testing.&lt;/p&gt;

&lt;p&gt;These are some reasons that I found during my daily development. I hope they are
enough to convince you to try parameterized testing. Now we understood the
motivation, we are going to check how to use it in the following section.&lt;/p&gt;

&lt;h2 id=&quot;prerequisite&quot;&gt;Prerequisite&lt;/h2&gt;

&lt;p&gt;Before using parameterized testing in JUnit 5, you have to declare 3
dependencies: the specification (API) and the implementation (engine) of the
JUnit 5, and also an additional module to support parameterized testing. Here is
what do they look like in the Maven POM file (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pom.xml&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;The specification (API) and the implementation (engine) are required for running
JUnit 5. You probably have them in your project already.&lt;/p&gt;

&lt;div class=&quot;language-xml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;org.junit.jupiter&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;junit-jupiter-api&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;5.7.0&lt;span class=&quot;nt&quot;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;scope&amp;gt;&lt;/span&gt;test&lt;span class=&quot;nt&quot;&gt;&amp;lt;/scope&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;org.junit.jupiter&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;junit-jupiter-engine&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;5.7.0&lt;span class=&quot;nt&quot;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;scope&amp;gt;&lt;/span&gt;test&lt;span class=&quot;nt&quot;&gt;&amp;lt;/scope&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then declare the additional Maven dependency to support parameterized testing:&lt;/p&gt;

&lt;div class=&quot;language-xml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;org.junit.jupiter&lt;span class=&quot;nt&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;junit-jupiter-params&lt;span class=&quot;nt&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;5.7.0&lt;span class=&quot;nt&quot;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;scope&amp;gt;&lt;/span&gt;test&lt;span class=&quot;nt&quot;&gt;&amp;lt;/scope&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;syntax&quot;&gt;Syntax&lt;/h2&gt;

&lt;p&gt;The basic syntax of a parameterized test is as follows:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nd&quot;&gt;@ParameterizedTest&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 1&lt;/span&gt;
&lt;span class=&quot;nd&quot;&gt;@ValueSource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;strings&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 2&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;racecar&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;radar&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;able was I ere I saw elba&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;palindromes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;candidate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 3&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;assertTrue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;StringUtils&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isPalindrome&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;candidate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where you can see that: 1) you need to use annotation &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@ParameterizedTest&lt;/code&gt; as
the replacement of the regular &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@Test&lt;/code&gt;; 2) an annotation containing a list of
sources to be used for the parameterized test; 3) one input parameter to
represent the source value provided by the annotation, it can also be multiple
input parameters: it depends on your sources.&lt;/p&gt;

&lt;h2 id=&quot;source-providers&quot;&gt;Source Providers&lt;/h2&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@ValueSource&lt;/code&gt; annotation can be used to provide a list of values, which each
item contains one single argument. It is supported for types: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;short&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;byte&lt;/code&gt;,
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;int&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;long&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;float&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;double&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;char&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;boolean&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;java.lang.String&lt;/code&gt;,
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;java.lang.Class&lt;/code&gt;. However, you may notice that value source can only provide
one argument at a time, so you have to keep your test simple to ensure that all
these arguments will fit the test.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nd&quot;&gt;@ValueSource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ints&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;})&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nd&quot;&gt;@ValueSource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;booleans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;})&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@ArgumentsSource&lt;/code&gt; annotation can be used to link to an arguments-provider,
which provides a stream of argument arrays (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Arguments&lt;/code&gt;) for the parameterized
tests. I found it useful for two cases: 1) providing multiple implementations of
the same interface, so that we can validate all of them using the same test, as
you can see in the code block below; 2) providing values that are computed from
another field in the codebase. This is not suitable for
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@ValueSource&lt;/code&gt; because the line will be long and unreadable. Using
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@ArgumentsSource&lt;/code&gt; makes the metadata of the test method more declarative.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nd&quot;&gt;@ParameterizedTest&lt;/span&gt;
&lt;span class=&quot;nd&quot;&gt;@ArgumentsSource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ChatBotProvider&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;sayHello&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ChatBot&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;assertThat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;sayHello&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Foo&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isEqualTo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Hello, Foo&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;assertThat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;sayHello&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Bar&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isEqualTo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Hello, Bar&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ChatBotProvider&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ArgumentsProvider&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Stream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Arguments&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;provideArguments&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ExtensionContext&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Stream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;StringFormatChatBot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;StringConcatenationChatBot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;Arguments:&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@CsvSource&lt;/code&gt; annotation can be used to declare multiple argument arrays, each
array representing one argument array. This is my favorite annotation for
providing sources because I can provide multiple arguments for each test case,
which is usually the case for enterprise development. You may notice that the
string value in the CSV source is converted to primitive type &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;int&lt;/code&gt; by JUnit.
This makes your tests concise. We will talk more about conversions in the next
section.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nd&quot;&gt;@ParameterizedTest&lt;/span&gt;
&lt;span class=&quot;nd&quot;&gt;@CsvSource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;({&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;1,  2, 2&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;1, -1, 1&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;1,  1, 1&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;testMax&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;assertThat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isEqualTo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are other source providers, such as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@EnumSource&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@NullSource&lt;/code&gt;,
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@EmptySource&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@MethodSource&lt;/code&gt;. They provide different types
of sources and they are easy to use. You can find the complete
documentation in &lt;a href=&quot;https://junit.org/junit5/docs/current/user-guide/#writing-tests-parameterized-tests-sources&quot;&gt;JUnit 5 User Guide - 2.15.3 Sources of
Arguments&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;conversion&quot;&gt;Conversion&lt;/h2&gt;

&lt;p&gt;From my experience, the CSV source seems to be the most frequently used
provider. But inside a CSV file, every row and every cell is considered as a
string. In this section, I want to share some tricks about type conversion. It
makes your code more concise: just let JUnit handle the work for you ;)&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;String-to-Primitive.&lt;/strong&gt; When providing a primitive type as an input parameter for
the test case, JUnit knows how to convert it. For example, given an input
parameter as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;int&lt;/code&gt;, then JUnit will convert your string into an integer
automatically. The same logic applies to other primitive types: long, double, float,
boolean, etc.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nd&quot;&gt;@ParameterizedTest&lt;/span&gt;
&lt;span class=&quot;nd&quot;&gt;@CsvSource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;({&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;1,  2, 2&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;1, -1, 1&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;1,  1, 1&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;testMax&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;assertThat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Math&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isEqualTo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;String-to-Enum.&lt;/strong&gt; When providing an enumeration type as an input parameter for the
test case, JUnit knows how to convert it as well (probably using the
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;valueOf(String)&lt;/code&gt; function of enumeration). Therefore, you don’t have to handle
the conversion yourself. Here is a concrete example about how to converting a
string into enum type &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FilePermission&lt;/code&gt;, and then test the executability for
different permission.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nd&quot;&gt;@ParameterizedTest&lt;/span&gt;
&lt;span class=&quot;nd&quot;&gt;@CsvSource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;({&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;R, false&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;W, false&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;RW, false&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;X, true&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;RX, true&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;WX, true&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;RWX, true&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;isExecutable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;FilePermission&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;perm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isExecutable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;assertThat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;perm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isExecutable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isEqualTo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isExecutable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;ide&quot;&gt;IDE&lt;/h2&gt;

&lt;p&gt;Another important part of testing is to understand how to use IDE so that it
can help you to be even more productive! In this section, I want to share two
things about IDE with you: how to check which parameterized test is running and
how to check the test coverage. Here I am using IntelliJ IDEA but I think the
methodology is still valid for other IDEs.&lt;/p&gt;

&lt;h3 id=&quot;ide-display-name-of-tests&quot;&gt;IDE: Display Name of Tests&lt;/h3&gt;

&lt;p&gt;When running the parameterized in JUnit 5, you can see each test
execution with the input parameters. For example, the test case
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;isWritable(FilePermission, boolean)&lt;/code&gt; is executed 7 times with different file
permission each time:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210131-junit5.png&quot; alt=&quot;Execution of JUnit 5 parameterized test in IntelliJ IDEA&quot; /&gt;&lt;/p&gt;

&lt;p&gt;It is also possible to customize the display names to print something more
human-readable. Personally, I prefer to avoid spending time on it. But if you
were interested, you can find it in the &lt;a href=&quot;https://junit.org/junit5/docs/current/user-guide/#writing-tests-parameterized-tests-display-names&quot;&gt;JUnit 5 User Guide §2.15.6. Customizing
Display
Names&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;ide-test-coverage&quot;&gt;IDE: Test Coverage&lt;/h3&gt;

&lt;p&gt;The main motivation of using parameterized testing is to increase
the test coverage and improve the robustness of the implementation. To review
the test coverage, you can run the tests with coverage and then check the
coverage. Here is how to trigger a “run tests with coverage” at package level
or class level in IntelliJ IDEA:&lt;/p&gt;

&lt;p&gt;Right-click on a Java package, such as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;io.mincong.junit5&lt;/code&gt; and select the option “Run ‘Test
in ‘io.mincong.junit5’’ with Coverage” to trigger the tests with coverage
enabled:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210131-coverage-package-level.png&quot; alt=&quot;Run tests with coverage at package level in IntelliJ IDEA&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Left-click on the test icon of the class name or the test name of a test file,
such as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FilePermissionTest&lt;/code&gt;, then select option “Run ‘FilePermissionTest’ with
Coverage” to trigger the tests with coverage enabled:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210131-coverage-class-level.png&quot; alt=&quot;Run tests with coverage at class level in IntelliJ IDEA&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Once the test execution is done, you can find the coverage report in different
views, such as the project view, the class file itself, or the dedicated test
coverage view:&lt;/p&gt;

&lt;p&gt;In the project, we can see the test coverage of each package and each class
inside the package. It gives a good overview of the current situation of a given
package.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210131-coverage-report-project-view.png&quot; alt=&quot;Coverage report at project view in IntelliJ IDEA&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Inside a class, it’s also possible to see the code coverage right next to the line
numbers. The color green is covered and the color red is not covered. This is useful
when you are modifying some logic, especially for some critical path, because
you want them to be covered by at least one test. This information helps you to
improve your tests.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210131-coverage-report-class-view.png&quot; alt=&quot;Coverage report at class view in IntelliJ IDEA&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The last view is the coverage view, where you can see a list of packages and
their coverage. You can also zoom into one package as the screenshot below and
inspect the coverage of each file inside the package.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210131-coverage-report-coverage-view.png&quot; alt=&quot;Coverage report at coverage view in IntelliJ IDEA&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;pros-and-cons&quot;&gt;Pros and Cons&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;When to use and not to use parameterized tests?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Now we understood how to use parameterized tests and get familiar with IDE, the
remaining question is: should we use it for our tests? I think it depends on
your needs. It’s not always the right choice. Here are some cases that I
summarized during my daily work. I hope that they will give you some
inspiration.&lt;/p&gt;

&lt;p&gt;As mentioned in the motivation section, you should use parameterized tests to:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Improve the test coverage&lt;/li&gt;
  &lt;li&gt;Reuse test code&lt;/li&gt;
  &lt;li&gt;Clarify inputs and outputs of your test&lt;/li&gt;
  &lt;li&gt;Delegate the complexity to JUnit&lt;/li&gt;
  &lt;li&gt;Validate multiple implementations&lt;/li&gt;
  &lt;li&gt;Testing the orthogonality of different parameters&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;But you shouldn’t use parameterized tests:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;if it makes the logic of the test difficult the understand. Typically, if it
introduces if-statements or other branches in the code.&lt;/li&gt;
  &lt;li&gt;if different arguments don’t share the same purpose. If they are different, it is
probably worth creating multiple test cases. A good way to know this is to
summarize the purpose in one sentence, if you cannot, it’s probably worth
writing different tests.&lt;/li&gt;
  &lt;li&gt;if there are too many input arguments. This can make the tests difficult to
maintain.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;To better understand parameterized tests of JUnit 5, visit the official
&lt;a href=&quot;https://junit.org/junit5/docs/current/user-guide/#writing-tests-parameterized-tests&quot;&gt;JUnit 5 User Guide §2.15 Parameterized
Tests&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;To learn more about testing, especially testing in Java, visit &lt;a href=&quot;/tags/testing/&quot;&gt;other articles
with tag “testing” of my blog&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If you want to see the source code of this article, they are available on GitHub
under module junit5 of project
&lt;a href=&quot;https://github.com/mincong-h/java-examples/tree/blog/junit5-parameterized-tests/junit5&quot;&gt;mincong-h/java-examples&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we saw the motivation of using parameterized testing in JUnit
5, how to declared dependencies, the annotations of different source providers
(value source, argument source, CSV source, …), the conversation from string
to primitive types and enum types, running tests and inspecting coverage in
IntelliJ IDEA, the pros and cons of using parameterized tests, and finally how
to go further from here.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;JUnit 5 User Guide, 2020.
&lt;a href=&quot;https://junit.org/junit5/docs/current/user-guide/&quot;&gt;https://junit.org/junit5/docs/current/user-guide/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="java-core" /><category term="java" /><category term="junit" /><category term="junit5" /><category term="testing" /><summary type="html">Improving code quality using parameterized tests of JUnit 5! This article explains the motivation, the basic syntax, different annotations, and IDE-related actions about parameterized tests. Also, when you should or shouldn't use it and how to go further from here.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-jean-louis-paulin-lHwmE58fW4Y-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-jean-louis-paulin-lHwmE58fW4Y-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">DVF: Snapshot And Restore</title><link href="https://mincong.io/2021/01/10/dvf-snapshot-and-restore/" rel="alternate" type="text/html" title="DVF: Snapshot And Restore" /><published>2021-01-10T11:46:21+01:00</published><updated>2021-01-10T11:46:21+01:00</updated><id>https://mincong.io/2021/01/10/dvf-snapshot-and-restore</id><content type="html" xml:base="https://mincong.io/2021/01/10/dvf-snapshot-and-restore/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;In the past articles, we saw how to index new documents for the open dataset
“Demande de valeurs foncières (DVF)” provided by the French government. We also
saw how to optimize the indexing process and optimize storage. In this
article, we are going to see something new: how to snapshot and restore in
Elasticsearch.&lt;/p&gt;

&lt;p&gt;But why do we want to do that? We want to snapshot data and store them as a backup
because it reduces the risk of data loss. If anything goes wrong in the
Elasticsearch cluster, we will be able to recover from the situation by
restoring the backups. It makes our storage system much more reliable. Having
snapshots also means having the possibility to move data around multiple
clusters, reducing the number of data replication (especially for warm storage),
etc. However, only knowing how to snapshot is not enough, it’s also essential
to understand how to restore your data and demonstrate that it works before
running into any actual incidents. That’s why it’s important to understand how
to snapshot and restore works in Elasticsearch.&lt;/p&gt;

&lt;p&gt;In this article, we are going to see some basics about snapshot and restore in
Elasticsearch using the filesystem. After reading this article, you will
understand how to:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;How to create a new snapshot repository of type &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fs&lt;/code&gt; (filesystem)?&lt;/li&gt;
  &lt;li&gt;How to create a new snapshot for one or multiple indices?&lt;/li&gt;
  &lt;li&gt;How to monitor the status of a snapshot creation?&lt;/li&gt;
  &lt;li&gt;How to list snapshots of a given repository?&lt;/li&gt;
  &lt;li&gt;How to restore a snapshot to an Elasticsearch cluster?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Note that this article is written using Elasticsearch 7.10 with Java 11. Now, let’s get started!&lt;/p&gt;

&lt;h2 id=&quot;register-a-snapshot-repository&quot;&gt;Register A Snapshot Repository&lt;/h2&gt;

&lt;p&gt;Before performing any snapshot operations (creation, listing, restore, deletion,
…), you need to create a snapshot repository first. There are different types
of snapshot repositories. Cloud repositories need additional repository plugins
to communicate with the target storage system. Here are the core types of
repositories and their related plugins:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Name&lt;/th&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;Type&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Plugin&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Filesystem&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fs&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;(built-in)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Amazon S3&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;s3&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/plugins/7.x/repository-s3.html&quot;&gt;S3 Repository Plugin&lt;/a&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Google Cloud Storage&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gcs&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/plugins/7.x/repository-gcs.html&quot;&gt;Google Cloud Storage Repository Plugin&lt;/a&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Azure&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;azure&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/plugins/7.x/repository-azure.html&quot;&gt;Azure Repository Plugin&lt;/a&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Hadoop HDFS&lt;/td&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hdfs&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/plugins/7.x/repository-hdfs.html&quot;&gt;Hadoop HDFS Repository Plugin&lt;/a&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Depending on the underlying infrastructure used, it makes sense to choose
one of these plugins and store your data there. For example, if you are using
Amazon Web Services in your company, you probably want to use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;s3&lt;/code&gt; for
storage. For this article, we are going to use the default &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fs&lt;/code&gt; one to facilitate
the set up so that we can focus on the snapshot operations. ⚠️  cloud snapshot
plugins are not part of this article.&lt;/p&gt;

&lt;p&gt;Before registering a snapshot repository, you need to ensure that the cluster is
started with the right configuration. For using a shared file system repository
(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fs&lt;/code&gt;), you need to declare the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;path.repo&lt;/code&gt; setting in Elasticsearch
configuration, such as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;elasticsearch.yml&lt;/code&gt; or environment variable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;path.repo&lt;/code&gt;.
In my demo, I am using the Elasticsearch Docker image and the path
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/elasticsearch/backup&lt;/code&gt; as the root path of repositories. This path is then
bound to environment variable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;esbackup&lt;/code&gt; in my mac.&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;esbackup&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;HOME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/es-backup/demo-dvf/&quot;&lt;/span&gt;

docker run &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--rm&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 9200:9200 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 9300:9300 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;discovery.type=single-node&quot;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;cluster.name=es-docker-cluster&quot;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;path.repo=/opt/elasticsearch/backup&quot;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$esdata&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;:/usr/share/elasticsearch/data &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$esbackup&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;:/opt/elasticsearch/backup &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  docker.elastic.co/elasticsearch/elasticsearch:7.10.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;path.repo&lt;/code&gt; is defined and the cluster is
started, it’s time to register a snapshot repository! In my case, all the data
of index &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;transactions&lt;/code&gt; have been indexed in the previous articles. So I just
need to call the API to register the repository. Since this project is around
DVF, so I am going to call the repository as “dvf”. The related PUT
request should be sent as follows:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT /_snapshot/dvf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;settings&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;location&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;dvf&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that the JSON path &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;settings.location&lt;/code&gt; refers to the path of this
repository. It can be an absolute path or a relative path. Regardless it is
absolute or relative, the canonical path must be under the root directory &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;path.repo&lt;/code&gt;
defined in Elasticsearch configuration. To better understand the location
setting, I prepared two screenshots for you, respectively for absolute path and
relative path:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210110-repo-path-absolute.png&quot; alt=&quot;Using absolute path to create snapshot repository (fs)&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In the screenshot above, we use an absolute path. You can see that the repository is located in path
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/elasticsearch/backup/dvf&lt;/code&gt; in the color blue. This path is under the root path of all repositories
(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;path.repo&lt;/code&gt;), which is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/elasticsearch/backup&lt;/code&gt; in the color red. The name of
the repository is called “dvf”,
written in color green. Also, from the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;find&lt;/code&gt; command, we can see that all the
data related to this repository are written inside the target location.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210110-repo-path-relative.png&quot; alt=&quot;Using relative path to create snapshot repository (fs)&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Now let’s take a look into the other version, done with the relative path. In the
screenshot above, you can see that the repository is located in
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/elasticsearch/backup/dvf&lt;/code&gt; in the color blue. The &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;path.repo&lt;/code&gt;
is still &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/elasticsearch/backup&lt;/code&gt; in color red. And the name of the
repository is called “dvf”, written in color green.
I believe this relative path is better because it allows us to decouple the
location settings with the actual location. We let Elasticsearch resolve the
actual path by looking into the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;path.repo&lt;/code&gt; settings and the location setting.
Therefore, in the Elasticsearch client, we won’t need to know the real path
anymore.&lt;/p&gt;

&lt;p&gt;Now we understand the difference between the root path of all the repositories
(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;path.repo&lt;/code&gt;), the name of the repository, and the location of the repository.
Let’s see how to write the same logic in Java using the Java High Level REST
Client. The code is easy to understand: you need to create a PUT repository
request with the name of the repository and the type of repository. Since we use
type &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fs&lt;/code&gt; here, we also need to provide the location, which is the relative path
“dvf”. Then, use an instance of the Java High Level REST client to retrieve
the underlying snapshot client. And finally, submit a request to perform the
creation. By the way, we are using the synchronous version here
(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;createRepository&lt;/code&gt;). There is also the asynchronous version:
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;createRepositoryAsync&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;PutRepositoryRequest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;dvf&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;fs&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Use relative path &quot;dvf&quot; and let Elasticsearch&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// to resolve the canonical path using environment&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// variable `repo.path`.&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;settings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;location&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;dvf&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;restClient&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;snapshot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;createRepository&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RequestOptions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;DEFAULT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;create-snapshot&quot;&gt;Create Snapshot&lt;/h2&gt;

&lt;p&gt;Now we have a snapshot repository, we can create a snapshot inside it. You can
create a new snapshot by sending a PUT HTTP request. The following request is
sent to repository &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dvf&lt;/code&gt; for creating a new snapshot called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;backup.2021-01-10&lt;/code&gt;
with some additional options provided in the request body. Option &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;indices&lt;/code&gt;
describes the list of indices to snapshot; option &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;include_global_state&lt;/code&gt;
describes whether the snapshot should include the cluster global state (we will
talk about this right after). Option &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;metadata&lt;/code&gt; which includes some metadata for
the snapshot; and more options that you can find in the official documentation
of Elasticsearch page &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/snapshots-take-snapshot.html&quot;&gt;“Create a snapshot
(7.x)”&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT /_snapshot/dvf/transactions.2021-01-10
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;indices&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;transactions&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;include_global_state&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;metadata&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;taken_by&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Mincong&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;taken_because&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;regular backup&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;According to the official document “Create a snapshot (7.x)” mentioned above,
the option &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;include_global_state&lt;/code&gt; is useful to choose whether you want to store the
cluster state as part of the snapshot. The global cluster state includes the
cluster’s index templates, such as those matching a data stream. If the snapshot
includes data stream, it’s recommended to store the state as part of the
snapshot so that later, you can restore templates required for a data stream.
In our case, we don’t need this because we don’t have any data stream.&lt;/p&gt;

&lt;p&gt;Now we understand which endpoint to use and its available options, it’s time to
check the usage in Java via Java High-Level REST Client. The code is straight
forward and easy to understand: you need to prepare a creation request and
submit this request via the Java client. During the preparation of the request,
provide the options that you want to control. Most of them are optional, you can
ignore them if you just want to use the default value of that option. The submission
can be done synchronously or asynchronously. The following code shows the
synchronous version:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;CreateSnapshotRequest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;repository&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;dvf&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;snapshot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;transactions.2021-01-10&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;includeGlobalState&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;restClient&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;snapshot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RequestOptions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;DEFAULT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;By default, the snapshot operation will return as soon as the snapshot is
initialized. If you want to wait until the completion of the snapshot, you can
change the setting &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;waitForCompletion(boolean)&lt;/code&gt; to true.&lt;/p&gt;

&lt;h2 id=&quot;snapshot-progress&quot;&gt;Snapshot Progress&lt;/h2&gt;

&lt;p&gt;As discussed above, snapshot operations may not be complete when the creation
response is returned. It may be just initialized and still in progress. To
retrieve all currently running snapshots with detailed status information, you
can use the following endpoint:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/_status
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or only focusing on one repository, e.g. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dvf&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/dvf/_status
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or only one snapshot, e.g. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;transactions.2021-01-10&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/dvf/transactions.2021-01-10/_status
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;snapshots&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;snapshot&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;transactions.2021-01-10&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;repository&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;dvf&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;uuid&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;DJE_mHGQSi-IqpxPPmqn0g&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;state&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SUCCESS&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;include_global_state&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;shards_stats&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;initializing&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;started&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;finalizing&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;done&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;failed&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;total&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;stats&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;incremental&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;file_count&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;18&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;size_in_bytes&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2644772&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;total&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;file_count&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;18&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;size_in_bytes&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2644772&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;start_time_in_millis&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1610891345219&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;time_in_millis&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1204&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;indices&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;transactions&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;shards_stats&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;initializing&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;started&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;finalizing&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;done&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;failed&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;total&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;stats&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;incremental&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
              &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;file_count&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;18&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
              &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;size_in_bytes&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2644772&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;total&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
              &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;file_count&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;18&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
              &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;size_in_bytes&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2644772&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;start_time_in_millis&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1610891345420&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;time_in_millis&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;602&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;shards&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;0&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
              &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;stage&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;DONE&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
              &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;stats&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;incremental&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;file_count&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;18&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;size_in_bytes&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2644772&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;total&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;file_count&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;18&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;size_in_bytes&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2644772&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;start_time_in_millis&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1610891345420&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;time_in_millis&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;602&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
              &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
            &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;list-snapshots&quot;&gt;List Snapshots&lt;/h2&gt;

&lt;p&gt;Once the creation is done, you can perform a GET request to get one target
snapshot using its name (e.g. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;transaction.2021-01-10&lt;/code&gt;); multiple snapshots
separated by comma &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;,&lt;/code&gt; (e.g. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;snapshot1,snapshot2&lt;/code&gt;); all snapshots using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_all&lt;/code&gt;
or wildcard &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/{repository}/{snapshot_expression}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/dvf/_all
GET /_snapshot/dvf/transactions.2021-01-10
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;snapshots&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;snapshot&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;transactions.2021-01-10&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;uuid&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;DJE_mHGQSi-IqpxPPmqn0g&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;version_id&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7100199&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;version&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;7.10.1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;indices&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;transactions&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;data_streams&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;include_global_state&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;metadata&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;taken_by&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Mincong&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;taken_because&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;regular backup&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;state&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SUCCESS&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;start_time&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;2021-01-17T13:49:05.219Z&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;start_time_in_millis&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1610891345219&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;end_time&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;2021-01-17T13:49:06.423Z&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;end_time_in_millis&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1610891346423&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;duration_in_millis&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1204&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;failures&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;shards&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;total&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;failed&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;successful&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;restore-snapshot&quot;&gt;Restore Snapshot&lt;/h2&gt;

&lt;p&gt;Now we know how to create and list snapshots. It’s time to see how to restore a
snapshot. Restore is an important operation because you never know if a backup
(snapshot) works until you restore it! To restore a snapshot, you can use the
following POST request by providing the name of the repository and the name of
the snapshot:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;POST /_snapshot/{repository}/{snapshot}/_restore
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For example, restoring the snapshot &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;transactions.2021-01-10&lt;/code&gt; from the
repository &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dvf&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;POST /_snapshot/dvf/transactions.2021-01-10/_restore
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;accepted&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that there are a lot of options available for the restore operation, but
it’s not the main goal of this article so I will just skip them. You can find
them in the official documentation of Elasticsearch &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/snapshots-restore-snapshot.html&quot;&gt;“Restore a snapshot
(7.x)”&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;As you can see from the HTTP response above, when a restore operation is
launched, we only retrieve an acknowledgment from the HTTP response. To monitor
the actual progress of the restore operation, you can use the index recovery API
or the cat recovery API.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /transactions/_recovery
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;transactions&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;shards&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;SNAPSHOT&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;stage&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;DONE&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;primary&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;start_time_in_millis&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1610894357787&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;stop_time_in_millis&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1610894359714&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;total_time_in_millis&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1927&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;repository&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;dvf&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;snapshot&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;transactions.2021-01-10&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;7.10.1&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;transactions&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;restoreUUID&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;JdeVFJUUR26trdhKYY-aGg&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_cat/recovery
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;transactions 0 1.9s snapshot done n/a n/a 172.17.0.3 fff70d104028 dvf transactions.2021-01-10 18 18 100.0% 18 2644772 2644772 100.0% 2644772 0 0 100.0%
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, let’s see how to do the same restore operation using Java client:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RestoreSnapshotRequest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;repository&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;dvf&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;snapshot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;transactions.2021-01-10&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;restClient&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;snapshot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;restore&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RequestOptions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;DEFAULT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;By default, the restore operation will return as soon as the restore request is
accepted. If you want to wait until the completion of the restore operation, you
can change the setting  &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;waitForCompletion(boolean)&lt;/code&gt; to true.&lt;/p&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;To learn more about snapshot and restore in Elasticsearch, visit page
“Snapshot and restore (7.x)” of Elasticsearch and other pages in that section
&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/snapshot-restore.html&quot;&gt;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/snapshot-restore.html&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;To learn more about dataset “Demande de valeurs foncières”, visit page
&lt;a href=&quot;https://cadastre.data.gouv.fr/dvf&quot;&gt;https://cadastre.data.gouv.fr/dvf&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we saw how to register a snapshot repository, create a
snapshot, monitor the snapshot progress, and restore a snapshot back to an
Elasticsearch cluster. All these operations are done using the open dataset
“Demande de valeurs foncières (DVF)”.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Elasticsearch, “Snapshot and restore (7.x)”, 2021.
&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/snapshot-restore.html&quot;&gt;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/snapshot-restore.html&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Elasticsearch, “Create a snapshot (7.x)”, 2021.
&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/snapshots-take-snapshot.html&quot;&gt;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/snapshots-take-snapshot.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="elasticsearch" /><category term="elasticsearch" /><category term="java" /><summary type="html">Part 4: How to create a snapshot for index &quot;transactions&quot; of DVF and restore it to an Elasticsearch cluster.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-leonard-cotte-R5scocnOOdM-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-leonard-cotte-R5scocnOOdM-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Highlight 2020</title><link href="https://mincong.io/2021/01/02/highlight-2020/" rel="alternate" type="text/html" title="Highlight 2020" /><published>2021-01-02T16:13:01+01:00</published><updated>2021-01-02T16:13:01+01:00</updated><id>https://mincong.io/2021/01/02/highlight-2020</id><content type="html" xml:base="https://mincong.io/2021/01/02/highlight-2020/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;Every chapter has an end and we finally finished the year 2020. 2020 was a
difficult year for everyone and COVID-19 changed completely the way we work and
live. Many people were infected, some left forever. That’s why I chose a grey
image from Kelly Sikkema for this article: to remember the people that were
impacted, to remember that life can be challenging, and to thank those who
protect us and avoid the situation being worse.&lt;/p&gt;

&lt;p&gt;Despite all the difficulties, I am lucky enough to say that 2020 was a good
year for me. In this article, I would like to share my technical journey
at Datadog as a software engineer working for data storage. Some personal projects I
did during my free time, such as open-source project VAVR and this technical blog
&lt;a href=&quot;https://mincong.io&quot;&gt;https://mincong.io&lt;/a&gt;. They are not just about what I did, but also
some thoughts and lessons learned that I want to share with you. Now, let’s get started!&lt;/p&gt;

&lt;h2 id=&quot;datadog&quot;&gt;Datadog&lt;/h2&gt;

&lt;p&gt;I joined Datadog at the end of 2019 as a software engineer working for the Event
Platform. Event Platform ingests trillions of events per day for different
products: Logs, APM, Profiling, Real User Monitoring (RUM), Security Analytics,
Error Tracking, Network Monitoring, and more. I am mainly working on the storage
part, where we host thousands of servers for storing these events. I am really
proud of being part of the team. There are many technical challenges to handle and my
teammates are very talented. Back in 2019, I wrote an article &lt;a href=&quot;/2019/11/17/dd-onboarding/&quot;&gt;“Datadog
Onboarding Recap”&lt;/a&gt;. But now, after working a full
year here, I found more interesting points to share with you.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Reliability.&lt;/strong&gt; Reliability is the key to our backend services. We spent a lot
of effort to: ensure service availability, reduce the impact across
services when a problem happens, reduce the impact across customers, and ensure
that we don’t lose any customer data. This is important for any SaaS
application, but I believe it’s even more important for Datadog as a monitoring
tool. People usually use Datadog in a critical situation, such as during an
incident, so Datadog cannot disappoint them. This year, I contributed to this
field in many tasks, such as adding throttling to some services to reduce the impact at peak
activity; backing-off client requests when servers are overloaded; participate
in the changes of data lifecycle so that we snapshot and restore data
continuously and much more.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Observability.&lt;/strong&gt; When I was a junior developer, I cared a lot about the
correctness of the code. But the reality is not just about right and wrong, it’s
more complex than that. Many factors can make software not working as
expected: the traffic volume, the network conditions, the hardware, the order of
execution, the parallelism, the state of the server, etc. Having observability
makes it much easier to operate a running system. Talking about observability,
we can use metrics, logs, tracing, etc to observe our application and the
underlying infrastructure. At Datadog, I learned how to write code with
observability in mind. Some basic ideas are: adding a log when the code faces an
important event; providing metrics about the application state or resources;
adding spans to code blocks to understand and visualize the workflow; measuring the
performance with statistics (p50, p90, p95, p99).&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;On-call.&lt;/strong&gt; In our platform with 50+ engineers and managers, everyone
participates in on-call rotations. No matter you are a software engineer, a team
lead, or a director, you need to be part of the rotation. We do that 24/7,
i.e. whenever there is a problem in production, at least one person is notified
and has to reply in minutes. There is also an escalation policy to ensure we don’t
miss any potential problems. This policy is also here to help the primary on-call
person for bigger incidents (outages) because one person may not be enough. This
year is the first time I participated in the on-call activity. I cannot say that I
enjoyed it, that would be a lie. Being paged at 3 AM in the morning trying to fix
a problem isn’t fun at all. But globally speaking, it’s worth the effort because
it reminds us of the importance of site reliability. If we were paged, it means our
customers are having problems — at least a subset of them. It is a great
motivation to improve the system and avoid the same problem from happening again.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Multi-language.&lt;/strong&gt; We use multiple programming languages to build our services.
The majority of the Event Platform services are written in Java, but we also use JS
for the front-end, Python and Bash for scripting, and Go for the agents.
This is a good opportunity to
learn other languages, know the advantages and inconveniences of each of them.
It also forces us to think about packaging and communication flow between
services. For example, we deliver Docker images as artifacts, use RESTful APIs
for many exchanges. On my side, I learned a lot about Python this year working
on scripting and an internal toolbox for Elasticsearch clusters. I definitely
miss the strong typing of Java, but I enjoy using JSON in Python, which is much
easier.&lt;/p&gt;

&lt;h2 id=&quot;oss&quot;&gt;OSS&lt;/h2&gt;

&lt;h3 id=&quot;vavr&quot;&gt;Vavr&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/vavr-io&quot;&gt;Vavr&lt;/a&gt; (formerly called Javaslang) is a non-commercial, non-profit
object-functional library that runs with Java 8+. It aims to reduce the lines
of code and increase code quality. It brings the concept of Scala to the Java
ecosystem. After being a member of this project, I contributed several patches
to Vavr in 2020:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210102-vavr-2020.png&quot; alt=&quot;My contributions to VAVR organization&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Vavr-core:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/vavr-io/vavr/pull/2572&quot;&gt;#2572 Support Option.orNull()&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/vavr-io/vavr/pull/2577&quot;&gt;#2577 Iterate once to create two iterators in
partition&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Vavr-jackson:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/vavr-io/vavr-jackson/pull/155&quot;&gt;#155 Collection serializers and deserializer should be contextual&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/vavr-io/vavr-jackson/pull/158&quot;&gt;#158 Serializer and deserializer of Map and Multimap should be contextual&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/vavr-io/vavr-jackson/pull/163&quot;&gt;#163 Support deserializeNullAsEmpty for maps&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/vavr-io/vavr-jackson/pull/166&quot;&gt;#166 Deserialize classes Option.{Some,None}&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;You can see the complete list of contributions &lt;a href=&quot;https://github.com/vavr-io/vavr/pulls?q=is%3Apr+is%3Aclosed+author%3Amincong-h&quot;&gt;here for
vavr-core&lt;/a&gt;
and &lt;a href=&quot;https://github.com/vavr-io/vavr-jackson/pulls?q=is%3Apr+is%3Aclosed+author%3Amincong-h&quot;&gt;here for
vavr-jackson&lt;/a&gt;.
I also wrote an article for the &lt;a href=&quot;https://blog.vavr.io/vavr-jackson-1-0-0-alpha-3/&quot;&gt;release note of vavr-jackson 1.0.0 Alpha
3&lt;/a&gt; in &lt;a href=&quot;https://blog.vavr.io&quot;&gt;https://blog.vavr.io&lt;/a&gt;.
However, starting from this summer, I lost my interest in continuing the
contributions because I don’t have the opportunity to use vavr in Datadog and I
don’t see other opportunities to use this library in the mid-term. So I stopped
investigating my time on it and tried to put effort into other fields that are
more related to my current work.&lt;/p&gt;

&lt;h3 id=&quot;algorithm&quot;&gt;Algorithm&lt;/h3&gt;

&lt;p&gt;I have two GitHub repositories about the algorithm and I want to share them with you
today.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210102-algo.png&quot; alt=&quot;GitHub projects: mincong-h/algorithm-princeton and AlgoStudyGroup/Leetcode&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/mincong-h/algorithm-princeton&quot;&gt;mincong-h/algorithm-princeton&lt;/a&gt;
– This project contains my solutions for the Coursera online course:
Introduction to Algorithms, created by Princeton University, taught by Kevin
Wayne, Senior Lecturer, and Robert Sedgewick, Professor. I created this project
when I learned the course back in 2016 and stop maintaining it after. People
keep adding stars since then and now reached 90 stars!! I am quite surprised by
the popularity of the project but I am happy to see that people love it and find
it useful. It makes me understand that hard work gets paid in the end, but you
need to be patient to see that day coming. It also encourages me to write software
with the quality so that it will still work years after.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/AlgoStudyGroup/Leetcode&quot;&gt;AlgoStudyGroup/Leetcode&lt;/a&gt; – This
project contains solutions of multiple LeetCode challenges starting
from Challenge April 2020 to Challenge November 2020. The solutions are written
in different languages: C++, C#, Python, Java, Scala, JS, Kotlin. This project
was created by &lt;a href=&quot;https://github.com/jinshendan&quot;&gt;Shendan Jin&lt;/a&gt; and followed by many
other Chinese developers in France when we were bored during the May holidays
and the COVID lockdown. It was fun!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210102-AlgoStudyGroup.png&quot; alt=&quot;GitHub project: AlgoStudyGroup/Leetcode&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;blogging&quot;&gt;Blogging&lt;/h2&gt;

&lt;p&gt;In 2020, I wrote 28 articles and updated some existing ones. Most of these blog
posts are about Java and Elasticsearch. They reflect on what I learned and practiced in my
daily work. Here you can see an overview of them, grouped by quarter:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210102-2020-overview.png&quot; alt=&quot;Blogging overview for 2020&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I like writing blog posts because it has several advantages.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;It is a good way to express technology in a human-readable way. Different
from writing code, this way is more accessible to most people, even
for those that have a little knowledge about the target framework or the language.&lt;/li&gt;
  &lt;li&gt;It expresses the motivation and reasoning behind logical choices. Why we need
this, why we need that, why shouldn’t we do it in this way, etc. As developers,
we need to make decisions every day, it’s important to know the pros and cons,
argue the benefits and potential risks face to choices.&lt;/li&gt;
  &lt;li&gt;It structures my skills. When writing code, I only know the fraction of the
framework I use. Writing articles allow me to take a step back and understand
the big picture and other important aspects provided by the product/framework/language.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In 2020, I received 234k page views from 182k users all around the world. It’s a
25% increase in terms of page views and a 23% increase in terms of users. Over the
4 years, the traffic grew and dropped, there were a lot of back-and-forths. For
example, it dropped significantly end of last year when my article &lt;a href=&quot;/2018/05/02/git-upstream-tracking/&quot;&gt;Git:
Upstream Tracking Understanding&lt;/a&gt; was not
featured by Google anymore and when I changed the domain name from
&lt;a href=&quot;https://mincong-h.github.io&quot;&gt;https://mincong-h.github.io&lt;/a&gt; to &lt;a href=&quot;https://mincong.io&quot;&gt;https://mincong.io&lt;/a&gt;. But overall, the trend is
growing up. Back to the 234k page view, it’s
such a pleasure to see that my articles are useful for other people! It gives me
the motivation to continue writing. Writing for the author himself may just be a daily
task, but for readers, it may be the answer for a long-pending problem, a solution
for a bug encountered in production, a confusing issue that requires
clarification. This reminds me to always go further in my
article, find the value points for readers.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210102-blog-stats-last-4-years.png&quot; alt=&quot;Google Analytics - The statistics of my blog mincong.io from 2017 to 2020&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Among all the articles written this year, the top 3 articles getting the most
page views are:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;a href=&quot;/2020/04/19/mockito-junit5/&quot;&gt;Mockito: 3 Ways to Init Mock in JUnit 5&lt;/a&gt;
(13,340 page views)&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/2020/05/30/exception-handling-in-completable-future/&quot;&gt;3 Ways to Handle Exception In Completable
Future&lt;/a&gt; (10,031 page
views)&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/2020/01/19/elasticsearch-scroll-api/&quot;&gt;Elasticsearch Scroll API&lt;/a&gt; (2,486 page
views)&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;I hope that in 2021, I can share more valuable articles with you!&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Thank you for reading this whole article. In this post, I shared some lessons
learned from Datadog as a software engineer, open-source contributions at Vavr,
and two projects related to Algorithm. Finally, some statistics and thoughts
about this blog &lt;a href=&quot;https://mincong.io&quot;&gt;https://mincong.io&lt;/a&gt;.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="review" /><category term="career" /><summary type="html">My tech journey at Datadog in 2020 as a software engineer working for data storage. Also pieces about blogging, open source software VAVR, and other side-projects.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-kelly-sikkema-ZHUi4uX6ipY-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-kelly-sikkema-ZHUi4uX6ipY-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>