<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.2.0">Jekyll</generator><link href="https://mincong.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://mincong.io/" rel="alternate" type="text/html" hreflang="en" /><updated>2022-01-02T09:39:39+01:00</updated><id>https://mincong.io/feed.xml</id><title type="html">Mincong Huang</title><subtitle>Hi, welcome to my blog! I'm a software engineer at Datadog. I write blog posts in my free time. My blogs are bits and pieces of my tech journey. Most of them are related to Java. Hope you enjoy them! My opinions are my own, not Datadog's. This blog is powered by Jekyll, a simple, blog-aware, static sites solution.
</subtitle><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><entry xml:lang="en"><title type="html">Highlight 2021</title><link href="https://mincong.io/en/highlight-2021/" rel="alternate" type="text/html" title="Highlight 2021" /><published>2021-12-30T14:12:23+01:00</published><updated>2021-12-30T14:12:23+01:00</updated><id>https://mincong.io/en/highlight-2021</id><content type="html" xml:base="https://mincong.io/en/highlight-2021/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;Writing an article for an annual review becomes a tradition for me. After
writing it for 5 consecutive years
(&lt;a href=&quot;/2016/09/01/projects-highlight-2015-2016/&quot;&gt;2016&lt;/a&gt;,
&lt;a href=&quot;/2017/11/26/highlight-2017/&quot;&gt;2017&lt;/a&gt;,
&lt;a href=&quot;/2018/12/21/highlight-2018/&quot;&gt;2018&lt;/a&gt;,
&lt;a href=&quot;/2019/12/31/highlight-2019/&quot;&gt;2019&lt;/a&gt;,
&lt;a href=&quot;/2021/01/02/highlight-2020/&quot;&gt;2020&lt;/a&gt;), I decided to
continue this year, to share with you my journey in the tech
industry, as a software engineer at Datadog and as an explorer for other side-projects
during my free time. Hopefully, they will let you learn something or inspire
you to create your story. Now, let‚Äôs get started!&lt;/p&gt;

&lt;h2 id=&quot;datadog&quot;&gt;Datadog&lt;/h2&gt;

&lt;p&gt;I joined Datadog at the end of 2019 as a software engineer working for the Event
Platform. Event Platform ingests trillions of events per day for 30+ products:
Logs, APM, Profiling, Real User Monitoring (RUM), Security Analytics, Error
Tracking, Network Monitoring, and more. This year, I kept working on the storage
part of the platform, developing new solutions to ensure data reliability,
reduce costs, and reduce operational work for other engineers. I was part of
the ‚ÄúEvent Storage Lifecycle‚Äù team and then moved to ‚ÄúEvent Platform Automation‚Äù
team on October. Here are some of my contributions related to these teams.&lt;/p&gt;

&lt;p&gt;Why ‚ÄúEvent Platform Automation‚Äù? Since the platform grew fast, having manual operations became
more and more painful. Operating a large-scale system without dedicated
operations engineers and site-reliability engineers (SRE) became very challenging.
I had the privilege to be part of this team since October 2021! The goals are to improve
the system operability at different levels (workflow automation, configuration
simplification, automatic checks, admin UI), pushing the
reliability to the next level (availability-zone failures, node-lifecycle
automation), and improve the deployment process for our microservices. Ok,
enough introduction, let‚Äôs go to the contributions now :)&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Indexold.&lt;/strong&gt; Indexold is a custom solution for data lifecycle management. It is
a state machine that manages the lifecycle of the data once they are stored in
our system. Similar to Elasticsearch‚Äôs &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.16/overview-index-lifecycle-management.html&quot;&gt;Index Lifecycle Management
(ILM)&lt;/a&gt;,
it allows moving data from computation-intensive machines to storage-friendly
machines. It allows storing historical data in a cost-efficient way, making
operations easy, having control about the data placement, and being resilient to node
failures. The development of this project last over 3 quarters and we have about
3 engineers working on it full time. I mainly participated to: storage
optimization (data compression), re-snapshotting, data deletion, rollout to
production (AWS, GCP, Azure), and maintenance. The solution is based on Akka,
MongoDB, and Elasticsearch.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Automation.&lt;/strong&gt; At Datadog, we use &lt;a href=&quot;https://temporal.io/&quot;&gt;Temporal&lt;/a&gt; as a workflow
engine for our automation. I made several workflows, such as one for
decommissioning
Elasticsearch cluster and one for providing checks for the provisioning our
pipelines. These workflows contain interactions to other services in the system
to read content (GitHub), communicate with the operator (Slack), improve
observability (Datadog), or manipulate resources (Kubernetes, Elasticsearch,
internal services). This year, I also wrote one article &lt;a href=&quot;/en/error-retries-in-temporal/&quot;&gt;Error Retries in Temporal
Workflow&lt;/a&gt; and I made my first contribution to Temporal Java SDK (&lt;a href=&quot;https://github.com/temporalio/sdk-java/releases/tag/v1.5.0&quot;&gt;release
notes v1.5.0&lt;/a&gt;) and
hopefully, I can contribute more next year!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20211231-temporal-java-sdk-1st-contribution.png&quot; alt=&quot;First contribution to Temporal SDK&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Operations.&lt;/strong&gt; Our operations were mainly to upgrade our data stores (VM at
node level, JVM, ES, configuration), deploying to zonal clusters, moving existing data stores from
one Kubernetes cluster to another due to capacity constraint, etc. It‚Äôs not
something very interesting in terms of development but it‚Äôs essential to be
compliant and keeping the business running.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;On-call.&lt;/strong&gt; According to &lt;a href=&quot;https://www.pagerduty.com/&quot;&gt;PagerDuty&lt;/a&gt;, I was on-call
for 1265h 20m in 2021 (actually I am still on-call when I am writing
this article üòÖ). I handled 228 high-urgency issues in total and 32 of them
were incidents. I suspect the total on-call duration is wrong because it may
include the Interrupt Handling (IH) work that is also in PagerDuty with much
lower priority. But anyway, it provides a sense of how important it is to
keep the production running at Datadog. And I am quite proud of it because it‚Äôs
a collective work and it contributed to the success of the business. Perhaps I
will write some articles around how to be on-call since I have some experience
in it.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Interviewer.&lt;/strong&gt; I started the training to become an interviewer in October 2021. 
I saw many colleagues were doing well on this, so why not try to be part of
the team? One major reason that I want to do this is that this YouTube video,
&lt;a href=&quot;https://youtu.be/s6tLGo9yij0&quot;&gt;I Increased My Productivity 10x - By Turning My Life Into a
Game&lt;/a&gt;, motivated me to gamify my activities and
explore new possibilities, like being an interviewer. I handled 3
shadow interviews so far.
My colleagues told me that I lead the exercise and technical aspect
of the interview well; selling, behavior, and communication went well; they also
appreciated my feedback which gives them detailed
and precise information about the candidate. All these made me happy.
They also suggested improvement around the time management and explanation
around some important details. For me, it‚Äôs also a good opportunity to learn what
other people are doing as well.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;What‚Äôs next?&lt;/strong&gt; In 2022, I would like to own more OKRs to help the team to
solve more problems. It probably requires expanding my skill set so that I can
implement the solutions from end to end. I would also like to create some
opportunities to encourage teamwork because together we can go more further. And
finally, I‚Äôd like to explore some new areas, such as the read path of
Elasticsearch, other data storage systems, or data processing as the upstream of
data storage.&lt;/p&gt;

&lt;h2 id=&quot;blogging&quot;&gt;Blogging&lt;/h2&gt;

&lt;p&gt;In 2021, I wrote 42 articles (25 in English and 17 in Chinese). 19 of them are
related to Elasticsearch, 7 of them are related to Java, and some posts on other
topics like Bash scripting, Nginx, MongoDB, Jekyll, and Javascript. This year I
changed the blog theme to &lt;a href=&quot;https://github.com/kitian616/jekyll-TeXt-theme&quot;&gt;Jekyll TeXt
Theme&lt;/a&gt; and added
&lt;a href=&quot;/en/jekyll-i18n/&quot;&gt;internationalization&lt;/a&gt; support to make the blog more
consistent when navigating between English and Chinese blog posts.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Focus on search.&lt;/strong&gt; Most of these new articles are
related to Elasticsearch. For example, there are series &lt;a href=&quot;/en/series/dvf/&quot;&gt;‚ÄúDVF‚Äù&lt;/a&gt;
which demonstrates Elasticsearch‚Äôs usage for indexing, storage, search, and analytics
using French open dataset for real-estate: ‚ÄúDemande de valeurs fonci√®res
(DVF)‚Äù; series &lt;a href=&quot;/en/series/es-snapshots/&quot;&gt;‚ÄúElasticsearch Snapshots‚Äù&lt;/a&gt; which
explores different aspects of the feature ‚ÄúSnapshot And Restore‚Äù in Elasticsearch;
series &lt;a href=&quot;/en/series/es-admin/&quot;&gt;‚ÄúElasticsearch Cluster Administration‚Äù&lt;/a&gt; which
provides hints for managing Elasticsearch clusters in production. Here are the
articles for the DVF series:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20211231-dvf.png&quot; alt=&quot;DVF&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Advertising.&lt;/strong&gt; This year I added the advertising feature for my blog. I wanted
to do this because having revenue gives me the motivation to keep writing. I chose
&lt;a href=&quot;https://www.ethicalads.io/&quot;&gt;EthicalAds&lt;/a&gt; because its advertising is transparent
for readers: they don‚Äôt use cookies to track users, but they match ads based on
the content of the site. The ads are relevant to technologies. Currently, I am
going to earn about $51.67 (before tax) over the last 2 months and a half.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Audience.&lt;/strong&gt; 2021 continued to be a great year. More and more people visited my
blog. In 2021, I received 294k page views from 222k users, that is a 25%
increase in terms of page views and a 21% increase in terms of users. Seeing my
articles are useful for other people really motivates me to keep writing.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20211231-blog-audience.png&quot; alt=&quot;Audience Overview 2021 vs 2020 via Google Analytics&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;What‚Äôs next?&lt;/strong&gt; In 2022, I would like to continue my focus on data storage because this is
my expertise and hopefully they will be valuable for you as well. Then, I would
also like to expand the scope to see the bigger picture: performing architecture
reviews, translating engineering blogs written by other engineers, writing a series of blog
posts, etc. Then it will also be great to increase the publishing cadence
because it took me too long to write one article. I want to improve
that by introducing a new blog post type: question-and-answer (Q&amp;amp;A), which is a
short article containing one question and one answer. Hopefully, it would be
possible for readers to subscribe to my mailing list so that I can share the
update on a weekly or monthly basis. This should help reduce the bounce rate
as well. To summarize, the 4 goals are: keeping the focus on data storage,
expanding the scope, improving delivery speed, and attracting more loyal users.&lt;/p&gt;

&lt;h2 id=&quot;other-projects&quot;&gt;Other Projects&lt;/h2&gt;

&lt;p&gt;I tried other projects as well. But most of the projects are unsuccessful, but
I think it‚Äôs still worth sharing why I tried and why it didn‚Äôt work.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Vavr&lt;/strong&gt; (‚ùå). Vavr is an object-functional library that runs with Java 8+. I tried to
persuade my teammates to integrate this library in our backend during a
hackathon. However, the idea was rejected because the naming of vavr‚Äôs types
(List, Set, Map, ‚Ä¶) are too invasive and therefore conflicting with the
standard Java library. So it‚Äôs hard to keep both during migration. Also, it‚Äôs
hard to prove its performance for the critical path (having millions of messages
being handled per second). My proposal was rejected. I didn‚Äôt see
any perspective of using this framework in the short-term or mid-term. Therefore, I
decided to stop the contribution and move forwards to something else.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Finance-toolkit&lt;/strong&gt; (üê¢). Finance toolkit is a small library helping you to
understand your personal financial situation by extracting, transforming, and
aggregating transactions from different companies into a single place:
BNP Paribas, Boursorama, Degiro, October, and Revolut. It generates CSV files
that can be used for data visualization in Jupyter Notebook.
It was created in 2019 and written in Python by
&lt;a href=&quot;https://github.com/jingwen-z/&quot;&gt;Jingwen Zheng&lt;/a&gt; and I, with some help from
&lt;a href=&quot;https://github.com/BoboTiG&quot;&gt;Micka√´l Schoentgen&lt;/a&gt;.
This project still continues at a slow pace.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Sunny&lt;/strong&gt; (ü§î). &lt;a href=&quot;https://sunnytj.info/#/&quot;&gt;Sunny Tejiao&lt;/a&gt; (Èò≥ÂÖâÁâπÊïôÁΩë) is a
non-commercial website that I created last year. It aims to help Chinese
teachers working in special education to better gather Chinese-version
material for preparing their courses. I did this during my holidays because I
feel that there is a lack of Chinese resources in mainland China and it‚Äôs
hard for teachers to search from the open internet due to government
restrictions. I did this also because my mother is a teacher working in a school for
special education. Therefore, I feel like it‚Äôs a good opportunity for doing so.
However, I had to pause the project because my mother didn‚Äôt have enough time to
help me and she probably had other priorities in her life.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Thank you for reading this whole article. In this post, I shared some projects
or important tasks that I did at Datadog as a software engineer, my blogging
experience, and some other projects that I explored.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="review" /><category term="review" /><category term="career" /><summary type="html">My tech journey at Datadog as a software engineer and some side-projects in my free time.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-markus-winkler-EcgyryGygeE-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-markus-winkler-EcgyryGygeE-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">The Decision System For Shard Allocation in Elasticsearch</title><link href="https://mincong.io/en/shard-allocation-deciders/" rel="alternate" type="text/html" title="The Decision System For Shard Allocation in Elasticsearch" /><published>2021-12-27T14:36:13+01:00</published><updated>2021-12-27T14:36:13+01:00</updated><id>https://mincong.io/en/shard-allocation-deciders</id><content type="html" xml:base="https://mincong.io/en/shard-allocation-deciders/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;Shard allocation plays an important role in the data distribution of an
Elasticsearch cluster. Having all the shards allocated ensures the good health
of your cluster and avoids potential data loss. That‚Äôs why it‚Äôs important to
avoid unassigned shards and avoid yellow cluster. But as a software engineer or
as a database administrator (DBA), do you know how the decision is made
internally? How does Elasticsearch know which node should be used? In this
article, we are going to study this part by exploring the decider system.&lt;/p&gt;

&lt;p&gt;After reading this article, you will understand:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The responsibility of allocation service and allocation deciders.&lt;/li&gt;
  &lt;li&gt;The structure of these 19 deciders.&lt;/li&gt;
  &lt;li&gt;How do they make decisions?&lt;/li&gt;
  &lt;li&gt;The deciders‚Äô position in the lifecycle of an ES node.&lt;/li&gt;
  &lt;li&gt;How to test them?&lt;/li&gt;
  &lt;li&gt;How to go further from this article?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;And hopefully, this article will help you better understand the internal mechanism
or inspire you to make your decision system based on a similar
architecture. Note that this article is written with Elasticsearch 7.16.2
(latest), which may be different from what you are using. Now, let‚Äôs get started!&lt;/p&gt;

&lt;h2 id=&quot;responsibility&quot;&gt;Responsibility&lt;/h2&gt;

&lt;p&gt;Allocation deciders are part of the allocation service in Elasticsearch. This
service manages the shard allocation of a cluster. For this reason, the
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AllocationService&lt;/code&gt; contains an instance of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AllocationDeciders&lt;/code&gt; to choose nodes for shard
allocation. This class also manages new nodes joining the cluster
and the rerouting of shards. If none of the nodes accepts the allocation, the shard
will remain unassigned. Having unassigned shard leads to under-replicated
shards. It will probably result to a yellow cluster and increase the risk of data loss.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Which actions require decisions?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;We can find this information from the abstract class &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AllocationDecider&lt;/code&gt;.
An allocation decider can decide for many actions: allocation,
rebalancing, keeping the shard in the current node (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;canRemain&lt;/code&gt;), and auto-expanding the
shards of a given index. Each method returns a decision so that the allocation service knows
how to react. Each action respects the naming convention &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;can{Action}&lt;/code&gt; or
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;should{Action}&lt;/code&gt;. Here is a more detailed version:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;‚ûú  elasticsearch git:(v7.16.2 u=) ‚úó grep &quot;public Decision&quot; server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDecider.java | sort
    public Decision canAllocate(IndexMetadata indexMetadata, RoutingNode node, RoutingAllocation allocation) {
    public Decision canAllocate(ShardRouting shardRouting, RoutingAllocation allocation) {
    public Decision canAllocate(ShardRouting shardRouting, RoutingNode node, RoutingAllocation allocation) {
    public Decision canAllocateReplicaWhenThereIsRetentionLease(ShardRouting shardRouting, RoutingNode node, RoutingAllocation allocation) {
    public Decision canForceAllocateDuringReplace(ShardRouting shardRouting, RoutingNode node, RoutingAllocation allocation) {
    public Decision canForceAllocatePrimary(ShardRouting shardRouting, RoutingNode node, RoutingAllocation allocation) {
    public Decision canRebalance(RoutingAllocation allocation) {
    public Decision canRebalance(ShardRouting shardRouting, RoutingAllocation allocation) {
    public Decision canRemain(ShardRouting shardRouting, RoutingNode node, RoutingAllocation allocation) {
    public Decision shouldAutoExpandToNode(IndexMetadata indexMetadata, DiscoveryNode node, RoutingAllocation allocation) {
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;deciders-structure&quot;&gt;Deciders Structure&lt;/h2&gt;

&lt;p&gt;In Elasticsearch 7.16, there are 19 deciders for the shard allocation. You can
find them as follows:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;‚ûú  elasticsearch git:(v7.16.2 u=) rg -l --sort-files &quot;extends AllocationDecider&quot; server/src/main | sed 's/.*\///g'
AllocationDeciders.java
AwarenessAllocationDecider.java
ClusterRebalanceAllocationDecider.java
ConcurrentRebalanceAllocationDecider.java
DiskThresholdDecider.java
EnableAllocationDecider.java
FilterAllocationDecider.java
MaxRetryAllocationDecider.java
NodeReplacementAllocationDecider.java
NodeShutdownAllocationDecider.java
NodeVersionAllocationDecider.java
RebalanceOnlyWhenActiveAllocationDecider.java
ReplicaAfterPrimaryActiveAllocationDecider.java
ResizeAllocationDecider.java
RestoreInProgressAllocationDecider.java
SameShardAllocationDecider.java
ShardsLimitAllocationDecider.java
SnapshotInProgressAllocationDecider.java
ThrottlingAllocationDecider.java
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Among these deciders, there is a root decider, the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AllocationDeciders&lt;/code&gt;, which
contains the references of all other deciders. When making a decision, it will
ask those deciders to decide for the shard allocation, and then assemble them to
make a global decision. We will discuss more details in the following
section. As for other deciders, you can see their purposes from
their filenames, such as for awareness key-value pairs (e.g. availability zone),
cluster rebalancing, concurrent rebalancing, disk threshold, and much more.&lt;/p&gt;

&lt;h2 id=&quot;making-decisions&quot;&gt;Making Decisions&lt;/h2&gt;

&lt;p&gt;There are two types of decision in the decider system: single decision and
multi-decision. A single decision represents a decision made on one
dimension, e.g. awareness or disk threshold. While a multi-decision represents a decision
container that contains a list of child decisions. Let‚Äôs take a closer look at
both of them.&lt;/p&gt;

&lt;h3 id=&quot;single-decision&quot;&gt;Single Decision&lt;/h3&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DiskThresholdDecider&lt;/code&gt; is a good example of making a single decision. Let‚Äôs check its method
for shard allocation: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;canAllocate(...)&lt;/code&gt;. First of all, it retrieves the settings from the
class member
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;diskThresholdSettings&lt;/code&gt; for the low and high thresholds, then it retrieves the disk
usage from the given information (node, routing allocation, usages), and finally
compare both of them to make the decision.
Depending on the situation, we will either get a YES or a NO decision. Here is the code
snippet:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Decision&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;canAllocate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ShardRouting&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shardRouting&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RoutingNode&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RoutingAllocation&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;allocation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// retrieve settings&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;usedDiskThresholdLow&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;100.0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;diskThresholdSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getFreeDiskThresholdLow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;usedDiskThresholdHigh&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;100.0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;diskThresholdSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getFreeDiskThresholdHigh&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// checks for exact byte comparisons&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;freeBytes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;diskThresholdSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getFreeBytesThresholdLow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getBytes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// checks for percentage comparisons&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;freeDiskPercentage&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;diskThresholdSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getFreeDiskThresholdLow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that YES and NO are not the only types for the decision. It also exists a
THROTTLE type, which allows users to control the shard allocation based on the
concurrency. We can consider it as a ‚Äútemporary NO‚Äù, as
the allocation is not allowed right now, but may be YES in the future.&lt;/p&gt;

&lt;h3 id=&quot;multi-decision&quot;&gt;Multi-Decision&lt;/h3&gt;

&lt;p&gt;Now let‚Äôs take a look at the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AllocationDeciders&lt;/code&gt; to see how it makes a
multi-decision. When starting the decision, it accepts information about the shard
routing, node routing, and the current allocation. Then, it either ignores the
shard or delegates the decision-making to its child deciders and assembles them at the end.
All child
deciders make a decision synchronously, probably because they don‚Äôt require
additional information (such as HTTP requests) from an external service. Once the
decision is made by a child decider, the result is processed with the fail-fast
strategy. That is, whenever one child decision is negative (NO), we consider the
whole decision as NO without asking the remaining deciders. It‚Äôs a short
circuit. We do that unless we are in the debug mode, in which case, we
gather all the decisions, including the NO decisions, before returning the final
result. If my explanation is a bit confusing for you, here is the source code of
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AllocationDeciders&lt;/code&gt;, hopefully, it makes things clearer.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Decision&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;canAllocate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ShardRouting&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shardRouting&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RoutingNode&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RoutingAllocation&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;allocation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;allocation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;shouldIgnoreShardForNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shardRouting&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;shardId&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;nodeId&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Decision&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;NO&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;nc&quot;&gt;Decision&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;Multi&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ret&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Decision&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;Multi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;AllocationDecider&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;allocationDecider&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;allocations&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nc&quot;&gt;Decision&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;decision&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;allocationDecider&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;canAllocate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shardRouting&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;allocation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// short track if a NO is returned.&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decision&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Decision&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;NO&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isTraceEnabled&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                &lt;span class=&quot;c1&quot;&gt;// short circuit only if debugging is not enabled&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;allocation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;debugDecision&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Decision&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;NO&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;ret&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decision&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;addDecision&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ret&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;decision&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;allocation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ret&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now if we go further into the structure of the value class &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Decision.Multi&lt;/code&gt;,
we can see that a multi-decision is a decision container, it contains
multiple child decisions inside it:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Multi&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Decision&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ToXContentFragment&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

        &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Decision&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ArrayList&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;gt;();&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Unlike single decisions, it does not have a label and explanation. More precisely,
getting a label from a multi-decision returns &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;null&lt;/code&gt;, and getting an explanation
throws an unsupported operation exception. In my opinion,
the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Decision&lt;/code&gt; base class is too vague and we shouldn‚Äôt return null or raise an
exception. But that‚Äôs a design choice and probably does not matter as this
decider system is internal to Elasticsearch.&lt;/p&gt;

&lt;h2 id=&quot;lifecycle&quot;&gt;Lifecycle&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;When are deciders created? I.e. where are deciders positioned in the lifecycle of
an Elasticsearch cluster?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;When starting a new node, the class &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Bootstrap&lt;/code&gt; is called. Before starting the
node, it creates a new &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Node&lt;/code&gt; instance, which creates and adds a list of modules.
One of these modules is
called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ClusterModule&lt;/code&gt; and it contains the deciders. So the whole logic happens
at the early stage of the lifecycle, more precisely, the creation happens before the
startup of a node.&lt;/p&gt;

&lt;div class=&quot;language-yml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;boostrap&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;- construct node&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;- create modules&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;- create master module&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;- create deciders&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;- create root decider (AllocationDeciders)&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;- create allocation service&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;- ...&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;- add modules&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;- start node&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now another question is: &lt;em&gt;when updating a setting of a cluster, do we need to restart
the node to take the new value into account?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;I don‚Äôt think so. I handled such
cases many times in production and it never requires a restart. These settings are dynamic.
When looking into Elasticsearch‚Äôs source code, such as awareness allocation decider and
disk threshold decider, we can find out that the settings are passed
from the constructor of the deciders. Here are the code snippets:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;AwarenessAllocationDecider&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Settings&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;settings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ClusterSettings&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;clusterSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;DiskThresholdDecider&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Settings&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;settings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ClusterSettings&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;clusterSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;diskThresholdSettings&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DiskThresholdSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;settings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;clusterSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;CURRENT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;major&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;remove enable_for_single_data_node in 9&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;enableForSingleDataNode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ENABLE_FOR_SINGLE_DATA_NODE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;settings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the decider is subscribed to the settings update. In other words, when a setting is updated,
the decider is notified and its setting is updated as well. Here is the code for subscribing to the settings update
for disk thresholds (low watermark, high watermark, flood-stage) in class &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DiskThresholdSettings&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;DiskThresholdSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Settings&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;settings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ClusterSettings&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;clusterSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;clusterSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;addSettingsUpdateConsumer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;CLUSTER_ROUTING_ALLOCATION_LOW_DISK_WATERMARK_SETTING&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setLowWatermark&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;clusterSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;addSettingsUpdateConsumer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;CLUSTER_ROUTING_ALLOCATION_HIGH_DISK_WATERMARK_SETTING&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setHighWatermark&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;clusterSettings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;addSettingsUpdateConsumer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;CLUSTER_ROUTING_ALLOCATION_DISK_FLOOD_STAGE_WATERMARK_SETTING&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setFloodStage&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where you can see that when those cluster settings are updated, the class &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DiskThresholdSettings&lt;/code&gt;
sets the new value into its instance.&lt;/p&gt;

&lt;h2 id=&quot;testing&quot;&gt;Testing&lt;/h2&gt;

&lt;p&gt;There are three types of testing related to the deciders: 1) the tests for the
single deciders which make one decision at a time; 2) the tests for the root
decider which gathers information from multiple single decisions and makes a
multi-decision; 3) other services that depend on deciders since deciders are
part of the cluster module. And ‚Ä¶ we are going to discuss three of them right now.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Testing a single-decision decider.&lt;/strong&gt; To understand this, let‚Äôs take the disk threshold
decider as an example (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DiskThresholdDeciderTests&lt;/code&gt;). As we saw in the previous sections ‚ÄúResponsibility‚Äù and
‚ÄúMaking Decisions‚Äù, the allocation is made using the index metadata, shard routing,
routing allocation, etc. All these data are fetched eagerly and passed as input parameters.
Therefore, it makes the test quite simple: we just need to provide this information to
a decider without mocking anything as there are no external calls. More precisely, in a test case, we:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;prepare settings that are relevant to this decider&lt;/li&gt;
  &lt;li&gt;create a decider instance using these settings&lt;/li&gt;
  &lt;li&gt;prepare a cluster state (including index metadata, shard routing, etc) which are
necessary for making the decision&lt;/li&gt;
  &lt;li&gt;create an allocation service that encapsulates the decider under test&lt;/li&gt;
  &lt;li&gt;require re-routing the shards by calling the service, which asks the deciders to make the
decision behind the screen&lt;/li&gt;
  &lt;li&gt;finally assert the result&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Testing a multi-decision decider.&lt;/strong&gt; To understand this, let‚Äôs take
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AllocationDecidersTests&lt;/code&gt; as an example. In this test suite, it tests the debug mode and
the early termination. Because these expectations are not tight to any specific child
deciders, the setup simply uses some mocked deciders instantiated as anonymous classes.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AllocationDeciders&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;allocationDeciders&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AllocationDeciders&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Arrays&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;asList&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;AllocationDecider&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AllocationDecider&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}));&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Testing a service that depends on the deciders.&lt;/strong&gt; In this case, the testing is more complex
to set up because we need to prepare the deciders. Depending on the needs of that service,
it may plug some decider during the setup phase. The easiest setup is to prepare
a no-operation decider system,
which requires an empty all-deciders decider.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ClusterAllocationExplainActionTests&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ESTestCase&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AllocationDeciders&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;NOOP_DECIDERS&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AllocationDeciders&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Collections&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;emptyList&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;To better understand what do all those deciders do, you can read another article
that I wrote last year: &lt;a href=&quot;/2020/09/27/shard-allocation/&quot;&gt;18 Allocation Deciders in Elasticsearch 7.9&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;To better understand the disk watermarks in Elasticsearch, you can read another article
that I wrote early this year: &lt;a href=&quot;/04/10/disk-watermarks-in-elasticsearch/&quot;&gt;Disk Watermarks In Elasticsearch&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;To better understand how to resolve unassigned shards in Elasticsearch, I suggest you
to read Datadog‚Äôs blog &lt;a href=&quot;https://www.datadoghq.com/blog/elasticsearch-unassigned-shards/&quot;&gt;‚ÄúHow to resolve unassigned shards in Elasticsearch‚Äù&lt;/a&gt;, written by Emily Chang.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we saw the decider system for shard allocation. More precisely,
we saw that the allocation service is responsible for allocating shards and balancing shards;
we saw that there are 19 deciders in Elasticsearch 7.16 and there are two types of decisions:
single decision and multi-decision. When making a decision, a decider relies on information from the ES settings and from
cluster state (index metadata, node, routing allocation info).
The deciders are created early in the lifecycle during node bootstrap. We also saw
how the testing works for testing a single-decision decider, a multi-decision decider, and
other services that depend on deciders. Finally, I suggested some resources for you so that you can
go further from this article. Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/elastic/elasticsearch/&quot;&gt;‚ÄúElasticsearch 7.16 source code (elastic/elasticsearch)&lt;/a&gt;, &lt;em&gt;GitHub&lt;/em&gt;, 2021.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://opster.com/guides/elasticsearch/glossary/elasticsearch-shards/&quot;&gt;‚ÄúElasticsearch Shards‚Äù&lt;/a&gt;,
Opster, 2021.&lt;/li&gt;
  &lt;li&gt;Emily Chang, &lt;a href=&quot;https://www.datadoghq.com/blog/elasticsearch-unassigned-shards/&quot;&gt;‚ÄúHow to resolve unassigned shards in
Elasticsearch‚Äù&lt;/a&gt;,
&lt;em&gt;Datadog&lt;/em&gt;, 2019.&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="elasticsearch" /><category term="java" /><category term="elasticsearch" /><category term="system-design" /><summary type="html">Curious about how does a decision system work? This article explains the deciders for shard allocation in Elasticsearch by going through their responsibility, structure, decision making, lifecycle, testing, and more.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-patrick-federi-LJEjI7LXABU-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-patrick-federi-LJEjI7LXABU-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Using Component in Vue.js</title><link href="https://mincong.io/en/use-component-in-vue-js/" rel="alternate" type="text/html" title="Using Component in Vue.js" /><published>2021-12-24T08:05:27+01:00</published><updated>2021-12-24T08:05:27+01:00</updated><id>https://mincong.io/en/use-component-in-vue-js</id><content type="html" xml:base="https://mincong.io/en/use-component-in-vue-js/">&lt;h2 id=&quot;question&quot;&gt;Question&lt;/h2&gt;

&lt;p&gt;My &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*.vue&lt;/code&gt; files are getting bigger and bigger. It‚Äôs hard to maintain. I would
like to split the file and move part of the structure (HTML) and the logic
(JS) to another location. Is it possible?&lt;/p&gt;

&lt;h2 id=&quot;answer&quot;&gt;Answer&lt;/h2&gt;

&lt;p&gt;You can do that by using components. You can extract part of the structure from
the original vue file to a new file and then import the component again into
the original one. Let‚Äôs say we have two files:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;my-page.vue&lt;/code&gt; ‚Äì the main page that contains most of the logic and
it‚Äôs getting big, probably 1000+ lines of code.&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;my-component.vue&lt;/code&gt; ‚Äì the new component that you are creating&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;First of all, you need to declare the structure in the component file. The
component should contain the HTML structure in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;template&lt;/code&gt; section and the
logic in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;script&lt;/code&gt; section. The logic usually contains the properties
(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;props&lt;/code&gt;), which are the fields passed from the main page when creating the
component; the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;data&lt;/code&gt; fields that are present during the lifecycle of the
component; the methods that are used for operating the template, such as loading
resources from the backend via RESTful APIs, methods for displaying or hiding
certain blocks, etc.&lt;/p&gt;

&lt;div class=&quot;language-html highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;template&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;&amp;lt;!-- TODO Add content for your resource (component) here --&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/template&amp;gt;&lt;/span&gt;

&lt;span class=&quot;nt&quot;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;props&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;resourceId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;required&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;isLoading&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;methods&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;loadResource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
       &lt;span class=&quot;c1&quot;&gt;// TODO Implement async HTTP call here&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;

&lt;span class=&quot;nt&quot;&gt;&amp;lt;style&amp;gt;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;CSS&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;goes&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;here&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/style&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then you need to import and use the new component in your main page.&lt;/p&gt;

&lt;div class=&quot;language-html highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;template&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;div&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;&amp;lt;!--
      Use the component here.

      The property &quot;resourceId&quot; becomes kebab case: &quot;resource-id&quot;
    --&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;my-component&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;resource-id=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;foo&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;&amp;lt;!-- ... --&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/template&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;MyComponent&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;@/path/to/my-component.vue&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;components&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;MyComponent&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;props&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;methods&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;

&lt;span class=&quot;nt&quot;&gt;&amp;lt;style&amp;gt;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;CSS&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;goes&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;here&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/style&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using components has many benefits. Some of them are:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Having clear input parameters for an element&lt;/li&gt;
  &lt;li&gt;Making logic easy to understand, i.e. avoid having huge files&lt;/li&gt;
  &lt;li&gt;Making tests easy&lt;/li&gt;
  &lt;li&gt;Re-use the same component in multiple pages&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Read the official &lt;a href=&quot;https://vuejs.org/v2/style-guide/&quot;&gt;Style Guide&lt;/a&gt; provided by
Vue.js to learn the best practices about this framework.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Hope you enjoy this article, see you the next time!&lt;/p&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="frontend" /><category term="javascript" /><category term="vuejs" /><category term="vuejs2" /><summary type="html">Your vue file is getting big? This Q&amp;A explains how to use component in Vue.js by extracting logic from your existing page.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/vuebigwhite.png" /><media:content medium="image" url="https://mincong.io/assets/vuebigwhite.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Change Log Level At Runtime in Logback</title><link href="https://mincong.io/en/change-log-level-at-runtime-in-logback/" rel="alternate" type="text/html" title="Change Log Level At Runtime in Logback" /><published>2021-12-18T09:02:43+01:00</published><updated>2021-12-18T09:02:43+01:00</updated><id>https://mincong.io/en/change-log-level-at-runtime-in-logback</id><content type="html" xml:base="https://mincong.io/en/change-log-level-at-runtime-in-logback/">&lt;h2 id=&quot;question&quot;&gt;Question&lt;/h2&gt;

&lt;p&gt;I have a Java application using &lt;a href=&quot;http://logback.qos.ch/&quot;&gt;Logback&lt;/a&gt; as
implementation for logging. I want to change log level at runtime for a given
Java package or a given Java class without restarting my Java application. Is
it possible? In particular, I am interested in enable the DEBUG level logs for a
given package a short period of time so that I can troubleshoot issues in
production.&lt;/p&gt;

&lt;h2 id=&quot;answer&quot;&gt;Answer&lt;/h2&gt;

&lt;p&gt;One possible solution is to retrieve the logger from logger context and modify
its log level. Let‚Äôs say that you are uring &lt;a href=&quot;http://www.slf4j.org/&quot;&gt;SLF4J&lt;/a&gt; as
interface and Logback as implementation, you can do that as follows:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;ch.qos.logback.classic.Level&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;ch.qos.logback.classic.Logger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;ch.qos.logback.classic.LoggerContext&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;LogbackLevelChanger&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;setLevel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Level&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;LoggerContext&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;LoggerFactory&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getILoggerFactory&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;logger&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getLogger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logger&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;logger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setLevel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// handle missing logger here&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then you can expose this method to your RESTful API so that the log level can be
changed remotely at runtime:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nd&quot;&gt;@PUT&lt;/span&gt;
&lt;span class=&quot;nd&quot;&gt;@Path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/log-level/{name}/{level}&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;setLogLevel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;nd&quot;&gt;@PathParam&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;nd&quot;&gt;@PathParam&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;level&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you are using this technique for troubleshooting, you may consider adding a
duration for the expiry so that the log level can be reset after the given
duration. This avoid creating additional logs and potentially increase the fee
for logging.&lt;/p&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;The solution described above is not the only solution. Milind Deobhankar
described &lt;a href=&quot;https://dzone.com/articles/5-ways-to-change-the-log-levels-at-runtime&quot;&gt;5 ways to change log levels at
runtime&lt;/a&gt;
in his post, including:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Using the Spring Boot Admin&lt;/li&gt;
  &lt;li&gt;Scan the logback.xml&lt;/li&gt;
  &lt;li&gt;Access logback.xml via URL&lt;/li&gt;
  &lt;li&gt;Creating API To Change the Log Levels (what we discussed in this post)&lt;/li&gt;
  &lt;li&gt;Pub / Sub ‚Äì the application instance needs to subscribe to the topic where log level changes will get published.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;It‚Äôs worth reading if you need more options.&lt;/p&gt;

&lt;p&gt;Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://logback.qos.ch/&quot;&gt;‚ÄúLogback Project‚Äù&lt;/a&gt;, &lt;em&gt;Logback&lt;/em&gt;, 2021.&lt;/li&gt;
  &lt;li&gt;Milind Deobhankar, &lt;a href=&quot;https://dzone.com/articles/5-ways-to-change-the-log-levels-at-runtime&quot;&gt;‚Äú5 ways to change log levels at
runtime‚Äù&lt;/a&gt;,
&lt;em&gt;DZone&lt;/em&gt;, 2020.&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="java-core" /><category term="java" /><category term="logging" /><summary type="html">This Q&amp;A explains how to change logger level dynamically at runtime via RESTful API for your Java application when using Logback.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-icons8-team-dhZtNlvNE8M-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-icons8-team-dhZtNlvNE8M-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">String Operations in Bash</title><link href="https://mincong.io/en/string-operations-in-bash/" rel="alternate" type="text/html" title="String Operations in Bash" /><published>2021-12-04T12:10:41+01:00</published><updated>2021-12-04T12:10:41+01:00</updated><id>https://mincong.io/en/string-operations-in-bash</id><content type="html" xml:base="https://mincong.io/en/string-operations-in-bash/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;When working in the software industry, no matter you are a software engineer, a
data scientist, a support engineer, or any other role, you probably need to
know some basic skills about Bash to
improve your productivity. This can be useful for automating complex tasks in
your terminal, generating the file for configuration or documentation, sharing
commands with your teammates, etc. In this post, we are going to explore some
frequently used techniques about string operations.&lt;/p&gt;

&lt;p&gt;This article is written in macOS 11.6 and the default Bash environment (more
details are described in the command below):&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;bash &lt;span class=&quot;nt&quot;&gt;-version&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sw_vers
GNU bash, version 3.2.57&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-release&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;x86_64-apple-darwin20&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Copyright &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;C&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 2007 Free Software Foundation, Inc.
ProductName:	macOS
ProductVersion:	11.6
BuildVersion:	20G165
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After reading this article, you will understand:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;How to declare a variable?&lt;/li&gt;
  &lt;li&gt;How to remove a substring using shell parameter expansion?&lt;/li&gt;
  &lt;li&gt;How to replace a substring using shell parameter expansion?&lt;/li&gt;
  &lt;li&gt;How to determine string value using regular expressions in if-statement?&lt;/li&gt;
  &lt;li&gt;How to manipulate streams using different commands?&lt;/li&gt;
  &lt;li&gt;How to go further from here?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now, let‚Äôs get started!&lt;/p&gt;

&lt;h2 id=&quot;declaring-variables&quot;&gt;Declaring Variables&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;Declare a single line variable.&lt;/strong&gt; To declare a single line variable, just
declare a variable, followed by an equal sign (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;=&lt;/code&gt;) for the assignment, and ends
with the value of the variable, either using a string directly, or using a
command inside a subshell (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$(...)&lt;/code&gt;):&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;content&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Hello Bash&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;creation_date&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt; +&lt;span class=&quot;s2&quot;&gt;&quot;%Y-%m-%d&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# 2012-12-04&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Declare a multi-line text.&lt;/strong&gt; A heredoc is a special-purpose code block that
tells the shell to read input from the current source until it encounters a line
containing a delimiter. EOF (end of file) is a commonly used delimiter but it‚Äôs
not mandatory. You can use JSON, YAML, TEXT, or any other delimiter that you
think is relevant to your situation. The syntax for Heredoc in Bash is:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;COMMAND &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;DELIMITER&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
Here is the long description
...
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;DELIMITER
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is an example for generating a YAML file, where we generate the heredoc and
print it inside a subshell
and assign the result to a variable:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;content&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;YAML&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
cluster:
  type: &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$TYPE&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
  name: elasticsearch-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$TYPE&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
  date: &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt; +&lt;span class=&quot;s2&quot;&gt;&quot;%Y-%m-%d&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;YAML
&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;substring-removal&quot;&gt;Substring Removal&lt;/h2&gt;

&lt;p&gt;Removing a substring can be done inside a shell parameter expansion &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;${param}&lt;/code&gt;.
Using character &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#&lt;/code&gt; can delete a prefix of the string and using character &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;%&lt;/code&gt;
can delete a suffix of the string. Using the same characters once or twice will
delete the shortest and the longest match respectively. To better remember this,
look at your ISO layout keyboard:&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;# 3&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$ 4&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;% 5&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;In a standard keyboard layout, keys 3/4/5 represent &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#&lt;/code&gt;/&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$&lt;/code&gt;/&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;%&lt;/code&gt;. Since &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#&lt;/code&gt; is
before &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;%&lt;/code&gt; is after &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$&lt;/code&gt;, deletion with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#&lt;/code&gt; happens from the front of a string
(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$&lt;/code&gt;), and deletion with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;%&lt;/code&gt; happens from the end of a string (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$&lt;/code&gt;). Here are some
concrete examples:&lt;/p&gt;

&lt;p&gt;Deleting the shortest match from the front of a string:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2021-12-04
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;#*-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;# 12-04&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Deleting the longest match from the front of a string:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2021-12-04
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;##*-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;# 04&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Deleting the shortest match from the back of a string:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2021-12-04
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;%-*&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;# 2021-12&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Deleting the longest match from the back of a string:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2021-12-04
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;%%-*&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;# 2021&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;substring-replacement&quot;&gt;Substring Replacement&lt;/h2&gt;

&lt;p&gt;Replace first match of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$substring&lt;/code&gt; with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$replacementi&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;/substring/replacement&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Replace all matches of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$substring&lt;/code&gt; with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$replacement&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;//substring/replacement&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Examples:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2021-12-04
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;/-/_&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;# 2021_12-04&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2021-12-04
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;//-/_&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;# 2021_12_04&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;if-statement&quot;&gt;If Statement&lt;/h2&gt;

&lt;p&gt;Normal regular expression:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$date&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;~ ^[0-9]&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;4&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;-[0-9]&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;2&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;-[0-9]&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;2&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Negate regular expression:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# inside&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$date&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;~ ^[0-9]&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;4&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;-[0-9]&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;2&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;-[0-9]&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;2&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# outside&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$date&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;~ ^[0-9]&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;4&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;-[0-9]&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;2&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;-[0-9]&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;2&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Contain keyword using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;==&lt;/code&gt;, e.g. word ‚Äú2021‚Äù:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$date&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;2021&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;stream&quot;&gt;Stream&lt;/h2&gt;

&lt;p&gt;To manipulate streams (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stdin&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stdout&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stderr&lt;/code&gt;) in Bash, you can use a pipe
(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;|&lt;/code&gt;) followed by a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;command&lt;/code&gt; after your stream to filter, update, or collect
information. This can be achieved using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;grep&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sed&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cut&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;xargs&lt;/code&gt;, or other
commands. Here is the syntax:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;my_stream | &amp;lt;&lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here are some examples using ‚Äúusers.csv‚Äù:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;users.csv
&lt;span class=&quot;s2&quot;&gt;&quot;User A&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;10&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Paris&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;User B&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;20&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;London&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;User C&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;30&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;New York&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;User d&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;40&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Toulouse&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Find users in Paris:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;users.csv | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;Paris
&lt;span class=&quot;s2&quot;&gt;&quot;User A&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;10&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Paris&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Remove quotes (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&quot;&lt;/code&gt;):&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;users.csv | &lt;span class=&quot;nb&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'s/&quot;//g'&lt;/span&gt;
User A,10,Paris
User B,20,London
User C,30,New York
User d,40,Toulouse
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Remove user with incorrect format, e.g. ID written in lower case:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;users.csv | &lt;span class=&quot;nb&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'/User [[:lower:]]/d'&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;User A&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;10&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Paris&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;User B&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;20&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;London&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;User C&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;30&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;New York&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Cut column 2 and only keep columns 1 and 3:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;users.csv | &lt;span class=&quot;nb&quot;&gt;cut&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; 1,3 &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; ,
&lt;span class=&quot;s2&quot;&gt;&quot;User A&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Paris&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;User B&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;London&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;User C&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;New York&quot;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;User d&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Toulouse&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;‚Ä¶ to learn more about the syntax of your target command, use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;man&lt;/code&gt; command or
use the help option &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-h&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# man cut&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# man grep&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# man sed&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ...&lt;/span&gt;
man &amp;lt;&lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# cut -h&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# grep -h&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# sed -h&lt;/span&gt;
&amp;lt;&lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;To know more techniques about manipulating strings, visit &lt;a href=&quot;https://tldp.org/LDP/abs/html/string-manipulation.html&quot;&gt;Advanced
Bash-Scripting Guide: Chapter 10. Manipulating
Variables&lt;/a&gt; in The Linux
Documentation Project (TLDP).&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we discussed different string operations in Bash, including
variable declaration, substring removal, built-in regular expression for
if-statement, manipulating streams (filter, update, collect). The source code is
also available on
&lt;a href=&quot;https://github.com/keweishang/tech-resources/tree/master/tool&quot;&gt;GitHub&lt;/a&gt;.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Kewei Shang &amp;amp; Mincong Huang, &lt;a href=&quot;https://github.com/keweishang/tech-resources/blob/master/tool/bash.md&quot;&gt;‚ÄúBash | Tech Resources‚Äù&lt;/a&gt;, &lt;em&gt;GitHub&lt;/em&gt;, 2020.&lt;/li&gt;
  &lt;li&gt;Vivek Gite, &lt;a href=&quot;https://www.cyberciti.biz/faq/mac-osx-find-tell-operating-system-version-from-bash-prompt/&quot;&gt;‚ÄúHow to find out macOS version information from Terminal command
prompt‚Äù&lt;/a&gt;, &lt;em&gt;CyberCiti&lt;/em&gt;, 2021.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html&quot;&gt;‚Äú3.5.3 Shell Parameter
Expansion‚Äù&lt;/a&gt;,
&lt;em&gt;GNU&lt;/em&gt;, 2021.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://tldp.org/LDP/abs/html/string-manipulation.html&quot;&gt;‚ÄúManipulating
Strings‚Äù&lt;/a&gt;, &lt;em&gt;The Linux
Documentation Project (TLDP)&lt;/em&gt;, 2021.&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="bash" /><category term="bash" /><category term="scripting" /><summary type="html">This article shares tips for different string operations in Bash, including string declaration, substring removal, substring replacement, regular expressions in if-statement, and operations in streams.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-pawel-czerwinski-ScYk6KKEPUI-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-pawel-czerwinski-ScYk6KKEPUI-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Slow Query Logs In Elasticsearch</title><link href="https://mincong.io/en/slow-logs-in-elasticsearch/" rel="alternate" type="text/html" title="Slow Query Logs In Elasticsearch" /><published>2021-11-27T09:19:02+01:00</published><updated>2021-11-27T09:19:02+01:00</updated><id>https://mincong.io/en/slow-logs-in-elasticsearch</id><content type="html" xml:base="https://mincong.io/en/slow-logs-in-elasticsearch/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;If you are using Elasticsearch in production, you are probably familiar with
slow logs. Slow logs are logs provided by Elasticsearch, which help you to
troubleshoot the slowness of the write path (index) or the read path
(search). It‚Äôs useful for determing the root cause of the problem and may
provide hints to mitigations and solutions. In this article, I want to discuss
slow logs with you, in particular:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;How does the log look like?&lt;/li&gt;
  &lt;li&gt;How to change thresholds?&lt;/li&gt;
  &lt;li&gt;Root causes of slow queries?&lt;/li&gt;
  &lt;li&gt;How to go further from this article?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now, let‚Äôs get started!&lt;/p&gt;

&lt;h2 id=&quot;query-slow-log&quot;&gt;Query Slow Log&lt;/h2&gt;

&lt;p&gt;Let‚Äôs analyze a slow log provided Elasticsearch official documentation (&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules-slowlog.html&quot;&gt;link&lt;/a&gt;):&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;[2030-08-30T11:59:37,786][WARN ][i.s.s.query              ] [node-0] [index6][0]
took[78.4micros], took_millis[0], total_hits[0 hits], stats[],
search_type[QUERY_THEN_FETCH], total_shards[1],
source[{‚Äúquery‚Äù:{‚Äúmatch_all‚Äù:{‚Äúboost‚Äù:1.0}}}], id[MY_USER_ID],&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;If we split the log into pieces, we can obtain the following table:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Field&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Value&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Description&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Timestamp&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;2030-08-30T11:59:37,786&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;The timestamp of the log.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Log Level&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;WARN&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;It means that the query execution time is higher than the query ‚Äúwarn‚Äù threshold. This is configured in index settings API.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Logger&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;i.s.s.query&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;This is a concise version of logger name (class name): ‚Äúindex.search.slowlog.query‚Äù. This is useful for users to determine the type of slowness: index or search.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Node&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;node-0&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;It means that the slowness happens on node-0. If you select a time range and group by nodes, it will help you determine the distribution of the slowness across the cluster. In other words, determine if the slowness happens on one single node or happens on multiple ones. Also, if you name the node with some special meaning, e.g. roles (fresh, warm, cold), you will be able to determine which roles are slow.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Index name&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;index6&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;The name of the index that is impacted. We have similar troubleshooting ideas as the ‚Äúnode‚Äù mentioned above. Additionally, you may have the customer‚Äôs id, product type, timestamp, or other useful information as part of the index names. Therefore, it‚Äôs useful for you to determine which customer, which product, or which range of indices are impacted.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Shard&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;0&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;The shard id.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Took&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;78.4micros&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Execution time in human-readable format. It determines how slow the query is.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Took in milliseconds&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;0&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Execution time in milliseconds in numeric value. If you have the possibility to transform this value in your log pipelines, you can calculate filter the queries that are slower than a certain threshold, e.g. ‚Äú&amp;gt;= 2 seconds‚Äù. Therefore, you can reduce noises and better identify the source of the problem. This transformation can be done using a grok parser. Here is a great beginner‚Äôs guide about &lt;a href=&quot;https://logz.io/blog/logstash-grok/&quot;&gt;Logstash Grok&lt;/a&gt; and here is the documentation of &lt;a href=&quot;https://docs.datadoghq.com/logs/log_configuration/processors/&quot;&gt;Grok Parser in Datadog&lt;/a&gt;.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Stats&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;¬†&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Statistics&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Search type&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;QUERY_THEN_FETCH&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;The type of search.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Total shards&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;1&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Total number of shards.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Source&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;{ ‚Äúquery‚Äù: { ‚Äúmatch_all‚Äù: { ‚Äúboost ‚Äú: 1.0 } } }&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;The source of of the query. This is one of the most important fields. It allows us the determine how the query looks like and gives us an idea of what kind of information that the user is looking for.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;ID&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;MY_USER_ID&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;The user ID. It may help you determine whether the query problems come from the same user.&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;thresholds&quot;&gt;Thresholds&lt;/h2&gt;

&lt;p&gt;You can use thresholds to better define the level of logs depending on your requirements. Note that these settings are dynamic so you can change them without restarting the server. The 3 different kinds of thresholds that you can define are index (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;index&lt;/code&gt;), the query phase of search (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;query&lt;/code&gt;), and the fetch phase of the search (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fetch&lt;/code&gt;).&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT /my-index-000001/_settings
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;index.search.slowlog.threshold.query.warn&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;10s&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;index.search.slowlog.threshold.query.info&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5s&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;index.search.slowlog.threshold.query.debug&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;2s&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;index.search.slowlog.threshold.query.trace&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;500ms&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;index.search.slowlog.threshold.fetch.warn&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1s&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;index.search.slowlog.threshold.fetch.info&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;800ms&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;index.search.slowlog.threshold.fetch.debug&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;500ms&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;index.search.slowlog.threshold.fetch.trace&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;200ms&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;‚Ä¶ but what is query-then-fetch?&lt;/p&gt;

&lt;p&gt;According to ‚ÄúElasticsearch: The Definitive Guide‚Äù, there are two phases in the search: query and fetch.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;query&lt;/strong&gt;: during the initial query phase, the query is broadcast to a shard copy (a primary or replica shard) of every shard in the index. Each shard executes the search locally and builds a priority queue of matching documents. It identifies which documents satisfy the search request.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;fetch&lt;/strong&gt;: we retrieve the documents themselves.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;For more details, you can visit &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/guide/current/index.html&quot;&gt;‚ÄúElasticsearch: The Definitive Guide 2.x‚Äù&lt;/a&gt;, especially the sections: &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/guide/current/_query_phase.html&quot;&gt;‚ÄúQuery Phase‚Äù&lt;/a&gt; and &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/guide/current/_fetch_phase.html&quot;&gt;‚ÄúFetch Phase‚Äù&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;root-causes&quot;&gt;Root Causes&lt;/h2&gt;

&lt;p&gt;Unfortunately, I don‚Äôt have much experience working with slow queries. However, I know that Opster has an excellent article about analyzing slow logs. In their article &lt;a href=&quot;https://opster.com/guides/data-structuring/elasticsearch-slow-search-query-guide/&quot;&gt;‚ÄúElasticsearch Slow Query Troubleshooting Guide‚Äù&lt;/a&gt;, they mention that the causes can be:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Poorly written or expensive search queries.&lt;/li&gt;
  &lt;li&gt;Poorly configured Elasticsearch clusters or indices.&lt;/li&gt;
  &lt;li&gt;Saturated CPU, Memory, Disk and network resources on the cluster.&lt;/li&gt;
  &lt;li&gt;Periodic background processes like snapshots or merging segments that consume cluster resources (CPU, Memory, disk) causing other search queries to perform slowly as resources are sparsely available for the main search queries.&lt;/li&gt;
  &lt;li&gt;Segment merging is used to reduce the number of segments so that search latency is improved, however, merges can be expensive to perform, especially on low IO environments.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Another great article comes from the engineering blog of Elasticsearch, written by Louis Ong as &lt;a href=&quot;https://www.elastic.co/blog/advanced-tuning-finding-and-fixing-slow-elasticsearch-queries&quot;&gt;‚ÄúAdvanced tuning: finding and fixing slow Elasticsearch queries‚Äù&lt;/a&gt;. He mentioned that the common causes are:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;High resource utilization when inactive&lt;/li&gt;
  &lt;li&gt;High thread pool rejected count&lt;/li&gt;
  &lt;li&gt;High CPU and indexing latency&lt;/li&gt;
  &lt;li&gt;Increased latency with more replica shards&lt;/li&gt;
  &lt;li&gt;High utilization when sharing resources&lt;/li&gt;
  &lt;li&gt;High heap aggregating highly unique fields&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Also, there is this article written by Burak Alta≈ü on Medium as &lt;a href=&quot;https://medium.com/@burak.altas/how-to-optimize-elasticsearch-for-better-search-performance-283492e475f8&quot;&gt;‚ÄúHow to Optimize Elasticsearch for Better Search Performance‚Äù&lt;/a&gt;, talking about index configuration, shard optimization, Elasticsearch (cluster) configuration. Check it out.&lt;/p&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Due to time constraints, I only discuss slow query logs here but didn‚Äôt mention much about index logs. In other words, we only discussed the read path and not the write path. You may want to explore that as well.&lt;/li&gt;
  &lt;li&gt;To learn more about how to fix the problems, check out the more detailed solutions mentioned in the ‚ÄúRoot Causes‚Äù section.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we discussed the slow log structure in Elasticsearch, its thresholds, and the possible root causes of the problem.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Ran Ramati, Gedalyah Reback, &lt;a href=&quot;https://logz.io/blog/logstash-grok/&quot;&gt;‚ÄúA Beginner‚Äôs Guide to Logstash Grok‚Äù&lt;/a&gt;, &lt;em&gt;Logz&lt;/em&gt;, 2020.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.datadoghq.com/logs/log_configuration/processors/&quot;&gt;‚ÄúProcessors‚Äù&lt;/a&gt;, &lt;em&gt;Datadog Documentation&lt;/em&gt;, 2021.&lt;/li&gt;
  &lt;li&gt;Vineeth Mohan, &lt;a href=&quot;https://qbox.io/blog/slow-logs-in-elasticsearch-search-index-config-example&quot;&gt;‚ÄúSlow Logs in Elasticsearch‚Äù&lt;/a&gt;, &lt;em&gt;QBOX&lt;/em&gt;, 2018.&lt;/li&gt;
  &lt;li&gt;Clinton Gormley, Zachary Tong, &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/guide/current/index.html&quot;&gt;‚ÄúElasticsearch: The Definitive Guide 2.x‚Äù&lt;/a&gt;, &lt;em&gt;Elasticsearch&lt;/em&gt;, 2014-2015.&lt;/li&gt;
  &lt;li&gt;Opster Team, &lt;a href=&quot;https://opster.com/guides/data-structuring/elasticsearch-slow-search-query-guide/&quot;&gt;‚ÄúElasticsearch Slow Query Troubleshooting Guide‚Äù&lt;/a&gt;, &lt;em&gt;Opster&lt;/em&gt;, 2021.&lt;/li&gt;
  &lt;li&gt;Louis Ong, &lt;a href=&quot;https://www.elastic.co/blog/advanced-tuning-finding-and-fixing-slow-elasticsearch-queries&quot;&gt;‚ÄúAdvanced tuning: finding and fixing slow Elasticsearch queries‚Äù&lt;/a&gt;, &lt;em&gt;Elastic&lt;/em&gt;, 2019.&lt;/li&gt;
  &lt;li&gt;Burak Alta≈ü, &lt;a href=&quot;https://medium.com/@burak.altas/how-to-optimize-elasticsearch-for-better-search-performance-283492e475f8&quot;&gt;‚ÄúHow to Optimize Elasticsearch for Better Search Performance‚Äù&lt;/a&gt;, &lt;em&gt;Medium&lt;/em&gt;, 2019.&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="elasticsearch" /><category term="elasticsearch" /><summary type="html">Better understand the slow queries in Elasticsearch by using the slow logs. In this article, we discuss the log structure, the thresholds, and some potential root causes.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-nareeta-martin-cOWn-bYGmlc-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-nareeta-martin-cOWn-bYGmlc-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Audit Logs</title><link href="https://mincong.io/en/audit-logs/" rel="alternate" type="text/html" title="Audit Logs" /><published>2021-11-20T08:40:44+01:00</published><updated>2021-11-20T08:40:44+01:00</updated><id>https://mincong.io/en/audit-logs</id><content type="html" xml:base="https://mincong.io/en/audit-logs/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;Today I would like to discuss audit logs with you. Audit logs are logs for
auditing. They are events that keep track of creation, modification, deletion,
or any other operation that mutates the state of a given resource. This resource
can be a database, a pipeline, or anything valuable for the company. You may
want to keep track of these events since they can be useful for security
analysis, troubleshooting, compliance, auditing, keeping track of the lifecycle
of a data store, etc, depending on your role. During
my work at Datadog, I had the chance to implement a simple audit solution for an
internal tool. That‚Äôs why I want to write down some thoughts and hopefully, they
will be useful for you as well.&lt;/p&gt;

&lt;p&gt;After reading this article, you will understand:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Requirements for audit logs&lt;/li&gt;
  &lt;li&gt;Principles when implementing audit logs&lt;/li&gt;
  &lt;li&gt;Focus deeper on Java solution using JAX-RS&lt;/li&gt;
  &lt;li&gt;How to go further from this article&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now, let‚Äôs get started!&lt;/p&gt;

&lt;h2 id=&quot;requirements-for-audit-logs&quot;&gt;Requirements For Audit Logs&lt;/h2&gt;

&lt;p&gt;Generally speaking, there is some information that we care about:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Resource.&lt;/strong&gt; We want to know what is being accessed or modified. Therefore,
we may want to record the resource ID, resource name, resource type, resource
group, or any other information related to this resource. Regarding RESTful
API, the resource ID can be the path, which is usually the representation of
the resource.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Time.&lt;/strong&gt; We want to know when does this happen precisely. This is important
to construct a timeline for a bigger event, like an incident, an attack, or
the lifecycle of a resource.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Action.&lt;/strong&gt; We want to know what is being done on that resource. It provides
an accurate description of the type of operation. Some typical examples are
‚Äúcreate‚Äù, ‚Äúread‚Äù, ‚Äúdelete‚Äù, ‚Äúupdate‚Äù, etc.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;User.&lt;/strong&gt; We want to know ‚Äúwho did that?‚Äù so that we can find out more
information based on that user or better understand the motivation of this
operation. The user information may contain the first name, last name, email,
department, organization unit, employee ID, etc.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We can eventually go further by adding more metadata to facilitate the search,
making the description more human-readable, etc. But I believe that these are not
requirements, but enhancements to make the feature more usable.&lt;/p&gt;

&lt;p&gt;Then on the business side, there are other also some requirements:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Retention.&lt;/strong&gt; The retention of the audit logs. We want them to store longer
than normal logs because they are specific logs for investigation. These are
precious events helping us to redraw the big picture.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Access&lt;/strong&gt;. Perhaps not everyone should be accessed to audit logs. Taking
Datadog‚Äôs product &lt;a href=&quot;https://docs.datadoghq.com/fr/account_management/audit_logs/&quot;&gt;‚ÄúAudit
Logs‚Äù&lt;/a&gt; as an
example, only administrator or security team members can access Audit Logs. As
an individual, you can only see a stream of your own actions.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I probably didn‚Äôt cover everything in the section. If you have other ideas,
please let me know what you think in the comment section below.&lt;/p&gt;

&lt;h2 id=&quot;principles-when-implementing-audit-logs&quot;&gt;Principles When Implementing Audit Logs&lt;/h2&gt;

&lt;p&gt;When implementing audit logs, I believe here are the principles to follow and I
will try to explain why.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Hooking into the lifecycle.&lt;/strong&gt; When implementing audit logging, we need to
decide where should we put the code. I believe that the best option is to hook
your logic into the lifecycle of the framework that you use. Then, you will be
able to log before or after an event. For example, if you use Java
Persistence API (JPA), you can implement your logic using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@PrePersist&lt;/code&gt;,
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@PreUpdate&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@PreRemove&lt;/code&gt; callbacks. Or if you use Java RESTful API
(JAX-RS), you can implement interfaces &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ContainerRequestFilter&lt;/code&gt; or
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ContainerResponseFilter&lt;/code&gt; to handle the audit logging, respectively before the
request is handled or after the response is created. By hooking into the
lifecycle, we ensure that the audit logging is decoupled from the actual
business logic. We avoid spamming the codebase by avoiding adding the audit logs
into every method. It also makes it clear when does the audit actually happen.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Avoid blocking the actual event.&lt;/strong&gt; When adding audit logs, we should also
avoid blocking actual events so that the user‚Äôs action won‚Äôt be blocked or delayed.
This is because sometimes the audit logging requires API calls, which means that
they may be slow or suffer from network issues. So my suggestion is to use
asynchronous implementation so that the actual event will be handled correctly.
As for network issues or other types of error, we can make it fault-tolerant by
adding a retry mechanism. We can also consider using a batch API call to group
multiple events.&lt;/p&gt;

&lt;h2 id=&quot;java-solutions&quot;&gt;Java Solutions&lt;/h2&gt;

&lt;p&gt;In this section, I would like to go further into Java to discuss how to
implement a simple audit logging solution for Java RESTful APIs. Here I am going
to list 3 solutions based on Java Servlet, Jetty, and JAX-RS (Jersey).&lt;/p&gt;

&lt;h3 id=&quot;java-servlet&quot;&gt;Java Servlet&lt;/h3&gt;

&lt;p&gt;For those who don‚Äôt know Java Servlet, here is a quick introduction. Java
Servlet or nowadays Jakarta Servlet, is a Java software component that extends
the capabilities of a server. It‚Äôs commonly used for implementing web containers
for hosting web applications, similar to PHP and ASP.NET. The evolution of Java
Servlet is part of the Java Specification Requests
(&lt;a href=&quot;https://jcp.org/en/jsr/all&quot;&gt;JSRs&lt;/a&gt;). The latest one is Java Servlet 4.0
(JSR-369) started in 2017.&lt;/p&gt;

&lt;p&gt;In our case, we can implement a simple Servlet filter to intercept the HTTP
request or response using the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;doFilter()&lt;/code&gt; method. Inside the method, you
must call the filter chain to pass the request and response to the next
filter so that they are handled. Otherwise, the request will be dropped
(filtered), which is not desired. Then, you can implement the actual auditing
logic before or after the chain. I prefer after the chain because in this case,
we will have the information of both the HTTP request and the HTTP response,
which makes the auditing logging more complete.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;javax.servlet.*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;java.io.IOException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;SimpleServletFilter&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Filter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;FilterConfig&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ServletException&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;

    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;doFilter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ServletRequest&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ServletResponse&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;nc&quot;&gt;FilterChain&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;chain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;IOException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ServletException&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// before the request being handled&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;chain&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;doFilter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// after the response being created&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;destroy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;jetty-server&quot;&gt;Jetty Server&lt;/h3&gt;

&lt;p&gt;If you are using Jetty as the solution for your Java server, you can extend
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AbstractNCSARequestLog&lt;/code&gt; to provide a custom access log solution in the
pseudo-standard NCSA commong log format. To do that, you can create a request
log handler which handles the request log, and then use the handler in your
Jetty server:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;logHandler&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RequestLogHandler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;logHandler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setRequestLog&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;MyRequestLog&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setHandler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logHandler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where the implementation of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;MyRequestLog&lt;/code&gt; looks like this:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;MyRequestLog&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AbstractNCSARequestLog&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;MyRequestLog&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// configure options here: timezone, locale, extended, IP address, ...&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;IOException&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;logger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem with this approach is that the final result must be a string and it
must look like an access log. Other output structures are not supported.
So if you need a more custom solution, then you will need to find another way to
handle it. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AbstractNCSARequestLog&lt;/code&gt; may be replaced by another class in the
recent versions of Jetty, but the most important thing here is to understand
that we can delegate the access log creation to a base class.&lt;/p&gt;

&lt;h3 id=&quot;jax-rs-filter&quot;&gt;JAX-RS Filter&lt;/h3&gt;

&lt;p&gt;Working with RESTful APIs is a very popular choice these days. Most of the web
services communicate with the frontend or between them using RESTful APIs.
Therefore, it makes sense to adapt the auditing solution to ‚ÄúJava API for
RESTful Web Services‚Äù (JAX-RS). By doing so, we assume that we are not serving
HTTP requests without APIs.&lt;/p&gt;

&lt;p&gt;Here is a basic structure for auditing filter based on interface
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ContainerResponseFilter&lt;/code&gt;. In the code block, we have access to information
about the HTTP request and the HTTP response, such as request path, request
headers, response status code, size of the response. These data allow us to
provide our custom implementation of audit logging.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;MyFilter&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ContainerResponseFilter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ContainerRequestContext&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;requestContext&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;nc&quot;&gt;ContainerResponseContext&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;responseContext&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;IOException&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// TODO: implementation goes here&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// read request info, response info, read environment variables, ...&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But this may not satisfy you because compared to the Java Servlet solution,
here we don‚Äôt have access to servlet anymore. It means some information may be
missing. However, we can use the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@Context&lt;/code&gt; annotation to inject the servlet
request again (or other resources if you need):&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;MyFilter&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ContainerResponseFilter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;nd&quot;&gt;@Context&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;HttpServletRequest&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// HERE&lt;/span&gt;

    &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ContainerRequestContext&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;requestContext&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;nc&quot;&gt;ContainerResponseContext&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;responseContext&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;IOException&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I didn‚Äôt have a chance to test this solution, but I saw it on &lt;a href=&quot;https://stackoverflow.com/questions/13198550/context-returns-proxy-instead-of-httpservletrequest-no-thread-local-value-in-s&quot;&gt;Stack
Overflow&lt;/a&gt;.
Hopefully, it will work for you.&lt;/p&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;To learn more about the difference between a Servlet filter and a Jersey
filter (JAX-RS), you can visit &lt;a href=&quot;https://stackoverflow.com/a/52210283/4381330&quot;&gt;this answer on Stack
Overflow&lt;/a&gt; written by Paul
Samsotha.&lt;/li&gt;
  &lt;li&gt;To learn more about Jakarta Servet (formerly Java Servlet), visit this
&lt;a href=&quot;https://en.wikipedia.org/wiki/Jakarta_Servlet&quot;&gt;Wikipedia&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we discuss how to implement audit logs in Java based on
Java JAX-RS. We discussed some technical and business requirements for the
solution. Some principles for the implementation. And finally, three Java
solutions based on Java Servlet, Jetty, and JAX-RS.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/LDAP_Data_Interchange_Format&quot;&gt;‚ÄúLDAP Data Interchange Format (LDIF)‚Äù&lt;/a&gt;, &lt;em&gt;Wikipedia&lt;/em&gt;, 2021.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Representational_state_transfer&quot;&gt;‚ÄúRepresentational state
transfer‚Äù&lt;/a&gt;,
&lt;em&gt;Wikipedia&lt;/em&gt;, 2021.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.baeldung.com/database-auditing-jpa&quot;&gt;‚ÄúAuditing with JPA, Hibernate and Spring Data
JPA‚Äù&lt;/a&gt;, &lt;em&gt;Baeldung&lt;/em&gt;, 2020.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://eclipse-ee4j.github.io/jersey.github.io/documentation/latest/filters-and-interceptors.html&quot;&gt;‚ÄúChapter 10. Filters and
Interceptors - Jersey‚Äù&lt;/a&gt;,
&lt;em&gt;Eclipse EE4J&lt;/em&gt;, 2021.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.oracle.com/javaee/7/api/javax/servlet/Filter.html&quot;&gt;‚ÄúFilter (Java(TM) EE 7 Specification
APIs)‚Äù&lt;/a&gt;,
&lt;em&gt;Oracle&lt;/em&gt;, 2015.&lt;/li&gt;
  &lt;li&gt;Jakob Jenkov, &lt;a href=&quot;http://tutorials.jenkov.com/java-servlets/servlet-filters.html&quot;&gt;‚ÄúServlet
Filters‚Äù&lt;/a&gt;,
&lt;em&gt;jenkov.com&lt;/em&gt;, 2014.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.oracle.com/cd/E19693-01/819-0997/6n3cs0bsg/index.html#gbwud&quot;&gt;‚ÄúAccess, Error, and Audit
Logs | Sun Java System Directory Server Enterprise Edition 6.0
Reference‚Äù&lt;/a&gt;,
&lt;em&gt;Oracle&lt;/em&gt;, 2010.&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="java-core" /><category term="java" /><category term="jetty" /><category term="jersey" /><category term="api" /><category term="jax-rs" /><summary type="html">This article discusses how to implement a simple audit logs solution with Java JAX-RS, including requirements, considerations for the implementation, and 3 different solutions based on Java Servlet, Jetty, and JAX-RS filter.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-markus-spiske-gnhxvdGmGG8-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-markus-spiske-gnhxvdGmGG8-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Elasticsearch Snapshot Plugins</title><link href="https://mincong.io/en/elasticsearch-snapshot-plugins/" rel="alternate" type="text/html" title="Elasticsearch Snapshot Plugins" /><published>2021-11-01T10:00:00+01:00</published><updated>2021-11-01T10:00:00+01:00</updated><id>https://mincong.io/en/elasticsearch-snapshot-plugins</id><content type="html" xml:base="https://mincong.io/en/elasticsearch-snapshot-plugins/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;The ‚ÄúSnapshot and Restore‚Äù feature is an important part of an Elasticsearch cluster.
Its existence provides a strong guarantee for data reliability. That‚Äôs why we
are interested in learning more about it. In this article, let‚Äôs take a look at
different official snapshot repository plugins in Elasticsearch.&lt;/p&gt;

&lt;p&gt;Before getting into details, let‚Äôs first understand what is a snapshot
repository. There are two types of snapshot repositories: local repository and
remote repository. The local repository is mainly used for testing (for unit
testing or when trying out Elasticsearch in localhost), and it does not make
much sense to use it on production. In production, we mainly use a remote
snapshot repository because it can store cluster data outside the cluster as
data backup. There are four official plugins: AWS, GCS, Azure, and HDFS. Among
them, AWS, GCS, and Azure are the three plugins that I had used in the past two
years, and they are also the main subject of discussion today.&lt;/p&gt;

&lt;p&gt;After reading this article, you will understand:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The plugin installation&lt;/li&gt;
  &lt;li&gt;The similarities and differences of snapshot operations across different
plugins&lt;/li&gt;
  &lt;li&gt;The dependency between the Elasticsearch plugin and the cloud provider&lt;/li&gt;
  &lt;li&gt;The source code analysis of several representative classes&lt;/li&gt;
  &lt;li&gt;How to go further from this article&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now, let‚Äôs get started!&lt;/p&gt;

&lt;h2 id=&quot;plugin-installation&quot;&gt;Plugin Installation&lt;/h2&gt;

&lt;p&gt;Plugins can be installed via the command line elasticsearch-plugin (&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/plugins/7.x/installation.html&quot; title=&quot;Install Plugins&quot;&gt;Official Document&lt;/a&gt;):&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;bin/elasticsearch-plugin &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$plugin_name&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;bin/elasticsearch-plugin &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;repository-s3
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;bin/elasticsearch-plugin &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;repository-gcs
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;bin/elasticsearch-plugin &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;repository-azure
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;bin/elasticsearch-plugin &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;repository-hdfs
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For the plugin to be used normally, the plugin must be installed on
each node of the cluster. The four plugins mentioned above are all official
plugins of Elasticsearch. You don‚Äôt need to download them, just install them
directly. After a successful installation, the node needs to be restarted for
the plugin to take effect.&lt;/p&gt;

&lt;p&gt;Once installed, you may want to get information about the plugin. There are at
least two ways to query the plugin. One is to query through the command line
after logging in to the node. The second is to query directly through the
RESTful API.&lt;/p&gt;

&lt;p&gt;Log in to the node and list the installed plugins using the following command:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;bin/elasticsearch-plugin list
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Query the plugins directly through &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-nodes-info.html&quot; title=&quot;Node API&quot;&gt;Node API&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_nodes/plugins
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;snapshot-apis&quot;&gt;Snapshot APIs&lt;/h2&gt;

&lt;p&gt;Elasticsearch‚Äôs snapshot APIs include two parts: Snapshot repository management
API (Snapshot repository management API) and Snapshot management API (Snapshot
management API). Most of the APIs are common to different plugins. The only
exception is the API for creating a snapshot repository. The type of repository
needs to be provided when creating it. The parameters for the creation request
of different repositories are also slightly different. Here are a few simple
examples. If you were interested in any specific parameters, please refer to the
&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/master/put-snapshot-repo-api.html&quot;&gt;official documentation&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Create an AWS S3 repository:&lt;/p&gt;

&lt;div class=&quot;language-http highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;PUT _snapshot/my_s3_repository

{
   &quot;type&quot;: &quot;s3&quot;,
   &quot;settings&quot;: {
     &quot;bucket&quot;: &quot;my-bucket&quot;
   }
}
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Create a Google Cloud Storage (GCS) repository:&lt;/p&gt;

&lt;div class=&quot;language-http highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;PUT _snapshot/my_gcs_repository

{
   &quot;type&quot;: &quot;gcs&quot;,
   &quot;settings&quot;: {
     &quot;bucket&quot;: &quot;my_bucket&quot;,
     &quot;client&quot;: &quot;my_alternate_client&quot;
   }
}
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Create an Azure repository:&lt;/p&gt;

&lt;div class=&quot;language-http highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;PUT _snapshot/my_backup

{
   &quot;type&quot;: &quot;azure&quot;,
   &quot;settings&quot;: {
     &quot;client&quot;: &quot;secondary&quot;
   }
}
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;dependencies-with-cloud-provider&quot;&gt;Dependencies With Cloud Provider&lt;/h2&gt;

&lt;p&gt;Using remote ES snapshot repository plugins means that you have to face the
issue of dependencies on your cloud provider. The dependency challenge here is
mainly reflected in two parts: the SDK of the cloud provider and the storage
system of the cloud provider.&lt;/p&gt;

&lt;p&gt;Regarding the cloud provider‚Äôs SDK, since Elasticsearch needs to use the SDK
client provided by the cloud provider to manipulate data (upload, list,
download, delete, etc.), there must be compatibility issues here between the SDK
version and your ES cluster. When the SDK version of the cloud provider is
constantly updated, if your Elasticsearch cluster version remains the same,
the SDK version will likely be too old to be used after a certain point
in time. It may make the cluster vulnerable to unsuccessful back-up, downgraded
performance, etc. Therefore, it is important to upgrade the Elasticsearch
cluster version in time.&lt;/p&gt;

&lt;p&gt;In the storage method, using the storage system of a specific cloud service
means that you need to configure and manage the corresponding storage, such as
creating and setting service accounts.&lt;/p&gt;

&lt;h2 id=&quot;source-code-samples&quot;&gt;Source Code Samples&lt;/h2&gt;

&lt;p&gt;Above we mainly looked at general information about snapshot repository plugins
in Elasticsearch. In the following paragraphs, I want to take you into the
code and read together a few representative classes.&lt;/p&gt;

&lt;h3 id=&quot;blob-store-repository&quot;&gt;Blob Store Repository&lt;/h3&gt;

&lt;p&gt;The abstract class &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BlobStoreRepository&lt;/code&gt; is the base implementation of a
snapshot repository, with works with any blob store implementation.
This class has only two abstract methods: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;createBlobStore()&lt;/code&gt;
and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;basePath()&lt;/code&gt;. The method &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;createBlobStore()&lt;/code&gt; can be used to create a blob
store, and it is recommended to implement with lazy initialization. Blob store is
responsible for creating, reading, updating, and deleting data (CRUD) towards to cloud provider
in Elasticsearch. We will analyze it further later. Another method is
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;basePath()&lt;/code&gt;, which obtains the relative storage path of the Elasticsearch
snapshot repository in the storage bucket of the cloud provider. If one bucket
is used for one single repository, then the base path should be &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/&lt;/code&gt;. If one
bucket is used for multiple repositories, or being used for other data-stores
(not only for Elasticsearch), then you need to fill in the relative path where
your Elasticsearch snapshot repo is located.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;BlobStoreRepository&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AbstractLifecycleComponent&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Repository&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;

    &lt;span class=&quot;cm&quot;&gt;/**
     * Creates new BlobStore to read and write data.
     */&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;BlobStore&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;createBlobStore&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;cm&quot;&gt;/**
     * Returns base path of the repository
     */&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;BlobPath&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;basePath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BlobStoreRepository&lt;/code&gt; contains the business logic related to snapshots. It implements functions such as snapshot, restore, get info, delete, cleanup, verify, extract statistics, and update cluster state.&lt;/p&gt;

&lt;p&gt;Regardless of the cloud providers, all repositories inherit this abstract class and
use the cloud provider‚Äôs SDK to implement the blob reading and writing. From the
command line below, we can see that whether it is a read-only URL Repository,
Mock Repository for testing, File System Repository for local warehouses, or
remote warehouses Azure, S3, GCS, HDFS, their implementations all inherit this
class:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;‚ûú elasticsearch git:&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;7.9 &lt;span class=&quot;nv&quot;&gt;u&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=)&lt;/span&gt; rg &lt;span class=&quot;s2&quot;&gt;&quot;extends BlobStoreRepository&quot;&lt;/span&gt;
modules/repository-url/src/main/java/org/elasticsearch/repositories/url/URLRepository.java
56:public class URLRepository extends BlobStoreRepository &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

server/src/test/java/org/elasticsearch/snapshots/mockstore/MockEventuallyConsistentRepository.java
68: public class MockEventuallyConsistentRepository extends BlobStoreRepository &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

server/src/main/java/org/elasticsearch/repositories/fs/FsRepository.java
53:public class FsRepository extends BlobStoreRepository &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureRepository.java
55:public class AzureRepository extends BlobStoreRepository &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Repository.java
72:class S3Repository extends BlobStoreRepository &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

plugins/repository-gcs/src/main/java/org/elasticsearch/repositories/gcs/GoogleCloudStorageRepository.java
43:class GoogleCloudStorageRepository extends BlobStoreRepository &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

plugins/repository-hdfs/src/main/java/org/elasticsearch/repositories/hdfs/HdfsRepository.java
54:public final class HdfsRepository extends BlobStoreRepository &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;blob-store&quot;&gt;Blob Store&lt;/h3&gt;

&lt;p&gt;Blob store mainly provides two functions related to blobs: obtaining the blob
container of a given path and obtaining statistics on the count of operations
that have been performed on this blob store.
For some plugins, the logic of adding, deleting, modifying, and checking blobs
is also written in the implementation of blob stores, such as the blob stores
Azure and GCS.&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cm&quot;&gt;/**
 * An interface for storing blobs.
 */&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;BlobStore&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Closeable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;cm&quot;&gt;/**
     * Get a blob container instance for storing blobs at the given {@link BlobPath}.
     */&lt;/span&gt;
    &lt;span class=&quot;nc&quot;&gt;BlobContainer&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;blobContainer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;BlobPath&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;cm&quot;&gt;/**
     * Returns statistics on the count of operations that have been performed on this blob store
     */&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Long&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;stats&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Collections&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;emptyMap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;blob-container&quot;&gt;Blob Container&lt;/h3&gt;

&lt;p&gt;A blob container refers to the container that contains all blobs under a certain
path. It does not contain logic related to snapshots, but it is more inclined to
the bottom layer of the cloud provider. It is mainly responsible for adding,
deleting, modifying and checking blobs under a given path, represented as
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BlobPath&lt;/code&gt;. Here are some of its methods:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210918-BlobContainer.png&quot; alt=&quot;BlobContainer&quot; /&gt;&lt;/p&gt;

&lt;p&gt;As mentioned in the previous paragraph, for some providers, the logic of adding,
deleting, modifying, and checking blobs are not directly done in this class, but
are delegated to the blob store, like the implementations of Azure and GCS.
However, the CRUD operations of S3 are implemented in the class
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;S3BlobContainer&lt;/code&gt;. So I feel that the boundary between blob store and blob
container is not clear. But one thing is for sure: there is only one blob store in
a repository and a repository may have many blob containers.&lt;/p&gt;

&lt;h3 id=&quot;snapshot-creation&quot;&gt;Snapshot Creation&lt;/h3&gt;

&lt;p&gt;Now we understand different classes, let‚Äôs take a look at how the snapshot is
created inside a snapshot repository, starting from the class
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BlobStoreRepository&lt;/code&gt;. The diagram below is generated by the third-party plugin
‚ÄúSequence Diagram‚Äù in IntelliJ IDEA. To simplify the description, some steps are omitted.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/20210918-BlobStoreRepository_snapshotFile.png&quot; alt=&quot;Sequence diagram&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In this figure, we can see that the method &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;snapshotFile&lt;/code&gt; of
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BlobStoreRepository&lt;/code&gt; first finds the file name (1.1) of the file to
snapshot, then verifies the correctness of the file (1.2), and then for each
part of the file (1.3), it performs un upload. When uploading, Elasticsearch uses a
custom input stream wrapper to achieve potential rate-limiting. The latter part
of the Sequence Diagram plugin seems to be incorrect, it writes the wrong serial
number. But the flaws are not concealed, the next step is to write the blob,
which is the blue part in the figure (1.4.1.1.4). Write the blob and forward it
to the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BlobContainer&lt;/code&gt; implementation. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BlobContainer&lt;/code&gt; is an interface that has
different implementations depending on the cloud provider. After the
implementation is completed, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BlobStoreRepository&lt;/code&gt; checks the correctness of the
written data. Finally, the repository adds the successfully created snapshot to the status
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;IndexShardSnapshotStatus&lt;/code&gt; to track the progress of the snapshot creation.&lt;/p&gt;

&lt;p&gt;Due to time constraints, we have to stop here for the source code analysis.&lt;/p&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from this article?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;If you are interested in understanding the internal structure of the snapshot
repository, you can read another article of mine &lt;a href=&quot;/en/elasticsearch-snapshot-repository-structure/&quot;&gt;The internal structure of
the Elasticsearch snapshot repository&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;If you are interested in learning how to prevent data loss in Elasticsearch,
you can read my other article &lt;a href=&quot;/en/prevent-data-loss-in-elasticsearch/&quot;&gt;How to prevent data loss in Elasticsearch? &lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;If you want to know more about plugins, please refer to the official
documentation &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/plugins/7.x/index.html&quot;&gt;Elasticsearch Plugins and Integrations&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;If you want to know more about the blob store, you can visit
&lt;a href=&quot;https://github.com/elastic/elasticsearch/blob/7.x/server/src/main/java/org/elasticsearch/repositories/blobstore/package-info.java&quot; title=&quot;org.elasticsearch.repositories.blobstore&quot;&gt;GitHub&lt;/a&gt; to read the documentation and source code of this package.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we saw how to install plugins for different cloud providers
through &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;elasticsearch-plugin&lt;/code&gt;; the impact of different plugins on the snapshot
operations; after using the snapshot plugin, the dependency between the
Elasticsearch cluster and the cloud provider; next, we walked into the source
code, briefly analyzed the logic of three classes: Blob Store Repository, Blob
Store, and Blob Container. We also snapshot creation as an example to
understand how Blob Store Repository communicates with Blob Container. Finally,
I also shared some resources to allow you to go further from this article.
I hope this article can give you some thoughts and give you a better understanding of
the ‚Äúsnapshot and restore‚Äù feature in Elasticsearch. If you are interested in knowing more
information, you can subscribe to the &lt;a href=&quot;/feed.xml&quot;&gt;feed of my blog&lt;/a&gt;, follow me on
&lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you
the next time!&lt;/p&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="elasticsearch" /><category term="elasticsearch" /><category term="java" /><summary type="html">Elasticsearch snapshot repository plugins for AWS, GCP, and Azure</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-aaron-burden-GFpxQ2ZyNc0-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-aaron-burden-GFpxQ2ZyNc0-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Elasticsearch Snapshot APIs</title><link href="https://mincong.io/en/elasticsearch-snapshot-apis/" rel="alternate" type="text/html" title="Elasticsearch Snapshot APIs" /><published>2021-10-25T16:34:05+02:00</published><updated>2021-10-25T16:34:05+02:00</updated><id>https://mincong.io/en/elasticsearch-snapshot-apis</id><content type="html" xml:base="https://mincong.io/en/elasticsearch-snapshot-apis/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;When managing Elasticsearch clusters in production, you will probably need to
backup and restore a cluster or specific indices since this is an efficient way
to avoid data loss. This can be done using the feature ‚ÄúSnapshot And Restore‚Äù in
Elasticsearch. However, it‚Äôs not easy to remember all the commands you need,
such as creating a new snapshot, listing existing snapshots, monitoring the
snapshot restore progress, canceling an ongoing snapshot, etc.
During my work at Datadog, I had the chance to work with the ‚ÄúSnapshot And
Restore‚Äù feature in AWS, GCP, and Azure. Therefore, I would like to share with
you the commands I used as a cheatsheet.&lt;/p&gt;

&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;Before getting started, you may ask: there are so many APIs, how can I remember
them?! Well, it‚Äôs not that
complicated. All the APIs follow the hierarchy: snapshot plugin &amp;gt; snapshot
repository &amp;gt; snapshots (or snapshot expression) &amp;gt; snapshot specific endpoint.
And for restore operations, they are standard recovery operations, so you can
from them from cat recovery or indexing recovery API. Based on the rules above,
we can summarize them as the following list of APIs:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;METHOD&amp;gt; /_snapshot/&amp;lt;?repo&amp;gt;/&amp;lt;?snapshot&amp;gt;/&amp;lt;?_action&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET     /_snapshot
GET     /_snapshot/_status

GET     /_snapshot/&amp;lt;repo&amp;gt;
PUT     /_snapshot/&amp;lt;repo&amp;gt;
DELETE  /_snapshot/&amp;lt;repo&amp;gt;
GET     /_snapshot/&amp;lt;repo&amp;gt;/_status
POST    /_snapshot/&amp;lt;repo&amp;gt;/_cleanup
POST    /_snapshot/&amp;lt;repo&amp;gt;/_verify
GET     /_snapshot/&amp;lt;repo&amp;gt;/_current

GET     /_snapshot/&amp;lt;repo&amp;gt;/&amp;lt;snapshot&amp;gt;
PUT     /_snapshot/&amp;lt;repo&amp;gt;/&amp;lt;snapshot&amp;gt;
POST    /_snapshot/&amp;lt;repo&amp;gt;/&amp;lt;snapshot&amp;gt;
DELETE  /_snapshot/&amp;lt;repo&amp;gt;/&amp;lt;snapshot&amp;gt;
GET     /_snapshot/&amp;lt;repo&amp;gt;/&amp;lt;snapshot&amp;gt;/_status
GET     /_snapshot/&amp;lt;repo&amp;gt;/&amp;lt;snapshot&amp;gt;/_restore

GET     /_cat/snapshots/{repo}
GET     /_cat/recovery

GET     /&amp;lt;index&amp;gt;/_recovery
---

snapshot_expression:
  - &quot;snap_1&quot;        -- snapshot 1
  - &quot;snap_1,snap_2&quot; -- snapshot 1 and 2, separated by comma ','
  - &quot;snap_*&quot;        -- all snapshots starting with &quot;snap_&quot;
  - &quot;_all&quot;          -- all snapshots
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, let‚Äôs go through them one by one.&lt;/p&gt;

&lt;h2 id=&quot;snapshot-apis&quot;&gt;Snapshot APIs&lt;/h2&gt;

&lt;h3 id=&quot;create-snapshot&quot;&gt;Create Snapshot&lt;/h3&gt;

&lt;p&gt;[&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/create-snapshot-api.html&quot;&gt;documentation&lt;/a&gt;]
Create a snapshot for the entire cluster or the target data streams and indices.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT  /_snapshot/&amp;lt;repository&amp;gt;/&amp;lt;snapshot&amp;gt;
POST /_snapshot/&amp;lt;repository&amp;gt;/&amp;lt;snapshot&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT /_snapshot/my_repo/snapshot_2?wait_for_completion=true

{
  &quot;indices&quot;: &quot;index_a,index_b&quot;,
  &quot;ignore_unavailable&quot;: true,
  &quot;include_global_state&quot;: false,
  &quot;metadata&quot;: {
    &quot;taken_by&quot;: &quot;user123&quot;,
    &quot;taken_because&quot;: &quot;backup before upgrading&quot;
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;clone-snapshot&quot;&gt;Clone Snapshot&lt;/h3&gt;

&lt;p&gt;[&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/clone-snapshot-api.html&quot;&gt;documentation&lt;/a&gt;]
Clones part or all of a snapshot into a new snapshot within the same repository.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT /_snapshot/&amp;lt;repository&amp;gt;/&amp;lt;source_snapshot&amp;gt;/_clone/&amp;lt;target_snapshot&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT /_snapshot/my_repo/old_snapshot/_clone/new_partial_snapshot

{
  &quot;indices&quot;: &quot;index_a,index_b&quot;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;get-snapshot-info&quot;&gt;Get Snapshot Info&lt;/h3&gt;

&lt;p&gt;[&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/get-snapshot-api.html&quot;&gt;documentation&lt;/a&gt;]
Get information about one or more snapshots.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/&amp;lt;repository&amp;gt;/&amp;lt;snapshot&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;get-snapshot-status&quot;&gt;Get Snapshot Status&lt;/h3&gt;

&lt;p&gt;[&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/get-snapshot-status-api.html&quot;&gt;documentation&lt;/a&gt;]
Get Snapshot Status API returns additional information beyond the Get Snapshot
Info API, such as shard status and file statistics:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/&amp;lt;repository&amp;gt;/&amp;lt;snapshot&amp;gt;/_status
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;restore-snapshot&quot;&gt;Restore Snapshot&lt;/h3&gt;

&lt;p&gt;[&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/restore-snapshot-api.html&quot;&gt;documentation&lt;/a&gt;]
Restore Snapshot API allows you to restore all indices (complete restore) of a
given snapshot or only restore a subset of them (partial restore):&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;POST /_snapshot/&amp;lt;repository&amp;gt;/&amp;lt;snapshot&amp;gt;/_restore
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;delete-snapshot&quot;&gt;Delete Snapshot&lt;/h3&gt;

&lt;p&gt;[&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/delete-snapshot-api.html&quot;&gt;documentation&lt;/a&gt;]
Delete a snapshot.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;DELETE /_snapshot/&amp;lt;repository&amp;gt;/&amp;lt;snapshot&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;snapshot-repository-apis&quot;&gt;Snapshot Repository APIs&lt;/h2&gt;

&lt;h3 id=&quot;list-repositories&quot;&gt;List Repositories&lt;/h3&gt;

&lt;p&gt;[&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/get-snapshot-repo-api.html&quot;&gt;Documentation&lt;/a&gt;]
List all the snapshot repositories.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/
GET /_snapshot/_all
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;get-repository&quot;&gt;Get Repository&lt;/h3&gt;

&lt;p&gt;[&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/get-snapshot-repo-api.html&quot;&gt;Documentation&lt;/a&gt;]
Get information about one or more registered snapshot repositories.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/&amp;lt;repository&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;createupdate-repository&quot;&gt;Create/Update Repository&lt;/h3&gt;

&lt;p&gt;[&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/put-snapshot-repo-api.html&quot;&gt;Documentation&lt;/a&gt;] Registers or updates a snapshot repository.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT /_snapshot/&amp;lt;repository&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT /_snapshot/my_repository
{
  &quot;type&quot;: &quot;fs&quot;,
  &quot;settings&quot;: {
    &quot;location&quot;: &quot;my_backup_location&quot;
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;verify-repository&quot;&gt;Verify Repository&lt;/h3&gt;

&lt;p&gt;[&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/verify-snapshot-repo-api.html&quot;&gt;documentation&lt;/a&gt;]
Verifies that a snapshot repository is functional.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;POST /_snapshot/&amp;lt;repository&amp;gt;/_verify
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;delete-repository&quot;&gt;Delete Repository&lt;/h3&gt;

&lt;p&gt;[&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/delete-snapshot-repo-api.html&quot;&gt;documentation&lt;/a&gt;]
Unregisters one or more snapshot repositories.&lt;/p&gt;

&lt;p&gt;NOTE: When a repository is unregistered, Elasticsearch only removes the
reference to the location where the repository is storing the snapshots. The
snapshots themselves are left untouched and in place. To delete the actual
snapshots, you should use the ‚ÄúDelete Snapshot API‚Äù. This API handles the
snapshot repository.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;DELETE /_snapshot/&amp;lt;repository&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;clean-up-repository&quot;&gt;Clean up Repository&lt;/h3&gt;

&lt;p&gt;[&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/clean-up-snapshot-repo-api.html&quot;&gt;documentation&lt;/a&gt;]
Triggers the review of a snapshot repository‚Äôs contents and deletes any stale
data that is not referenced by existing snapshots.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;POST /_snapshot/&amp;lt;repository&amp;gt;/_cleanup
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;monitoring-apis&quot;&gt;Monitoring APIs&lt;/h2&gt;

&lt;p&gt;Description extracted from official documentation &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-monitor-snapshot-restore.html&quot;&gt;Monitor snapshot and restore
progress | Elasticsearch&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;snapshot-in-progress&quot;&gt;Snapshot In Progress&lt;/h3&gt;

&lt;p&gt;Use the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_current&lt;/code&gt; parameter to get all currently running snapshots in the
cluster:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/&amp;lt;repository&amp;gt;/_current
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or a single one:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/&amp;lt;repository&amp;gt;/snapshot_1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Retrieve all currently running snapshots with detailed status info:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/_status
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;‚Ä¶ limit the results to a target repository:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/&amp;lt;repository&amp;gt;/_status
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;‚Ä¶ limit the result to the given snapshot (even if it‚Äôs not currently running):&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_snapshot/&amp;lt;repository&amp;gt;/&amp;lt;snapshot&amp;gt;/_status
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;restore-in-progress&quot;&gt;Restore In Progress&lt;/h3&gt;

&lt;p&gt;The restore process is a standard recovery mechanism of Elasticsearch. So you
can use the cat recovery API to monitor the snapshot restore as other
recoveries. Perhaps you want to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;grep snapshot&lt;/code&gt; to filter snapshots.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /_cat/recovery
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or using the index recovery API to have a JSON result with more detailed
information:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET /&amp;lt;index&amp;gt;/_recovery
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;cancel-snapshot-creation&quot;&gt;Cancel Snapshot Creation&lt;/h3&gt;

&lt;p&gt;You can do that using the delete snapshot API.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;DELETE /_snapshot/&amp;lt;repo&amp;gt;/&amp;lt;snapshot&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;cancel-snapshot-restore&quot;&gt;Cancel Snapshot Restore&lt;/h3&gt;

&lt;p&gt;You can do that by deleting data streams and indices that are being restored. Be
careful! The data for all deleted data streams and indices will be removed from
the cluster.&lt;/p&gt;

&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;

&lt;p&gt;How to go further from here?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;To learn more about different APIs related to snapshot repository or snapshot
themselves, visit the official documentation
&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore-apis.html&quot;&gt;‚ÄúSnapshot and restore APIs | Elasticsearch‚Äù&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;To monitor snapshot and restore progress, visit the official documentation
&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-monitor-snapshot-restore.html&quot;&gt;‚ÄúMonitor snapshot and restore progress |
Elasticsearch‚Äù&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we saw how to remember different APIs efficiently by
using the resource hierarchy (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_snapshot/&amp;lt;repo&amp;gt;/&amp;lt;snapshot&amp;gt;/&amp;lt;action&amp;gt;&lt;/code&gt;) and the
relationship between restore and recovery; we saw the list of APIs for snapshot
operations and snapshot repository operations; we also saw how to monitor the
snapshot or restore progress and cancel them; finally, I shared some resources to
let you go further from this article.
Interested to know more? You can subscribe to &lt;a href=&quot;/feed.xml&quot;&gt;the feed of my blog&lt;/a&gt;, follow me
on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or
&lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Elastic, &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore.html&quot;&gt;‚ÄúSnapshot and
restore‚Äù&lt;/a&gt;, &lt;em&gt;Elasticsearch Documentation&lt;/em&gt;, 2021.&lt;/li&gt;
  &lt;li&gt;Opster Team, &lt;a href=&quot;https://opster.com/elasticsearch-glossary/elasticsearch-snapshot/&quot;&gt;‚ÄúElasticsearch Snapshot‚Äù&lt;/a&gt;, &lt;em&gt;Opster&lt;/em&gt;, 2021.&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="elasticsearch" /><category term="elasticsearch" /><category term="api" /><summary type="html">This article summarizes the list of APIs for &quot;Snapshot and Restore&quot; in Elasticsearch, which allows you to perform operations easily and navigate to official documentation if you need more detail.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-alfons-morales-YLSwjSy7stw-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-alfons-morales-YLSwjSy7stw-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Error Retries in Temporal Workflow</title><link href="https://mincong.io/en/error-retries-in-temporal/" rel="alternate" type="text/html" title="Error Retries in Temporal Workflow" /><published>2021-10-09T22:08:20+02:00</published><updated>2021-10-09T22:08:20+02:00</updated><id>https://mincong.io/en/error-retries-in-temporal</id><content type="html" xml:base="https://mincong.io/en/error-retries-in-temporal/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;When working with Temporal to build workflows, you will have to face to error
handling at some point because workflow and activity can fail for different
reasons. Temporal Go SDK defines its &lt;a href=&quot;https://docs.temporal.io/docs/go/error-handling/&quot;&gt;error
handling&lt;/a&gt; logic and &lt;a href=&quot;https://docs.temporal.io/docs/go/retries/&quot;&gt;activity
and workflow retries&lt;/a&gt; in the official
documentation. But whenever I visit those pages, I always feel that
it‚Äôs missing something that I need as a developer. So I decide to write this
article, to share my understanding of error retries in Temporal in Go SDK, as a
complementary to the official documents. And hopefully, it will clarify
different situations and give you a clearer picture of how errors are retried.
This article is written with Temporal Go SDK v1.10.0 (15 Sept 2021).&lt;/p&gt;

&lt;p&gt;After reading this article, you will understand:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The difference between retryable and non-retryable error at acvitity level&lt;/li&gt;
  &lt;li&gt;Non-retryable error types in retry policy&lt;/li&gt;
  &lt;li&gt;How to use retry policy?&lt;/li&gt;
  &lt;li&gt;The maximum attempts when retrying&lt;/li&gt;
  &lt;li&gt;How to write unit tests?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If you don‚Äôt have time to read the entire article, here is a table for
summarizing the difference.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: center&quot;&gt;Scope&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Error Type&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Methods&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Retryable (Default)&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Retryable (Override)&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;Activity&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ApplicationError&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;temporal.NewNonRetryableApplicationError()&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;No&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;-&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;Activity&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ApplicationError&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;temporal.NewApplicationError()&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Yes&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;-&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;Activity&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Other errors&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fmt.Errorf()&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;errors.New()&lt;/code&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Yes&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Retry policy (activity options)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;Top-level workflow&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;All&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;-&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;No&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Retry policy (start workflow options)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: center&quot;&gt;Child workflow&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;All&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;-&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;No&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;Retry policy (child workflow options)&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;retryable-and-non-retryable-application-error&quot;&gt;Retryable and Non-Retryable Application Error&lt;/h2&gt;

&lt;p&gt;By default, Temporal retries activities, but not workflows. According to
official documentation &lt;a href=&quot;https://docs.temporal.io/docs/go/error-handling/&quot;&gt;Error Handling in
Go&lt;/a&gt;, if the activity returns
an error as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;errors.New()&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fmt.Errorf()&lt;/code&gt;, that error will be converted to
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*temporal.ApplicationError&lt;/code&gt;, which is retryable. If you don‚Äôt want the error to
be retried, you can return a non-retryable application error from the activity.&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MyActivity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// retryable&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Errorf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;oops&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MyActivity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// retryable&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;temporal&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewApplicationError&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;oops&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;test&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MyActivity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// non-retryable&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;temporal&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewNonRetryableApplicationError&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;oops&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;test&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is easy to understand: Temporal wants to provide a fault-tolerant system so
that it can retry automatically when thing goes wrong. So at activity-level,
error are retried by default, unless user asks Temporal to not retry explicitly via wrapper
method &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;temporal.NewNonRetryableApplicationError(...)&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;If we dive into the source code, you can see that
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ApplicationError&lt;/code&gt; determines the retry-ability of an error using its internal
boolean attribute &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nonRetryable&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;// go.temporal.io/sdk@v1.10.0/internal/error.go&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// ApplicationError returned from activity implementations with message and optional details.&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ApplicationError&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;temporalError&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;          &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;errType&lt;/span&gt;      &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;nonRetryable&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;// HERE&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;cause&lt;/span&gt;        &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;details&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;converter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EncodedValues&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;One possible usecase for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;temporal.NewNonRetryableApplicationError(...)&lt;/code&gt; is when
interacting with a third-party service. When that service returns a
deterministic error indicating that required action cannot be performed, you may
not want to retry. For example, when a resource deletion request is rejected by
the third party service because it is still in used, you probably
don‚Äôt want to retry. Therefore, calling
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;temporal.NewNonRetryableApplicationError(...)&lt;/code&gt; is a good choice.&lt;/p&gt;

&lt;h2 id=&quot;non-retryable-error-types-in-retry-policy&quot;&gt;Non-Retryable Error Types in Retry Policy&lt;/h2&gt;

&lt;p&gt;Another way to define non-retryable error types for activity is to provide a
custom &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;RetryPolicy&lt;/code&gt; as part of the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ActivityOptions&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ChildWorkflowOptions&lt;/code&gt;.
For example, to avoid retrying errors of type &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;MyError&lt;/code&gt;, we can make it as
non-retryable as follows:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MyWorkflowWithRetryPolicy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workflow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workflow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WithActivityOptions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workflow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ActivityOptions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;StartToCloseTimeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;RetryPolicy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;temporal&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RetryPolicy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;InitialInterval&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;    &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;BackoffCoefficient&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;MaximumInterval&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;    &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Minute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;MaximumAttempts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;    &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;NonRetryableErrorTypes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;MyError&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;// HERE&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But, why Temporal has &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NonRetryableErrorTypes&lt;/code&gt; in Retry Policy? In my opionion,
there are several reasons:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;temporal.NewNonRetryableApplicationError(...)&lt;/code&gt; is not enough.&lt;/strong&gt;
It does not fit all the usecases.
Sometime users already know the error types that they don‚Äôt want to retry, but
they don‚Äôt want to determine the error types themselves for each activity and
fire a non-retryable applicaton error, since it makes the activity verbose.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Bringing the control at workflow level.&lt;/strong&gt; An activity can be used for multiple
workflows, e.g. primitive activities for GitHub, Slack, Build, Kubernetes, etc.
Depending on the case of each workflow, some may want to retry while others
don‚Äôt.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Retry policy is not only used by activity.&lt;/strong&gt; It can be used as part of
the activity options, child workflow options, or event the top-level workflow
options. Since the policy controls the retry activitation, having
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NonRetryableErrorTypes&lt;/code&gt; allows to refine the activiations on different
types of error.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;using-retry-policy&quot;&gt;Using Retry Policy&lt;/h2&gt;

&lt;p&gt;Now, let‚Äôs see how to use retry policy in different cases.&lt;/p&gt;

&lt;h3 id=&quot;activity-options&quot;&gt;Activity Options&lt;/h3&gt;

&lt;p&gt;Enable custom retry policy as activity options:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MyWorkflowWithRetryPolicy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workflow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workflow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WithActivityOptions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workflow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ActivityOptions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;StartToCloseTimeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;RetryPolicy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;         &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;retryPolicy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case, failed activities will be retried, more precisely:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Errors having type defined in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NonRetryableErrorTypes&lt;/code&gt; won‚Äôt be retried&lt;/li&gt;
  &lt;li&gt;Errors wrapped into non-retryable application error won‚Äôt be retried&lt;/li&gt;
  &lt;li&gt;Other application errors will be retried&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;child-workflow-options&quot;&gt;Child Workflow Options&lt;/h3&gt;

&lt;p&gt;Enable custom retry policy as child workflow options:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MyWorkflowWithChildWorkflowRetryPolicy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workflow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workflow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WithChildOptions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workflow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ChildWorkflowOptions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;WorkflowRunTimeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;RetryPolicy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;        &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;retryPolicy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case, failed child workflow will be retried (which is not the case by
default). The child workflow will be retried on all types of errors, except the ones
defined in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NonRetryableErrorTypes&lt;/code&gt; in the retry policy.&lt;/p&gt;

&lt;h3 id=&quot;top-level-workflow-options&quot;&gt;Top-Level Workflow Options&lt;/h3&gt;

&lt;p&gt;Enable custom retry policy as top-level workflow options:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;startOptions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;StartWorkflowOptions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;                  &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;TaskQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;           &lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;taskQueueName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;WorkflowRunTimeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;20&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;WorkflowTaskTimeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;RetryPolicy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;         &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;retryPolicy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;executeWorkflowWithOption&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;startOptions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workflowFn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case, top-level workflow will be retried by the server on all types of
errors, except the ones defined in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NonRetryableErrorTypes&lt;/code&gt; in the retry policy.&lt;/p&gt;

&lt;h2 id=&quot;maximum-attempts&quot;&gt;Maximum Attempts&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;For how many times is the server going to retry?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;When the custom retry policy is defined, the answer is obvious: the server is
going to retry &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;MaximumAttempts&lt;/code&gt; times, defined in the policy. If the policy is
defined, but &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;MaximumAttempts&lt;/code&gt; is not set or set to 0, it means unlimited, and
we rely on activity &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ScheduleToCloseTimeout&lt;/code&gt; to stop.&lt;/p&gt;

&lt;p&gt;When the custom retry policy is not defined, for activities, it means using the
default retry policy. The default RetryPolicy provided by the server specifies
(&lt;a href=&quot;https://github.com/temporalio/sdk-go/blob/9d143aa8634807e523b3ac199a0447b9cf147e72/internal/activity.go#L127-L131&quot;&gt;v1.10.0&lt;/a&gt;):&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;InitialInterval of 1 second&lt;/li&gt;
  &lt;li&gt;BackoffCoefficient of 2.0&lt;/li&gt;
  &lt;li&gt;MaximumInterval of 100 x InitialInterval&lt;/li&gt;
  &lt;li&gt;MaximumAttempts of 0 (unlimited)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;For top-level workflow or child workflow, it means that there are no
retry because by default, Temporal retries activies, but not workflows
(&lt;a href=&quot;https://docs.temporal.io/docs/go/retries/&quot;&gt;doc&lt;/a&gt;).&lt;/p&gt;

&lt;h2 id=&quot;writing-unit-tests&quot;&gt;Writing Unit Tests&lt;/h2&gt;

&lt;p&gt;Now we understand how the error retries mechanism works, it‚Äôs time to write some
tests. Yes, writing tests because we need it: we need it to assert the retry
behavior, to assert the number of retry attempts, to assert the completion and
the result of the workflow, etc.&lt;/p&gt;

&lt;p&gt;Here is an example for demonstrating that an applicaton error ‚Äúoops‚Äù is
retryable and the activity is being executed twice: the first time failed and
the second time succeed.&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WorkflowTestSuite&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TestActivityError_ExplicitRetryableError&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Given&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;executionCount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OnActivity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MyActivity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Anything&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Anything&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;executionCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;executionCount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;temporal&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewApplicationError&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;oops&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;test&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Hello, UnitTest!&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// When&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ExecuteWorkflow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MyWorkflow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;UnitTest&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Then&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IsWorkflowCompleted&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NoError&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetWorkflowResult&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Equal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Hello, UnitTest!&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Equal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;executionCount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;1st execution failed and 2nd execution succeed&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;See &lt;a href=&quot;https://github.com/mincong-h/learning-go/pull/15&quot;&gt;https://github.com/mincong-h/learning-go/pull/15&lt;/a&gt; for more samples.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this article, we saw the retryable and non-retryable application errors in
Temporal; we saw the non-retryable error tpes defined by &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;RetryPolicy&lt;/code&gt;; we saw
how to use retry policy as activity options, child workflow options, and
start workflow options for top-level workflows; and we also discuss the maximum
attempts for retries in different cases.&lt;/p&gt;

&lt;p&gt;I hope that this article gives you more insights about how error retries is done
in Temporal workflow. The source code of this article is also available on
&lt;a href=&quot;https://github.com/mincong-h/learning-go/pull/15&quot;&gt;GitHub&lt;/a&gt;.
You can subscribe to the &lt;a href=&quot;/feed.xml&quot;&gt;feed of my blog&lt;/a&gt;, follow me on &lt;a href=&quot;https://twitter.com/mincong_h&quot;&gt;Twitter&lt;/a&gt; or &lt;a href=&quot;https://github.com/mincong-h/&quot;&gt;GitHub&lt;/a&gt;. Hope you enjoy this article, see you the next time!&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Temporal, ‚ÄúActivity and Workflow Retries‚Äù, &lt;em&gt;Temporal Documentation&lt;/em&gt;, 2021.
&lt;a href=&quot;https://docs.temporal.io/docs/go/retries/&quot;&gt;https://docs.temporal.io/docs/go/retries/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Temporal, ‚ÄúError Handling in Go‚Äù, &lt;em&gt;Temporal Documentation&lt;/em&gt;, 2021.
&lt;a href=&quot;https://docs.temporal.io/docs/go/error-handling/&quot;&gt;https://docs.temporal.io/docs/go/error-handling/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Temporal, ‚ÄúTesting and Debugging‚Äù, &lt;em&gt;Temporal Documentation&lt;/em&gt;, 2021.
&lt;a href=&quot;https://docs.temporal.io/docs/go/testing/&quot;&gt;https://docs.temporal.io/docs/go/testing/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Temporal, ‚ÄúTemporal Go SDK‚Äù, &lt;em&gt;GitHub&lt;/em&gt;, 2021.
&lt;a href=&quot;https://github.com/temporalio/sdk-go&quot;&gt;https://github.com/temporalio/sdk-go&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Temporal, ‚ÄúTemporal Go SDK Samples‚Äù, &lt;em&gt;GitHub&lt;/em&gt;, 2021.
&lt;a href=&quot;https://github.com/temporalio/samples-go&quot;&gt;https://github.com/temporalio/samples-go&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Mincong Huang</name><email>mincong.h@gmail.com</email></author><category term="temporal" /><category term="temporal" /><category term="go" /><summary type="html">This article discusses the error retries in workflow engine Temporal, including retryable and non-retryable application errors, error types in retry policy, retry policy usage in different levels, maximum attempts, and more.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mincong.io/assets/bg-pablo-garcia-saldana-lPQIndZz8Mo-unsplash.jpg" /><media:content medium="image" url="https://mincong.io/assets/bg-pablo-garcia-saldana-lPQIndZz8Mo-unsplash.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>