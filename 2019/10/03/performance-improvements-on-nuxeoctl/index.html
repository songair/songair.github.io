<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Performance Improvements on Nuxeoctl - Mincong Huang</title>

<meta name="description" content="How NOS team improves the performance of Nuxeoctl, Nuxeo Server's command line, recently.">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Performance Improvements on Nuxeoctl | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Performance Improvements on Nuxeoctl" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="en" />
<meta name="description" content="How NOS team improves the performance of Nuxeoctl, Nuxeo Server’s command line, recently." />
<meta property="og:description" content="How NOS team improves the performance of Nuxeoctl, Nuxeo Server’s command line, recently." />
<link rel="canonical" href="https://mincong.io/2019/10/03/performance-improvements-on-nuxeoctl/" />
<meta property="og:url" content="https://mincong.io/2019/10/03/performance-improvements-on-nuxeoctl/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-veri-ivanova-p3Pj7jOYvnM-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-03T21:43:23+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-veri-ivanova-p3Pj7jOYvnM-unsplash.jpg" />
<meta property="twitter:title" content="Performance Improvements on Nuxeoctl" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Mincong Huang"},"image":"https://mincong.io/assets/bg-veri-ivanova-p3Pj7jOYvnM-unsplash.jpg","description":"How NOS team improves the performance of Nuxeoctl, Nuxeo Server’s command line, recently.","headline":"Performance Improvements on Nuxeoctl","dateModified":"2019-10-03T21:43:23+02:00","@type":"BlogPosting","datePublished":"2019-10-03T21:43:23+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/2019/10/03/performance-improvements-on-nuxeoctl/"},"url":"https://mincong.io/2019/10/03/performance-improvements-on-nuxeoctl/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="1280"/>
<meta property="og:image:height" content="853"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/2019/10/03/performance-improvements-on-nuxeoctl/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>

          

          
          
          

          
          
          

          
          

          
          

          <a href="/">Mincong Huang</a>
        </div><button class="button button--secondary button--circle search-button js-search-toggle">
            <i class="fas fa-search"></i>
          </button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/en/categories/">Categories</a></li><li class="navigation__item"><a href="/en/series/">Series</a></li><li class="navigation__item"><a href="/en/archive/">Archive</a></li><li class="navigation__item"><a href="/en/about/">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li><li>
            <a href="/cn/">
             <img src="/assets/flag-CN.png"
                  alt=""
                  class="naviation__lang_img">
            </a>
          </li>
        </ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/assets/bg-veri-ivanova-p3Pj7jOYvnM-unsplash.jpg);background-color:#203028;"><div class="hero__content"><div class ="main">

  
  <div class="article__info clearfix">
      <ul class="left-col menu">
        <li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=java">java</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=performance">performance</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=cli">cli</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=jgit">jgit</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=rest">rest</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=jersey">jersey</a>
            </li>

        <li class="separator">|</li>
          
            <li>
              <a class="button button--circle button--primary focus lang"
                 href="/2019/10/03/performance-improvements-on-nuxeoctl/"><span>EN</span></a>

              






              

              
            </li>
          
        
      </ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Oct 03, 2019</span>
            </li></ul></div><div class="article__header"><header><h1>Performance Improvements on Nuxeoctl</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">How NOS team improves the performance of Nuxeoctl, Nuxeo Server's command line, recently.</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      
      Photo by
      <a href="https://unsplash.com/@veri_ivanova" target="_blank">Veri Ivanova</a>
      
      on
      <a href="https://unsplash.com/license" target="_blank">Unplash </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><meta itemprop="headline" content="Performance Improvements on Nuxeoctl"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2019-10-03T21:43:23+02:00">
    <meta itemprop="keywords" content="java,performance,cli,jgit,rest,jersey"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h2 id="overview">Overview</h2>

<p><a href="https://doc.nuxeo.com/nxdoc/nuxeoctl-and-control-panel-usage/">Nuxeoctl</a> is a
controlling interface and inspection tool for Nuxeo Server. It allows you to
register your instance, start and stop it, interact with Nuxeo Online
Services to list and install your marketplace packages. However, it is slow in
regards to Marketplace commands: install, listall, … 
In this article, I will explain what <a href="https://github.com/akervern">Arnaud Kervern</a>
and I did recently to improve the performance of Nuxeoctl.
For the command line examples, I will assume that we
are located at <code class="language-plaintext highlighter-rouge">$NUXEO_HOME</code>, the home path of a Nuxeo Server 10.10 instance.
Let’s get started :)</p>

<h2 id="enable-log-timestamp">Enable Log Timestamp</h2>

<p>On the client-side (<code class="language-plaintext highlighter-rouge">nuxeoctl</code>), there is no improvement done. But what we did
is to observe: we prove that the majority of the problem comes from Nuxeo Online Services and
not the client itself.</p>

<p>The first attempt was to prove the slowness of the commands. This is done by
using <code class="language-plaintext highlighter-rouge">time</code> command, followed by the actual command. Here is the pattern for
measuring the execution time of command “mp-update”:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>time bin/nuxeoctl mp-update
</code></pre></div></div>

<p>The second attempt was to prove that the slowness comes from Nuxeo Online
Services. By default, Nuxeoctl does not contain timestamp when logging execution
output. Timestamp is essential for time measurement. The timestamp can be added by
modifying the default Log4J 2 configuration shipped by Nuxeo Launcher JAR
(<code class="language-plaintext highlighter-rouge">bin/nuxeo-launcher.jar:log4j2.xml</code>). This action can be done via
VIM, where you open the JAR, enter into the Log4J 2 zip entry, modify the
pattern layout from simple to ISO-8601, and save the changes by closing VIM.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code> &lt;Console name="CONSOLE" target="SYSTEM_OUT"&gt;
   &lt;ThresholdFilter level="DEBUG" onMatch="ACCEPT" /&gt;
<span class="gd">-  &lt;PatternLayout pattern="%m%n" /&gt;
</span><span class="gi">+  &lt;PatternLayout pattern="%d{ISO8601} %-5p [%t] [%c] %m%n /&gt;
</span> &lt;/Console&gt;
</code></pre></div></div>

<p>Once done, relaunch the nuxeoctl command with <code class="language-plaintext highlighter-rouge">time</code> and debug mode enabled for
Java packages starting with namespace <code class="language-plaintext highlighter-rouge">org.nuxeo</code>. In this case, we can see all the
HTTP requests sent to Nuxeo Online Services:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>time bin/nuxeoctl -d org.nuxeo -- mp-update
</code></pre></div></div>

<h2 id="java-flight-recorder">Java Flight Recorder</h2>

<p>Now we understand that the problem comes from our RESTful APIs, the next step
is to measure the actual pain points in Java code. We used logger at the
beginning: we created an INFO level log wherever we think the call is long. Then
observe the log entries on Datadog, our monitoring tool. However, this is not
efficient:</p>

<ul>
  <li>Hard to understand logs as stack-trace, where one method can call another</li>
  <li>Difficult to read (need to search in Datadog)</li>
  <li>Impossible to handle multi-thread situation (our timer is not thread-safe)</li>
</ul>

<p>Then, we switched to <a href="https://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/about.htm#JFRUH172">Java Flight Recorder (JFR)</a>. Java Flight Recorder is a tool
for collecting diagnostic and profiling data about a running Java application.
It is integrated into the JVM and causes almost no performance overhead. Using
it in production requires a commercial license, but we only used it for the dev
environments, which is ok. Enable JFR via Java option by restarting the JVM:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">-XX</span>:+UnlockCommercialFeatures <span class="nt">-XX</span>:+FlightRecorder MyApp
</code></pre></div></div>

<p>Once enabled, the following commands can be used for JFR:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># List and find Java PID</span>
jps

<span class="c"># Start recording</span>
jcmd <span class="nv">$pid</span> JFR.start <span class="se">\</span>
    <span class="nv">name</span><span class="o">=</span>MyRecording <span class="se">\</span>
    <span class="nv">settings</span><span class="o">=</span>profile <span class="se">\</span>
    <span class="nv">delay</span><span class="o">=</span>5s <span class="se">\</span>
    <span class="nv">dumponexit</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
    <span class="nv">filename</span><span class="o">=</span>/path/to/file

<span class="c"># Stop recording</span>
jcmd <span class="nv">$pid</span> JFR.stop <span class="se">\</span>
    <span class="nv">name</span><span class="o">=</span>MyRecoring
</code></pre></div></div>

<p>The JFR file (<code class="language-plaintext highlighter-rouge">*.jfr</code>) can be opened via Java Mission Control (JMC).
Due to confidentiality, I cannot share the screenshots with you. But we gathered
important information about the application and successfully identified some
problems. The record contains: threads, the stack trace of hot methods, the call
trees, the file read/write, the socket read/write, etc.</p>

<h2 id="optimize-jgit-operation">Optimize JGit Operation</h2>

<p>From the JFR record, we can see that 58.3% of the time is spent on thread HTTP
(<code class="language-plaintext highlighter-rouge">http-bio-0.0.0.0-exec-1</code>) for reading file content from a local Git repository
of the web server. It consists of the following steps:</p>

<ol>
  <li>Clone a Git repository from remote if not exist locally</li>
  <li>Perform <code class="language-plaintext highlighter-rouge">git-fetch</code> command to update the repository</li>
  <li>Perform <code class="language-plaintext highlighter-rouge">git-checkout</code> command to switch branch</li>
  <li>Read the file content from the target branch</li>
  <li>Repeat on all related projects sequentially</li>
</ol>

<p>But actually what we need is just an XML file from a given project. So I
proposed to create a new RESTful API endpoint for reading files in our Git
server. In this way, the read operation will no longer rely on the local Git
repository. The file reading can also be done concurrently for multiple
projects. The new endpoint looks like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/site/gitty/blob/{projectId}/{rev:.+}?path={path}
</code></pre></div></div>

<p>Why using Git server will be better? Because we don’t have to clone the
repository, fetch the delta changes between local and remote, and checkout
the Git repository. Reading a given path will be as simple as the following
native Git command. Also, this solution is not tight to JGit. It can be applied
to any modern Git server.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git show REVISION:path/to/file
</code></pre></div></div>

<p>By doing so, the time spent decreased from 300 seconds (timeout) to 104 seconds.
So the performance increased about 65%.</p>

<h2 id="avoid-amazon-s3">Avoid Amazon S3</h2>

<p>Then, we continued to measure the performance using Java Flight Recorder. We
figured out that 78% of the time spent is now focused on retrieving file metadata
from Amazon S3. This is mainly for constructing “PackageDocument” object in
Java. However, in our case, creating a virtual object does not require an
actual file downloaded from Amazon S3, since most of the metadata are also stored
locally on the web server. So the method can be refactored.
Combined with the first fix on file content API, the execution now finished
around 70 seconds.</p>

<h2 id="optimize-jersey-client">Optimize Jersey Client</h2>

<p>According to Jersey Client documentation: <a href="https://eclipse-ee4j.github.io/jersey.github.io/documentation/1.19.1/client-api.html#d4e621">3.5.1 Configuring a Client and
WebResource</a>,
<code class="language-plaintext highlighter-rouge">Client</code> instances are expensive resources. It is recommended a configured
instance is reused for the creation of Web resources. The creation of Web
resources, the building of requests and the receiving of responses are guaranteed
to be thread-safe. Thus a Client instance and WebResource instances may be
shared between multiple threads. This was not yet our case. Therefore, Arnaud
changed the logic and reused the same instance as a singleton.
Combined with the fixes above, the execution now finished less than 60 seconds
(missing more accurate data).</p>

<h2 id="cache-user-rights">Cache User Rights</h2>

<p>In Git server, we retrieved user rights via API to determine if the user has
permission to visit and modify certain resources. Since user rights are not
frequently changed but frequently read, we decided to add a cache
for the given user. In this case, we avoid extra network exchange whenever
possible. We built the cache using Guava.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">USER_RIGHTS_CACHE</span> <span class="o">=</span>
    <span class="nc">CacheBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">expireAfterAccess</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<p>On the other hand, the performance will depend on if the cache is hot or cold.
In other words, filled or empty. The first time an HTTP request is performed,
the execution will still be long because the cache is not yet filled. However,
the following calls within 5 seconds will be much faster, because the cache is
filled. Combined with the fixes above, the execution now finished less than 60
seconds (missing more accurate data).</p>

<h2 id="rejected-proposals">Rejected Proposals</h2>

<p>We also discussed other proposals. However, they are rejected due to different
reasons. Let’s take a quick look:</p>

<p>Java Parallel Stream:</p>

<ul>
  <li>Description: Use parallel stream instead of stream</li>
  <li>Category: Java Core</li>
  <li>Difficulty: <del>Easy</del> Hard</li>
  <li>Rejected Reason: Most of the calls in our source code are related to the database.
Using parallel stream increases significantly the number of simultaneous
connections to the database. We must review the connection pool configuration
and other related configuration (connection blocking timeout, HTTP threads, …) before
using this approach. Also, we should have a way to control the max level of
parallelism and avoid relying on the default JVM settings.</li>
</ul>

<p>File Content Cache:</p>

<ul>
  <li>Description: Use cache on web server for repetitive deserialization from file
<code class="language-plaintext highlighter-rouge">application.xml</code>. Cache result per branch per project (key: project-branch,
value: the content of application.xml)</li>
  <li>Category: Java Core</li>
  <li>Difficulty: Hard</li>
  <li>Rejected Reason: branch (Git reference) can be changed by pointing to another
object id; projects combined with branches, the cache will consume a lot of
memory; improvement will only be beneficial starting from the second call
(warm cache). In short, the concerns are: write strategy, memory usage, and
cache eviction.</li>
</ul>

<p>Improve RESTful APIs for Nuxeoctl:</p>

<ul>
  <li>Description: Nuxeoctl relies on <a href="https://github.com/nuxeo/nuxeo-connect">Nuxeo Connect
Client</a>. Nuxeo Connect Client should
separate package listing API into “listing packages” and “fetching detail of
specific package”. It will reduce the size of HTTP response and make
complex calculations (package detail) done on demand.</li>
  <li>Category: Nuxeoctl, API</li>
  <li>Difficulty: Hard</li>
  <li>Rejected Reason: Changing Nuxeo Connect Client requires import effort. Nuxeo
Connect Client is shipped into each Nuxeo Server. Currently, we support Nuxeo
Server 8.10, 9.10, 10.10. We cannot change those versions. It means that the
new design must be backward compatible.</li>
</ul>

<p>Add Skip-Options for Nuxeoctl:</p>

<ul>
  <li>Description: Nuxeoctl should have skip options <code class="language-plaintext highlighter-rouge">--skip-*</code> to skip different
unnecessary logic, such as skipping Studio project listing, add-on listing,
hot-fix listing, etc.</li>
  <li>Category: Nuxeoctl</li>
  <li>Difficulty: Medium</li>
  <li>Rejected Reason: Similar to the reasons above, this change needs to be adapted to
Nuxeo 8.10, 9.10, and 10.10. Also, it requires a deep understanding of Nuxeoctl
in the first place. From the DEBUG level logs of Nuxeoctl, we can see that
most of the time are spent waiting for HTTP responses from the server. We think
the effort should be put on server-side first, which maximizes the benefits
for our users without changes on their side.</li>
</ul>

<h2 id="enforce-observability">Enforce Observability</h2>

<p>At Nuxeo, we use Datadog for monitoring our SaaS application: Nuxeo Online
Services. Apache Access Log is sent as JSON to Datadog so that we can have an
overview of the performance of each API endpoint. There was a bug in our Apache
configuration, which makes the JSON invalid thus impossible to unparse. I fixed
it so that we can resume the monitoring from Datadog.</p>

<p>Also, I created project <a href="/2019/09/15/project-nos-test/">NOS Checker</a> (formerly
NOS Test), an acceptance testing tool that checks the HTTP status code and the
time spent on existing API endpoints. This tool allows you the substitute as
another user: normal user, presales, support, professional services, … after
execution, an execution report is generated. So it’s easy to compare the
performance of each type of profile in one single command.</p>

<h2 id="improvement-strategy">Improvement Strategy</h2>

<p>Here is the strategy of performance improvement I summarize from this change:</p>

<ul>
  <li>Understand the app architecture: client, server, database, …</li>
  <li>Measure and observe time spent: command line, logs, monitoring, Java
profiling</li>
  <li>Identify the performance bottlenecks</li>
  <li>Propose solutions based on effort, complexity, gain, potential risk, and
maintenance cost</li>
  <li>Implement and measure again</li>
  <li>Set up or update tools (performance tests, acceptance tests, monitoring, …)
to ensure the result is as expected for different factors: projects, user
profile, environment.</li>
</ul>

<h2 id="next-steps">Next Steps</h2>

<p>The performance changes are not yet in production the time I wrote this article.
From the feedback of our engineering manager, the result on preprod is 89%
faster than the one from production (12m00 -&gt; 1m19). But this still needs to be
confirmed by our actual users once the changes are publicly available. We also
planned to add more optimization in NXQL queries based on <a href="https://doc.nuxeo.com/nxdoc/nxql/">NXQL | Nuxeo
Documentation</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, I shared how Arnaud and I improved the performance by
measuring and implementing different solutions, I discussed some rejected
proposals, observability improvement and performance improvement strategy in
general.</p>

<p>Interested to know more? You can subscribe to <a href="/feed.xml">my feed</a>, follow
me on <a href="https://twitter.com/mincong_h">Twitter</a> or
<a href="https://github.com/mincong-h/">GitHub</a>. Hope you enjoy this article, see you
the next time!</p>

<h2 id="references">References</h2>

<ul>
  <li>Nuxeo, “nuxeoctl and Control Panel Usage”, <em>Nuxeo</em>, 2019.
<a href="https://doc.nuxeo.com/nxdoc/nuxeoctl-and-control-panel-usage/">https://doc.nuxeo.com/nxdoc/nuxeoctl-and-control-panel-usage/</a></li>
  <li>Nuxeo, “NXQL | Nuxeo Documentation”, <em>Nuxeo</em>, 2019.
<a href="https://doc.nuxeo.com/nxdoc/nxql/">https://doc.nuxeo.com/nxdoc/nxql/</a></li>
  <li>Oracle, “Java Platform, Standard Edition Java Flight Recorder Runtime Guide”,
<em>Oracle Help Center</em>, 2019.
<a href="https://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/about.htm#JFRUH170">https://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/about.htm#JFRUH170</a></li>
  <li>Oracle, “Command Reference”, <em>Oracle Help Center</em>, 2019.
<a href="https://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/comline.htm#JFRUH193">https://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/comline.htm#JFRUH193</a></li>
  <li>Andrew Shcherbakov, “Monitoring Java Applications with Flight Recorder”,
<em>Baeldung</em>, 2019. <a href="https://www.baeldung.com/java-flight-recorder-monitoring">https://www.baeldung.com/java-flight-recorder-monitoring</a></li>
  <li>mike, “Is there a quick Git command to see an old version of a file?”,
<em>Stack Overflow</em>, 2008.
<a href="https://stackoverflow.com/questions/338436/">https://stackoverflow.com/questions/338436/</a></li>
  <li>Amir, “What does it mean by cold cache and warm cache concept?”, <em>Stack
Overflow</em>, 2014.
<a href="https://stackoverflow.com/questions/22756092/">https://stackoverflow.com/questions/22756092/</a></li>
  <li>Jersey, “Jersey 1.19.1 - 3.5.1 Configuring a Client and WebResource”, <em>Eclipse
EE4J</em>, 2019.
<a href="https://eclipse-ee4j.github.io/jersey.github.io/documentation/1.19.1/client-api.html#d4e621">https://eclipse-ee4j.github.io/jersey.github.io/documentation/1.19.1/client-api.html#d4e621</a></li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2019-10-03T21:43:23+02:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">Subscribe</a>
</div></div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/2019/09/22/mockito-verify/">Mockito: 4 Ways to Verify Interactions</a></div><div class="next"><span>NEXT</span><a href="/2019/10/07/nuxeo-2019/">Nuxeo 2019</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/2019/10/03/performance-improvements-on-nuxeoctl/';
    this.page.identifier = '/2019/10/03/performance-improvements-on-nuxeoctl';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

