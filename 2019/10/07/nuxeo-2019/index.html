<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><!--
	_title: Nuxeo 2019;
        _titles: ;
        __return: Nuxeo 2019;
 -->
<!-- title: "Nuxeo 2019" -->
<title>Nuxeo 2019 - Mincong Huang</title>

<meta name="description" content="As a software engineer, what I did this year at Nuxeo over plan, code, build, test, release, deploy, operate, and monitor for Nuxeo Online Services (NOS).">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Nuxeo 2019 | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Nuxeo 2019" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="en" />
<meta name="description" content="As a software engineer, what I did this year at Nuxeo over plan, code, build, test, release, deploy, operate, and monitor for Nuxeo Online Services (NOS)." />
<meta property="og:description" content="As a software engineer, what I did this year at Nuxeo over plan, code, build, test, release, deploy, operate, and monitor for Nuxeo Online Services (NOS)." />
<link rel="canonical" href="https://mincong.io/2019/10/07/nuxeo-2019/" />
<meta property="og:url" content="https://mincong.io/2019/10/07/nuxeo-2019/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-cristian-escobar-abkEAOjnY0s-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-07T21:47:25+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-cristian-escobar-abkEAOjnY0s-unsplash.jpg" />
<meta property="twitter:title" content="Nuxeo 2019" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"image":"https://mincong.io/assets/bg-cristian-escobar-abkEAOjnY0s-unsplash.jpg","headline":"Nuxeo 2019","description":"As a software engineer, what I did this year at Nuxeo over plan, code, build, test, release, deploy, operate, and monitor for Nuxeo Online Services (NOS).","datePublished":"2019-10-07T21:47:25+02:00","dateModified":"2019-10-07T21:47:25+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/2019/10/07/nuxeo-2019/"},"url":"https://mincong.io/2019/10/07/nuxeo-2019/","author":{"@type":"Person","name":"Mincong Huang"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="1280"/>
<meta property="og:image:height" content="853"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/2019/10/07/nuxeo-2019/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>

          

          
          
          

          
          
          

          
          

          
          

          <a href="/">Home</a>
        </div><button class="button button--secondary button--circle search-button js-search-toggle">
            <i class="fas fa-search"></i>
          </button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/en/categories/">Categories</a></li><li class="navigation__item"><a href="/en/series/">Series</a></li><li class="navigation__item"><a href="/en/archive/">Archive</a></li><li class="navigation__item"><a href="/en/about/">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li><li>
            <a href="/cn/">
             <img src="/assets/flag-CN.png"
                  alt=""
                  class="naviation__lang_img">
            </a>
          </li>
        </ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/assets/bg-cristian-escobar-abkEAOjnY0s-unsplash.jpg);background-color:#203028;"><div class="hero__content"><div class ="main">

  
  <div class="article__info clearfix">
      <ul class="left-col menu">
        <li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=career">career</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=project">project</a>
            </li>

        <li class="separator">|</li>
          
            <li>
              <a class="button button--circle button--primary focus lang"
                 href="/2019/10/07/nuxeo-2019/"><span>EN</span></a>

              






              

              
            </li>
          
        
      </ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Oct 07, 2019</span>
            </li></ul></div><!--
	_title: Nuxeo 2019;
        _titles: ;
        __return: Nuxeo 2019;
 -->
<div class="article__header"><header><h1>Nuxeo 2019</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">As a software engineer, what I did this year at Nuxeo over plan, code, build, test, release, deploy, operate, and monitor for Nuxeo Online Services (NOS).</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      
      Photo by
      <a href="https://unsplash.com/@cristian1" target="_blank">Cristian Escobar</a>
      
      on
      <a href="https://unsplash.com/license" target="_blank">Unplash </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><!--
	_title: Nuxeo 2019;
        _titles: ;
        __return: Nuxeo 2019;
 -->
<meta itemprop="headline" content="Nuxeo 2019"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2019-10-07T21:47:25+02:00">
    <meta itemprop="keywords" content="career,project"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h2 id="overview">Overview</h2>

<p>Today, I would like to share what I did this year at Nuxeo. Nuxeo is a content
management platform to build modern business applications. I work at Nuxeo
Online Services (NOS) Team, a SaaS (<a href="https://en.wikipedia.org/wiki/Software_as_a_service">software as a
service</a>) application
including all online services of Nuxeo: Nuxeo Studio, Nuxeo Marketplace, Nuxeo
Connect Dashboard, Nuxeo Register, and command-line tool “nuxeoctl”. In the
following paragraphs, I will explain my daily mission as a Software Engineer
through 8 parts: plan, code, test, build, release, deploy, operate and monitor.</p>

<p align="center">
 <img src="/assets/20191007-devops-cycle.png" alt="DevOps cycle" />
  <small>Image: <a href="https://guide.freecodecamp.org/devops/">
DevOps | freeCodeCamp Guide
</a></small>
</p>

<p>The NOS Team consists of one product owner, one designer, and five full-stack
developers (two focus on the front-end and three focus on the back-end). We
use Sprint methodology to organize the team’s work and iterate every two weeks.</p>

<h2 id="plan">Plan</h2>

<p>In the NOS Team, we go through several meetings to ensure tasks are prioritized
correctly and ensure they can bring actual value to our customers. We have:</p>

<ul>
  <li>Triage — weekly meeting (1h30) to review tickets between product owner,
designer, and developers to ensure the ticket is well understood before
being inserted into the backlog.</li>
  <li>GoT — Gang-of-Three meeting (1h) between PO, designer, and tech lead to discuss the
feasibility, timeline, product value, user-experience, technical constraints,
etc. Actually, not only tech lead, but all developers can participate in this
meeting.</li>
  <li>Poker — poker planning, the weekly meeting (1h) we have to understand what
should be planned for the next sprint.</li>
  <li>Sprint Priorities — cross-team meeting (1h) between engineering teams
(platform, NOS, UI, AI) to communicate the next priorities.</li>
  <li>Sprint Planning — bi-weekly meeting (1h) to review tasks done in the current
sprint and plan for the next sprint.</li>
  <li>Retrospective — the review of the last sprint (1h) with an exclusive focus on the
team members: what went well and what should be improved. The results are
written as action points.</li>
</ul>

<p>As a software engineer, my goal in the planning part is to participate in these meetings
and provide technical information to help decision making. This is crucial for a
software vendor like Nuxeo, which is heavily relied on technology. For
cross-team changes, highlight the dependency between teams, understand their
schedule, the time constraint, their capacity, the possible solutions, the
history of some changes, etc. For team-internal changes, understand the
importance of the issue, its difficulty, technical constraints, architecture,
dependency with other issues, possible solutions and their trade-offs,
acceptance criteria, etc. Ultimately, these efforts bring transparency
to the team and facilitate decision making for the product.</p>

<h2 id="code">Code</h2>

<p>Development is my core activity. This year, I participated in different topics.
If grouping them by service, there are Studio Service, Connect Dashboard
Service, Marketplace Service, and Instance Registration Service. If grouping
them by components, there are authentication, Docker image, Google Web Kit
(GWT), logging, JGit, performance improvement, Tomcat, Nuxeo Framework,
analytics, security, RESTful API, etc. Most of them are bug-fixes. I also did
some changes around Git Server, Docker image, and performance improvement this
year. Due to the time constraint, I cannot cover everything, so I just picked up
three topics to share with you: bug-fixing, Git server, and performance
improvement.</p>

<p>For bug-fixing, several aspects are very important: understand the problem,
reproduce, solve, and test. First, you need to clarify the unclear detail and
eliminate the confusing (irrelevant) information, then reproduce the problem
yourself. Translate the description with accurate words will help.
Reconstruct the timeline, find the missing technical information from the monitoring
tool will help too. Try to simplify the reproduction steps and ensure they are
deterministic. Sometimes this can be very hard, you need to cover all possible
dimensions related to the same event and avoid making assumptions in the early
stage. Debugging tools, audit events, and logs will help for finding out more information. Once done,
it’s time to solve it. Depending on the severity, it can be a regular or an
urgent ticket: for urgent tickets, it might be needed to split the solutions
into workaround and real fixes, where workaround must be applied immediately and
real fixes can be handled in a normal pace. Once the solution is found, we need
to write tests to ensure the fix works as expected. This will be detailed in the
next section. Once done, we also deploy the fix on a development environment so
that either us or product team members (PO, QA) can validate the fix.</p>

<p>For Git Server, we have to host thousands of repositories for hundreds
of customers in Nuxeo Online Services. We used to use <a href="https://about.gitlab.com/">GitLab Server</a>
(Community Edition), but due to several constraints in terms of maintenance,
security, analytics, customizability, etc., we decided to develop our
solution: Gitty, based on <a href="https://github.com/eclipse/jgit/">Eclipse JGit</a>.
JGit contains an HTTP module, which provides a Git Servlet. It can be deployed in
any Java Servlet container effortlessly. This year, I contribute several patches
in Git Server for adding the health-check, fixing security issues, improving
logging, and creating new RESTful API endpoints. Collaborate with Cloud Team to
provide infrastructure level changes: auto-scaling group, HTTP threads, connection
pool, Apache rules, etc.</p>

<p>For performance improvement, I recently also did some improvements around
nuxeoctl with <a href="https://github.com/akervern">Arnaud Kervern</a>. We
measured, profiled, and optimized the source code to make the processing faster.
The API is nearly 5 times faster than before according to our engineering manager.
This release will come very soon. For more information, see <a href="/2019/10/03/performance-improvements-on-nuxeoctl/">Performance
Improvements on Nuxeoctl</a>.</p>

<h2 id="test">Test</h2>

<p>In Nuxeo Online Services, we have a lot of bug-fixes to do. When we handle a
ticket, we are facing several challenges: lack of software structure, tightly
coupled class/methods, time limit, out-dated library, dependency constraint,
lack of existing tests, etc. However, none of these can stop us from writing
better software. That’s where testing comes into the screen.
In terms of testing, we tried to improve the software as follows:</p>

<ul>
  <li>Clarify the logic through refactoring</li>
  <li>Clarify the assumption and expected outcomes in test</li>
  <li>Leverage the power of testing frameworks</li>
  <li>Put the effort on the most mission-critical part</li>
</ul>

<p>This year, I tried my best to practice test-driven-development (TDD): whenever
the code is modified, new tests were added systematically. Not only the code
coverage has been improved, but there was also extra-effort to keep the tests as
simple as possible.
In this way, it is easier to review and maintain. Also, test execution
remains fast. In my opinion, the goal of writing tests is not to reach a certain
coverage. Instead, the goal is to bring assurance to the software and bring
confidence to our users. If you were interested, here are some blog posts I
wrote about testing this year:</p>

<ul>
  <li><a href="/2019/09/22/mockito-verify/">Mockito: 4 Ways to Verify Interactions, 22 Sep 2019</a></li>
  <li><a href="/2019/09/15/project-nos-test/">Project: NOS Test, 15 Sep 2019</a></li>
  <li><a href="/2019/09/13/init-mock/">Mockito: 3 Ways to Init Mock in JUnit, 13 Sep 2019</a></li>
  <li><a href="/2019/09/02/measure-coverage-with-coverage.py/">Measure Coverage with Coverage.py, 02 Sep 2019</a></li>
  <li><a href="/2019/08/26/testing-with-gwtmockito/">Testing with GwtMockito, 26 Aug 2019</a></li>
  <li><a href="/2019/07/18/fixing-comparator/">Fixing Comparator, 18 Jul 2019</a></li>
  <li><a href="/2019/02/19/static-factory-method/">Design Pattern: Static Factory Method, 19 Feb 2019</a></li>
  <li><a href="/2019/02/05/tdd-after-3-months-practice/">TDD: After 3 Months’ Practice, 05 Feb 2019</a></li>
  <li><a href="/2019/01/09/test-polymer-2-using-wct/">Test Polymer 2 Using WCT, 09 Jan 2019</a></li>
</ul>

<p>In the context of continuous delivery, having tests allows fast and
deterministic feedback. If testing does not yield new information, defects will
go undetected.</p>

<h2 id="build">Build</h2>

<p>Our build pipeline is very complex. <a href="https://maven.apache.org/">Apache Maven</a>
is our primary build tool, but other tools are also involved in the build, such as Ant, Node.js, Polymer, Gulp, Bower,
and tools for functional tests (Gecko-driver, Firefox). In the following
paragraphs, I will share two things I did for the build: enable GitHub status
in Jenkins CI and triggering Checkstyle automatically from GitHub.</p>

<p>The NOS team does not set up restrictions to run all tests before merging the
pull requests. Mainly because the tests are too long to execute (almost 3
hours), it might contain random failures. And in any case, the commit will be
tested on the master branch before being released. However, it is still a big problem,
especially at the end of sprint: when something went wrong on master, it was hard to
tell which commit caused the problem as several commits were merged at the same
time window and none of them was tested. It caused unnecessary troubles and
stress. However, it is very hard to propose a simple and efficient solution with
a personal effort. After many considerations, I finally found out a solution:
enable the GitHub plugin on our Jenkins jobs which notifies GitHub at the
start of the build (status: pending) and at the end of the build (status:
succeeded or failed). Therefore, we can have a build status during the review.
It makes the work visible and makes the process more transparent: reviewers are
now able to evaluate the risk of changes without visiting Jenkins CI. If it were
a small PR, we can eventually consider it’s OK and merge the PR without checks.</p>

<p align="center">
  <img src="/assets/20191007-build-checks.png" alt="Jenkins build results on GitHub" />
</p>

<p>This year, I also started working on Checkstyle to build the rules according to
Nuxeo’s coding conventions. For example, check
<a href="https://checkstyle.org/config_imports.html#CustomImportOrder">CustomImportOrder</a>
had been added to ensure our import order is done correctly in Java files. You
might not know, I’m a big fan of Maven, I wrote 17 articles about Maven in the
last 3 years. You can check them <a href="/tags/maven/">here</a>.</p>

<h2 id="release">Release</h2>

<p>At NOS, our release cycle is about two weeks: we create a new release after the
end of each sprint. We use <a href="https://semver.org/">semantic versioning</a> for our
release versions: MAJOR.MINOR.PATCH. We adapted the version naming with our own
needs, where we increment the:</p>

<ul>
  <li>MAJOR version when upgrading our Nuxeo Server</li>
  <li>MINOR version when we perform bi-weekly release</li>
  <li>PATCH version when handling bug-fixes</li>
</ul>

<p>My mission during the release phase is to ensure that new releases can be created on
time with appropriate changes. This is done by reminding people the release day,
reviewing the pull-requests, accelerating or postponing upcoming changes
depending on the context, estimating the delivery volume and risk, etc. Doing
so helps us deliver at a stable pace and have a predictable day for deployment.</p>

<h2 id="deploy">Deploy</h2>

<p>Deployment is handled by Nuxeo Cloud Team (formerly Nuxeo Cloud Operations Team). The
deployment pipeline is a 100% automated process, mainly based on
<a href="https://github.com/ansible/ansible">Ansible</a>. Also, they use a blue-green
deployment method, an effective way to update services with limited
downtime. Even if the pipeline is 100% automated, there will still be an
engineer which monitors the progress and handle the post-deployment tasks:
manual switch from BLUE stack to GREEN stack; keep BLUE stack alive until GREEN
stack is validated; trash BLUE stack or switch back depending on the context;
etc.</p>

<p align="center">
  <img src="/assets/20191007-blue-green-deployment.png" alt="bg-deploy" />

  <small>Image: <a href="https://michaeljswart.com/2018/01/100-percent-online-deployments-blue-green-deployment/">
100 Percent Online Deployments: Blue-Green Deployment, Machael J Swart
</a></small>
</p>

<p>My mission in deployment is to coordinate with the Cloud Team to ensure the new
release will be deployed on time and will be deployed successfully. The main
challenges are:</p>

<ul>
  <li>Check constraints before schedule – Avoid deployments during
training weeks, hackathon, big demos, …</li>
  <li>Check availability – The Cloud Team has 30+ customers, so we need to
avoid conflicts here.</li>
  <li>Perform post-deployment checks – Valide the new stack and provide feedback to
them.</li>
</ul>

<p>In the NOS Team, we used to perform post-deployment checks manually.
We visited the most important pages of the website and ensure they can be
loaded. As you can see, this process is manual and has very limited coverage.
Since we need to do this repetitively, I created our new tool – NOS Checker
(formerly NOS Test). It consists of three parts: browser checks (Selenium),
API checks (JAX-RS/Jersey), and command-line checks (nuxeoctl). For the browser
checks, it visits the target pages and ensures the behaviors are expected. For
API checks, it sends HTTP requests to target APIs and asserts the response. For
the command line, it downloads Nuxeo Server, registers the Nuxeo Server, and
performs frequently used nuxeoctl commands. NOS Checker can also be run in
performance mode, where hundreds of requests will be sent simultaneously. Then
it calculates the meantime of these requests. It can
also substitute a target user so that you can run it as presales, PS, support,
or other profile. A human-readable report is generated at the end.
If you’re interested in this tool, I have another blog post
here: <a href="/2019/09/15/project-nos-test/">Project: NOS Test</a>. In short, NOS Checker
brings the post-deployment checks into the next level.</p>

<p align="center">
  <img src="/assets/20191007-nos-checker.png" alt="NOS Checker" />
  <small>Image: Help message of NOS Checker</small>
</p>

<h2 id="operate">Operate</h2>

<p>Operations are handled by the Cloud Team. However, due to the limited resources
and the particularity of the NOS stack, they sometimes need help on our side. For
example, we rely on Apache Access Logs and Datadog to understand the HTTP
traffic. However, the JSON log generated by Apache Server was wrong, so we don’t get any useful
insight from Datadog. Another example is the Apache URL rewrite-pattern has to
be changed in the deployment pipeline, due to another change at the application-level. Although these changes are trivial
to do, I want to highlight the impact here: at the operation
level, many changes are time-related, they have to be done quickly. Without those
changes, we will have big trouble on production: in those two examples, the
first one could have caused API statistic problem on production (no data), the second
one could have caused service unavailability for customers.</p>

<h2 id="monitor">Monitor</h2>

<p>Monitoring is important for understanding the health of our production
environment and troubleshooting
when a production incident happened. We mainly use Datadog, a cloud-based
monitoring solution for doing it. In Datadog, we set up dashboards to monitor
our HTTP traffic (volume, 4xx errors, 5xx errors), Java web servers (memory,
threads, GC, session), database (connection pool, size, CPU), hard disk, etc.</p>

<p align="center">
  <img src="/assets/20191007-datadog-background.png" alt="Datadog Background" style="max-width:50%" />
  <small>Image: <a href="https://www.datadoghq.com/about/press/resources/">
Datadog</a></small>
</p>

<p>On my side, I created “qWatch” project: qWatch stands for “Quality Watch”, it
analyzes the quality of the software based on Datadog Logs — I download logs
from Datadog Logs web page regularly and match them with predefined log patterns.
Each pattern represents an exception in the software. It allows us to detect
software anomalies, based on their frequency, their age, their impact and more.
It allows us to have precious feedback before the error goes critical. Also, it
allows us to prioritize the most critical ones, group them by components since
we have more insights right now.</p>

<p>Recently, I also created a dashboard for HTTP and database. Based on our
previous experience, the database has a significant correlation with the HTTP
traffic. Different from the existing dashboard, this one focuses exclusively on HTTP
traffic — the volume of the traffic, the distribution per service, the
response time, etc. The graphs are created based on log events and metrics. The
objective is to:</p>

<ul>
  <li>Better monitor the database (RDS) activity</li>
  <li>Better understand the activity of each API</li>
  <li>Find out the eventual correlation between the database, JVM and the HTTP traffic</li>
</ul>

<p>I also use Datadog frequently for troubleshooting, especially with logs. Thanks
to the log entries and all its metadata, it helps to understand the context of
the exception, the root cause, what happened in that context (near time) on that
machine or on the entire cluster, the severity, the frequency of the same error,
eventual workaround. It also helps to set up an alert (monitor) based on the known
log events. Or set up a graph in a dashboard to keep track of the evolution of the
same error pattern.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, I shared with you how the team works and what I did as a
software engineer at Nuxeo over 8 parts: plan, code, test, build, release, deploy,
operate, and monitor. As you can see, being a software engineer is far more than
just writing code. It comes with the responsibility of taking care of the stack
and deep collaboration with other teams.
 In the end, I would like to give share 10 tips that works
well as a software engineer, based on this year’s experience at Nuxeo:</p>

<ol>
  <li>Be data-driven</li>
  <li>Have full ownership of your stack (Dev + Ops)</li>
  <li>Test-driven development (TDD)</li>
  <li>Communication is the key</li>
  <li>Prefer automation over manual process</li>
  <li>Cross-domain skills (scale horizontally)</li>
  <li>Keep learning</li>
  <li>Team spirit</li>
  <li>Product first</li>
  <li>Shift left</li>
</ol>

<p>Interested to know more? You can subscribe to <a href="/feed.xml">my feed</a>, follow me
on <a href="https://twitter.com/mincong_h">Twitter</a> or
<a href="https://github.com/mincong-h/">GitHub</a>. Hope you enjoy this article, see you the next time!</p>

<h2 id="references">References</h2>

<ul>
  <li>Ansible, “Ansible is a radically simple IT automation platform that makes your
applications and systems easier to deploy”, <em>GitHub</em>, 2019.
<a href="https://github.com/ansible/ansible">https://github.com/ansible/ansible</a></li>
  <li>Michael J Swart, “100 Percent Online Deployments: Blue-Green Deployment”,
<em>Michael J Swart’s Blog</em>, 2018.
<a href="https://michaeljswart.com/2018/01/100-percent-online-deployments-blue-green-deployment/">https://michaeljswart.com/2018/01/100-percent-online-deployments-blue-green-deployment/</a></li>
  <li>freeCodeCamp, “DevOps”, <em>freeCodeCamp</em>, 2019.
<a href="https://guide.freecodecamp.org/devops/">https://guide.freecodecamp.org/devops/</a></li>
  <li>GitLab, “The single application for the entire DevOps lifecycle”, <em>GitLab</em>, 2019.
<a href="https://about.gitlab.com/">https://about.gitlab.com/</a></li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2019-10-07T21:47:25+02:00"><!-- start custom article footer snippet -->


  

  

  <div class="article__ads">
    
      <div id="ea-article"
           data-ea-publisher="mincongio"
           data-ea-keywords="career|project"
           data-ea-type="image">
    
    </div>
  </div>

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">Subscribe</a>
</div></div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/2019/10/03/performance-improvements-on-nuxeoctl/">Performance Improvements on Nuxeoctl</a></div><div class="next"><span>NEXT</span><a href="/2019/10/27/unzipping-file-in-java/">Unzipping File in Java</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/2019/10/07/nuxeo-2019/';
    this.page.identifier = '/2019/10/07/nuxeo-2019';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script><script src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script>
<script>
ethicalads.wait.then((placements) => {
  if (!placements.length) {
    console.debug('Loading backup content');
    div = document.querySelector('[data-ea-publisher]')
    div.innerHTML = '<p>Check out our first-party ad content.</p>'
  } else {
    console.debug('EthicalAds are loaded');
  }
});
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

