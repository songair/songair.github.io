<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Testing with GwtMockito - Mincong Huang</title>

<meta name="description" content="My recent bug fixing experience on Google Web Kit (GWT) with GwtMockito: problem understanding, code refactoring, mocking framework preparation, testing, and...">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Testing with GwtMockito | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Testing with GwtMockito" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="en" />
<meta name="description" content="My recent bug fixing experience on Google Web Kit (GWT) with GwtMockito: problem understanding, code refactoring, mocking framework preparation, testing, and comparison between GwtMockito and GWTTestCase." />
<meta property="og:description" content="My recent bug fixing experience on Google Web Kit (GWT) with GwtMockito: problem understanding, code refactoring, mocking framework preparation, testing, and comparison between GwtMockito and GWTTestCase." />
<link rel="canonical" href="https://mincong.io/2019/08/26/testing-with-gwtmockito/" />
<meta property="og:url" content="https://mincong.io/2019/08/26/testing-with-gwtmockito/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-board-2450236_1280.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-08-26T22:16:23+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-board-2450236_1280.jpg" />
<meta property="twitter:title" content="Testing with GwtMockito" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Mincong Huang"},"description":"My recent bug fixing experience on Google Web Kit (GWT) with GwtMockito: problem understanding, code refactoring, mocking framework preparation, testing, and comparison between GwtMockito and GWTTestCase.","@type":"BlogPosting","image":"https://mincong.io/assets/bg-board-2450236_1280.jpg","headline":"Testing with GwtMockito","dateModified":"2019-08-26T22:16:23+02:00","datePublished":"2019-08-26T22:16:23+02:00","url":"https://mincong.io/2019/08/26/testing-with-gwtmockito/","mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/2019/08/26/testing-with-gwtmockito/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="1280"/>
<meta property="og:image:height" content="927"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/2019/08/26/testing-with-gwtmockito/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>
<a title="Hi, welcome to my blog! I'm a software engineer at Datadog. I write blog posts in my free time. My blogs are bits and pieces of my tech journey. Most of them are related to Java. Hope you enjoy them! My opinions are my own, not Datadog's. This blog is powered by Jekyll, a simple, blog-aware, static sites solution.
" href="/">Mincong Huang</a></div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/categories">Categories</a></li><li class="navigation__item"><a href="/series">Series</a></li><li class="navigation__item"><a href="/archive">Archive</a></li><li class="navigation__item"><a href="/about">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/assets/bg-board-2450236_1280.jpg);background-color:#203028;"><div class="hero__content"><div class ="main"><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=testing">testing</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=mockito">mockito</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=gwt">gwt</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Aug 26, 2019</span>
            </li></ul></div><div class="article__header"><header><h1>Testing with GwtMockito</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">My recent bug fixing experience on Google Web Kit (GWT) with GwtMockito: problem understanding, code refactoring, mocking framework preparation, testing, and comparison between GwtMockito and GWTTe...</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      Photo by
      <a href="https://pixabay.com/en/board-school-uni-learn-work-test-2450236/" target="_blank">
        geralt
      </a>
      on
      <a href="https://pixabay.com/service/license/" target="_blank">
        Pixabay 
      </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><meta itemprop="headline" content="Testing with GwtMockito"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2019-08-26T22:16:23+02:00">
    <meta itemprop="keywords" content="testing,mockito,gwt"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h2 id="overview">Overview</h2>

<p>Recently, I fixed a front-end bug with our application written in Google Web Kit
(GWT). This is done by using <a href="https://google.github.io/gwtmockito/">GwtMockito</a>.
Today, I would like to share my experience about how I fixed it. After reading
this article, you will understand:</p>

<ul>
  <li>What happened to that web page?</li>
  <li>How to fix it?</li>
  <li>How to refactor the code for testing?</li>
  <li>Why I tested it using GwtMockito?</li>
  <li>How the test is written?</li>
  <li>Some other improvements</li>
</ul>

<p>Let’s get started :)</p>

<h2 id="the-bug">The Bug</h2>

<p>In Nuxeo Studio, we have a Custom Chain Browser, it is an editor that should display
all the Automation Chain features for a given user for customization. However, it
displays not only Automation Chain features, but also all other types of
features that are available in the user’s project model. It brings a lot of
confusion. The goal of the ticket is to fix it by displaying only the required
type: Automation Chain.</p>

<p>The changes in source code are pretty obvious:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code> public class OpRestBindingFeatureEditor extends AbstractFeatureEditor&lt;OpRestBindingFeature&gt; {
     ...
     class NonUIChainsBrowser extends FeatureBrowser {
<span class="gi">+        private static final String[] FILTER = { OpChainFeatureType.ID };
</span>
         NonUIChainsBrowser() {
             super(IDE.getActiveProject());
<span class="gi">+            setAcceptedFeatureTypes(FILTER);
</span>         }
      }
 }
</code></pre></div></div>

<p>I added a filter to <em>NonUIChainsBrowser</em> to ensure
the fix is applied correctly. This is done by using the
<code class="language-plaintext highlighter-rouge">setAcceptedFeatureTypes(String[])</code> defined in parent class <em>FeatureBrowser</em>.</p>

<p>The question is: How to test it? 🤔</p>

<h2 id="extract-usage-for-test">Extract Usage for Test</h2>

<p>Before going further, let’s see how the class is used. In parent class
<em>FeatureBrowser</em>, features are read to create content. The list of
feature models go through a for-loop: if the feature model is an accepted
one, it will be put inside the target maps. Else, it will be skipped. This
approach is not test-friendly. The function has no input parameters, it depends
on the state of the dialog. The feature-filtering is split into two parts:
getting features and filtering.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code> public class FeatureBrowser extends Dialog {
     ...

     @Override
     protected Widget createContent() {
         tree = new TreeEx();
         Map&lt;String, String&gt; itemLabels = new HashMap&lt;&gt;();
         Map&lt;String, FeatureModel&gt; featureItems = new HashMap&lt;&gt;();
<span class="gd">-        List&lt;FeatureModel&gt; extensions = project.getFeatures();
-        for (FeatureModel xt : extensions.toArray(new FeatureModel[extensions.size()])) {
</span><span class="gi">+        for (FeatureModel xt : getAcceptedFeatures()) {
</span>             String id = xt.getId();
<span class="gd">-            if (accept(xt) &amp;&amp; !itemLabels.containsKey(id)) {
</span><span class="gi">+            if (!itemLabels.containsKey(id)) {
</span>                 featureItems.put(id, xt);
                 itemLabels.put(id, id);
             }
         }
         ...
     }

+    public List&lt;FeatureModel&gt; getAcceptedFeatures() {
<span class="gi">+        return project.getFeatures()
+                      .stream()
+                      .filter(this::accept)
+                      .collect(Collectors.toList());
+    }
+
</span> }
</code></pre></div></div>

<p>In order to better test the code, I extracted the filter part into a seperacted
method called <code class="language-plaintext highlighter-rouge">getAcceptedFeatures()</code>. It use <code class="language-plaintext highlighter-rouge">accept()</code> defined in the current
class. More importantly, its behaviors change according to the filter. In other
words, <code class="language-plaintext highlighter-rouge">FeatureBrowser.accept()</code> and <code class="language-plaintext highlighter-rouge">NonUIChainsBrowser.accept()</code> have different
behaviors—their filter are different. The first one accepts all the features and
the second one only accepts specific feature having type: Automation Chain.
Therefore, we will be able to write test for filtering of the child class
<em>NonUIChainsBrowser</em>. For example:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">NonUIChainsBrowser</span> <span class="n">browser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NonUIChainsBrowser</span><span class="o">();</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">FeatureModel</span><span class="o">&gt;</span> <span class="n">accepted</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="na">getAcceptedFeatures</span><span class="o">();</span>
<span class="n">assertTrue</span><span class="o">(</span><span class="n">accepted</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span> <span class="o">...</span> <span class="o">));</span>
</code></pre></div></div>

<p>But the problem is the project model. In <code class="language-plaintext highlighter-rouge">getAcceptedFeatures()</code>, we need to
have project model configured to retrieve the results. In Nuxeo Online Services,
the construction of project model class is very complex. It requires lot of
set up: having user, subscription, etc. In order to avoid these conditions, I
would like to use mocking framework. That’s how GwtMockito comes it.</p>

<h2 id="gwtmockito">GwtMockito</h2>

<p>Ideally, I can use Mockito to handle the mock of features as follows in my test:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Given a project with a list of features</span>
<span class="nc">ProjectModel</span> <span class="n">project</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">ProjectModel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">FeatureModel</span> <span class="n">featureB</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BrandingFeature</span><span class="o">(</span><span class="s">"aBranding"</span><span class="o">);</span>
<span class="nc">FeatureModel</span> <span class="n">featureC</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OpChainFeature</span><span class="o">(</span><span class="s">"aChain"</span><span class="o">);</span>
<span class="nc">FeatureModel</span> <span class="n">featureS</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AutomationScriptingFeature</span><span class="o">(</span><span class="s">"aScript"</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">FeatureModel</span><span class="o">&gt;</span> <span class="n">features</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">featureB</span><span class="o">,</span> <span class="n">featureC</span><span class="o">,</span> <span class="n">featureS</span><span class="o">);</span>
<span class="n">when</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">features</span><span class="o">);</span>
</code></pre></div></div>

<p>But I cannot do that in Google Web Kit (GWT). Testing GWT applications using
<a href="http://www.gwtproject.org/javadoc/latest/com/google/gwt/junit/client/GWTTestCase.html">GWTTestCase</a> is not pure Java tests. They are transpiled into
JavaScript. Running a compiled <a href="http://www.gwtproject.org/javadoc/latest/com/google/gwt/junit/client/GWTTestCase.html">GWTTestCase</a> subclass under JUnit
launches the HtmlUnit browser which serves to emulate your application behavior
during test execution. You cannot use reflection-based tools like mocking
frameworks. According to GwtMockito, if you’ve tried to test widgets normal test
cases, you’ve probably run into this error:</p>

<blockquote>
  <p>ERROR: GWT.create() is only usable in client code!  It cannot be called,
for example, from server code. If you are running a unit test, check that 
your test case extends GWTTestCase and that GWT.create() is not called
from within an initializer or constructor.</p>
</blockquote>

<p>GwtMockito solves this and other GWT-related testing problems by allowing you
to call <code class="language-plaintext highlighter-rouge">GWT.create</code> from JUnit tests, returning Mockito mocks.</p>

<p>Using GwtMockito in unit tests is pretty simple, you just need to declare the
classical JUnit annotation <code class="language-plaintext highlighter-rouge">RunWith</code> with <code class="language-plaintext highlighter-rouge">GwtMockitoTestRunner.class</code>, and GWT
Mockito will do the magic for you. There is no need to extend GWTTestCase.
Also, you can use JUnit 4 syntax (which is not the case for GWTTestCase).</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">GwtMockitoTestRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OpRestBindingFeatureEditorTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">myTest</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="final-test">Final Test</h2>

<p>After switching from GWTTestCase to GwtMockito, here is the final version of my
test:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">GwtMockitoTestRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OpRestBindingFeatureEditorTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">classCustomChainBrowser_getAcceptedFeatures</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Given a project with a list of features</span>
        <span class="nc">ProjectModel</span> <span class="n">project</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">ProjectModel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">FeatureModel</span> <span class="n">featureB</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BrandingFeature</span><span class="o">(</span><span class="s">"aBranding"</span><span class="o">);</span>
        <span class="nc">FeatureModel</span> <span class="n">featureC</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OpChainFeature</span><span class="o">(</span><span class="s">"aChain"</span><span class="o">);</span>
        <span class="nc">FeatureModel</span> <span class="n">featureS</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AutomationScriptingFeature</span><span class="o">(</span><span class="s">"aScript"</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">FeatureModel</span><span class="o">&gt;</span> <span class="n">features</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">featureB</span><span class="o">,</span> <span class="n">featureC</span><span class="o">,</span> <span class="n">featureS</span><span class="o">);</span>
        <span class="n">when</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">features</span><span class="o">);</span>

        <span class="c1">// When querying the accepted feature in Custom Chain Browser (Dialog)</span>
        <span class="nc">CustomChainBrowser</span> <span class="n">browser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CustomChainBrowser</span><span class="o">(</span><span class="n">project</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">FeatureModel</span><span class="o">&gt;</span> <span class="n">accepted</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="na">getAcceptedFeatures</span><span class="o">();</span>

        <span class="c1">// Then the only accepted one belongs to Operation Chain</span>
        <span class="n">assertTrue</span><span class="o">(</span><span class="n">accepted</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">featureC</span><span class="o">));</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">accepted</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>The first step of the test is to mock the project model. As I said, the project
model is too complex to configure. So I mock it with Mockito. When asking for
features in the project model, then mocking framework returns the prepared features
for the test. They have different types: branding, operation-chain,
automation-scripting. But all of them implement the interface <code class="language-plaintext highlighter-rouge">FeatureModel</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">FeatureModel</span><span class="o">&gt;</span> <span class="n">features</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">featureB</span><span class="o">,</span> <span class="n">featureC</span><span class="o">,</span> <span class="n">featureS</span><span class="o">);</span>
<span class="n">when</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">features</span><span class="o">);</span>
</code></pre></div></div>

<p>Then the second step is to construct the target “browser” (dialog). Previously,
it was called <code class="language-plaintext highlighter-rouge">NonUIChainsBrowser</code>. I renamed it to <code class="language-plaintext highlighter-rouge">CustomChainBrowser</code>, so
that it is easier to remember. Once the browser constructed, we can ask the
accepted features from this browser and check if the filtering works as
expected. Reminder: <code class="language-plaintext highlighter-rouge">getAcceptedFeatures()</code> comes from parent class
<code class="language-plaintext highlighter-rouge">FeatureBrowser</code>, added during bug-fixing.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// When querying the accepted feature in Custom Chain Browser (Dialog)</span>
<span class="nc">CustomChainBrowser</span> <span class="n">browser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CustomChainBrowser</span><span class="o">(</span><span class="n">project</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">FeatureModel</span><span class="o">&gt;</span> <span class="n">accepted</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="na">getAcceptedFeatures</span><span class="o">();</span>
</code></pre></div></div>

<p>Once we got the accepted features, we assert the results about the filtering.
This is done using the classic JUnit assertions. As you can see, features from
Branding and Automation Scripting are filtered correctly. Operation Chain
feature is the only one remains.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Then the only accepted one belongs to Operation Chain</span>
<span class="n">assertTrue</span><span class="o">(</span><span class="n">accepted</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">featureC</span><span class="o">));</span>
<span class="n">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">accepted</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</code></pre></div></div>

<h2 id="other-improvements">Other Improvements</h2>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">-    class NonUIChainsBrowser extends FeatureBrowser {
-        NonUIChainsBrowser() {
-            super(IDE.getActiveProject());
</span><span class="gi">+    static class CustomChainBrowser extends FeatureBrowser {
+        private static final String[] FILTER = { OpChainFeatureType.ID };
+
+        CustomChainBrowser(ProjectModel project) {
+            super(project);
+            setAcceptedFeatureTypes(FILTER);
+        }
</span></code></pre></div></div>

<p>In the same commit, I also did some other improvements in the code. Let’s take a
quick look together.</p>

<ul>
  <li>The class was renamed from <code class="language-plaintext highlighter-rouge">NonUIChainsBrowser</code> to <code class="language-plaintext highlighter-rouge">CustomChainBrowser</code> to
better illustrate the purpose of the class.</li>
  <li>The class was changed from inner class to <code class="language-plaintext highlighter-rouge">static</code> nested class so that it can
be instantiated independently from its outer class. It allows me to create an
instance of this static nested class in the test.</li>
  <li>Avoid static usage from <code class="language-plaintext highlighter-rouge">IDE.getActiveProject()</code>. This usage is not
test-friendly. The project model should be decoupled from the browser. Therefore,
it is now moved to the input parameter of the constructor. This idea comes from
<a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">Dependency Inversion
 Principle</a>,
which is part of the <a href="https://en.wikipedia.org/wiki/SOLID">SOLID principles</a>.
By consequence, the project model is mocked and then passed to the target object.</li>
</ul>

<h2 id="more-about-gwtmockito">More about GwtMockito</h2>

<p>Tests written in GwtMockito are executed by <a href="https://maven.apache.org/surefire/maven-surefire-plugin/index.html">Maven Surefire
Plugin</a> in
goal “surefire:test”. This goal binds by default to Maven lifecycle phase:
“test”. As you can see, the test is running fast, it can finish
in 0.737 second. Here is the screenshot from our build:</p>

<p><img src="/assets/20190827-gwtmockito.png" alt="Maven Surefire Plugin for GwtMockito Tests" /></p>

<p>On the other hand, subclasses of GWTTestCases are executed by <a href="https://gwt-maven-plugin.github.io/gwt-maven-plugin/">GWT Maven
Plugin</a> in goal
“gwt:test”. We don’t consider GWTTestCase to be unit test as they require the
whole GWT Module to run. For this reason, the “gwt:test” goal is bound by
default to Maven lifecycle phase: “integration-test”. Here is the screenshot
from our build:</p>

<p><img src="/assets/20190827-gwttestcase.png" alt="GWT Maven Plugin for GWTTestCase" /></p>

<p>If you want to know more about GwtMockito, take a look at
<a href="https://github.com/google/gwtmockito">https://github.com/google/gwtmockito</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Today, I shared with you my own experience on GWT bug-fixing using GwtMockito.
We started with a 2 lines fix, then expand it into a complete test plan. This is
done by refactoring the code, preparing the mocking framework, and writing the
actual test. Afterward, I explained a bit other improvements I did in the same
commits. Finally, we compared the difference between GwtMockito and GWTTestCase.
Hope you enjoy this article, see you the next time!</p>

<h2 id="references">References</h2>

<ul>
  <li>Oracle, “Nested Classes”, <em>Java Documentation</em>, 2017.
<a href="https://docs.oracle.com/javase/tutorial/java/javaOO/nested.html">https://docs.oracle.com/javase/tutorial/java/javaOO/nested.html</a></li>
  <li>GWT Project, “GWTTestCase (GWT Javadoc)”, <em>GWT Project</em>, 2019.
<a href="http://www.gwtproject.org/javadoc/latest/com/google/gwt/junit/client/GWTTestCase.html">http://www.gwtproject.org/javadoc/latest/com/google/gwt/junit/client/GWTTestCase.html</a></li>
  <li>GWT Project, “Testing”, <em>GWT Project</em>, 2019.
<a href="http://www.gwtproject.org/doc/latest/DevGuideTesting.html">http://www.gwtproject.org/doc/latest/DevGuideTesting.html</a></li>
  <li>Wikipedia, “Dependency inversion principle”, <em>Wikipedia</em>, 2019.
<a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">https://en.wikipedia.org/wiki/Dependency_inversion_principle</a></li>
  <li>Wikipedia, “SOLID”, <em>Wikipedia</em>, 2019.
<a href="https://en.wikipedia.org/wiki/SOLID">https://en.wikipedia.org/wiki/SOLID</a></li>
  <li>GWT, “Maven Plugin for GWT”, <em>GWT Maven Plugin</em>, 2017.
<a href="https://gwt-maven-plugin.github.io/gwt-maven-plugin/">https://gwt-maven-plugin.github.io/gwt-maven-plugin/</a></li>
  <li>Maven, “Introduction to the Build Lifecycle”, <em>Apache Maven</em>, 2019.
<a href="https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html">https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html</a></li>
</ul>

</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2019-08-26T22:16:23+02:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">Subscribe</a>
</div></div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/2019/08/20/checkstyle-customimportorder/">Checkstyle CustomImportOrder</a></div><div class="next"><span>NEXT</span><a href="/2019/09/02/measure-coverage-with-coverage.py/">Measure Coverage with Coverage.py</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/2019/08/26/testing-with-gwtmockito/';
    this.page.identifier = '/2019/08/26/testing-with-gwtmockito';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

