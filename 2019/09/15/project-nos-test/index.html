<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87129300-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-87129300-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Project: NOS Test - Mincong Huang</title>

<meta name="description" content="NOS Test is a QA project consists of 3 parts: RESTful API, browser, and command line. In this article, I will explain how I implemented it.">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Project: NOS Test | Mincong Huang</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Project: NOS Test" />
<meta name="author" content="Mincong Huang" />
<meta property="og:locale" content="en" />
<meta name="description" content="NOS Test is a QA project consists of 3 parts: RESTful API, browser, and command line. In this article, I will explain how I implemented it." />
<meta property="og:description" content="NOS Test is a QA project consists of 3 parts: RESTful API, browser, and command line. In this article, I will explain how I implemented it." />
<link rel="canonical" href="https://mincong.io/2019/09/15/project-nos-test/" />
<meta property="og:url" content="https://mincong.io/2019/09/15/project-nos-test/" />
<meta property="og:site_name" content="Mincong Huang" />
<meta property="og:image" content="https://mincong.io/assets/bg-mathew-schwartz-OjQgsR1oyEw-unsplash.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-09-15T15:50:33+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mincong.io/assets/bg-mathew-schwartz-OjQgsR1oyEw-unsplash.jpg" />
<meta property="twitter:title" content="Project: NOS Test" />
<meta name="twitter:site" content="@mincong_h" />
<meta name="twitter:creator" content="@mincong_h" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Mincong Huang"},"image":"https://mincong.io/assets/bg-mathew-schwartz-OjQgsR1oyEw-unsplash.jpg","description":"NOS Test is a QA project consists of 3 parts: RESTful API, browser, and command line. In this article, I will explain how I implemented it.","headline":"Project: NOS Test","dateModified":"2019-09-15T15:50:33+02:00","@type":"BlogPosting","datePublished":"2019-09-15T15:50:33+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mincong.io/2019/09/15/project-nos-test/"},"url":"https://mincong.io/2019/09/15/project-nos-test/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<meta property="og:image:width" content="1280"/>
<meta property="og:image:height" content="853"/>

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://mincong.io/2019/09/15/project-nos-test/"><link rel="alternate" type="application/rss+xml" title="Mincong Huang" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>

          

          
          
          

          
          
          

          
          

          
          

          <a href="/">Mincong Huang</a>
        </div><button class="button button--secondary button--circle search-button js-search-toggle">
            <i class="fas fa-search"></i>
          </button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/en/categories/">Categories</a></li><li class="navigation__item"><a href="/en/series/">Series</a></li><li class="navigation__item"><a href="/en/archive/">Archive</a></li><li class="navigation__item"><a href="/en/about/">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li><li>
            <a href="/cn/">
             <img src="/assets/flag-CN.png"
                  alt=""
                  class="naviation__lang_img">
            </a>
          </li>
        </ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/assets/bg-mathew-schwartz-OjQgsR1oyEw-unsplash.jpg);background-color:#203028;"><div class="hero__content"><div class ="main">

  
  <div class="article__info clearfix">
      <ul class="left-col menu">
        <li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=java">java</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=testing">testing</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=api">api</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=selenium">selenium</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/en/archive/?tag=cli">cli</a>
            </li>

        <li class="separator">|</li>
          
            <li>
              <a class="button button--circle button--primary focus lang"
                 href="/2019/09/15/project-nos-test/"><span>EN</span></a>

              






              

              
            </li>
          
        
      </ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Sep 15, 2019</span>
            </li></ul></div><div class="article__header"><header><h1>Project: NOS Test</h1></header></div><div class="article__header">
                        <p class="overlay__excerpt">NOS Test is a QA project consists of 3 parts: RESTful API, browser, and command line. In this article, I will explain how I implemented it.</p>
                      </div><div class="article__info clearfix">
  <ul class="left-col menu">
    <li>
      <i class="fas fa-camera"></i>
      
      Photo by
      <a href="https://unsplash.com/@cadop" target="_blank">Mathew Schwartz</a>
      
      on
      <a href="https://unsplash.com/license" target="_blank">Unplash </a>
    </li>
  </ul>
</div>
</div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><meta itemprop="headline" content="Project: NOS Test"><meta itemprop="author" content="Mincong Huang"/><meta itemprop="datePublished" content="2019-09-15T15:50:33+02:00">
    <meta itemprop="keywords" content="java,testing,api,selenium,cli"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->


<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><h2 id="overview">Overview</h2>

<p>In today’s article, I will explain how I implemented “NOS Test”, a side-project
I developped for automating some manual testing at Nuxeo.
Nuxeo Online Services (NOS) team develops and maintains all the online services
for Nuxeo: Studio, Connect Dashboard, Marketplace, etc. It is important to
verify everything works as expected. Besides unit tests and integration tests
running in CI, we also check the key results manually after each deployment.
However, the manual process is long and very basic.</p>

<p>The goal of “NOS Test” is to empower developers in this process. By asserting
web pages, RESTful APIs, and Nuxeo Server command line <code class="language-plaintext highlighter-rouge">nuxeoctl</code>, we are able
to do much more. After reading this article, you will understand:</p>

<ul>
  <li>The architecture of “NOS Test”</li>
  <li>The main technologies used for each components</li>
  <li>The interests of having such tool</li>
  <li>Next steps</li>
</ul>

<h2 id="architecture">Architecture</h2>

<p>“NOS Test” is written 100% in Java. It consists 3 components: Browser Testing,
API Testing, and <code class="language-plaintext highlighter-rouge">nuxeoctl</code> Testing for Nuxeo Server. They are stored in
separated packages:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">com.nuxeo.test.browser</code> for testing browser</li>
  <li><code class="language-plaintext highlighter-rouge">com.nuxeo.test.rest</code> for testing RESTful APIs</li>
  <li><code class="language-plaintext highlighter-rouge">com.nuxeo.test.nuxeoctl</code> for testing Nuxeoctl</li>
</ul>

<p>Each component contains one test-suite. A test-suite is a sequence of tests to
perform. Note the tests are ordered, because in some cases, a test can only be
launched based on the result of another test. For example, you have to login
before visiting private pages. Detail about its test will be discussed later.</p>

<p>This tool is built using Maven and packaged as a flat JAR with all dependencies.
You can use it as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ java -jar nos-test-xxx.jar [--project &lt;id&gt;] [--env &lt;name&gt;]
</code></pre></div></div>

<p>The two optional options, project and environment, provide more flexibility
to this tool. Option “project” (<code class="language-plaintext highlighter-rouge">--project &lt;id&gt;</code>) allows to choose the desired
Studio project to be asserted, defaults to my sandbox; Option “environment”
(<code class="language-plaintext highlighter-rouge">--env &lt;name&gt;</code>) allows to choose the desired environment to test (production,
pre-production, UAT, development), defaults to pre-production (<code class="language-plaintext highlighter-rouge">preprod</code>)
environment. Now we saw the architecture overview, let’s visit each component
and see how they work.</p>

<h2 id="browser-testing">Browser Testing</h2>

<p>Browser test suite is created as follows, with the URL of the website, the project
ID and user’s credentials.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BrowserTestSuite</span> <span class="n">browserTestSuite</span> <span class="o">=</span>
    <span class="nc">BrowserTestSuite</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span> <span class="c1">//</span>
        <span class="o">.</span><span class="na">siteUri</span><span class="o">(</span><span class="n">siteUri</span><span class="o">)</span>
        <span class="o">.</span><span class="na">projectId</span><span class="o">(</span><span class="n">projectId</span><span class="o">)</span>
        <span class="o">.</span><span class="na">user</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">browserTestSuite</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</code></pre></div></div>

<p>Browser test suite is implemented using <a href="https://github.com/SeleniumHQ/selenium/">Selenium
WebDriver</a>, a testing tool compatible
with all major web browsers. In my case, the code is only tested with Firefox,
but it should be easy to use other browsers in the future. Currently,
the browser test suite is very basic: it will login to the website, nagivate to
Studio project given by user, and ensure the web page is loaded correctly.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Pages</span> <span class="n">pages</span> <span class="o">=</span> <span class="nc">Pages</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">driver</span><span class="o">,</span> <span class="n">siteUri</span><span class="o">,</span> <span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
<span class="n">pages</span><span class="o">.</span><span class="na">studioModelerHome</span><span class="o">(</span><span class="n">projectId</span><span class="o">);</span>
</code></pre></div></div>

<p>At the end of the test suite, the HTTP cookie <code class="language-plaintext highlighter-rouge">JSESSIONID</code> is retrieved and
stored. It will be re-used in API testing, because some APIs do not accept basic
authentication. They can only be used when user is authenticated via Central
Authentication Service (CAS). Having the cookie <code class="language-plaintext highlighter-rouge">JSESSIONID</code> allows to simulate
such situation.</p>

<h2 id="api-testing">API Testing</h2>

<p>API test suite is created as follows, with two JAX-RS clients authenticated via basic auth
and via CAS (cookie), the project to assert and the expected range of hot-fixes:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApiTestSuite</span> <span class="n">apiTestSuite</span> <span class="o">=</span>
    <span class="nc">ApiTestSuite</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">basicAuthClient</span><span class="o">(</span><span class="n">basicAuthClient</span><span class="o">)</span>
        <span class="o">.</span><span class="na">casAuthClient</span><span class="o">(</span><span class="n">casAuthClient</span><span class="o">)</span>
        <span class="o">.</span><span class="na">projectId</span><span class="o">(</span><span class="n">projectId</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withHF</span><span class="o">(</span><span class="s">"nuxeo-10.10"</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withHF</span><span class="o">(</span><span class="s">"nuxeo-9.10"</span><span class="o">,</span> <span class="mi">33</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withHF</span><span class="o">(</span><span class="s">"nuxeo-8.10"</span><span class="o">,</span> <span class="mi">46</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">apiTestSuite</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</code></pre></div></div>

<p>API test suite is implemented using
<a href="https://github.com/eclipse-ee4j/jersey">Jersey</a>, the reference implementation
of Java™ API for RESTful Web Services
(<a href="https://jcp.org/en/jsr/detail?id=370">JSR-370</a>). At the implementation level,
all the resources available on Nuxeo Online Services are described as Java
interfaces. The actual deserialization from HTTP response is delegated to
Jersey’s
<a href="https://jersey.github.io/nonav/apidocs/2.0/jersey/org/glassfish/jersey/client/proxy/WebResourceFactory.html">WebResourceFactory</a>.
Here is an example about resource described as interface. As you
can see, it is concise and declarative:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Path</span><span class="o">(</span><span class="s">"/nuxeo/site/studio/maven/nuxeo-studio"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StudioMavenResource</span> <span class="o">{</span>

  <span class="nd">@GET</span>
  <span class="nd">@Path</span><span class="o">(</span><span class="s">"/{projectId}"</span><span class="o">)</span>
  <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span>
  <span class="nc">Response</span> <span class="nf">getProjectPage</span><span class="o">(</span><span class="nd">@PathParam</span><span class="o">(</span><span class="s">"projectId"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">projectId</span><span class="o">);</span>

  <span class="nd">@GET</span>
  <span class="nd">@Path</span><span class="o">(</span><span class="s">"/{projectId}/maven-metadata.xml"</span><span class="o">)</span>
  <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">WILDCARD</span><span class="o">)</span>
  <span class="nc">Response</span> <span class="nf">getMavenMetadataXml</span><span class="o">(</span><span class="nd">@PathParam</span><span class="o">(</span><span class="s">"projectId"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">projectId</span><span class="o">);</span>

  <span class="nd">@GET</span>
  <span class="nd">@Path</span><span class="o">(</span><span class="s">"/{projectId}/maven-metadata.xml.md5"</span><span class="o">)</span>
  <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">WILDCARD</span><span class="o">)</span>
  <span class="nc">Response</span> <span class="nf">getMavenMetadataXmlMd5</span><span class="o">(</span><span class="nd">@PathParam</span><span class="o">(</span><span class="s">"projectId"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">projectId</span><span class="o">);</span>

  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>WebResourceFactory defines a high-level (proxy-based) client API. The API
enables utilization of the server-side JAX-RS annotations to describe the
server-side resources and dynamically generate client-side project objects for
them. Once generated, it can be used directly in the code to perform
HTTP request and to get the deserialized result in Java:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">StudioMavenResource</span> <span class="n">rMaven</span> <span class="o">=</span>
    <span class="nc">WebResourceFactory</span><span class="o">.</span><span class="na">newResource</span><span class="o">(</span><span class="nc">StudioMavenResource</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">webTarget</span><span class="o">);</span>
<span class="nc">Response</span> <span class="n">page</span> <span class="o">=</span> <span class="n">rMaven</span><span class="o">.</span><span class="na">getProjectPage</span><span class="o">(</span><span class="n">projectId</span><span class="o">);</span>
<span class="nc">Response</span> <span class="n">xml</span> <span class="o">=</span> <span class="n">rMaven</span><span class="o">.</span><span class="na">getMavenMetadataXml</span><span class="o">(</span><span class="n">projectId</span><span class="o">);</span>
<span class="nc">Response</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">rMaven</span><span class="o">.</span><span class="na">getMavenMetadataXmlMd5</span><span class="o">(</span><span class="n">projectId</span><span class="o">);</span>
</code></pre></div></div>

<p>In “NOS Test”, 36 endpoints are being tested, mainly for GET operations.
It also focus on regression: new tests are added if regression detected on
production. As you can see, adding more resources will be effortless. Declaring
a new interface with a few annotations will be enough. There is also possibility
to map JSON response to Java automatically thanks to Jackson JSON provider,
registered in Jersey client. There are several reasons why I chose JAX-RS over
other technologies:</p>

<ul>
  <li>JAX-RS interfaces mentioned above is declarative and easy to be integrated</li>
  <li>JAX-RS had been actively used by the NOS team for at least 2 years, similar
concepts on interfaces</li>
  <li>JAX-RS is well known by team members</li>
  <li>Compared to other command line or GUI tools, JAX-RS has benefits from the
Java type system, assertions for HTTP response is much easier. E.g. testing
the MD5 checksum of XML file</li>
</ul>

<h2 id="nuxeoctl-testing">Nuxeoctl Testing</h2>

<p>Nuxeoctl testing is created as follows, with download directory for storing the
Nuxeo Server (ZIP) download from internet, the server version, the username, the
project id, the token and also the site URL.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">NuxeoctlTestSuite</span> <span class="n">nuxeoctlTestSuite</span> <span class="o">=</span>
    <span class="nc">NuxeoctlTestSuite</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">downloadDir</span><span class="o">(</span><span class="n">downloadDir</span><span class="o">)</span>
        <span class="o">.</span><span class="na">server</span><span class="o">(</span><span class="nc">NuxeoServer</span><span class="o">.</span><span class="na">SERVER_10_10</span><span class="o">)</span>
        <span class="o">.</span><span class="na">username</span><span class="o">(</span><span class="n">username</span><span class="o">)</span>
        <span class="o">.</span><span class="na">projectId</span><span class="o">(</span><span class="n">projectId</span><span class="o">)</span>
        <span class="o">.</span><span class="na">token</span><span class="o">(</span><span class="n">token</span><span class="o">.</span><span class="na">value</span><span class="o">())</span>
        <span class="o">.</span><span class="na">siteUri</span><span class="o">(</span><span class="n">siteUri</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">nuxeoctlTestSuite</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</code></pre></div></div>

<p>Nuxeoctl test-suite manipulates Nuxeo Server by sending commands to the server
directly: register as the target user, list marketplace packages, install
marketplace packages or more. This is done using
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Process.html">java.lang.Process</a>,
which allows you to have a native process. It can be used to control the
process and obtain information about it. In my case, commands are sent to Nuxeo
Server process, and “NOS Test” waits until the command to be complete. Exit code
is then verified.</p>

<p>Here’s an excerpt for building a process based on Bash and Bash script
<code class="language-plaintext highlighter-rouge">$SERVER/bin/nuxeoctl</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">ProcessBuilder</span> <span class="nf">newProcess</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="n">nuxeoctl</span> <span class="o">=</span> <span class="n">serverHome</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="s">"bin/nuxeoctl"</span><span class="o">).</span><span class="na">toAbsolutePath</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
  <span class="nc">String</span><span class="o">[]</span> <span class="n">command</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
  <span class="n">command</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="s">"bash"</span><span class="o">;</span>
  <span class="n">command</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">nuxeoctl</span><span class="o">;</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">command</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">ProcessBuilder</span><span class="o">(</span><span class="n">command</span><span class="o">).</span><span class="na">inheritIO</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="report">Report</h2>

<p>After each execution, a text block is generated using JIRA syntax, which
contains the essential information about each tests.</p>

<p><img src="/assets/20190915-nos-test-report.png" alt="NOS Test Report in JIRA" /></p>

<h2 id="impact">Impact</h2>

<p>Thanks to project “NOS Test”, the verification process becomes much easier than
the manual one. Here’re some advantages I can see:</p>

<ul>
  <li>Better test coverage, compared to manual testing</li>
  <li>Parameterized input data</li>
  <li>Strict regression control</li>
  <li>Execution time measurement</li>
  <li>Consistency in verification process, same test suites for each deployment</li>
  <li>One line execution</li>
  <li>Report is easy to share (command line output)</li>
  <li>Audit</li>
</ul>

<h2 id="next-steps">Next Steps</h2>

<p>As you can see, this tool is still in its very early stage. There are a lot of
improvements can be done in the future. Here are some of them that I have in mind,
grouped by component.</p>

<p>Command line:</p>

<ul>
  <li>Show command line usage (<code class="language-plaintext highlighter-rouge">help</code>) if the command entered was incorrect.</li>
  <li>Expose more parameters to users to refine the test</li>
  <li>Support “NOS Test” run command file (<code class="language-plaintext highlighter-rouge">.nostestrc</code>) to avoid typing the command
line options everytime.</li>
  <li>Provide verbose option (<code class="language-plaintext highlighter-rouge">-v,--verbose</code>) to enable or disable verbose output.</li>
</ul>

<p>Browser:</p>

<ul>
  <li>Visit more web pages</li>
  <li>Interact with web page to assert results</li>
  <li>Test via other drivers, such as Chrome Driver</li>
</ul>

<p>API:</p>

<ul>
  <li>Send HTTP requests concurrently to save time</li>
  <li>Do POST and DELETE requests</li>
  <li>Improve API coverage</li>
</ul>

<p>Nuxeoctl:</p>

<ul>
  <li>Test more commands</li>
  <li>Extract server output from <code class="language-plaintext highlighter-rouge">Process</code> and assert</li>
  <li>Test all supported Nuxeo Servers, not only Nuxeo LTS 2019 (10.10)</li>
  <li>Measure the time spent</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, I explained the side project “NOS Test” that I started on
22nd July, 2019 by sharing its architecture and its three components: browser,
API and Nuxeoctl. I explained its impact and some potentials about this tool.
Hope you enjoy this article, see you the next time!</p>

<h2 id="references">References</h2>

<ul>
  <li>Selenium, “SeleniumHQ/Selenium: A browser automation framework and
ecosystem.”, <em>GitHub</em>, 2019.
<a href="https://github.com/SeleniumHQ/selenium/">https://github.com/SeleniumHQ/selenium/</a></li>
  <li>Jersey, “eclipse-ee4j/jersey: Eclipse Jersey Project”, <em>GitHub</em>, 2019.
<a href="https://github.com/eclipse-ee4j/jersey">https://github.com/eclipse-ee4j/jersey</a></li>
  <li>Java Community Process, “JSR 370: Java™ API for RESTful Web Services (JAX-RS
2.1) Specification”, <em>Java Community Process</em>, 2017.
<a href="https://jcp.org/en/jsr/detail?id=370">https://jcp.org/en/jsr/detail?id=370</a></li>
  <li>Jersey, “WebResourceFactory (jersey 2.0 API)”, <em>Jersey</em>, 2013.
<a href="https://jersey.github.io/nonav/apidocs/2.0/jersey/org/glassfish/jersey/client/proxy/WebResourceFactory.html">https://jersey.github.io/nonav/apidocs/2.0/jersey/org/glassfish/jersey/client/proxy/WebResourceFactory.html</a></li>
  <li>Oracle, “Process (Java Platform SE 8)”, <em>Oracle</em>, 2019.
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Process.html">https://docs.oracle.com/javase/8/docs/api/java/lang/Process.html</a></li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2019-09-15T15:50:33+02:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe">
  <i class="fas fa-rss"></i>
  <a type="application/rss+xml" href="/feed.xml">Subscribe</a>
</div></div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/2019/09/13/init-mock/">Mockito: 3 Ways to Init Mock in JUnit 4</a></div><div class="next"><span>NEXT</span><a href="/2019/09/22/mockito-verify/">Mockito: 4 Ways to Verify Interactions</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mincong.io/2019/09/15/project-nos-test/';
    this.page.identifier = '/2019/09/15/project-nos-test';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://mincong-h.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mincong Huang"><meta itemprop="url" content="/"><meta itemprop="description" content="I am an amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mincong.h@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/mincong_h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/mincong-huang" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/mincong-h" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Mincong Huang 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

